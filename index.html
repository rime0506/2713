<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- 开启iOS全屏模式，隐藏Safari工具栏 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- 全屏时状态栏为半透明黑色，视觉更统一 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- 设置主屏幕图标 -->
    <link rel="apple-touch-icon" href="https://img.heliar.top/file/1768165259227_IMG_9124.jpeg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <title>Pure Milky Pink Desktop</title>
    <style>
        :root {
            --pure-pink: #FFF2F8;
            --text-color: #D2C2C9;
            --deep-pink: #F0C8D6;
            --border-pink: #F9EBF2;
            --widget-bg: #ffffff;
            --weather-color: #F0C8D6;
            --success-color: #34C759;
            --error-color: #FF3B30;
        }

        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            padding-top: env(safe-area-inset-top);
            font-family: -apple-system, "Helvetica Neue", sans-serif;
            background-color: #ffffff;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* 主页面 */
        .desktop {
            width: 100%; 
            height: 100%;
            display: flex; 
            flex-direction: column;
            padding: 15px 5% 0;
            padding-bottom: 15px;
            box-sizing: border-box;
            transition: transform 0.4s ease;
        }

        .desktop.hidden {
            transform: translateX(-100%);
        }

        .widget {
            width: 100%;
            max-width: 420px;
            height: 130px;
            background-color: var(--widget-bg);
            border-radius: 40px;
            border: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            padding: 0 20px 0 25px;
            margin-bottom: 10px;
            position: relative;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .widget-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 2px solid var(--border-pink);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 20px;
            font-size: 30px;
            color: var(--deep-pink);
            flex-shrink: 0;
            overflow: hidden;
            cursor: pointer;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .widget-info {
            flex: 1;
            height: 85%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 5px 0 0;
            box-sizing: border-box;
            overflow: visible;
        }

        .widget-date {
            font-size: 14px;
            color: var(--deep-pink);
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .widget-time {
            font-size: 16px;
            color: var(--deep-pink);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            white-space: nowrap;
        }

        .widget-tip {
            width: calc(100% - 20px);
            min-height: 35px;
            background-color: var(--pure-pink);
            border-radius: 14px;
            border: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            padding: 6px 10px;
            font-size: 10px;
            color: var(--deep-pink);
            white-space: normal;
            line-height: 1.3;
        }

        .widget-weather-temp {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: absolute;
            right: 55px;
            top: 20px;
            flex-shrink: 0;
        }

        .weather-icon {
            width: 20px;
            height: 20px;
            position: relative;
            margin-bottom: 2px;
        }

        .sun-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--weather-color);
            position: absolute;
            top: 4px;
            left: 4px;
        }

        .sun-ray {
            position: absolute;
            background-color: var(--weather-color);
        }

        .ray-1 { top: 0; left: 9px; width: 2px; height: 3px; }
        .ray-2 { bottom: 0; left: 9px; width: 2px; height: 3px; }
        .ray-3 { left: 0; top: 9px; width: 3px; height: 2px; }
        .ray-4 { right: 0; top: 9px; width: 3px; height: 2px; }
        .ray-5 { top: 2px; left: 2px; width: 2px; height: 3px; transform: rotate(45deg); }
        .ray-6 { top: 2px; right: 2px; width: 2px; height: 3px; transform: rotate(-45deg); }
        .ray-7 { bottom: 2px; left: 2px; width: 2px; height: 3px; transform: rotate(-45deg); }
        .ray-8 { bottom: 2px; right: 2px; width: 2px; height: 3px; transform: rotate(45deg); }

        .widget-temp {
            font-size: 16px;
            color: var(--deep-pink);
            font-weight: 500;
            white-space: nowrap;
        }

        .icon-grid {
            display: flex;
            justify-content: space-between; /* 图标之间自动平均分布 */
            padding: 0 10px; /* 两边留出等距间隔 */
            margin-bottom: 10px;
            box-sizing: border-box;
            width: 100%; /* 占满容器宽度 */
            flex-shrink: 0;
        }

        .app-item {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer;
            width: 60px; /* 固定宽度，确保分布均匀 */
        }

        .icon-box {
            width: 60px;
            height: 60px;
            border-radius: 20px;
            background-color: var(--pure-pink);
            margin-bottom: 8px;
            transition: transform 0.15s ease;
            box-shadow: none;
            border: 1px solid var(--border-pink);
        }

        .app-item:active .icon-box {
            transform: scale(0.92);
            background-color: #F9EBF2;
        }

        .app-label {
            color: var(--text-color);
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .dock-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 88%;
            max-width: 340px;
            height: 84px;
            background: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 30px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            box-shadow: none;
            box-sizing: border-box;
        }

        .dock-icon {
            width: 54px;
            height: 54px;
            border-radius: 18px;
            background-color: var(--pure-pink);
            border: 1px solid var(--border-pink);
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .dock-icon:active {
            transform: scale(0.92);
            background-color: #F9EBF2;
        }

        /* 微信页面样式 */
        .wechat-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #ffffff;
            z-index: 20;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
        }

        /* 朋友资料页面应该在聊天详细页面之上 */
        #friendProfilePage {
            z-index: 50;
        }
        
        #momentsPage {
            z-index: 60;
        }

        .wechat-page.active {
            transform: translateX(0);
        }

        .music-app-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #ffffff;
            z-index: 20;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            overflow: hidden;
        }

        .music-app-page.active {
            transform: translateX(0);
        }

        .wechat-content {
            flex: 1;
            overflow-y: auto;
            background-color: #fff;
            padding-bottom: 60px; /* 留出底部导航栏高度 */
            position: relative; /* 为子页面绝对定位提供基准 */
        }

        /* 我的页面作为子页面，不再固定定位 */
        .me-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 60px); /* 给底部 tabbar 让位 */
            padding-bottom: 60px;
            background-color: var(--pure-pink);
            z-index: 10;
            display: none;
            overflow-y: auto;
        }

        .me-page.active {
            display: block;
        }

        .wechat-header {
            height: 88px; /* 顶栏高度，和聊天页面一样 */
            display: flex;
            align-items: center; /* 垂直居中 */
            justify-content: space-between;
            padding: 15px 15px 0;
            padding-top: calc(15px + env(safe-area-inset-top));
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            box-sizing: border-box;
            position: relative;
            margin-top: 0; /* 确保紧贴顶部 */
        }

        .wechat-header-btn {
            font-size: 16px;
            color: var(--deep-pink);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* 朋友资料页面专用样式 */
        #friendProfilePage .wechat-header {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
        }

        .wechat-header-btn svg {
            display: block;
        }

        /* 加号菜单 */
        .add-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: white;
            border-radius: 12px;
            border: 1px solid var(--border-pink);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 8px 0;
            min-width: 140px;
            z-index: 100;
            display: none;
        }

        .add-menu.active {
            display: block;
        }

        .add-menu-item {
            padding: 12px 20px;
            color: var(--deep-pink);
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-menu-item:active {
            background-color: var(--pure-pink);
        }

        /* 弹窗遮罩 */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.3);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        /* 弹窗内容 */
        .modal-content {
            background-color: white;
            border-radius: 20px;
            padding: 25px;
            min-width: 280px;
            max-width: 90%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--deep-pink);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-option-btn {
            height: 48px;
            border-radius: 12px;
            border: 1px solid var(--border-pink);
            background-color: var(--pure-pink);
            color: var(--deep-pink);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-option-btn:active {
            background-color: #F9EBF2;
            transform: scale(0.98);
        }

        .modal-input {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--border-pink);
            background-color: white;
            padding: 0 15px;
            color: var(--deep-pink);
            font-size: 15px;
            outline: none;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        .modal-input:focus {
            border-color: var(--deep-pink);
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .modal-btn {
            width: 80px;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn-primary {
            background-color: var(--deep-pink);
            color: white;
        }

        .modal-btn-primary:active {
            background-color: #e8b8d0;
            transform: scale(0.98);
        }

        .modal-btn-cancel {
            background-color: var(--pure-pink);
            color: var(--deep-pink);
            border: 1px solid var(--border-pink);
        }

        .modal-btn-cancel:active {
            background-color: #F9EBF2;
            transform: scale(0.98);
        }

        /* 聊天页面 */
        .chat-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #ffffff;
            z-index: 30;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
        }

        .chat-page.active {
            transform: translateX(0);
        }

        .chat-header {
            height: 88px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 15px 0;
            padding-top: calc(15px + env(safe-area-inset-top));
            background-color: var(--pure-pink);
            border-bottom: 1px solid var(--border-pink);
            box-sizing: border-box;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .chat-back-btn {
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
        }

        .chat-name {
            font-size: 17px;
            font-weight: 600;
            color: #999;
            flex: 1;
            text-align: center;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-header-btn {
            color: #999;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
        }

        .chat-header-btn svg {
            width: 22px;
            height: 22px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px; /* 增加底部内边距，防止最后一条消息被输入栏遮挡 */
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch; /* 优化移动端滚动体验 */
        }

        .chat-message {
            display: flex;
            gap: 10px;
            max-width: 75%;
        }

        .chat-message.self {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 1px solid var(--border-pink);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--deep-pink);
        }

        .chat-bubble {
            background-color: white;
            border-radius: 12px;
            padding: 10px 14px;
            color: var(--text-color); /* 改为桌面灰色 */
            font-size: 15px;
            line-height: 1.4;
            border: 1px solid var(--border-pink);
        }

        .chat-message.self .chat-bubble {
            background-color: white;
            color: var(--text-color); /* 改为桌面灰色 */
            border-color: var(--border-pink);
        }
        
        /* 红包专用：去除气泡包裹样式 */
        .chat-bubble.red-packet-wrapper {
            background: none !important;
            border: none !important;
            padding: 0 !important;
        }

        .chat-bubble {
            user-select: text;
            -webkit-user-select: text;
        }

        /* 消息操作菜单（参考微信样式） */
        .message-action-menu {
            position: fixed;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            z-index: 2000;
            padding: 8px;
            display: flex;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .message-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            padding: 0;
        }

        .message-action-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.8);
        }

        .message-action-btn svg {
            width: 24px;
            height: 24px;
            color: var(--deep-pink);
        }

        .message-action-btn .btn-label {
            font-size: 10px;
            color: var(--deep-pink);
            margin-top: 2px;
        }

        .message-action-btn.delete-btn {
            background: rgba(255, 77, 79, 0.95);
        }

        .message-action-btn.delete-btn svg,
        .message-action-btn.delete-btn .btn-label {
            color: white;
        }

        /* 多选模式样式 */
        .chat-messages.multi-select-mode .chat-message {
            position: relative;
        }

        .chat-messages.multi-select-mode .chat-message::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--deep-pink);
            border-radius: 50%;
            background: transparent;
        }

        .chat-messages.multi-select-mode .chat-message.selected::before {
            background: var(--deep-pink);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
            background-size: 14px;
            background-position: center;
            background-repeat: no-repeat;
        }

        .multi-select-bar {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--deep-pink);
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1500;
        }

        .multi-select-bar.active {
            display: flex;
        }

        .multi-select-info {
            color: white;
            font-size: 15px;
        }

        .multi-select-actions {
            display: flex;
            gap: 15px;
        }

        .multi-select-action-btn {
            color: white;
            font-size: 15px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .multi-select-action-btn:active {
            opacity: 0.7;
        }

        /* 聊天输入栏 */
        .chat-input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            min-height: 60px;
            height: calc(60px + env(safe-area-inset-bottom));
            background-color: var(--pure-pink);
            border-top: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            gap: 8px;
            box-sizing: border-box;
            z-index: 2000; /* 确保聊天输入栏在底部导航栏之上 */
            transition: bottom 0.3s ease;
        }

        .chat-input-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: white;
            border: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            color: var(--deep-pink);
            transition: all 0.2s ease;
        }

        .chat-input-btn:active {
            background-color: #F9EBF2;
            transform: scale(0.95);
        }

        .chat-input-btn svg {
            width: 20px;
            height: 20px;
        }

        .chat-accept-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--deep-pink);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .chat-accept-btn:active {
            background-color: #e8b8d0;
            transform: scale(0.98);
        }

        .chat-accept-btn svg {
            width: 20px;
            height: 20px;
        }

        .chat-accept-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .chat-send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--deep-pink);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .chat-send-btn:active {
            background-color: #e8b8d0;
            transform: scale(0.95);
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
        }

        .chat-input-box {
            flex: 1;
            height: 36px;
            border-radius: 18px;
            border: 1px solid var(--border-pink);
            background-color: white;
            padding: 0 12px;
            font-size: 15px;
            color: var(--deep-pink);
            outline: none;
            box-sizing: border-box;
        }

        .chat-input-box:focus {
            border-color: var(--deep-pink);
        }

        .chat-menu-btn {
            display: flex;
            gap: 8px;
        }

        /* 图片输入弹窗 */
        .image-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .image-input-modal.active {
            display: flex;
        }

        .image-input-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .image-input-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--deep-pink);
            margin-bottom: 15px;
            text-align: center;
        }

        .image-input-field {
            margin-bottom: 15px;
        }

        .image-input-label {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 8px;
            display: block;
        }

        .image-input-url {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-pink);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
        }

        .image-input-url:focus {
            border-color: var(--deep-pink);
        }

        .image-input-desc {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-pink);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
            resize: vertical;
            min-height: 60px;
        }

        .image-input-desc:focus {
            border-color: var(--deep-pink);
        }

        .image-input-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .image-input-btn {
            width: 80px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .image-input-btn.cancel {
            background: #f5f5f5;
            color: var(--text-color);
        }

        .image-input-btn.cancel:active {
            background: #e0e0e0;
        }

        .image-input-btn.send {
            background: var(--deep-pink);
            color: white;
        }

        .image-input-btn.send:active {
            background: #d81b60;
        }

        .image-input-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 聊天中的图片消息 */
        .chat-bubble img {
            max-width: 200px;
            max-height: 300px;
            border-radius: 8px;
            display: block;
            margin-top: 5px;
        }

        .chat-bubble .image-desc {
            font-size: 12px;
            color: rgba(0, 0, 0, 0.6);
            margin-top: 5px;
            font-style: italic;
        }

        .chat-message.self .chat-bubble .image-desc {
            color: rgba(255, 255, 255, 0.8);
        }

        /* 语音消息样式 */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .voice-duration {
            font-size: 15px;
            font-weight: 500;
        }

        .voice-icon {
            flex-shrink: 0;
        }

        .voice-text-content {
            font-size: 14px;
            line-height: 1.5;
            color: inherit;
        }

        .chat-message.self .chat-bubble .voice-text-content {
            color: rgba(255, 255, 255, 0.9);
        }

        /* 红包封面选择样式 */
        .red-packet-covers {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .red-packet-cover-option {
            width: 60px;
            height: 80px;
            border-radius: 6px;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
        }
        .red-packet-cover-option.selected {
            border-color: var(--deep-pink);
        }
        .red-packet-cover-option.selected::after {
            content: '✓';
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: var(--deep-pink);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 聊天气泡中的红包样式 */
        .red-packet-bubble {
            background-color: #fa9d3b;
            color: white;
            border-radius: 4px;
            width: 200px;
            padding: 0 !important;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        /* 收款卡片样式（与红包区分） */
        .transfer-bubble {
            background-color: #4a90e2;
            color: white;
            border-radius: 8px;
            width: 220px;
            padding: 0 !important;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            border: 2px solid #357abd;
        }
        
        .transfer-top {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            padding: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .transfer-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .transfer-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .transfer-amount {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .transfer-note {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .transfer-bottom {
            padding: 10px 15px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .red-packet-top {
            background-color: #f76260; /* 红包红 */
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .red-packet-icon {
            width: 36px;
            height: 36px;
            background: #ffeeb1; /* 金币色 */
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .red-packet-text {
            display: flex;
            flex-direction: column;
        }
        .red-packet-note {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .red-packet-status {
            font-size: 12px;
            opacity: 0.8;
        }
        .red-packet-bottom {
            padding: 6px 12px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            background-color: white;
            color: #999;
        }

        /* 表情面板 - 紧贴底部 */
        .emoji-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            max-height: 200px;
            background: var(--pure-pink);
            border-top: 1px solid var(--border-pink);
            z-index: 999;
            overflow: hidden;
            transition: height 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .emoji-panel.active {
            height: 25vh;
        }

        /* 功能面板 - 紧贴底部 */
        .function-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            max-height: 200px;
            background: var(--pure-pink);
            border-top: 1px solid var(--border-pink);
            z-index: 999;
            overflow: hidden;
            transition: height 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .function-panel.active {
            height: 25vh;
        }

        .function-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .function-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 8px;
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border-pink);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .function-item:active {
            transform: scale(0.95);
            background: var(--pure-pink);
        }

        .function-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 6px;
            color: var(--deep-pink);
        }

        .function-icon svg {
            width: 100%;
            height: 100%;
        }

        .function-label {
            font-size: 11px;
            color: var(--text-color);
            text-align: center;
        }

        .emoji-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-pink);
            background: white;
        }

        .emoji-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--deep-pink);
        }

        .emoji-panel-close {
            width: 30px;
            height: 30px;
            border: none;
            background: transparent;
            color: var(--deep-pink);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .emoji-panel-close:active {
            background: var(--pure-pink);
        }

        .emoji-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .emoji-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .emoji-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
            background: white;
            border: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-item:active {
            transform: scale(0.9);
        }

        .emoji-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .emoji-add-btn {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px dashed var(--border-pink);
            background: white;
            color: var(--deep-pink);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .emoji-add-btn:active {
            background: var(--pure-pink);
            border-color: var(--deep-pink);
        }

        .emoji-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-color);
            font-size: 14px;
        }

        /* 添加表情弹窗 */
        .emoji-add-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .emoji-add-modal.active {
            display: flex;
        }

        .emoji-add-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .emoji-add-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--deep-pink);
            margin-bottom: 15px;
            text-align: center;
        }

        .emoji-add-field {
            margin-bottom: 15px;
        }

        .emoji-add-label {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 8px;
            display: block;
        }

        .emoji-add-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-pink);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
        }

        .emoji-add-input:focus {
            border-color: var(--deep-pink);
        }

        .emoji-add-upload-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-pink);
            border-radius: 8px;
            background: var(--pure-pink);
            color: var(--deep-pink);
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .emoji-add-upload-btn:active {
            background: var(--deep-pink);
            color: white;
        }

        .emoji-add-upload-btn input[type="file"] {
            display: none;
        }

        .emoji-add-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: center;
        }

        .emoji-add-btn {
            width: 80px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .emoji-add-btn.cancel {
            background: #f5f5f5;
            color: var(--text-color);
        }

        .emoji-add-btn.cancel:active {
            background: #e0e0e0;
        }

        .emoji-add-btn.confirm {
            background: var(--deep-pink);
            color: white;
        }

        .emoji-add-btn.confirm:active {
            background: #d81b60;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 聊天中的表情消息 */
        .chat-bubble .emoji-message {
            width: 80px;
            height: 80px;
            object-fit: contain;
            display: block;
        }

        .chat-menu-btn.hidden,
        .chat-send-btn.hidden {
            display: none;
        }

        /* 好友列表样式 */
        .friend-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-pink);
            cursor: pointer;
            background-color: white;
        }

        .friend-item:active {
            background-color: var(--pure-pink);
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--deep-pink);
            margin-right: 12px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-size: 16px;
            color: var(--deep-pink);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .friend-preview {
            font-size: 13px;
            color: var(--text-color);
        }

        /* 聊天详情页面 */
        .chat-detail-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--pure-pink);
            z-index: 40;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            overflow-y: auto;
        }

        .chat-detail-page.active {
            transform: translateX(0);
        }

        /* 视频通话页面 */
        .video-call-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 50;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            overflow: hidden;
        }

        .video-call-page.active {
            transform: translateX(0);
        }

        .video-call-header {
            height: 88px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 15px 0;
            padding-top: calc(15px + env(safe-area-inset-top));
            background: rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
            color: white;
        }

        .video-call-back-btn {
            font-size: 18px;
            color: white;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
        }

        .video-call-name {
            font-size: 17px;
            font-weight: 600;
            color: white;
            flex: 1;
            text-align: center;
        }

        .video-call-status {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            margin-top: 5px;
        }

        .video-call-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }

        .video-call-main-view {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .video-call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            margin-bottom: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .video-call-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .video-call-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .video-call-message {
            color: white;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .video-call-input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .video-call-input {
            flex: 1;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 22px;
            padding: 0 15px;
            color: white;
            font-size: 15px;
            outline: none;
        }

        .video-call-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .video-call-send-btn {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .video-call-send-btn:active {
            background: rgba(255, 255, 255, 0.5);
        }

        .video-call-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .video-call-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .video-call-control-btn:active {
            transform: scale(0.9);
        }

        .video-call-control-btn.end-call {
            background: #ff3b30;
            border-color: #ff3b30;
        }

        .chat-detail-header {
            height: 88px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 15px 0;
            padding-top: calc(15px + env(safe-area-inset-top));
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            box-sizing: border-box;
            position: relative;
            margin-top: 0;
            margin-bottom: 0;
            border-radius: 0;
        }

        .detail-back-icon {
            font-size: 16px;
            color: var(--deep-pink);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .detail-back-icon svg {
            width: 24px;
            height: 24px;
            display: block;
        }

        .chat-detail-title {
            color: #333;
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 17px;
        }

        .avatar-area {
            background: var(--widget-bg);
            padding: 18px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 15px;
            margin: 0 8px 10px;
            border: 1px solid var(--border-pink);
        }

        .detail-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: var(--pure-pink);
            border: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--deep-pink);
            flex-shrink: 0;
            overflow: hidden;
        }

        .detail-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-desc {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .detail-friend-name {
            font-size: 15px;
            color: #999;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .detail-friend-id {
            font-size: 11px;
            color: #aaa;
        }
        
        /* 朋友资料页面按钮样式 */
        .friend-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: var(--deep-pink);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .friend-action-btn:active {
            background: var(--deep-pink);
            opacity: 0.8;
            transform: scale(0.98);
        }

        .option-list {
            background: var(--widget-bg);
            margin: 0 8px;
            border-radius: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - 250px);
            border: 1px solid var(--border-pink);
            -webkit-overflow-scrolling: touch;
        }

        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-pink);
            font-size: 15px;
            cursor: pointer;
            color: #999;
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .option-item:active {
            background-color: var(--pure-pink);
        }

        .favorite-item {
            transition: background-color 0.2s;
        }
        .favorite-item:hover {
            background-color: #f5f5f5;
        }
        .favorite-item:active {
            background-color: #eeeeee;
        }

        .detail-toggle {
            width: 42px;
            height: 20px;
            border-radius: 10px;
            background: var(--pure-pink);
            position: relative;
            cursor: pointer;
            border: 1px solid var(--border-pink);
        }

        .detail-toggle.active {
            background: var(--deep-pink);
            border-color: var(--deep-pink);
        }

        .detail-toggle::after {
            content: '';
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            position: absolute;
            top: 1px;
            left: 1px;
            transition: left 0.2s ease;
        }

        .detail-toggle.active::after {
            left: 23px;
        }

        .detail-arrow {
            font-size: 14px;
            color: #aaa;
        }

        .danger-text {
            color: var(--error-color);
        }

        /* 朋友资料弹窗 */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .profile-modal.active {
            display: flex;
        }

        .profile-content {
            background: var(--widget-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border-pink);
        }

        .profile-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: var(--deep-pink);
        }

        .remark-edit {
            margin-bottom: 20px;
        }

        .remark-label {
            font-size: 13px;
            color: var(--text-color);
            margin-bottom: 6px;
            display: block;
        }

        .remark-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-pink);
            border-radius: 12px;
            outline: none;
            font-size: 15px;
            background-color: var(--pure-pink);
            color: var(--deep-pink);
            box-sizing: border-box;
        }

        .remark-input:focus {
            border-color: var(--deep-pink);
        }

        .avatar-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .upload-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--pure-pink);
            margin: 0 auto 8px;
            cursor: pointer;
            border: 1px solid var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--deep-pink);
            overflow: hidden;
        }

        .upload-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-text {
            color: var(--deep-pink);
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }

        .persona-edit {
            margin-bottom: 20px;
        }

        .persona-label {
            font-size: 13px;
            color: var(--text-color);
            margin-bottom: 6px;
        }

        .persona-textarea {
            width: 100%;
            height: 90px;
            padding: 10px 12px;
            border: 1px solid var(--border-pink);
            border-radius: 12px;
            outline: none;
            resize: none;
            background-color: var(--pure-pink);
            color: var(--deep-pink);
            font-family: inherit;
            box-sizing: border-box;
        }

        .persona-textarea:focus {
            border-color: var(--deep-pink);
        }

        .modal-btns {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .detail-modal-btn {
            width: 80px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .detail-cancel-btn {
            background: var(--pure-pink);
            border: 1px solid var(--border-pink);
            color: var(--deep-pink);
        }

        .detail-cancel-btn:active {
            background: #F9EBF2;
            transform: scale(0.98);
        }

        .detail-save-btn {
            background: var(--deep-pink);
            color: white;
            border: none;
        }

        .detail-save-btn:active {
            background: #e8b8d0;
            transform: scale(0.98);
        }

        .me-profile-top {
            background: var(--widget-bg);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid var(--border-pink);
            border-top: none;
        }

        .me-profile-top:active {
            background-color: var(--pure-pink);
        }

        .me-profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 2px solid var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--deep-pink);
            font-size: 24px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .me-profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .me-profile-info {
            flex: 1;
        }

        .me-profile-name {
            font-size: 18px;
            color: var(--deep-pink);
            font-weight: 500;
            margin-bottom: 3px;
        }

        .me-profile-id {
            font-size: 12px;
            color: var(--text-color);
        }

        .me-profile-arrow {
            color: var(--text-color);
            font-size: 16px;
        }

        .me-func-list {
            background: var(--widget-bg);
            margin: 0 8px;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border-pink);
        }

        .me-func-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-pink);
            color: #999;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .me-func-item:last-child {
            border-bottom: none;
        }

        .me-func-item:active {
            background-color: var(--pure-pink);
        }

        .me-func-icon {
            width: 22px;
            height: 22px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 18px;
        }

        .me-func-text {
            flex: 1;
        }

        .me-func-arrow {
            color: #aaa;
            font-size: 16px;
            margin-left: 10px;
        }

        /* 人设管理弹窗 */
        .persona-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .persona-modal.active {
            display: flex;
        }

        .persona-content {
            background: var(--widget-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 25px;
            padding: 25px;
            border: 1px solid var(--border-pink);
            max-height: 80vh;
            overflow-y: auto;
        }

        .persona-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
            color: var(--deep-pink);
        }

        .persona-tab-group {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .persona-tab-btn {
            flex: 1;
            padding: 10px;
            border-radius: 15px;
            border: 1px solid var(--border-pink);
            background-color: var(--pure-pink);
            color: var(--deep-pink);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .persona-tab-btn.active {
            background-color: var(--deep-pink);
            color: white;
            border: none;
        }

        .persona-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .persona-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .persona-upload-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 2px dashed var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--deep-pink);
            font-size: 28px;
            margin-bottom: 10px;
            overflow: hidden;
            cursor: pointer;
        }

        .persona-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .persona-form-label {
            font-size: 13px;
            color: var(--text-color);
            margin-bottom: 5px;
            display: block;
        }

        .persona-form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-pink);
            border-radius: 12px;
            outline: none;
            font-size: 15px;
            background-color: var(--pure-pink);
            color: var(--deep-pink);
            box-sizing: border-box;
        }

        .persona-form-input:focus {
            border-color: var(--deep-pink);
        }

        .persona-form-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px 12px;
            border: 1px solid var(--border-pink);
            border-radius: 12px;
            outline: none;
            resize: none;
            background-color: var(--pure-pink);
            color: var(--deep-pink);
            font-family: inherit;
            box-sizing: border-box;
        }

        .persona-form-textarea:focus {
            border-color: var(--deep-pink);
        }

        .persona-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .persona-list.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px 0;
            color: var(--text-color);
            font-size: 14px;
        }

        .persona-item {
            width: calc(33.333% - 10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            opacity: 0.6;
        }

        .persona-item.active {
            opacity: 1;
        }

        .persona-item-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 2px solid var(--border-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--deep-pink);
            font-size: 22px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .persona-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .persona-item-name {
            font-size: 13px;
            color: var(--deep-pink);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .wechat-title {
            font-size: 17px;
            font-weight: 600;
            color: #999;
        }

        .wechat-tabbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            min-height: 60px;
            height: calc(60px + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            border-top: 1px solid var(--border-pink);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            background-color: var(--pure-pink);
            box-sizing: border-box;
        }

        .wechat-tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: var(--text-color);
        }

        .wechat-tab-item.active {
            color: var(--deep-pink);
        }

        .wechat-tab-icon {
            width: 24px;
            height: 24px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            /* 使用CSS mask实现变色图标，需要图标为纯色SVG/PNG */
            background-color: var(--text-color);
            mask-size: contain;
            -webkit-mask-size: contain;
            mask-repeat: no-repeat;
            -webkit-mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-position: center;
        }

        .wechat-tab-item.active .wechat-tab-icon {
            background-color: var(--deep-pink);
        }

        /* SVG图标定义 - 使用更符合微信风格的简洁图标 */
        .icon-chat { 
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z'/%3E%3C/svg%3E");
        }
        .icon-contacts { 
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20 0H4v24h16V0zm-2 20H6V4h12v16zM8 6h8v2H8V6zm0 4h8v2H8v-2zm0 4h5v2H8v-2z'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20 0H4v24h16V0zm-2 20H6V4h12v16zM8 6h8v2H8V6zm0 4h8v2H8v-2zm0 4h5v2H8v-2z'/%3E%3C/svg%3E");
        }
        .icon-discover { 
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2V7zm0 8h2v2h-2v-2z'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2V7zm0 8h2v2h-2v-2z'/%3E%3C/svg%3E");
        }
        .icon-me { 
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
        }

        .wechat-tab-label {
            font-size: 10px;
        }

        /* 钱包/服务页面 */
        .wallet-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--pure-pink);
            z-index: 30;
            display: none;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
        }

        .wallet-page.active {
            display: flex;
            transform: translateX(0);
        }

        .wallet-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 0 20px 0;
        }

        /* 余额卡片 */
        .balance-card {
            background: linear-gradient(135deg, var(--deep-pink) 0%, #e8b8d0 100%);
            margin: 15px;
            padding: 25px 20px;
            color: white;
            text-align: center;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(240, 200, 214, 0.15);
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 500;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .balance-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .balance-btn {
            padding: 10px 30px;
            border-radius: 25px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .balance-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }

        /* 核心功能区（亲属卡） */
        .wallet-core-func {
            background: var(--widget-bg);
            margin: 0 15px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-pink);
            padding: 20px;
        }

        .relative-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 15px;
            background-color: rgba(229, 229, 229, 0.3);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .relative-card:active {
            background-color: #E5E5E5;
        }

        .relative-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background-color: #E5E5E5;
            color: #999999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 15px;
        }

        .relative-info {
            flex: 1;
        }

        .relative-title {
            font-size: 15px;
            color: #999999;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .relative-desc {
            font-size: 12px;
            color: #999999;
            opacity: 0.8;
        }

        .relative-arrow {
            color: #999999;
            font-size: 16px;
        }

        /* 交易记录 */
        .transaction-section {
            background: var(--widget-bg);
            margin: 0 15px;
            border-radius: 20px;
            border: 1px solid var(--border-pink);
            padding: 20px;
        }

        .transaction-title {
            font-size: 16px;
            color: var(--text-color);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-pink);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .icon-in {
            background: rgba(240, 200, 214, 0.1);
            color: var(--deep-pink);
        }

        .icon-out {
            background: rgba(255, 77, 79, 0.1);
            color: #ff4d4f;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-name {
            font-size: 15px;
            color: var(--text-color);
            margin-bottom: 3px;
            font-weight: 500;
        }

        .transaction-time {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .transaction-amount {
            font-size: 15px;
            font-weight: 500;
        }

        .amount-in {
            color: var(--deep-pink);
        }

        .amount-out {
            color: #ff4d4f;
        }

        /* 亲属卡弹窗 */
        .relative-card-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .relative-card-modal.active {
            display: flex;
        }

        .relative-card-modal-content {
            background: var(--widget-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 25px;
            padding: 25px;
            border: 1px solid var(--border-pink);
        }

        .relative-card-modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
            color: var(--deep-pink);
        }

        .relative-card-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .relative-card-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 12px;
            background-color: rgba(229, 229, 229, 0.3);
        }

        .relative-card-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background-color: #E5E5E5;
            color: #999999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-right: 12px;
        }

        .relative-card-info {
            flex: 1;
        }

        .relative-card-name {
            font-size: 14px;
            color: #999999;
            font-weight: 500;
        }

        .relative-card-desc {
            font-size: 11px;
            color: #999999;
            opacity: 0.7;
        }

        .add-relative-card-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px dashed #E5E5E5;
            background-color: rgba(229, 229, 229, 0.3);
            color: #999999;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-relative-card-btn:active {
            background-color: #E5E5E5;
        }

        /* 个性化设置页面 */
        .personalization-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #ffffff;
            z-index: 10;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .personalization-page.active {
            transform: translateX(0);
        }

        /* 设置页面 */
        .settings-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            z-index: 10;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .settings-page.active {
            transform: translateX(0);
        }

        .page-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 10px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 1px solid var(--border-pink);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--deep-pink);
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.2s ease;
        }

        .back-btn:active {
            transform: scale(0.92);
            background-color: #F9EBF2;
        }

        .page-title {
            font-size: 22px;
            color: var(--deep-pink);
            font-weight: 600;
        }

        .settings-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        /* 折叠面板样式 */
        .collapse-panel {
            background-color: var(--pure-pink);
            border-radius: 25px;
            border: 1px solid var(--border-pink);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 25px;
            cursor: pointer;
            user-select: none;
        }

        .collapse-title {
            font-size: 16px;
            color: var(--deep-pink);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 12px;
            color: var(--deep-pink);
            transition: transform 0.3s ease;
        }

        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding: 0 25px;
        }

        .collapse-panel.expanded .collapse-content {
            max-height: 1200px;
            padding: 0 25px 25px;
        }

        .collapse-panel.expanded .collapse-icon {
            transform: rotate(180deg);
        }

        /* 设置项样式 */
        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 15px;
            color: var(--deep-pink);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .settings-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .settings-item:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            font-size: 14px;
            color: var(--text-color);
        }

        .settings-input {
            height: 44px;
            border-radius: 15px;
            border: 1px solid var(--border-pink);
            background-color: white;
            padding: 0 15px;
            color: var(--deep-pink);
            font-size: 15px;
            outline: none;
        }

        .settings-input:focus {
            border-color: var(--deep-pink);
        }

        .settings-textarea {
            min-height: 80px;
            border-radius: 15px;
            border: 1px solid var(--border-pink);
            background-color: white;
            padding: 12px 15px;
            color: var(--deep-pink);
            font-size: 14px;
            outline: none;
            resize: none;
            font-family: inherit;
        }

        .settings-textarea:focus {
            border-color: var(--deep-pink);
        }

        #avatarUpload {
            display: none;
        }

        .upload-btn, .save-btn, .test-btn {
            height: 44px;
            border-radius: 15px;
            border: none;
            background-color: var(--deep-pink);
            color: white;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .upload-btn:hover, .save-btn:hover, .test-btn:hover {
            background-color: #e8b8d0;
        }

        .upload-btn:active, .save-btn:active, .test-btn:active {
            transform: scale(0.98);
        }

        .api-test-result {
            margin-top: 10px;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .api-test-result.success {
            display: flex;
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .api-test-result.error {
            display: flex;
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .api-test-result.loading {
            display: flex;
            background-color: rgba(240, 200, 214, 0.1);
            color: var(--deep-pink);
            border: 1px solid rgba(240, 200, 214, 0.2);
        }

        .result-icon {
            font-size: 16px;
        }

        /* 切换开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .slider {
            background-color: var(--deep-pink);
        }

        .toggle-switch input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* 通知状态显示 */
        #notification-status-display {
            margin-top: 10px;
            padding: 12px;
            background-color: rgba(240, 200, 214, 0.1);
            border-radius: 12px;
            font-size: 13px;
            color: #666;
        }

        .notification-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .notification-btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-btn-primary {
            background-color: var(--deep-pink);
            color: white;
        }

        .notification-btn-primary:hover {
            background-color: #e8b8d0;
        }

        .notification-btn-test {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .notification-btn-test:hover {
            background-color: #bbdefb;
        }

        .notification-btn-bg-test {
            background-color: #fff3e0;
            color: #e65100;
            border: 1px solid #ffb74d;
        }

        .notification-btn-bg-test:hover {
            background-color: #ffe0b2;
        }

        /* API验证结果显示 */
        #apiUrlValidationResult {
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-line;
            word-break: break-word;
            background-color: rgba(240, 200, 214, 0.05);
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        #apiUrlValidationResult:not(:empty) {
            border-color: rgba(240, 200, 214, 0.3);
        }

        .avatar-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .preview-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--pure-pink);
            border: 2px solid var(--border-pink);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: var(--deep-pink);
        }

        .preview-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-text {
            font-size: 13px;
            color: var(--text-color);
            flex: 1;
        }

        .save-all-btn {
            margin-top: 30px;
            background-color: var(--deep-pink);
            color: white;
            height: 50px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-all-btn:active {
            transform: scale(0.98);
            background-color: #e8b8d0;
        }

        .password-toggle {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--deep-pink);
            font-size: 14px;
            cursor: pointer;
        }

        @media (max-width: 375px) {
            .widget {
                height: 120px;
                padding: 0 15px 0 20px;
            }
            .widget-avatar {
                width: 60px;
                height: 60px;
                font-size: 25px;
                margin-right: 15px;
            }
            .widget-date {
                font-size: 12px;
            }
            .widget-time {
                font-size: 14px;
            }
            .widget-tip {
                font-size: 9px;
                width: calc(100% - 30px);
                min-height: 30px;
                padding: 4px 10px;
            }
            .widget-weather-temp {
                right: 20px;
                top: 25px;
            }
            .weather-icon {
                width: 18px;
                height: 18px;
            }
            .sun-circle {
                width: 10px;
                height: 10px;
            }
            .widget-temp {
                font-size: 14px;
            }
            /* 移除之前针对特定断点的 icon-grid 覆盖，因为现在使用 space-between 自适应 */
            .icon-box {
                width: 55px;
                height: 55px;
            }
            .collapse-header {
                padding: 18px 20px;
            }
            .collapse-content {
                padding: 0 20px;
            }
            .collapse-panel.expanded .collapse-content {
                padding: 0 20px 20px;
            }
            .page-title {
                font-size: 20px;
            }
        }

        @media (max-width: 320px) {
            .widget {
                height: 110px;
            }
            .widget-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            .widget-weather-temp {
                right: 15px;
                top: 20px;
            }
            .widget-tip {
                font-size: 8px;
                width: calc(100% - 25px);
            }
            /* 移除 icon-grid gap 覆盖 */
            .icon-box {
                width: 50px;
                height: 50px;
            }
            .collapse-header {
                padding: 16px 18px;
            }
            .collapse-content {
                padding: 0 18px;
            }
            .collapse-panel.expanded .collapse-content {
                padding: 0 18px 18px;
            }
        }
        /* 饿美了页面样式 */
        .pay-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            width: 220px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        
        .pay-card-header {
            background-color: #ff9a9e;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .pay-card-content {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .pay-card-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .pay-card-desc {
            font-size: 12px;
            color: #999;
        }
        
        .pay-card-amount {
            font-size: 20px;
            font-weight: bold;
            color: #ff4d4f;
            margin-top: 10px;
        }
        
        .pay-card-footer {
            padding: 10px;
            font-size: 12px;
            color: #999;
            text-align: center;
        }

        .pay-card.paid .pay-card-header {
            background-color: #ccc;
        }
        
        .pay-card.paid .pay-card-footer {
            color: #34C759;
        }
        
        /* 一起听卡片样式 */
        .together-listen-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            width: 280px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .together-listen-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            color: white;
        }
        .together-listen-content {
            padding: 12px;
            background: white;
        }

        .food-delivery-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #f5f5f5;
            z-index: 50;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            box-sizing: border-box;
        }

        .food-delivery-page.active {
            transform: translateX(0);
        }
        
        .food-delivery-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
        }
        
        .coupon-banner {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.3);
            transition: transform 0.2s;
        }
        
        .coupon-banner:active {
            transform: scale(0.98);
        }
        
        .coupon-text {
            color: white;
        }
        
        .coupon-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .coupon-desc {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .coupon-icon {
            font-size: 40px;
        }
        
        .restaurant-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .food-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .food-img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-color: #f0f0f0;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .food-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .food-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .food-desc {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .food-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .food-price {
            font-size: 18px;
            font-weight: bold;
            color: #ff4d4f;
        }
        
        .food-add-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--deep-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }
        
        .food-cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-sizing: border-box;
            z-index: 60;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .cart-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-icon {
            position: relative;
            font-size: 24px;
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -8px;
            background: #ff4d4f;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 10px;
            text-align: center;
        }
        
        .cart-price {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .cart-actions {
            display: flex;
            gap: 8px;
        }
        
        .cart-btn {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        
        .cart-btn.primary {
            background-color: #ff4d4f;
            color: white;
        }
        
        .cart-btn.secondary {
            background-color: #fff1f0;
            color: #ff4d4f;
        }
        
        /* 店铺列表样式 */
        .store-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .store-item:active {
            transform: scale(0.98);
        }
        
        .store-img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-color: #f0f0f0;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .store-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .store-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .store-desc {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .store-tags {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .store-tag {
            font-size: 10px;
            color: #ff4d4f;
            border: 1px solid #ff4d4f;
            padding: 1px 4px;
            border-radius: 4px;
        }
        
        /* 店铺详情页 */
        .store-page {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #f5f5f5;
            z-index: 60;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s ease;
        }
        
        .store-page.active {
            transform: translateX(0);
        }
        
        .store-header {
            height: 120px;
            background: linear-gradient(135deg, #ff9a9e 0%, #ff758c 100%);
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            color: white;
            position: relative;
            display: flex;
            align-items: flex-end;
        }
        
        .back-btn-white {
            position: absolute;
            top: calc(10px + env(safe-area-inset-top));
            left: 10px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            color: white;
        }
        
        .store-header-content {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .store-header-img {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }
        
        .store-header-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .store-header-desc {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .store-menu {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
        }
        
        /* 领券弹窗样式 */
        .coupon-modal-content {
            background: linear-gradient(180deg, #ff5e62 0%, #ff9966 100%);
            width: 320px;
            border-radius: 20px;
            padding: 20px;
            position: relative;
            text-align: center;
            color: white;
        }
        
        .coupon-modal-header {
            margin-bottom: 20px;
        }
        
        .coupon-modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .close-coupon {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }
        
        .coupon-cards-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .coupon-card-item {
            width: 85px;
            height: 100px;
            background: #ffebeb;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ff4d4f;
        }
        
        .coupon-card-icon {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .coupon-card-text {
            font-size: 12px;
            font-weight: bold;
        }
        
        .draw-btn {
            background: #ffd700;
            color: #d32f2f;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #b8860b;
            margin-bottom: 10px;
            transition: transform 0.1s;
        }
        
        .draw-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #b8860b;
        }
        
        .draw-btn:disabled {
            background: #ccc;
            color: #666;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .draw-tip {
            font-size: 12px;
            opacity: 0.8;
        }

        .modal-option-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 16px;
            color: #333;
        }
        
        .modal-option-item:last-child {
            border-bottom: none;
        }
        
        .modal-option-item:active {
            background-color: #f9f9f9;
        }

        /* 网易云音乐播放器样式 */
        .wyy-app-wrapper {
            background: #ffffff;
            width: 100%;
            height: 100%;
            color: #333333;
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            overflow-y: hidden;
            position: relative;
        }
        
        .wyy-app-wrapper * {
            box-sizing: border-box;
        }
        
        .wyy-page {
            display: none !important;
            animation: wyyFadeIn 0.3s ease;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        .wyy-page.active {
            display: block !important;
            z-index: 2;
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }
        .wyy-main-page.active {
            z-index: 1;
        }
        .wyy-player-page {
            z-index: 1;
        }
        .wyy-player-page.active {
            z-index: 3;
        }
        @keyframes wyyFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 播放详情页面 */
        .wyy-player-page {
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.3));
            width: 100%;
            height: 100%;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            color: white;
            display: flex;
            flex-direction: column;
        }
        .wyy-player-header {
            padding: 20px 20px 30px;
            color: white;
            position: relative;
            width: 100%;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .wyy-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .wyy-together-listen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
        }
        .wyy-together-listen-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .wyy-together-listen-btn.active {
            background: rgba(255,255,255,0.4);
            color: #ff6b6b;
        }
        .wyy-song-info-large {
            text-align: center;
            margin-top: 80px;
            padding: 0 20px;
            flex-shrink: 0;
        }
        .wyy-song-name-large {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .wyy-singer-name-large {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
        }
        .wyy-album-art-container {
            text-align: center;
            margin: auto 0;
            padding: 40px 20px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .wyy-album-art-large {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: #f5f5f5 center/cover no-repeat;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transition: opacity 0.3s ease;
            cursor: pointer;
        }
        .wyy-album-art-large.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .wyy-progress-container {
            padding: 0 30px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .wyy-progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin-bottom: 10px;
            position: relative;
            cursor: pointer;
        }
        .wyy-progress {
            height: 100%;
            background: #ffffff;
            border-radius: 2px;
            width: 0%;
        }
        .wyy-time-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        .wyy-player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
            padding: 0 20px 40px;
            flex-shrink: 0;
        }
        .wyy-album-art-container {
            transition: opacity 0.3s ease;
        }
        .wyy-album-art-container.hidden {
            display: none;
        }
        .wyy-lyrics-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.3s ease;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            text-align: center;
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            line-height: 2;
            background: transparent;
            z-index: 10;
            -webkit-overflow-scrolling: touch;
        }
        .wyy-lyrics-container.active {
            display: flex;
        }
        .wyy-lyrics-container::-webkit-scrollbar {
            width: 4px;
        }
        .wyy-lyrics-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        .wyy-loop-mode-single {
            color: #ff6b6b !important;
        }
        .wyy-control-btn-large {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .wyy-play-btn-large {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            color: #333333;
            font-size: 28px;
        }
        .wyy-quality-tag {
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        /* 主页面样式 */
        .wyy-main-page {
            background: #ffffff;
            width: 100%;
            min-height: 100%;
            padding-bottom: 70px; /* Space for play bar */
            overflow-x: hidden;
        }
        .wyy-user-header {
            width: 100%;
            max-width: 100%;
            padding: 20px 15px 10px;
            position: relative;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .wyy-avatar-wrapper {
            text-align: center;
            margin: 10px 0 15px;
            position: relative;
        }
        .wyy-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto;
            border: 1px solid #eeeeee;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            background: #f5f5f5 center/cover no-repeat;
        }
        .wyy-nickname {
            font-size: 17px;
            font-weight: 500;
            color: #333333;
            text-align: center;
            margin-bottom: 5px;
        }
        .wyy-vip-tag {
            display: inline-block;
            background: #f5f5f5;
            color: #666666;
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: 4px;
        }
        .wyy-user-stats {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 8px 0 15px;
            font-size: 13px;
            color: #666666;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        .wyy-stat-item { 
            text-align: center;
            cursor: pointer;
            position: relative;
        }
        .wyy-stat-value {
            min-height: 18px;
        }
        .wyy-stat-label { 
            font-size: 11px; 
            margin-top: 2px; 
            color: #999999;
        }
        .wyy-func-tab {
            display: flex;
            background: #f5f5f5;
            border-radius: 12px;
            margin: 0 15px;
            padding: 6px;
            border: 1px solid #eeeeee;
            width: calc(100% - 30px);
            max-width: 100%;
            box-sizing: border-box;
        }
        .wyy-func-item {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            border-radius: 8px;
            font-size: 12px;
            color: #666666;
            cursor: pointer;
            transition: all 0.3s;
        }
        .wyy-func-item.active {
            background: #ffffff;
            color: #333333;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        .wyy-playlist-placeholder {
            display: flex;
            margin: 15px auto 0;
            gap: 15px;
            overflow-x: hidden;
            padding-bottom: 5px;
            justify-content: center;
            max-width: 100%;
            width: 100%;
            flex-wrap: wrap;
            box-sizing: border-box;
        }
        .wyy-placeholder-card {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f5f5f5 center/cover no-repeat;
            border: 1px solid #eeeeee;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .wyy-placeholder-card:hover {
            transform: scale(1.05);
        }
        .wyy-music-section {
            margin: 20px 15px 100px;
            width: calc(100% - 30px);
            max-width: 100%;
            box-sizing: border-box;
        }
        .wyy-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .wyy-section-title {
            font-size: 15px;
            font-weight: bold;
            color: #333333;
        }
        .wyy-music-tab-group {
            display: flex;
            gap: 8px;
            font-size: 12px;
        }
        .wyy-music-tab {
            padding: 4px 10px;
            border-radius: 12px;
            color: #666666;
            background: #f5f5f5;
        }
        .wyy-music-tab.active {
            background: #333333;
            color: #ffffff;
        }
        .wyy-playlist-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #eeeeee;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            transition: background 0.2s;
        }
        .wyy-playlist-card:hover {
            background: #f9f9f9;
        }
        .wyy-playlist-actions {
            margin-left: auto;
        }
        .wyy-new-playlist-card:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }
        .wyy-playlist-selector-item:hover {
            background: #f9f9f9;
        }
        .wyy-playlist-selector-item:active {
            background: #f0f0f0;
        }
        .wyy-playlist-cover {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            background: #f5f5f5;
        }
        .wyy-playlist-info {
            flex: 1;
            min-width: 0;
        }
        .wyy-playlist-name {
            font-size: 14px;
            font-weight: 500;
            color: #333333;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .wyy-playlist-desc {
            font-size: 11px;
            color: #999999;
        }
        
        /* 底部播放栏 */
        .wyy-play-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            background: #ffffff;
            border-top: 1px solid #eeeeee;
            padding: 8px 15px;
            height: 60px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            box-sizing: border-box;
        }
        .wyy-record-container {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f5f5f5 center/cover no-repeat;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }
        .wyy-record-cover {
            width: 100%;
            height: 100%;
            animation: wyyRotate 8s linear infinite;
            animation-play-state: paused;
            background: inherit;
            border-radius: 50%;
        }
        .wyy-record-cover.playing {
            animation-play-state: running;
        }
        @keyframes wyyRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .wyy-play-info {
            flex: 1;
            min-width: 0;
        }
        .wyy-song-name {
            font-size: 13px;
            font-weight: 500;
            color: #333333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .wyy-singer-name {
            font-size: 11px;
            color: #999999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .wyy-play-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }
        .wyy-control-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666666;
            font-size: 15px;
            padding: 0;
        }
        .wyy-play-btn {
            width: 28px;
            height: 28px;
            background: #333333;
            border-radius: 50%;
            color: #ffffff;
            font-size: 12px;
        }
        
        /* 模态框样式 */
        .wyy-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            animation: wyyFadeIn 0.3s ease;
        }
        .wyy-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: wyySlideUp 0.3s ease;
        }
        @keyframes wyySlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .wyy-modal-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        .wyy-avatar-upload-section {
            text-align: center;
            margin-bottom: 20px;
        }
        .wyy-avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #f5f5f5 center/cover no-repeat;
            margin: 0 auto 10px;
            border: 2px solid #eeeeee;
        }
        .wyy-upload-btn {
            background: #333333;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        .wyy-upload-btn:hover {
            background: #555555;
        }
        .wyy-info-edit-section {
            margin-bottom: 20px;
        }
        .wyy-edit-group {
            margin-bottom: 15px;
        }
        .wyy-edit-label {
            display: block;
            font-size: 12px;
            color: #666666;
            margin-bottom: 5px;
        }
        .wyy-edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #eeeeee;
            border-radius: 8px;
            font-size: 13px;
            background: #f9f9f9;
        }
        .wyy-cards-edit-section {
            margin-bottom: 20px;
        }
        .wyy-cards-preview-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .wyy-card-preview-item {
            text-align: center;
        }
        .wyy-card-preview {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #f5f5f5 center/cover no-repeat;
            border: 1px solid #eeeeee;
            margin-bottom: 8px;
        }
        .wyy-card-upload-btn {
            background: #f5f5f5;
            color: #333333;
            font-size: 11px;
            padding: 4px 8px;
        }
        .wyy-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .wyy-cancel-btn {
            background: #f5f5f5;
            color: #333333;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .wyy-cancel-btn:hover {
            background: #e5e5e5;
        }
        .wyy-save-btn {
            background: #333333;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .wyy-save-btn:hover {
            background: #555555;
        }
        .wyy-file-input {
            display: none;
        }
        /* 歌曲列表模态框样式 */
        .wyy-playlist-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            animation: wyySlideUp 0.3s ease;
        }
        .wyy-songs-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #eeeeee;
            border-radius: 8px;
        }
        .wyy-song-item {
            padding: 10px 12px;
            border-bottom: 1px solid #eeeeee;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .wyy-song-item:hover {
            background: #f9f9f9;
        }
        .wyy-song-item.active {
            background: #f0f0f0;
        }
        .wyy-song-item:last-child {
            border-bottom: none;
        }
        .wyy-song-item-icon {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background: #f5f5f5 center/cover no-repeat;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            flex-shrink: 0;
            position: relative;
        }
        .wyy-song-item-icon.default {
            background: #333333;
        }
        .wyy-song-item-info {
            flex: 1;
            min-width: 0;
        }
        .wyy-song-item-name {
            font-size: 13px;
            font-weight: 500;
            color: #333333;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .wyy-song-item-singer {
            font-size: 11px;
            color: #999999;
        }
        .wyy-song-item-actions {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-shrink: 0;
        }
        .wyy-song-item-add {
            color: #333;
            background: none;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .wyy-song-item-add:hover {
            background: #f0f0f0;
            color: #666;
        }
        .wyy-song-item-remove {
            color: #ff4444;
            background: none;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .wyy-song-item-remove:hover {
            background: #ffeeee;
        }
        .wyy-add-song-form {
            border-top: 1px solid #eeeeee;
            padding-top: 20px;
        }
        .wyy-form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .wyy-add-song-btn {
            background: #333333;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            flex: 1;
        }
        .wyy-clear-all-btn {
            background: #f5f5f5;
            color: #333333;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            flex: 1;
        }
        .wyy-empty-playlist {
            text-align: center;
            padding: 30px 20px;
            color: #999999;
            font-size: 13px;
        }
        .wyy-upload-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .wyy-upload-option-btn {
            flex: 1;
            background: #f5f5f5;
            color: #666666;
            border: 1px solid #eeeeee;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
        }
        .wyy-upload-option-btn.active {
            background: #333333;
            color: white;
        }
        .wyy-upload-section {
            display: none;
        }
        .wyy-upload-section.active {
            display: block;
        }
        .wyy-cover-upload-section {
            text-align: center;
            margin-bottom: 15px;
        }
        .wyy-cover-preview {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            background: #f5f5f5 center/cover no-repeat;
            margin: 0 auto 10px;
            border: 1px solid #eeeeee;
        }

    </style>
    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</head>
<body>
    <!-- 主页面 -->
    <div class="desktop" id="desktop">
        <div class="widget">
            <div class="widget-avatar" id="avatarContainer">
                🧸
            </div>
            <div class="widget-info">
                <div class="widget-date" id="showDate">01/12/2026</div>
                <div class="widget-time" id="showTime">03:14<span id="showPeriod">上午</span></div>
                <div class="widget-tip" id="showTip">A小猫咪：丢失请联系主人电话，捡到有小零食奖励哦～</div>
            </div>
            <div class="widget-weather-temp">
                <div class="weather-icon">
                    <div class="sun-circle"></div>
                    <div class="sun-ray ray-1"></div>
                    <div class="sun-ray ray-2"></div>
                    <div class="sun-ray ray-3"></div>
                    <div class="sun-ray ray-4"></div>
                    <div class="sun-ray ray-5"></div>
                    <div class="sun-ray ray-6"></div>
                    <div class="sun-ray ray-7"></div>
                    <div class="sun-ray ray-8"></div>
                </div>
                <div class="widget-temp" id="showTemp">27℃</div>
            </div>
        </div>

        <div class="icon-grid">
            <div class="app-item" onclick="openSettingsPage()">
                <div class="icon-box"></div>
                <div class="app-label">设置</div>
            </div>
            <div class="app-item" onclick="openPersonalizationPage()">
                <div class="icon-box"></div>
                <div class="app-label">个性化</div>
            </div>
            <div class="app-item" onclick="openApp('WeChat')">
                <div class="icon-box"></div>
                <div class="app-label">WeChat</div>
            </div>
            <div class="app-item" onclick="openApp('网易云')">
                <div class="icon-box"></div>
                <div class="app-label">网易云</div>
            </div>
        </div>

        <div class="dock-container">
            <div class="dock-icon" onclick="openApp('WeChat')"></div>
            <div class="dock-icon" onclick="openApp('信息')"></div>
            <div class="dock-icon" onclick="openApp('世界书')"></div>
            <div class="dock-icon" onclick="openPersonalizationPage()"></div>
        </div>
    </div>

    <!-- 微信页面 -->
    <div class="wechat-page" id="wechatPage">
        <div class="wechat-header">
            <div class="wechat-header-btn" onclick="closeApp('wechatPage')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
                <span style="font-size: 16px; margin-left: -5px;">微信</span>
            </div>
            <div class="wechat-title">微信</div>
            <div class="wechat-header-btn" style="position: relative;" onclick="toggleAddMenu(event)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 8v8M8 12h8" />
                </svg>
                <div class="add-menu" id="addMenu">
                    <div class="add-menu-item" onclick="showAddFriendModal()">
                        <span>添加好友</span>
                    </div>
                    <div class="add-menu-item" onclick="alert('发起群聊功能开发中...')">
                        <span>发起群聊</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="wechat-content" id="wechatContent">
            <!-- 好友列表将在这里显示 -->
            <ul class="friend-list" id="friendList">
                <!-- 好友列表项将动态添加 -->
            </ul>
            
            <!-- 我的页面 (作为子页面嵌入) -->
            <div class="me-page" id="mePage">
                <div class="me-profile-top" onclick="openPersonaModal()">
                    <div class="me-profile-avatar" id="meProfileAvatar">
                        <span>我</span>
                    </div>
                    <div class="me-profile-info">
                        <div class="me-profile-name" id="meProfileName">USER</div>
                        <div class="me-profile-id" id="meProfileId">微信号：USER123</div>
                    </div>
                    <div class="me-profile-arrow">→</div>
                </div>
                <div class="me-func-list">
                    <div class="me-func-item" onclick="openFavoritesPage()">
                        <div class="me-func-icon">⭐</div>
                        <div class="me-func-text">收藏</div>
                        <div class="me-func-arrow">→</div>
                    </div>
                    <div class="me-func-item" onclick="openWalletPage()">
                        <div class="me-func-icon">💳</div>
                        <div class="me-func-text">服务</div>
                        <div class="me-func-arrow">→</div>
                    </div>
                    <div class="me-func-item" onclick="openFoodDeliveryPage()">
                        <div class="me-func-icon">🍔</div>
                        <div class="me-func-text">饿美了</div>
                        <div class="me-func-arrow">→</div>
                    </div>
                    <div class="me-func-item" onclick="openMeSettingsPage()">
                        <div class="me-func-icon">⚙</div>
                        <div class="me-func-text">设置</div>
                        <div class="me-func-arrow">→</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="wechat-tabbar">
            <div class="wechat-tab-item active" onclick="switchWeChatTab(0)">
                <div class="wechat-tab-icon icon-chat"></div>
                <div class="wechat-tab-label">微信</div>
            </div>
            <div class="wechat-tab-item" onclick="switchWeChatTab(1)">
                <div class="wechat-tab-icon icon-contacts"></div>
                <div class="wechat-tab-label">通讯录</div>
            </div>
            <div class="wechat-tab-item" onclick="switchWeChatTab(2)">
                <div class="wechat-tab-icon icon-discover"></div>
                <div class="wechat-tab-label">发现</div>
            </div>
            <div class="wechat-tab-item" onclick="switchWeChatTab(3)">
                <div class="wechat-tab-icon icon-me"></div>
                <div class="wechat-tab-label">我</div>
            </div>
        </div>
    </div>

    <!-- 世界书页面 -->
    <div class="wechat-page" id="worldbookPage">
        <div class="wechat-header">
            <div class="wechat-header-btn" onclick="closeApp('worldbookPage')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
                <span style="font-size: 16px; margin-left: -5px;">世界书</span>
            </div>
            <div class="wechat-title">世界书</div>
            <div class="wechat-header-btn" onclick="showAddWorldbookModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 8v8M8 12h8" />
                </svg>
            </div>
        </div>

        <div class="wechat-content" style="padding: 0;">
            <div id="worldbookList" style="padding: 10px;">
                <!-- 世界书列表将在这里显示 -->
            </div>
        </div>
    </div>

    <!-- 收藏页面 -->
    <div class="wechat-page" id="favoritesPage">
        <div class="wechat-header">
            <div class="wechat-header-btn" onclick="closeApp('favoritesPage')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
                <span style="font-size: 16px; margin-left: -5px;">收藏</span>
            </div>
            <div class="wechat-title">收藏</div>
        </div>

        <div class="wechat-content" style="padding: 0;">
            <div id="favoritesList" style="padding: 10px;">
                <!-- 收藏列表将在这里显示，按角色分类 -->
            </div>
        </div>
    </div>

    <!-- 网易云音乐页面 -->
    <div class="music-app-page" id="musicAppPage">
        <div class="wyy-app-wrapper">
            <!-- 主页面 -->
            <div class="wyy-page wyy-main-page active" id="wyyMainPage">
                <!-- 顶部返回按钮 -->
                <button class="wyy-main-back-btn" onclick="closeMusicApp()" style="position: fixed; top: 20px; left: 20px; z-index: 200; font-size: 18px; background: rgba(0,0,0,0.1); border: none; width: 40px; height: 40px; border-radius: 50%; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <i class="fa fa-chevron-left"></i>
                </button>
                <!-- 顶部个人信息 -->
                <div class="wyy-user-header">
                    <div class="wyy-avatar-wrapper">
                        <div class="wyy-avatar" id="wyyAvatarDisplay"></div>
                    </div>
                    <div class="wyy-nickname">他的命就这样落到了我的怀里 <span class="wyy-vip-tag">VIP叁</span></div>
                    <div class="wyy-user-stats">
                        <div class="wyy-stat-item" data-type="follow">
                            <div class="wyy-stat-value">29</div>
                            <div class="wyy-stat-label">关注</div>
                        </div>
                        <div class="wyy-stat-item" data-type="fans">
                            <div class="wyy-stat-value">9</div>
                            <div class="wyy-stat-label">粉丝</div>
                        </div>
                        <div class="wyy-stat-item" data-type="level">
                            <div class="wyy-stat-value">Lv.7</div>
                            <div class="wyy-stat-label">等级</div>
                        </div>
                        <div class="wyy-stat-item" data-type="time">
                            <div class="wyy-stat-value">904h</div>
                            <div class="wyy-stat-label">时长</div>
                        </div>
                    </div>
                    <div class="wyy-func-tab">
                        <div class="wyy-func-item">最近</div>
                        <div class="wyy-func-item">本地</div>
                        <div class="wyy-func-item">网盘</div>
                        <div class="wyy-func-item active" id="wyyDressUpBtn">装扮</div>
                    </div>
                    <div class="wyy-playlist-placeholder">
                        <div class="wyy-placeholder-card" id="wyyCard1"></div>
                        <div class="wyy-placeholder-card" id="wyyCard2"></div>
                        <div class="wyy-placeholder-card" id="wyyCard3"></div>
                        <div class="wyy-placeholder-card" id="wyyCard4"></div>
                    </div>
                </div>

                <!-- 音乐板块 -->
                <div class="wyy-music-section">
                    <div class="wyy-section-header">
                        <div class="wyy-section-title">音乐</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="wyy-control-btn" id="wyyManagePlaylistsBtn" title="歌单管理" style="font-size: 14px; padding: 4px 8px;">
                                <i class="fa fa-cog"></i>
                            </button>
                            <div class="wyy-music-tab-group">
                                <div class="wyy-music-tab">近期</div>
                                <div class="wyy-music-tab active">创建</div>
                                <div class="wyy-music-tab">收藏</div>
                            </div>
                        </div>
                    </div>
                    <div class="wyy-playlist-card wyy-new-playlist-card" id="wyyNewPlaylistBtn" style="cursor: pointer; border: 2px dashed #ddd; background: #fafafa;">
                        <div class="wyy-playlist-cover" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #999;">+</div>
                        <div class="wyy-playlist-info">
                            <div class="wyy-playlist-name">新建歌单</div>
                            <div class="wyy-playlist-desc">创建你的专属歌单</div>
                        </div>
                    </div>
                    <div id="wyyPlaylistsList">
                        <!-- 歌单列表将在这里动态生成 -->
                    </div>
                </div>

                <!-- 底部播放栏 -->
                <div class="wyy-play-bar" id="wyyPlayBar">
                    <div class="wyy-record-container" id="wyyCurrentRecordContainer">
                        <div class="wyy-record-cover" id="wyyRecordCover"></div>
                    </div>
                    <div class="wyy-play-info">
                        <div class="wyy-song-name" id="wyyCurrentSongName">怎么唱情歌</div>
                        <div class="wyy-singer-name" id="wyyCurrentSingerName">刘惜君</div>
                    </div>
                    <div class="wyy-play-controls">
                        <button class="wyy-control-btn wyy-play-btn" id="wyyPlayBtn"><i class="fa fa-play"></i></button>
                        <button class="wyy-control-btn" id="wyyPlaylistBtn"><i class="fa fa-bars"></i></button>
                    </div>
                </div>
            </div>

            <!-- 播放详情页面 -->
            <div class="wyy-page wyy-player-page" id="wyyPlayerPage">
                <div class="wyy-player-header">
                    <button class="wyy-back-btn" id="wyyBackBtn"><i class="fa fa-chevron-down"></i></button>
                    <button class="wyy-together-listen-btn" id="wyyTogetherListenBtn" title="一起听">
                        <i class="fa fa-users"></i>
                    </button>
                    <div class="wyy-song-info-large">
                        <div class="wyy-song-name-large" id="wyyPlayerSongName">怎么唱情歌</div>
                        <div class="wyy-singer-name-large" id="wyyPlayerSingerName">刘惜君</div>
                    </div>
                    <div class="wyy-album-art-container" id="wyyAlbumArtContainer">
                        <div class="wyy-album-art-large" id="wyyAlbumArtLarge"></div>
                        <div class="wyy-lyrics-container" id="wyyLyricsContainer">
                            <div id="wyyLyricsContent">暂无歌词</div>
                        </div>
                    </div>
                    <div class="wyy-progress-container">
                        <div class="wyy-progress-bar" id="wyyProgressBar">
                            <div class="wyy-progress" id="wyyProgress"></div>
                        </div>
                        <div class="wyy-time-info">
                            <span id="wyyCurrentTime">00:00</span>
                            <span class="wyy-quality-tag">极高音质</span>
                            <span id="wyyTotalTime">04:59</span>
                        </div>
                    </div>
                    <div class="wyy-player-controls">
                        <button class="wyy-control-btn-large" id="wyyLoopModeBtn" title="循环模式">
                            <i class="fa fa-list" id="wyyLoopIcon"></i>
                        </button>
                        <button class="wyy-control-btn-large" id="wyyPrevBtn"><i class="fa fa-backward"></i></button>
                        <button class="wyy-control-btn-large wyy-play-btn-large" id="wyyPlayerPlayBtn"><i class="fa fa-play"></i></button>
                        <button class="wyy-control-btn-large" id="wyyNextBtn"><i class="fa fa-forward"></i></button>
                        <button class="wyy-control-btn-large" id="wyyPlayerPlaylistBtn" title="播放列表">
                            <i class="fa fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 装扮模态框 -->
            <div class="wyy-modal-overlay" id="wyyDressUpModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">装扮设置</div>
                    
                    <div class="wyy-avatar-upload-section">
                        <div class="wyy-avatar-preview" id="wyyModalAvatarPreview"></div>
                        <button class="wyy-upload-btn" id="wyyUploadAvatarBtn">上传头像</button>
                        <input type="file" id="wyyAvatarFileInput" class="wyy-file-input" accept="image/*">
                    </div>
                    
                    <div class="wyy-info-edit-section">
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">关注数量</label>
                            <input type="text" class="wyy-edit-input" id="wyyFollowInput" placeholder="输入关注数量" value="29">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">粉丝数量</label>
                            <input type="text" class="wyy-edit-input" id="wyyFansInput" placeholder="输入粉丝数量" value="9">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">等级</label>
                            <input type="text" class="wyy-edit-input" id="wyyLevelInput" placeholder="输入等级" value="Lv.7">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">时长</label>
                            <input type="text" class="wyy-edit-input" id="wyyTimeInput" placeholder="输入时长" value="904h">
                        </div>
                    </div>
                    
                    <div class="wyy-cards-edit-section">
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌单卡片图片</label>
                            <div class="wyy-cards-preview-container">
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview1"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="1">卡片1</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="1" accept="image/*">
                                </div>
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview2"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="2">卡片2</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="2" accept="image/*">
                                </div>
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview3"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="3">卡片3</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="3" accept="image/*">
                                </div>
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview4"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="4">卡片4</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="4" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelBtn">取消</button>
                        <button class="wyy-save-btn" id="wyySaveBtn">保存</button>
                    </div>
                </div>
            </div>

            <!-- 歌曲列表模态框 -->
            <div class="wyy-modal-overlay" id="wyyPlaylistModal">
                <div class="wyy-playlist-modal-content">
                    <div class="wyy-modal-title">播放列表</div>
                    
                    <div class="wyy-songs-list" id="wyySongsList">
                        <div class="wyy-empty-playlist" id="wyyEmptyPlaylist">暂无歌曲，请添加歌曲</div>
                        <!-- 歌曲列表会动态添加到这里 -->
                    </div>
                    
                    <div class="wyy-add-song-form">
                        <!-- 歌曲封面上传 -->
                        <div class="wyy-cover-upload-section">
                            <div class="wyy-cover-preview" id="wyySongCoverPreview"></div>
                            <button class="wyy-upload-btn" id="wyyUploadCoverBtn">上传歌曲封面</button>
                            <input type="file" id="wyyCoverFileInput" class="wyy-file-input" accept="image/*">
                        </div>
                        
                        <!-- 歌曲名称和歌手 -->
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌曲名称</label>
                            <input type="text" class="wyy-edit-input" id="wyySongNameInput" placeholder="输入歌曲名称">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌手名称</label>
                            <input type="text" class="wyy-edit-input" id="wyySingerNameInput" placeholder="输入歌手名称">
                        </div>
                        
                        <!-- 歌曲上传选项 -->
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌曲文件</label>
                            <div class="wyy-upload-options">
                                <button class="wyy-upload-option-btn" id="wyyUrlOptionBtn" data-type="url">URL链接</button>
                                <button class="wyy-upload-option-btn active" id="wyyFileOptionBtn" data-type="file">本地文件</button>
                            </div>
                            <div class="wyy-upload-section active" id="wyyFileUploadSection">
                                <input type="file" id="wyySongFileInput" class="wyy-file-input" accept=".mp3,.wav,.ogg,.m4a,.flac,.aac,audio/*">
                                <button class="wyy-upload-btn" style="width: 100%; margin-top: 5px;" id="wyyUploadSongFileBtn">选择歌曲文件</button>
                                <div class="wyy-edit-label" style="margin-top: 5px; color: #999; font-size: 10px;">支持MP3、WAV、OGG、M4A、FLAC、AAC等格式</div>
                            </div>
                            <div class="wyy-upload-section" id="wyyUrlUploadSection">
                                <input type="text" class="wyy-edit-input" id="wyySongUrlInput" placeholder="输入歌曲音频URL">
                            </div>
                        </div>
                        
                        <!-- 歌词上传选项 -->
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌词文件 (可选)</label>
                            <div class="wyy-upload-options">
                                <button class="wyy-upload-option-btn" id="wyyLyricUrlOptionBtn" data-type="url">URL链接</button>
                                <button class="wyy-upload-option-btn active" id="wyyLyricFileOptionBtn" data-type="file">本地文件</button>
                            </div>
                            <div class="wyy-upload-section active" id="wyyLyricFileUploadSection">
                                <input type="file" id="wyyLyricFileInput" class="wyy-file-input" accept=".lrc,.txt">
                                <button class="wyy-upload-btn" style="width: 100%; margin-top: 5px;" id="wyyUploadLyricFileBtn">选择歌词文件</button>
                                <div class="wyy-edit-label" style="margin-top: 5px; color: #999; font-size: 10px;">支持LRC、TXT格式</div>
                            </div>
                            <div class="wyy-upload-section" id="wyyLyricUrlUploadSection">
                                <input type="text" class="wyy-edit-input" id="wyyLyricUrlInput" placeholder="输入歌词文件URL">
                            </div>
                        </div>
                        
                        <div class="wyy-form-buttons">
                            <button class="wyy-clear-all-btn" id="wyyClearAllBtn">清空列表</button>
                            <button class="wyy-add-song-btn" id="wyyAddSongBtn">添加歌曲</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 创建歌单模态框 -->
            <div class="wyy-modal-overlay" id="wyyCreatePlaylistModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">创建歌单</div>
                    
                    <div class="wyy-edit-group">
                        <label class="wyy-edit-label">歌单名称</label>
                        <input type="text" class="wyy-edit-input" id="wyyNewPlaylistName" placeholder="输入歌单名称">
                    </div>
                    
                    <div class="wyy-edit-group">
                        <label class="wyy-edit-label">歌单描述（可选）</label>
                        <textarea class="wyy-edit-input" id="wyyNewPlaylistDesc" placeholder="输入歌单描述" style="height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="wyy-avatar-upload-section">
                        <div class="wyy-avatar-preview" id="wyyNewPlaylistCoverPreview" style="width: 100px; height: 100px; border-radius: 8px;"></div>
                        <button class="wyy-upload-btn" id="wyyUploadPlaylistCoverBtn">上传封面</button>
                        <input type="file" id="wyyPlaylistCoverFileInput" class="wyy-file-input" accept="image/*">
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelCreatePlaylistBtn">取消</button>
                        <button class="wyy-save-btn" id="wyySaveCreatePlaylistBtn">创建</button>
                    </div>
                </div>
            </div>

            <!-- 添加到歌单模态框 -->
            <div class="wyy-modal-overlay" id="wyyAddToPlaylistModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">添加到歌单</div>
                    
                    <div id="wyyPlaylistSelectorList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                        <!-- 歌单列表将在这里动态生成 -->
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelAddToPlaylistBtn">取消</button>
                    </div>
                </div>
            </div>

            <!-- 歌单详情模态框 -->
            <div class="wyy-modal-overlay" id="wyyPlaylistDetailModal">
                <div class="wyy-playlist-modal-content">
                    <div class="wyy-modal-title" id="wyyPlaylistDetailTitle">歌单详情</div>
                    
                    <div class="wyy-songs-list" id="wyyPlaylistDetailSongsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- 歌曲列表将在这里动态生成 -->
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyClosePlaylistDetailBtn">关闭</button>
                        <button class="wyy-save-btn" id="wyySwitchToPlaylistBtn">切换到该歌单</button>
                    </div>
                </div>
            </div>

            <!-- 一起听 - 选择角色模态框 -->
            <div class="wyy-modal-overlay" id="wyyTogetherListenModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">选择一起听的角色</div>
                    
                    <div id="wyyTogetherListenRoleList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                        <!-- 角色列表将在这里动态生成 -->
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelTogetherListenBtn">取消</button>
                        <button class="wyy-save-btn" id="wyyStopTogetherListenBtn" style="display: none;">结束一起听</button>
                    </div>
                </div>
            </div>

            <!-- 歌单管理模态框 -->
            <div class="wyy-modal-overlay" id="wyyPlaylistManageModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">歌单管理</div>
                    
                    <div class="wyy-modal-buttons" style="flex-direction: column; gap: 10px;">
                        <button class="wyy-upload-btn" id="wyyExportPlaylistBtn" style="width: 100%;">导出当前歌单</button>
                        <button class="wyy-upload-btn" id="wyyImportPlaylistBtn" style="width: 100%;">导入歌单</button>
                        <input type="file" id="wyyImportPlaylistFileInput" class="wyy-file-input" accept=".json" style="display: none;">
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyClosePlaylistManageBtn">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 个性化设置页面 -->
    <div class="personalization-page" id="personalizationPage">
        <div class="page-header">
            <div class="back-btn" onclick="closePersonalizationPage()">
                ←
            </div>
            <div class="page-title">个性化设置</div>
        </div>
        
        <div class="settings-content">
            <!-- 小组件设置折叠面板 -->
            <div class="collapse-panel expanded" id="widgetSettingsPanel">
                <div class="collapse-header" onclick="toggleWidgetSettings()">
                    <div class="collapse-title">
                        <span>📱</span> 小组件设置
                    </div>
                    <div class="collapse-icon">▼</div>
                </div>
                <div class="collapse-content">
                    <!-- 头像设置 -->
                    <div class="settings-section">
                        <div class="section-title">头像设置</div>
                        
                        <div class="avatar-preview">
                            <div class="preview-avatar" id="previewAvatar">
                                🧸
                            </div>
                            <div class="preview-text">
                                点击下方按钮上传头像图片，支持 JPG、PNG 格式
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <input type="file" id="avatarUpload" accept="image/*" onchange="previewAvatar(event)">
                            <button class="upload-btn" onclick="document.getElementById('avatarUpload').click()">选择头像图片</button>
                        </div>
                    </div>
                    
                    <!-- 提示文字 -->
                    <div class="settings-section">
                        <div class="section-title">提示文字</div>
                        
                        <div class="settings-item">
                            <label class="settings-label">修改桌面提示文字</label>
                            <textarea class="settings-textarea" id="tipInput" placeholder="输入想要显示的提示文字">A小猫咪：丢失请联系主人电话，捡到有小零食奖励哦～</textarea>
                        </div>
                    </div>
                    
                    <!-- 时间与日期 -->
                    <div class="settings-section">
                        <div class="section-title">时间与日期</div>
                        
                        <div class="settings-item">
                            <label class="settings-label">设置日期 (MM/DD/YYYY)</label>
                            <input type="text" class="settings-input" id="dateInput" placeholder="例如：01/12/2026">
                        </div>

                        <div class="settings-item">
                            <label class="settings-label">设置时间 (HH:MM)</label>
                            <input type="text" class="settings-input" id="timeInput" placeholder="例如：03:14">
                        </div>

                        <div class="settings-item">
                            <label class="settings-label">设置时段</label>
                            <select class="settings-input" id="periodInput">
                                <option value="上午">上午</option>
                                <option value="下午">下午</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 天气设置 -->
                    <div class="settings-section">
                        <div class="section-title">天气设置</div>
                        
                        <div class="settings-item">
                            <label class="settings-label">查询地区天气 (输入城市名)</label>
                            <input type="text" class="settings-input" id="cityInput" placeholder="例如：北京、上海">
                            <button class="test-btn" onclick="getWeather()">获取实时天气</button>
                        </div>
                        
                        <div class="settings-item">
                            <label class="settings-label">当前显示温度</label>
                            <input type="text" class="settings-input" id="tempDisplay" value="27℃" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="save-all-btn" onclick="savePersonalizationSettings()">保存个性化设置</button>
        </div>
    </div>

    <!-- 弹窗遮罩 -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" id="modalTitle">添加好友</div>
            <div class="modal-options" id="modalOptions"></div>
        </div>
    </div>

    <!-- 视频通话页面 -->
    <div class="video-call-page" id="videoCallPage">
        <div class="video-call-header">
            <div class="video-call-back-btn" onclick="closeVideoCallPage()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </div>
            <div style="flex: 1; text-align: center;">
                <div class="video-call-name" id="videoCallName">视频通话</div>
                <div class="video-call-status" id="videoCallStatus">通话中</div>
            </div>
            <div style="width: 40px;"></div>
        </div>
        <div class="video-call-content">
            <div class="video-call-main-view">
                <div class="video-call-avatar" id="videoCallAvatar">
                    <!-- 头像将动态显示 -->
                </div>
            </div>
            <div class="video-call-messages" id="videoCallMessages">
                <!-- 消息将动态添加 -->
            </div>
            <div class="video-call-input-area">
                <input type="text" class="video-call-input" id="videoCallInput" placeholder="说点什么..." onkeypress="handleVideoCallInputKeyPress(event)">
                <button class="video-call-send-btn" onclick="sendVideoCallMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <div class="video-call-controls">
                <div class="video-call-control-btn" onclick="toggleVideoCallMute()" id="muteBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </div>
                <div class="video-call-control-btn end-call" onclick="endVideoCall()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天详情页面 -->
    <div class="chat-detail-page" id="chatDetailPage">
        <div class="chat-detail-header">
            <div class="detail-back-icon" onclick="closeChatDetailPage()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </div>
            <div class="chat-detail-title">聊天详情</div>
            <div style="width: 40px; flex-shrink: 0;"></div>
        </div>

        <div class="avatar-area" onclick="openFriendProfilePage(event)" style="cursor: pointer;">
            <div class="detail-avatar" id="detailAvatar">
                <!-- 头像将动态显示 -->
            </div>
            <div class="avatar-desc">
                <div class="detail-friend-name" id="detailFriendName">好友</div>
                <div class="detail-friend-id" id="detailFriendId">ID: friend001</div>
            </div>
        </div>

        <div class="option-list">
            <div class="option-item" id="profileItem" onclick="openProfileModal()">
                <span>朋友资料</span>
                <span class="detail-arrow">→</span>
            </div>
            
            <!-- 新增聊天详细功能 -->
            <div class="option-item">
                <span>挂载记忆条数</span>
                <input type="number" id="detailMemoryCount" class="detail-input" style="width: 60px; text-align: right; border:none; background:transparent; font-size: 16px; color: var(--text-secondary); outline: none;" placeholder="10" onchange="saveChatDetailSettings()">
            </div>
            
            <div class="option-item" onclick="openBubbleCssModal()">
                <span>自定义气泡CSS</span>
                <span class="detail-arrow">→</span>
            </div>

            <div class="option-item">
                <span>线下模式（第三人称/动作）</span>
                <div class="detail-toggle" id="offlineModeToggle" onclick="toggleOfflineMode(this)"></div>
            </div>
            
            <div class="option-item" id="offlineLengthOption" style="display: none;">
                <span>输出字数限制</span>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" id="detailMinLen" class="detail-input" style="width: 50px; border: 1px solid #eee; border-radius: 4px; padding: 2px; text-align: center;" placeholder="min" onchange="saveChatDetailSettings()">
                    <span>-</span>
                    <input type="number" id="detailMaxLen" class="detail-input" style="width: 50px; border: 1px solid #eee; border-radius: 4px; padding: 2px; text-align: center;" placeholder="max" onchange="saveChatDetailSettings()">
                </div>
            </div>
            <div class="option-item" onclick="openMyProfileInChat()">
                <span>我的资料</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="showWorldbookSelector()">
                <span>世界书</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="alert('查找聊天内容功能开发中...')">
                <span>查找聊天内容</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item">
                <span>消息免打扰</span>
                <div class="detail-toggle" id="muteToggle" onclick="toggleSwitch(this)"></div>
            </div>
            <div class="option-item">
                <span>置顶聊天</span>
                <div class="detail-toggle active" id="pinToggle" onclick="toggleSwitch(this)"></div>
            </div>
            <div class="option-item">
                <span>提醒</span>
                <div class="detail-toggle" id="remindToggle" onclick="toggleSwitch(this)"></div>
            </div>
            <div class="option-item" onclick="alert('设置聊天背景功能开发中...')">
                <span>设置当前聊天背景</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="exportChatHistory()">
                <span>导出聊天记录</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="importChatHistory()">
                <span>导入聊天记录</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="importChatHistoryAdvanced()">
                <span>高级导入（EPhone格式）</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="showSummaryOptions()">
                <span>自动总结</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="showManualSummaryModal()">
                <span>手动总结</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="clearChatHistory()">
                <span>清空聊天记录</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="deleteFriend()">
                <span class="danger-text">删除</span>
                <span class="detail-arrow">→</span>
            </div>
            <div class="option-item" onclick="addToBlacklist()">
                <span class="danger-text">拉入黑名单</span>
                <span class="detail-arrow">→</span>
            </div>
        </div>
    </div>

    <!-- 朋友资料页面 -->
    <div class="wechat-page" id="friendProfilePage">
        <div class="wechat-header">
            <div class="wechat-header-btn" onclick="closeFriendProfilePage()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </div>
            <div class="wechat-title"></div>
            <div class="wechat-header-btn" onclick="showFriendProfileMenu()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="5" r="1" />
                    <circle cx="12" cy="12" r="1" />
                    <circle cx="12" cy="19" r="1" />
                </svg>
            </div>
        </div>
        
        <div class="wechat-content" style="background: #f7f7f7; padding: 0;">
            <!-- 头像信息区域 -->
            <div style="background: white; padding: 20px 15px; display: flex; align-items: center; gap: 15px;">
                <div class="detail-avatar" id="friendProfileAvatar" style="width: 60px; height: 60px; border-radius: 8px; background-color: var(--pure-pink); border: 1px solid var(--border-pink); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 500;">
                    <!-- 头像将动态显示 -->
                </div>
                <div style="flex: 1;">
                    <div class="detail-friend-name" id="friendProfileName" style="font-size: 18px; color: #333; margin-bottom: 5px; font-weight: 500;">备注</div>
                    <div class="detail-friend-id" id="friendProfileId" style="font-size: 14px; color: #aaa;">id:xxx</div>
                </div>
            </div>
            
            <!-- 朋友资料区域 -->
            <div style="background: white; margin-top: 10px;">
                <div style="padding: 15px;">
                    <div style="font-size: 15px; color: #999; margin-bottom: 10px;">朋友资料</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 15px; color: #999;">标签</span>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 15px; color: #aaa;" id="friendProfileTags">不可以,不给</span>
                            <span style="color: #aaa;">→</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; cursor: pointer;" onclick="openFriendMomentsPage()">
                        <span style="font-size: 15px; color: #999;">朋友圈</span>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 14px; color: #aaa;" id="friendProfileMoments">可以是文字可以是文字图片</span>
                            <span style="color: #aaa;">→</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 个性签名区域 -->
            <div style="background: white; margin-top: 10px;">
                <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 15px; color: #999;">个性签名</span>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="font-size: 14px; color: #aaa;" id="friendProfileSignature">暂无内容</span>
                    </div>
                </div>
            </div>
            
            <!-- 操作按钮区域 -->
            <div style="padding: 20px 15px; display: flex; gap: 15px;">
                <button class="friend-action-btn" onclick="sendMessageFromProfile()" style="flex: 1;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 5px;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                    发消息
                </button>
                <button class="friend-action-btn" onclick="startVideoCall()" style="flex: 1;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 5px;">
                        <path d="M23 7l-7 5 7 5V7z" />
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                    </svg>
                    音视频通话
                </button>
            </div>
        </div>
    </div>

    <!-- 朋友资料弹窗 -->
    <div class="profile-modal" id="profileModal" onclick="closeProfileModal(event)">
        <div class="profile-content" onclick="event.stopPropagation()">
            <div class="profile-title">朋友资料</div>
            <div class="remark-edit">
                <label class="remark-label">备注名称</label>
                <input type="text" class="remark-input" id="remarkInput" placeholder="请输入备注...">
            </div>
            <div class="avatar-upload">
                <div class="upload-avatar" id="avatarPreview" onclick="document.getElementById('detailAvatarUpload').click()">
                    <!-- 头像预览 -->
                </div>
                <input type="file" id="detailAvatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                <div class="upload-text" onclick="document.getElementById('detailAvatarUpload').click()">上传/更换头像</div>
            </div>
            <div class="persona-edit">
                <div class="persona-label">角色人设</div>
                <textarea class="persona-textarea" id="personaTextarea" placeholder="请输入这个角色的人设..."></textarea>
            </div>
            <div class="persona-edit" style="margin-bottom: 15px;">
                <div class="persona-label">使用我的资料</div>
                <button class="modal-option-btn" onclick="selectMyPersona()" style="margin-top: 8px;">选择我的人设</button>
            </div>
            <div class="persona-edit" style="margin-bottom: 15px;">
                <div class="persona-label">挂载世界书</div>
                <button class="modal-option-btn" onclick="showWorldbookSelectorForFriend()" style="margin-top: 8px;">选择世界书</button>
                <div id="currentWorldbookDisplay" style="font-size: 12px; color: #999; margin-top: 8px;"></div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeProfileModal()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="saveProfile()">保存</button>
            </div>
        </div>
    </div>

    <!-- 钱包/服务页面 -->
    <div class="wallet-page" id="walletPage">
        <div class="wechat-header">
            <div class="wechat-header-btn" onclick="closeWalletPage()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
                <span style="font-size: 16px; margin-left: -5px;">服务</span>
            </div>
            <div class="wechat-title">服务</div>
            <div class="wechat-header-btn"></div>
        </div>
        <div class="wallet-content">
            <div class="balance-card">
                <div class="balance-label">总资产（元）</div>
                <div class="balance-amount" id="walletBalance">0.00</div>
                <div class="balance-btns">
                    <button class="balance-btn" id="walletRechargeBtn" onclick="openRechargeModal()">充值</button>
                    <button class="balance-btn" onclick="alert('提现功能暂未开放')">提现</button>
                </div>
            </div>
            
            <div class="wallet-core-func">
                <div class="relative-card" onclick="openRelativeCardModal()">
                    <div class="relative-icon"></div>
                    <div class="relative-info">
                        <div class="relative-title">亲属卡</div>
                        <div class="relative-desc">添加亲属卡，为家人消费买单</div>
                    </div>
                    <div class="relative-arrow">→</div>
                </div>
            </div>
            
            <div class="transaction-section">
                <div class="transaction-title">最近交易</div>
                <div class="transaction-list" id="transactionList">
                    <div style="text-align:center;padding:20px;color:#999;font-size:14px;">暂无交易记录</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 充值弹窗 -->
    <div class="emoji-add-modal" id="rechargeModal" onclick="if(event.target===this) closeRechargeModal()">
        <div class="emoji-add-content" style="width: 80%; max-width: 320px;">
            <div class="emoji-add-title">余额充值</div>
            <div style="margin-bottom: 15px; font-size: 13px; color: #666; text-align: center;">
                初始充值仅限一次，请慎重填写金额
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">充值金额 (元)</label>
                <input type="number" class="emoji-add-input" id="rechargeAmountInput" placeholder="输入金额..." min="0.01" step="0.01">
            </div>
            <div class="emoji-add-actions">
                <button class="emoji-add-btn cancel" onclick="closeRechargeModal()">取消</button>
                <button class="emoji-add-btn confirm" onclick="confirmRecharge()">确认充值</button>
            </div>
        </div>
    </div>

    <!-- 发红包弹窗 -->
    <div class="emoji-add-modal" id="redPacketModal" onclick="if(event.target===this) closeRedPacketModal()">
        <div class="emoji-add-content" style="width: 80%; max-width: 320px;">
            <div class="emoji-add-title">发红包</div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">金额 (元)</label>
                <input type="number" class="emoji-add-input" id="redPacketAmountInput" placeholder="0.00" min="0.01" step="0.01">
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">备注</label>
                <input type="text" class="emoji-add-input" id="redPacketNoteInput" placeholder="恭喜发财，大吉大利">
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">文字颜色</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="color" id="redPacketTextColorInput" value="#D2C2C9" style="width: 40px; height: 30px; border: none; padding: 0; background: none;">
                    <span style="font-size: 12px; color: #999;">点击色块选择颜色 (默认灰色)</span>
                </div>
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">红包封面</label>
                <div class="red-packet-covers" id="redPacketCoverList">
                    <!-- 封面列表 JS 动态生成 -->
                </div>
                <div style="margin-top: 5px;">
                    <button class="modal-option-btn" onclick="document.getElementById('redPacketCoverUpload').click()" style="font-size: 12px; padding: 4px 10px;">+ 上传封面</button>
                    <input type="file" id="redPacketCoverUpload" accept="image/*" style="display: none;" onchange="handleRedPacketCoverUpload(event)">
                </div>
                <input type="hidden" id="selectedRedPacketCover" value="default">
            </div>
            <div class="emoji-add-actions">
                <button class="emoji-add-btn cancel" onclick="closeRedPacketModal()">取消</button>
                <button class="emoji-add-btn confirm" onclick="sendRedPacket()">塞钱进红包</button>
            </div>
        </div>
    </div>

    <!-- 发起收款弹窗 -->
    <div class="emoji-add-modal" id="transferModal" onclick="if(event.target===this) closeTransferModal()">
        <div class="emoji-add-content" style="width: 80%; max-width: 320px;">
            <div class="emoji-add-title">发起收款</div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">金额 (元)</label>
                <input type="number" class="emoji-add-input" id="transferAmountInput" placeholder="0.00" min="0.01" step="0.01">
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">备注</label>
                <input type="text" class="emoji-add-input" id="transferNoteInput" placeholder="收款理由">
            </div>
            <div class="emoji-add-actions">
                <button class="emoji-add-btn cancel" onclick="closeTransferModal()">取消</button>
                <button class="emoji-add-btn confirm" onclick="sendTransfer()">发起收款</button>
            </div>
        </div>
    </div>

    <!-- 亲属卡弹窗 -->
    <div class="relative-card-modal" id="relativeCardModal" onclick="closeRelativeCardModal(event)">
        <div class="relative-card-modal-content" onclick="event.stopPropagation()">
            <div class="relative-card-modal-title">亲属卡管理</div>
            <div class="relative-card-list" id="relativeCardList">
                <div style="text-align:center;padding:20px 0;color:#999999;font-size:14px;">
                    暂无亲属卡
                </div>
            </div>
            <button class="add-relative-card-btn" onclick="addRelativeCard()">
                <span>+</span> 添加亲属卡
            </button>
            <div class="modal-btns" style="margin-top: 15px;">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeRelativeCardModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 世界书添加/编辑弹窗 -->
    <div class="profile-modal" id="worldbookModal" onclick="if(event.target===this) closeWorldbookModal()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="profile-title" id="worldbookModalTitle">添加世界书</div>
            <div style="padding: 20px;">
                <div class="persona-edit">
                    <div class="persona-label">世界书名称</div>
                    <input type="text" class="persona-form-input" id="worldbookNameInput" placeholder="输入世界书名称">
                </div>
                <div class="persona-edit">
                    <div class="persona-label">世界观内容</div>
                    <textarea class="persona-form-textarea" id="worldbookContentInput" placeholder="输入世界观内容，用于角色扮演时提供背景设定..." style="min-height: 200px;"></textarea>
                </div>
                <div class="persona-edit">
                    <div class="persona-label">适用范围</div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                            <input type="radio" name="worldbookScope" value="global" id="worldbookScopeGlobal" style="margin-right: 8px;">
                            <span>全局</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                            <input type="radio" name="worldbookScope" value="single" id="worldbookScopeSingle" checked style="margin-right: 8px;">
                            <span>单聊</span>
                        </label>
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 8px; line-height: 1.5;">
                        <div>• <strong>全局</strong>：打开后所有角色都会使用这个世界书</div>
                        <div>• <strong>单聊</strong>：需要在角色详细页面中挂载这个世界书</div>
                    </div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeWorldbookModal()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="saveWorldbook()">保存</button>
            </div>
        </div>
    </div>

    <!-- 世界书选择弹窗 -->
    <div class="profile-modal" id="worldbookSelectorModal" onclick="if(event.target===this) closeWorldbookSelector()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 400px; max-height: 70vh;">
            <div class="profile-title" id="worldbookSelectorTitle">选择世界书</div>
            <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
                <div id="worldbookSelectorList" style="margin-bottom: 15px;">
                    <!-- 世界书列表将动态添加 -->
                </div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeWorldbookSelector()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="confirmWorldbookSelection()">确定</button>
            </div>
        </div>
    </div>

    <!-- 自动总结选项弹窗 -->
    <div class="profile-modal" id="summaryOptionsModal" onclick="if(event.target===this) closeSummaryOptions()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 400px;">
            <div class="profile-title">自动总结设置</div>
            <div style="padding: 20px;">
                <div class="persona-edit">
                    <div class="persona-label">总结条数</div>
                    <input type="number" class="persona-form-input" id="summaryCountInput" placeholder="20" value="20" min="1" max="100">
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">选择要总结的最近N条消息（默认20条）</div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeSummaryOptions()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="startAutoSummary()">开始总结</button>
            </div>
        </div>
    </div>

    <!-- 手动总结弹窗 -->
    <div class="profile-modal" id="manualSummaryModal" onclick="if(event.target===this) closeManualSummary()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="profile-title">手动总结</div>
            <div style="padding: 20px;">
                <div class="persona-edit">
                    <div class="persona-label">总结条数</div>
                    <input type="number" class="persona-form-input" id="manualSummaryCountInput" placeholder="20" value="20" min="1" max="100">
                </div>
                <div class="persona-edit" style="margin-top: 15px;">
                    <div class="persona-label">总结标题（可选）</div>
                    <input type="text" class="persona-form-input" id="manualSummaryTitleInput" placeholder="输入总结标题，留空则自动生成">
                </div>
                <div class="persona-edit" style="margin-top: 15px;">
                    <div class="persona-label">总结内容</div>
                    <textarea class="persona-form-textarea" id="manualSummaryContentInput" placeholder="输入或粘贴总结内容..." style="min-height: 200px;"></textarea>
                </div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeManualSummary()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="saveManualSummary()">保存到收藏</button>
            </div>
        </div>
    </div>

    <!-- 人设管理弹窗 (用于我的页面创建/选择人设) -->
    <div class="persona-modal" id="personaModal" onclick="closePersonaModal(event)">
        <div class="persona-content" onclick="event.stopPropagation()">
            <div class="persona-title">人设管理</div>
            <div class="persona-tab-group">
                <button class="persona-tab-btn" id="selectPersonaTabBtn" onclick="switchPersonaTab('select')">选择人设</button>
                <button class="persona-tab-btn active" id="createPersonaTabBtn" onclick="switchPersonaTab('create')">新建人设</button>
            </div>
            <div class="persona-form" id="personaForm">
                <div class="persona-avatar-section">
                    <div class="persona-upload-preview" id="personaAvatarPreview" onclick="document.getElementById('personaAvatarInput').click()">+</div>
                    <input type="file" id="personaAvatarInput" accept="image/*" style="display: none;" onchange="handlePersonaAvatarUpload(event)">
                    <button class="upload-btn" onclick="document.getElementById('personaAvatarInput').click()">上传头像图片</button>
                </div>
                <div>
                    <label class="persona-form-label">真名</label>
                    <input type="text" class="persona-form-input" id="personaRealNameInput" placeholder="输入真实姓名">
                </div>
                <div>
                    <label class="persona-form-label">网名</label>
                    <input type="text" class="persona-form-input" id="personaNicknameInput" placeholder="输入展示网名" value="USER">
                </div>
                <div>
                    <label class="persona-form-label">微信号</label>
                    <input type="text" class="persona-form-input" id="personaWechatIdInput" placeholder="输入微信号" value="USER123">
                </div>
                <div>
                    <label class="persona-form-label">人设描述</label>
                    <textarea class="persona-form-textarea" id="personaDescInput" placeholder="输入人设特点（如：温柔体贴，善于倾听）"></textarea>
                </div>
            </div>
            <div class="persona-list empty" id="personaList">
                暂无创建的人设，快去新建吧～
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closePersonaModal()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="savePersona()">保存</button>
            </div>
        </div>
    </div>

    <!-- 选择我的人设弹窗 (用于朋友资料中挂载我的人设) -->
    <div class="persona-modal" id="selectMyPersonaModal" onclick="closeSelectMyPersonaModal(event)">
        <div class="persona-content" onclick="event.stopPropagation()">
            <div class="persona-title">选择我的人设</div>
            <div class="persona-list empty" id="myPersonaList">
                暂无创建的人设，请先在"我"页面创建
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeSelectMyPersonaModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 朋友圈页面 -->
    <div class="moments-page" id="momentsPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; z-index: 60; overflow-y: auto;">
        <div class="moments-header" style="position: fixed; top: 0; left: 0; width: 100%; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 10; padding-top: 20px;">
            <div class="moments-back-btn" onclick="closeMomentsPage()" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </div>
            <div id="momentsHeaderBtn" class="moments-header-btn" style="width: auto; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 10px; padding: 0 12px; background: rgba(255,255,255,0.2); border-radius: 15px; color: white; font-size: 14px; font-weight: 500;">
                <span id="momentsHeaderBtnText">生成</span>
            </div>
        </div>
        
        <div class="moments-cover" style="height: 300px; background: linear-gradient(135deg, var(--pure-pink) 0%, var(--deep-pink) 100%); position: relative; margin-bottom: 40px; cursor: pointer;" onclick="document.getElementById('momentsCoverInput').click()">
            <img src="" id="momentsCoverImg" style="width: 100%; height: 100%; object-fit: cover; display: none;">
            <div class="moments-cover-placeholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px; background: linear-gradient(135deg, var(--pure-pink) 0%, var(--deep-pink) 100%);">可替换背景图</div>
            <input type="file" id="momentsCoverInput" style="display:none" accept="image/*" onchange="handleMomentsCoverUpload(event)">
            
            <div class="moments-user-info" style="position: absolute; bottom: -20px; right: 20px; display: flex; align-items: flex-start; gap: 15px; cursor: default;" onclick="event.stopPropagation()">
                <div class="moments-user-name" onclick="editMomentsName()" style="color: white; font-weight: bold; font-size: 18px; margin-top: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); cursor: pointer;">网名</div>
                <div class="moments-user-avatar" onclick="document.getElementById('momentsAvatarInput').click()" style="width: 70px; height: 70px; border-radius: 8px; overflow: hidden; background-color: #f0f0f0; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; cursor: pointer;">
                    <img src="" id="momentsAvatarImg" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    <div class="moments-avatar-placeholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; text-align: center; background: #f0f0f0;">点击<br>更换</div>
                    <input type="file" id="momentsAvatarInput" style="display:none" accept="image/*" onchange="handleMomentsAvatarUpload(event)">
                </div>
            </div>
        </div>
        
        <div class="moments-list" style="padding: 20px; padding-top: 0;">
            <!-- 朋友圈列表内容 -->
            <div class="moments-empty" style="text-align: center; padding: 40px; color: #999; font-size: 14px;">暂无内容</div>
        </div>
    </div>

    <!-- 聊天页面 -->
    <div class="chat-page" id="chatPage">
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="chat-back-btn" onclick="closeChatPage()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </div>
                <div class="chat-name" id="chatName">聊天</div>
            </div>
            <div class="chat-header-right">
                <div class="chat-header-btn" onclick="openChatDetailPage()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="19" cy="12" r="1"/>
                        <circle cx="5" cy="12" r="1"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- 消息将动态添加 -->
        </div>
        <div class="chat-input-bar">
            <button class="chat-accept-btn" id="acceptReplyBtn" onclick="acceptReply()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    <path d="M12 7v6"/>
                    <path d="M9 10l3 3 3-3"/>
                </svg>
            </button>
            <input type="text" class="chat-input-box" id="chatInput" placeholder="输入消息..." oninput="handleChatInputChange(event)" onkeypress="handleChatInputKeyPress(event)">
            <div class="chat-menu-btn" id="chatMenuBtn">
                <div class="chat-input-btn" onclick="toggleEmojiPanel()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                    </svg>
                </div>
                <div class="chat-input-btn" onclick="toggleFunctionPanel()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 8v8M8 12h8"/>
                    </svg>
                </div>
            </div>
            <button class="chat-send-btn hidden" id="chatSendBtn" onclick="sendChatMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
        
        <!-- 表情面板 -->
        <div class="emoji-panel" id="emojiPanel">
            <div class="emoji-panel-header">
                <div class="emoji-panel-title">我的表情</div>
                <button class="emoji-panel-close" onclick="closeEmojiPanel()">×</button>
            </div>
            <div class="emoji-panel-content">
                <div class="emoji-list" id="emojiList">
                    <!-- 表情列表将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 功能面板 -->
        <div class="function-panel" id="functionPanel">
            <div class="function-panel-content">
                <div class="function-grid" id="functionGrid">
                    <!-- 功能按钮将动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 图片输入弹窗 -->
    <div class="image-input-modal" id="imageInputModal" onclick="if(event.target===this) closeImageInputModal()">
        <div class="image-input-content">
            <div class="image-input-title">发送图片</div>
            <div class="image-input-field">
                <label class="image-input-label">图片链接（支持GIF）</label>
                <input type="text" class="image-input-url" id="imageUrlInput" placeholder="输入图片或图床链接..." onkeypress="if(event.key==='Enter') sendImageMessage()">
            </div>
            <div class="image-input-field">
                <label class="image-input-label">描述（可选，帮助AI理解）</label>
                <textarea class="image-input-desc" id="imageDescInput" placeholder="简单描述图片内容，不填也可以..." onkeypress="if(event.key==='Enter' && !event.shiftKey) {event.preventDefault(); sendImageMessage();}"></textarea>
            </div>
            <div class="image-input-actions">
                <button class="image-input-btn cancel" onclick="closeImageInputModal()">取消</button>
                <button class="image-input-btn send" onclick="sendImageMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- 添加表情弹窗 -->
    <div class="emoji-add-modal" id="emojiAddModal" onclick="if(event.target===this) closeEmojiAddModal()">
        <div class="emoji-add-content">
            <div class="emoji-add-title">添加表情</div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">表情名称（可选）</label>
                <input type="text" class="emoji-add-input" id="emojiNameInput" placeholder="请输入表情名称（可不填）">
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">图片链接</label>
                <input type="text" class="emoji-add-input" id="emojiUrlInput" placeholder="输入图床/图片URL（.jpg/.png/.gif）">
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">或从相册上传</label>
                <label class="emoji-add-upload-btn">
                    <input type="file" id="emojiFileInput" accept="image/jpeg,image/png,image/gif" onchange="handleEmojiFileSelect(event)">
                    选择图片（JPG/PNG/GIF）
                </label>
            </div>
            <div class="emoji-add-actions">
                <button class="emoji-add-btn cancel" onclick="closeEmojiAddModal()">取消</button>
                <button class="emoji-add-btn confirm" onclick="confirmAddEmoji()">确定</button>
            </div>
        </div>
    </div>

    <!-- 照片弹窗 -->
    <div class="emoji-add-modal" id="photoModal" onclick="if(event.target===this) closePhotoModal()">
        <div class="emoji-add-content">
            <div class="emoji-add-title">发送照片</div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">文字描述图片（可选）</label>
                <textarea class="emoji-add-input" id="photoDescInput" placeholder="描述图片内容，不填也可以..." style="min-height: 60px; resize: vertical;"></textarea>
            </div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">或上传真实图片</label>
                <label class="emoji-add-upload-btn">
                    <input type="file" id="photoFileInput" accept="image/*" onchange="handlePhotoFileSelect(event)">
                    选择图片
                </label>
            </div>
            <div id="photoPreview" style="margin: 10px 0; text-align: center; display: none;">
                <img id="photoPreviewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
            </div>
            <div class="emoji-add-actions">
                <button class="emoji-add-btn cancel" onclick="closePhotoModal()">取消</button>
                <button class="emoji-add-btn confirm" onclick="sendPhotoMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- 位置弹窗 -->
    <div class="emoji-add-modal" id="locationModal" onclick="if(event.target===this) closeLocationModal()">
        <div class="emoji-add-content">
            <div class="emoji-add-title">发送位置</div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">位置信息</label>
                <input type="text" class="emoji-add-input" id="locationInput" placeholder="输入位置信息..." onkeypress="if(event.key==='Enter') sendLocationMessage()">
            </div>
            <div class="emoji-add-actions">
                <button class="emoji-add-btn cancel" onclick="closeLocationModal()">取消</button>
                <button class="emoji-add-btn confirm" onclick="sendLocationMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- 语音输入弹窗 -->
    <div class="emoji-add-modal" id="voiceModal" onclick="if(event.target===this) closeVoiceModal()">
        <div class="emoji-add-content">
            <div class="emoji-add-title">语音输入</div>
            <div class="emoji-add-field">
                <label class="emoji-add-label">文字输入语音内容</label>
                <textarea class="emoji-add-input" id="voiceTextInput" placeholder="输入语音转文字内容..." style="min-height: 60px; resize: vertical;"></textarea>
            </div>
            <div class="emoji-add-field" style="text-align: center;">
                <button class="emoji-add-upload-btn" id="voiceRecordBtn" onclick="startVoiceRecording()" style="width: 100%;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    开始录音
                </button>
                <div id="voiceRecordingStatus" style="margin-top: 10px; color: var(--deep-pink); display: none;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #ff4d4f; border-radius: 50%; animation: pulse 1s infinite;"></div>
                        <span>正在录音中...</span>
                    </div>
                </div>
            </div>
            <div class="emoji-add-actions">
                <button class="emoji-add-btn cancel" onclick="closeVoiceModal()">取消</button>
                <button class="emoji-add-btn confirm" onclick="sendVoiceMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- 饿美了外卖页面 -->
    <div class="food-delivery-page" id="foodDeliveryPage">
        <div class="page-header">
            <div class="back-btn" onclick="closeFoodDeliveryPage()">
                ←
            </div>
            <div class="page-title">饿美了外卖</div>
            <div class="page-action-btn" onclick="openFoodProfile()" style="font-size: 20px; cursor: pointer; color: var(--deep-pink); width: 30px; display: flex; justify-content: center;">🧾</div>
        </div>
        
        <div class="food-delivery-content">
            <!-- 优惠券区域 -->
            <div class="coupon-banner" onclick="openCouponModal()">
                <div class="coupon-text">
                    <div class="coupon-title">天天神券</div>
                    <div class="coupon-desc" id="couponDesc">点击抽取今日外卖红包</div>
                </div>
                <div class="coupon-icon">🧧</div>
            </div>
            
            <!-- 商家列表 -->
            <div class="restaurant-list">
                <div class="restaurant-section-title">附近优选</div>
                <div id="storeList">
                    <!-- 炸鸡店 -->
                    <div class="store-item" onclick="openStore('chicken')">
                        <div class="store-img">🍗</div>
                        <div class="store-info">
                            <div class="store-name">肯打鸡炸鸡店</div>
                            <div class="store-desc">酥脆多汁，快乐源泉</div>
                            <div class="store-tags">
                                <span class="store-tag">免配送费</span>
                                <span class="store-tag">4.8分</span>
                            </div>
                        </div>
                    </div>
                    <!-- 奶茶店 -->
                    <div class="store-item" onclick="openStore('tea')">
                        <div class="store-img">🧋</div>
                        <div class="store-info">
                            <div class="store-name">蜜雪冰城甜蜜蜜</div>
                            <div class="store-desc">你爱我，我爱你，蜜雪冰城甜蜜蜜</div>
                            <div class="store-tags">
                                <span class="store-tag">人均¥10</span>
                                <span class="store-tag">4.9分</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部购物车栏 (主页不显示，进店显示) -->
    </div>

    <!-- 店铺详情页 -->
    <div class="store-page" id="storePage">
        <div class="store-header" id="storeHeader">
            <div class="back-btn-white" onclick="closeStorePage()">←</div>
            <div class="store-header-content">
                <div class="store-header-img" id="storeHeaderImg">🍗</div>
                <div class="store-header-info">
                    <div class="store-header-name" id="storeHeaderName">店铺名称</div>
                    <div class="store-header-desc" id="storeHeaderDesc">店铺描述</div>
                </div>
            </div>
        </div>
        
        <div class="store-menu" id="storeMenu">
            <!-- 菜单列表 -->
        </div>
        
        <!-- 店铺购物车栏 -->
        <div class="food-cart-bar">
            <div class="cart-info">
                <div class="cart-icon">🛒 <span id="cartCount" class="cart-count">0</span></div>
                <div class="cart-price">¥<span id="cartTotal">0</span></div>
            </div>
            <div class="cart-actions">
                <button class="cart-btn secondary" onclick="showOrderForRoleModal()">给TA点</button>
                <button class="cart-btn secondary" onclick="showAskPayModal()">让TA付</button>
                <button class="cart-btn primary" onclick="selfPay()">去支付</button>
            </div>
        </div>
    </div>

    <!-- 我的外卖档案弹窗 (优惠券和订单) -->
    <div class="modal-overlay" id="foodProfileModal" onclick="closeFoodProfile()">
        <div class="modal-content" onclick="event.stopPropagation()" style="height: 60%; display: flex; flex-direction: column;">
            <div class="modal-title">我的外卖</div>
            <div class="wechat-tabbar" style="position: static; border-top: none; border-bottom: 1px solid #eee; height: 40px; padding: 0;">
                <div class="wechat-tab-item active" id="couponTab" onclick="switchFoodProfileTab('coupon')" style="flex: 1; height: 100%;">
                    <div class="wechat-tab-label" style="margin: 0; font-size: 14px;">红包卡券</div>
                </div>
                <div class="wechat-tab-item" id="orderTab" onclick="switchFoodProfileTab('order')" style="flex: 1; height: 100%;">
                    <div class="wechat-tab-label" style="margin: 0; font-size: 14px;">历史订单</div>
                </div>
            </div>
            <div class="food-profile-content" style="flex: 1; overflow-y: auto; padding: 15px; background: #f5f5f5;">
                <div id="couponList" class="profile-list-section">
                    <!-- 优惠券列表 -->
                </div>
                <div id="orderList" class="profile-list-section" style="display: none;">
                    <!-- 订单列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 确认订单弹窗 -->
    <div class="modal-overlay" id="orderConfirmModal" onclick="closeOrderConfirmModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 320px;">
            <div class="modal-title" id="orderConfirmTitle">确认订单</div>
            
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; max-height: 150px; overflow-y: auto;">
                <div id="orderConfirmItems" style="font-size: 14px; color: #333; line-height: 1.6;">
                    <!-- 订单项 -->
                </div>
                <div style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between; font-weight: bold;">
                    <span>小计</span>
                    <span id="orderConfirmSubtotal">¥0.00</span>
                </div>
            </div>
            
            <div class="form-group">
                <label style="font-size: 14px; color: #666; margin-bottom: 5px;">优惠券</label>
                <select id="couponSelector" onchange="updateOrderFinalPrice()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; color: #333; outline: none;">
                    <!-- 优惠券选项 -->
                </select>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 16px;">
                <span>实付金额:</span>
                <span id="orderConfirmTotal" style="font-size: 20px; font-weight: bold; color: #ff4d4f;">¥0.00</span>
            </div>
            
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeOrderConfirmModal()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="executeOrderPayment()">确认支付</button>
            </div>
        </div>
    </div>

    <!-- 领券弹窗 -->
    <div class="modal-overlay" id="couponModal" onclick="closeCouponModal()">
        <div class="coupon-modal-content" onclick="event.stopPropagation()">
            <div class="coupon-modal-header">
                <div class="coupon-modal-title">惊喜红包，最高优惠288元</div>
                <div class="close-coupon" onclick="closeCouponModal()">×</div>
            </div>
            <div class="coupon-cards-container">
                <div class="coupon-card-item">
                    <div class="coupon-card-icon">?</div>
                    <div class="coupon-card-text">美食红包</div>
                </div>
                <div class="coupon-card-item">
                    <div class="coupon-card-icon">?</div>
                    <div class="coupon-card-text">超市红包</div>
                </div>
                <div class="coupon-card-item">
                    <div class="coupon-card-icon">?</div>
                    <div class="coupon-card-text">饮品红包</div>
                </div>
            </div>
            <button class="draw-btn" onclick="drawDailyCoupon()" id="drawBtn">立即领取</button>
            <div class="draw-tip">每天限领一次，随机获得惊喜满减红包</div>
        </div>
    </div>

    <!-- 选人弹窗 (复用) -->
    <div class="modal-overlay" id="roleSelectorModal" onclick="closeRoleSelectorModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" id="roleSelectorTitle">选择角色</div>
            <div class="modal-options" id="roleSelectorList">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 设置页面 -->
    <div class="settings-page" id="settingsPage">
        <div class="page-header">
            <div class="back-btn" onclick="closeSettingsPage()">
                ←
            </div>
            <div class="page-title">系统设置</div>
        </div>
        
        <div class="settings-content">
            <!-- API设置折叠面板 -->
            <div class="collapse-panel expanded" id="apiSettingsPanel">
                <div class="collapse-header" onclick="toggleApiSettings()">
                    <div class="collapse-title">
                        <span>🔌</span> API 设置
                    </div>
                    <div class="collapse-icon">▼</div>
                </div>
                <div class="collapse-content">
                    <!-- 主API设置 -->
                    <div class="settings-section">
                        <div class="section-title">主API设置</div>
                        
                        <!-- 反代地址输入框 -->
                        <div class="settings-item">
                            <label class="settings-label">反代地址</label>
                            <input type="text" class="settings-input" id="openaiApiUrl" placeholder="例如：https://api.openai.com" value="https://api.openai.com/v1/chat/completions" onblur="autoCompleteApiUrl()">
                            <div style="font-size: 11px; color: var(--text-color); margin-top: 4px; opacity: 0.8; line-height: 1.4;">
                                提示：仅需输入基础域名（如 https://api.openai.com），系统会自动补全接口路径（/v1/chat/completions）
                            </div>
                        </div>
                        
                        <!-- API密钥输入框 -->
                        <div class="settings-item">
                            <label class="settings-label">API 密钥</label>
                            <div class="password-toggle">
                                <input type="password" class="settings-input" id="openaiApiKey" placeholder="输入 API 密钥（如：sk-...）">
                                <button class="toggle-password" onclick="togglePasswordVisibility('openaiApiKey', this)">显示</button>
                            </div>
                        </div>
                        
                        <!-- 模型下拉选择框 -->
                        <div class="settings-item">
                            <label class="settings-label">模型选择</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select class="settings-input" id="openaiModel" style="flex: 1;">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4o">GPT-4o</option>
                            </select>
                                <button class="test-btn" id="fetchModelsBtn" onclick="fetchModels(event)" style="margin: 0; padding: 8px 16px; white-space: nowrap;">拉取模型</button>
                            </div>
                        </div>
                        
                        <!-- 测试连接按钮和结果显示 -->
                        <div class="settings-item">
                            <button class="test-btn" id="testConnectionBtn" onclick="testApiConnection()" style="width: 100%; margin-top: 10px;">
                                <span id="testConnectionBtnText">测试连接</span>
                            </button>
                            <div id="apiConnectionResult" style="margin-top: 12px; font-size: 12px; min-height: 20px; line-height: 1.5;"></div>
                        </div>
                        
                        <div class="settings-item">
                            <label class="settings-label">API 温度 (Temperature)</label>
                            <input type="range" class="settings-input" id="openaiTemperature" min="0" max="2" step="0.1" value="0.8" oninput="updateTemperatureDisplay(this.value)">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-color); margin-top: 5px;">
                                <span>0 (保守)</span>
                                <span id="temperatureValue" style="color: var(--deep-pink); font-weight: 500;">0.8</span>
                                <span>2 (创意)</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <label class="settings-label">测试消息</label>
                            <input type="text" class="settings-input" id="openaiTestMessage" placeholder="输入测试消息" value="你好，请简单介绍一下你自己">
                        </div>
                        
                        <div class="settings-item">
                            <button class="test-btn" onclick="testOpenAI()">测试 OpenAI API 连接</button>
                        </div>
                        
                        <div class="api-test-result" id="openaiTestResult"></div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">API 设置说明</div>
                        <div class="settings-item">
                            <p style="font-size: 13px; color: var(--text-color); line-height: 1.5; margin: 0;">
                                1. OpenAI API: 需要有效的 OpenAI API 密钥，可以从 <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--deep-pink);">OpenAI 平台</a> 获取<br>
                                2. API 密钥将保存在本地浏览器中，不会发送到其他服务器<br>
                                3. 建议定期更新 API 密钥以确保安全
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 系统设置折叠面板 -->
            <div class="collapse-panel" id="systemSettingsPanel">
                <div class="collapse-header" onclick="toggleSystemSettings()">
                    <div class="collapse-title">
                        <span>⚙️</span> 系统设置
                    </div>
                    <div class="collapse-icon">▼</div>
                </div>
                <div class="collapse-content">
                    <div class="settings-section">
                        <div class="section-title">主题设置</div>
                        
                        <div class="settings-item">
                            <label class="settings-label">选择主题颜色</label>
                            <select class="settings-input" id="themeColor">
                                <option value="pink">粉色调</option>
                                <option value="blue">蓝色调</option>
                                <option value="green">绿色调</option>
                                <option value="purple">紫色调</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">桌面布局</div>
                        
                        <div class="settings-item">
                            <label class="settings-label">图标排列</label>
                            <select class="settings-input" id="iconLayout">
                                <option value="grid">网格布局</option>
                                <option value="list">列表布局</option>
                                <option value="free">自由布局</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">其他设置</div>
                        
                        <div class="settings-item">
                            <label class="settings-label">开启桌面通知</label>
                            <select class="settings-input" id="notifications">
                                <option value="enabled">开启</option>
                                <option value="disabled">关闭</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">后台通知与保活</div>
                        
                        <div class="settings-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <label style="margin-bottom: 0; flex: 1;">
                                <div class="settings-label">后台通知与保活</div>
                                <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                    开启后，当页面切到后台时将通过静音音频和心跳保持运行，并发送通知。需要浏览器授权通知权限。
                                </p>
                            </label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notification-permission-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div id="notification-status-display" style="display: none;">
                            <div id="notification-status-text">通知状态：未授权</div>
                            <div class="notification-buttons">
                                <button id="notification-request-btn" class="notification-btn notification-btn-primary" style="display: none;">开启通知</button>
                                <button id="notification-test-btn" class="notification-btn notification-btn-test" style="display: none;">测试通知</button>
                                <button id="notification-background-test-btn" class="notification-btn notification-btn-bg-test" style="display: none;">🔒 测试后台通知（10秒）</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="save-all-btn" onclick="saveSystemSettings()">保存系统设置</button>
        </div>
    </div>

<script>
    // ==========================================
    // Dexie 数据库初始化
    // ==========================================
    const db = new Dexie('YaYaWorldbookDB');
    db.version(1).stores({
        worldbooks: 'id, name, scope, enabled, createdAt',
        favorites: '++id, friendName, title, content, summaryType, messageCount, createdAt'
    });

    // 全局变量
    let isCustomTime = false;
    let customDate = '';
    let customTime = '';
    let customPeriod = '';
    let customTip = 'A小猫咪：丢失请联系主人电话，捡到有小零食奖励哦～';
    // 从本地存储读取已保存的城市名和API设置
    let savedCity = localStorage.getItem('savedCity') || '';
    let savedOpenAIUrl = localStorage.getItem('openaiApiUrl') || 'https://api.openai.com/v1/chat/completions';
    let savedOpenAIKey = localStorage.getItem('openaiApiKey') || '';
    let savedOpenAIModel = localStorage.getItem('openaiModel') || 'gpt-3.5-turbo';
    let savedTemperature = parseFloat(localStorage.getItem('openaiTemperature')) || 0.8;
    let currentPersona = null; // 当前选择的我的人设

    // 页面加载完成后执行
    window.onload = function() {
        // 1. 初始化时间和提示文字
        updateWidgetTime();
        document.getElementById('tipInput').value = customTip;
        
        // 2. 初始化API设置
        document.getElementById('openaiApiUrl').value = savedOpenAIUrl;
        document.getElementById('openaiApiKey').value = savedOpenAIKey;
        document.getElementById('openaiModel').value = savedOpenAIModel;
        document.getElementById('openaiTemperature').value = savedTemperature;
        document.getElementById('temperatureValue').textContent = savedTemperature;
        
        // 加载我的人设
        loadMyPersona();
        
        // 3. 初始化天气系统 (自动定位或使用保存城市)
        if (savedCity) document.getElementById('cityInput').value = savedCity;
        initWeatherSystem();
        
        // 4. 初始化好友列表
        renderFriendList();
        
        // 4.5. 初始化世界书列表
        renderWorldbookList();
        
        // 5. 启动时间自动更新
        setInterval(updateWidgetTime, 60000);
        
        // 6. 启动天气自动更新 (60分钟)
        setInterval(autoUpdateWeather, 3600000);

        // 初始化页面显示状态
        const mePage = document.getElementById('mePage');
        const wechatPage = document.getElementById('wechatPage');
        const friendList = document.getElementById('friendList');
        
        if (mePage) mePage.classList.remove('active');
        if (wechatPage) wechatPage.classList.remove('active');
        if (friendList) friendList.style.display = 'block';
    }

    // 时间更新函数
    function updateWidgetTime() {
        if (isCustomTime && customDate && customTime && customPeriod) {
            document.getElementById('showDate').textContent = customDate;
            document.getElementById('showTime').childNodes[0].textContent = customTime;
            document.getElementById('showPeriod').textContent = customPeriod;
        } else {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const year = now.getFullYear();
            const dateStr = `${month}/${day}/${year}`;
            
            let hours = now.getHours();
            const period = hours >= 12 ? '下午' : '上午';
            hours = hours % 12 || 12;
            hours = String(hours).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;

            document.getElementById('showDate').textContent = dateStr;
            document.getElementById('showTime').childNodes[0].textContent = timeStr;
            document.getElementById('showPeriod').textContent = period;

            if (!isCustomTime) {
                document.getElementById('dateInput').value = dateStr;
                document.getElementById('timeInput').value = timeStr;
                document.getElementById('periodInput').value = period;
            }
        }
        document.getElementById('showTip').textContent = customTip;
    }

    // 打开APP模拟
    function openApp(name) {
        if(name === 'WeChat') {
            document.getElementById('desktop').classList.add('hidden');
            document.getElementById('wechatPage').classList.add('active');
            // 确保打开微信时显示好友列表，隐藏"我"页面
            const friendList = document.getElementById('friendList');
            const mePage = document.getElementById('mePage');
            if (friendList) friendList.style.display = 'block';
            if (mePage) mePage.classList.remove('active');
            // 切换到微信Tab
            switchWeChatTab(0);
        } else if(name === '世界书') {
            document.getElementById('desktop').classList.add('hidden');
            document.getElementById('worldbookPage').classList.add('active');
            renderWorldbookList(); // 异步函数，会自动执行
        } else if(name === '网易云') {
            document.getElementById('desktop').classList.add('hidden');
            document.getElementById('musicAppPage').classList.add('active');
            document.getElementById('wyyMainPage').classList.add('active');
            document.getElementById('wyyPlayerPage').classList.remove('active');
        } else if(name === 'TikTok') {
            alert('即将打开 TikTok 应用...');
        } else {
            alert(`即将打开 ${name} 应用...`);
        }
    }

    // ============================================
    // WeChat 微信模块 - 核心功能函数
    // ============================================

    // 通用关闭APP函数
    function closeApp(pageId) {
        document.getElementById('desktop').classList.remove('hidden');
        document.getElementById(pageId).classList.remove('active');
    }

    // 打开收藏页面
    function openFavoritesPage() {
        document.getElementById('desktop').classList.add('hidden');
        document.getElementById('favoritesPage').classList.add('active');
        renderFavoritesList();
    }

    // ========== 好友列表管理 ==========
    
    /**
     * 获取好友列表
     * @returns {Array} 好友列表数组
     */
    function getFriendList() {
        const friends = localStorage.getItem('wechatFriends');
        return friends ? JSON.parse(friends) : [];
    }

    /**
     * 保存好友列表到本地存储
     * @param {Array} friends - 好友列表数组
     */
    function saveFriendList(friends) {
        localStorage.setItem('wechatFriends', JSON.stringify(friends));
    }

    /**
     * 添加好友到列表
     * @param {string} name - 好友名称
     */
    function addFriendToList(name) {
        const friends = getFriendList();
        // 检查是否已存在
        if (!friends.find(f => f.name === name)) {
            friends.push({
                name: name,
                remark: name, // 默认备注为名字
                id: name.toLowerCase().replace(/\s/g, '') + '001',
                avatar: '',
                persona: '',
                lastMessage: '你好！很高兴认识你～',
                lastTime: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
            });
            saveFriendList(friends);
            renderFriendList();
        }
    }

    /**
     * 渲染好友列表到页面
     * 如果好友列表为空，显示提示信息
     */
    function renderFriendList() {
        const friends = getFriendList();
        const list = document.getElementById('friendList');
        
        if (!list) {
            console.warn('friendList element not found');
            return;
        }
        
        if (friends.length === 0) {
            list.innerHTML = '<div style="padding: 40px 20px; text-align: center; color: var(--text-color);">暂无好友<br>点击右上角 + 添加好友</div>';
            return;
        }
        
        list.innerHTML = friends.map(friend => {
            const displayName = friend.remark || friend.name;
            const avatarContent = friend.avatar 
                ? `<img src="${friend.avatar}" alt="" style="width:100%;height:100%;object-fit:cover;">`
                : friend.name.charAt(0);
            return `
            <li class="friend-item" onclick="openChatPage('${friend.name}')">
                <div class="friend-avatar">${avatarContent}</div>
                <div class="friend-info">
                    <div class="friend-name">${displayName}</div>
                    <div class="friend-preview">${friend.lastMessage}</div>
                </div>
            </li>
        `;
        }).join('');
    }

    /**
     * 更新好友的最后一条消息
     * @param {string} name - 好友名称
     * @param {string} message - 消息内容
     */
    function updateFriendLastMessage(name, message) {
        const friends = getFriendList();
        const friend = friends.find(f => f.name === name);
        if (friend) {
            friend.lastMessage = message;
            friend.lastTime = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            saveFriendList(friends);
            renderFriendList();
        }
    }

    // ========== 标签管理 ==========
    
    /**
     * 获取所有标签列表（包含标签信息和关联的角色）
     * @returns {Array} 标签数组，每个标签包含 {name: string, friends: string[]}
     */
    function getTags() {
        const tags = localStorage.getItem('wechatTags');
        if (!tags) return [];
        const parsed = JSON.parse(tags);
        // 兼容旧格式（只有字符串数组）
        if (parsed.length > 0 && typeof parsed[0] === 'string') {
            return parsed.map(name => ({ name, friends: [] }));
        }
        return parsed;
    }
    
    /**
     * 保存标签列表
     * @param {Array} tags - 标签数组
     */
    function saveTags(tags) {
        localStorage.setItem('wechatTags', JSON.stringify(tags));
    }
    
    /**
     * 添加标签
     * @param {string} tagName - 标签名称
     */
    function addTag(tagName) {
        const tags = getTags();
        if (!tags.find(t => t.name === tagName) && tagName.trim()) {
            tags.push({ name: tagName.trim(), friends: [] });
            saveTags(tags);
        }
    }
    
    /**
     * 更新标签关联的角色
     * @param {string} tagName - 标签名称
     * @param {Array} friendNames - 角色名称数组
     */
    function updateTagFriends(tagName, friendNames) {
        const tags = getTags();
        const tag = tags.find(t => t.name === tagName);
        if (tag) {
            tag.friends = friendNames || [];
            saveTags(tags);
            
            // 更新好友的标签
            const friends = getFriendList();
            friends.forEach(friend => {
                // 如果好友在这个标签的角色列表中，自动设置标签
                if (friendNames.includes(friend.name)) {
                    friend.tag = tagName;
                } else if (friend.tag === tagName) {
                    // 如果好友不在列表中但标签是这个，清除标签
                    friend.tag = '';
                }
            });
            saveFriendList(friends);
        }
    }
    
    /**
     * 删除标签
     * @param {string} tagName - 标签名称
     */
    function deleteTag(tagName) {
        const tags = getTags();
        const index = tags.findIndex(t => t.name === tagName);
        if (index > -1) {
            tags.splice(index, 1);
            saveTags(tags);
            
            // 清除使用该标签的好友的标签
            const friends = getFriendList();
            friends.forEach(friend => {
                if (friend.tag === tagName) {
                    friend.tag = '';
                }
            });
            saveFriendList(friends);
        }
    }
    
    // ========== 世界书管理 ==========
    
    /**
     * 获取所有世界书列表
     * @returns {Promise<Array>} 世界书数组
     */
    async function getWorldbooks() {
        try {
            const worldbooks = await db.worldbooks.toArray();
            // 迁移旧数据（从 localStorage）
            const oldData = localStorage.getItem('worldbooks');
            if (oldData && worldbooks.length === 0) {
                try {
                    const parsed = JSON.parse(oldData);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        await db.worldbooks.bulkAdd(parsed);
                        localStorage.removeItem('worldbooks'); // 迁移后删除旧数据
                        return await db.worldbooks.toArray();
                    }
                } catch (e) {
                    console.error('迁移世界书数据失败:', e);
                }
            }
            return worldbooks || [];
        } catch (e) {
            console.error('获取世界书列表失败:', e);
            return [];
        }
    }
    
    /**
     * 保存世界书（单个）
     * @param {Object} worldbook - 世界书对象
     */
    async function saveWorldbook(worldbook) {
        try {
            await db.worldbooks.put(worldbook);
        } catch (e) {
            console.error('保存世界书失败:', e);
            throw e;
        }
    }
    
    /**
     * 删除世界书
     * @param {string} worldbookId - 世界书ID
     */
    async function deleteWorldbookById(worldbookId) {
        try {
            await db.worldbooks.delete(worldbookId);
        } catch (e) {
            console.error('删除世界书失败:', e);
            throw e;
        }
    }
    
    /**
     * 获取全局世界书（scope为global的世界书）
     * @returns {Promise<Object|null>} 全局世界书对象
     */
    async function getGlobalWorldbook() {
        try {
            const worldbook = await db.worldbooks
                .where('scope').equals('global')
                .and(wb => wb.enabled === true)
                .first();
            return worldbook || null;
        } catch (e) {
            console.error('获取全局世界书失败:', e);
            return null;
        }
    }
    
    /**
     * 获取指定角色的世界书（通过角色的 worldbookId）
     * @param {string} friendName - 角色名称
     * @returns {Promise<Object|null>} 世界书对象
     */
    async function getWorldbookForFriend(friendName) {
        try {
            const friends = getFriendList();
            const friend = friends.find(f => f.name === friendName);
            if (!friend || !friend.worldbookId) {
                return null;
            }
            
            const worldbook = await db.worldbooks.get(friend.worldbookId);
            if (worldbook && worldbook.scope === 'single' && worldbook.enabled) {
                return worldbook;
            }
            return null;
        } catch (e) {
            console.error('获取角色世界书失败:', e);
            return null;
        }
    }
    
    /**
     * 获取聊天时应该使用的世界书内容
     * @param {string} friendName - 角色名称
     * @returns {Promise<string>} 世界书内容，如果没有则返回空字符串
     */
    async function getWorldbookContentForChat(friendName) {
        try {
            // 优先使用全局世界书
            const globalWorldbook = await getGlobalWorldbook();
            if (globalWorldbook) {
                return globalWorldbook.content || '';
            }
            
            // 如果没有全局世界书，使用单聊世界书
            const singleWorldbook = await getWorldbookForFriend(friendName);
            if (singleWorldbook) {
                return singleWorldbook.content || '';
            }
            
            return '';
        } catch (e) {
            console.error('获取世界书内容失败:', e);
            return '';
        }
    }
    
    /**
     * 显示添加世界书弹窗
     * @param {Object} worldbook - 可选，要编辑的世界书对象
     */
    async function showAddWorldbookModal(worldbook = null) {
        const modal = document.getElementById('worldbookModal');
        const title = document.getElementById('worldbookModalTitle');
        const nameInput = document.getElementById('worldbookNameInput');
        const contentInput = document.getElementById('worldbookContentInput');
        const scopeGlobal = document.getElementById('worldbookScopeGlobal');
        const scopeSingle = document.getElementById('worldbookScopeSingle');
        
        if (worldbook) {
            // 编辑模式
            title.textContent = '编辑世界书';
            nameInput.value = worldbook.name || '';
            contentInput.value = worldbook.content || '';
            if (worldbook.scope === 'global') {
                scopeGlobal.checked = true;
            } else {
                scopeSingle.checked = true;
            }
            window.currentEditingWorldbookId = worldbook.id;
        } else {
            // 新建模式
            title.textContent = '添加世界书';
            nameInput.value = '';
            contentInput.value = '';
            scopeSingle.checked = true;
            scopeGlobal.checked = false;
            window.currentEditingWorldbookId = null;
        }
        
        modal.classList.add('active');
    }
    
    /**
     * 渲染世界书好友选择列表
     */
    async function renderWorldbookFriendsList() {
        const friendsList = document.getElementById('worldbookFriendsList');
        const friends = getFriendList();
        
        if (friends.length === 0) {
            friendsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暂无好友</div>';
            return;
        }
        
        let checkedFriends = [];
        if (window.currentEditingWorldbookId) {
            try {
                const worldbook = await db.worldbooks.get(window.currentEditingWorldbookId);
                checkedFriends = worldbook && worldbook.friends ? worldbook.friends : [];
            } catch (e) {
                console.error('获取世界书失败:', e);
            }
        }
        
        friendsList.innerHTML = friends.map(friend => {
            const checked = checkedFriends.includes(friend.name);
            return `
                <label style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                    <input type="checkbox" value="${friend.name}" ${checked ? 'checked' : ''} style="margin-right: 10px;">
                    <span>${friend.remark || friend.name}</span>
                </label>
            `;
        }).join('');
    }
    
    /**
     * 保存世界书
     */
    async function saveWorldbook() {
        const nameInput = document.getElementById('worldbookNameInput');
        const contentInput = document.getElementById('worldbookContentInput');
        const scopeGlobal = document.getElementById('worldbookScopeGlobal');
        const friendsList = document.getElementById('worldbookFriendsList');
        
        const name = nameInput.value.trim();
        const content = contentInput.value.trim();
        const scope = scopeGlobal.checked ? 'global' : 'single';
        
        if (!name) {
            alert('请输入世界书名称');
            return;
        }
        
        if (!content) {
            alert('请输入世界观内容');
            return;
        }
        
        try {
            if (window.currentEditingWorldbookId) {
                // 编辑模式
                const existing = await db.worldbooks.get(window.currentEditingWorldbookId);
                if (existing) {
                    await db.worldbooks.update(window.currentEditingWorldbookId, {
                        name,
                        content,
                        scope
                    });
                }
            } else {
                // 新建模式
                const newWorldbook = {
                    id: Date.now().toString(),
                    name,
                    content,
                    scope,
                    enabled: true,
                    createdAt: new Date().toISOString()
                };
                await db.worldbooks.add(newWorldbook);
            }
            
            closeWorldbookModal();
            await renderWorldbookList();
        } catch (e) {
            console.error('保存世界书失败:', e);
            alert('保存失败，请重试');
        }
    }
    
    /**
     * 关闭世界书弹窗
     */
    function closeWorldbookModal() {
        const modal = document.getElementById('worldbookModal');
        modal.classList.remove('active');
        window.currentEditingWorldbookId = null;
    }
    
    /**
     * 渲染世界书列表
     */
    async function renderWorldbookList() {
        const list = document.getElementById('worldbookList');
        if (!list) return;
        
        try {
            const worldbooks = await getWorldbooks();
            
            if (worldbooks.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📖</div>
                        <div style="font-size: 16px; margin-bottom: 5px;">暂无世界书</div>
                        <div style="font-size: 14px;">点击右上角添加世界书</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = worldbooks.map(worldbook => {
                const scopeText = worldbook.scope === 'global' ? '全局' : '单聊';
                const enabledText = worldbook.enabled ? '已启用' : '已禁用';
                const enabledColor = worldbook.enabled ? '#4CAF50' : '#999';
                
                return `
                    <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">
                                    ${worldbook.name}
                                </div>
                                <div style="font-size: 12px; color: #999; margin-bottom: 5px;">
                                    ${scopeText} · <span style="color: ${enabledColor};">${enabledText}</span>
                                </div>
                                <div style="font-size: 13px; color: #666; line-height: 1.5; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                    ${worldbook.content.substring(0, 100)}${worldbook.content.length > 100 ? '...' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="toggleWorldbookEnabled('${worldbook.id}')" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #333; font-size: 14px; cursor: pointer;">
                                ${worldbook.enabled ? '禁用' : '启用'}
                            </button>
                            <button onclick="editWorldbook('${worldbook.id}')" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #333; font-size: 14px; cursor: pointer;">
                                编辑
                            </button>
                            <button onclick="deleteWorldbook('${worldbook.id}')" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #f44336; font-size: 14px; cursor: pointer;">
                                删除
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error('渲染世界书列表失败:', e);
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #f44336;">加载失败，请刷新页面</div>';
        }
    }
    
    /**
     * 切换世界书启用状态
     * @param {string} worldbookId - 世界书ID
     */
    async function toggleWorldbookEnabled(worldbookId) {
        try {
            const worldbook = await db.worldbooks.get(worldbookId);
            if (worldbook) {
                await db.worldbooks.update(worldbookId, { enabled: !worldbook.enabled });
                await renderWorldbookList();
            }
        } catch (e) {
            console.error('切换世界书状态失败:', e);
            alert('操作失败，请重试');
        }
    }
    
    /**
     * 编辑世界书
     * @param {string} worldbookId - 世界书ID
     */
    async function editWorldbook(worldbookId) {
        try {
            const worldbook = await db.worldbooks.get(worldbookId);
            if (worldbook) {
                await showAddWorldbookModal(worldbook);
            }
        } catch (e) {
            console.error('获取世界书失败:', e);
            alert('加载失败，请重试');
        }
    }
    
    /**
     * 删除世界书
     * @param {string} worldbookId - 世界书ID
     */
    async function deleteWorldbook(worldbookId) {
        if (!confirm('确定要删除这个世界书吗？')) return;
        
        try {
            await deleteWorldbookById(worldbookId);
            await renderWorldbookList();
        } catch (e) {
            console.error('删除世界书失败:', e);
            alert('删除失败，请重试');
        }
    }
    
    /**
     * 更新世界书显示
     */
    async function updateWorldbookDisplay(worldbookId) {
        const display = document.getElementById('currentWorldbookDisplay');
        if (!display) return;
        
        if (!worldbookId) {
            display.textContent = '未挂载世界书';
            display.style.color = '#999';
            return;
        }
        
        try {
            const worldbook = await db.worldbooks.get(worldbookId);
            if (worldbook) {
                display.textContent = `已挂载：${worldbook.name}`;
                display.style.color = '#4CAF50';
            } else {
                display.textContent = '世界书不存在';
                display.style.color = '#f44336';
            }
        } catch (e) {
            console.error('获取世界书失败:', e);
            display.textContent = '加载失败';
            display.style.color = '#f44336';
        }
    }
    
    /**
     * 显示世界书选择器（用于角色详细页面）
     */
    async function showWorldbookSelectorForFriend() {
        if (!currentChatFriend) return;
        
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentChatFriend);
        if (!friend) return;
        
        window.worldbookSelectorMode = 'friend';
        window.selectedWorldbookId = friend.worldbookId || null;
        await showWorldbookSelector();
    }
    
    /**
     * 显示世界书选择器
     */
    async function showWorldbookSelector() {
        const modal = document.getElementById('worldbookSelectorModal');
        const title = document.getElementById('worldbookSelectorTitle');
        const list = document.getElementById('worldbookSelectorList');
        
        if (window.worldbookSelectorMode === 'friend') {
            title.textContent = '选择世界书（单聊）';
        } else {
            title.textContent = '选择世界书';
        }
        
        try {
            const worldbooks = await getWorldbooks();
            const singleWorldbooks = worldbooks.filter(wb => wb.scope === 'single' && wb.enabled);
            
            if (singleWorldbooks.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div>暂无单聊世界书</div>
                        <div style="font-size: 12px; margin-top: 10px;">请先在世界书页面创建单聊世界书</div>
                    </div>
                `;
            } else {
                list.innerHTML = `
                    <label style="display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; background: ${!window.selectedWorldbookId ? '#f7f7f7' : 'white'};" onclick="selectWorldbookOption(null)">
                        <input type="radio" name="worldbookSelect" value="" ${!window.selectedWorldbookId ? 'checked' : ''} style="margin-right: 12px;">
                        <div>
                            <div style="font-size: 15px; color: #333;">不挂载</div>
                            <div style="font-size: 12px; color: #999; margin-top: 2px;">不使用世界书</div>
                        </div>
                    </label>
                    ${singleWorldbooks.map(wb => `
                        <label style="display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; background: ${window.selectedWorldbookId === wb.id ? '#f7f7f7' : 'white'};" onclick="selectWorldbookOption('${wb.id}')">
                            <input type="radio" name="worldbookSelect" value="${wb.id}" ${window.selectedWorldbookId === wb.id ? 'checked' : ''} style="margin-right: 12px;">
                            <div style="flex: 1;">
                                <div style="font-size: 15px; color: #333;">${wb.name}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 2px; max-height: 40px; overflow: hidden;">${wb.content.substring(0, 50)}${wb.content.length > 50 ? '...' : ''}</div>
                            </div>
                        </label>
                    `).join('')}
                `;
            }
            
            modal.classList.add('active');
        } catch (e) {
            console.error('加载世界书列表失败:', e);
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #f44336;">加载失败</div>';
        }
    }
    
    /**
     * 选择世界书选项
     */
    function selectWorldbookOption(worldbookId) {
        window.selectedWorldbookId = worldbookId;
        // 更新选中状态
        document.querySelectorAll('#worldbookSelectorList label').forEach(label => {
            const input = label.querySelector('input[type="radio"]');
            if (input.value === (worldbookId || '')) {
                label.style.background = '#f7f7f7';
                input.checked = true;
            } else {
                label.style.background = 'white';
                input.checked = false;
            }
        });
    }
    
    /**
     * 确认世界书选择
     */
    async function confirmWorldbookSelection() {
        if (window.worldbookSelectorMode === 'friend') {
            // 更新显示
            await updateWorldbookDisplay(window.selectedWorldbookId);
        }
        closeWorldbookSelector();
    }
    
    /**
     * 关闭世界书选择器
     */
    function closeWorldbookSelector() {
        const modal = document.getElementById('worldbookSelectorModal');
        modal.classList.remove('active');
        window.worldbookSelectorMode = null;
    }
    
    /**
     * 渲染通讯录页面
     * 包含：新朋友入口、标签分组显示好友
     */
    function renderContactsPage() {
        const content = document.getElementById('wechatContent');
        if (!content) return;
        
        // 清理旧内容
        const oldContent = content.querySelector('.contacts-container');
        if (oldContent) oldContent.remove();
        
        const contactsContainer = document.createElement('div');
        contactsContainer.className = 'contacts-container';
        contactsContainer.style.cssText = 'position: relative; width: 100%; height: 100%; overflow-y: auto; background: #f7f7f7; z-index: 1;';
        
        // 新朋友入口
        const newFriendItem = document.createElement('div');
        newFriendItem.style.cssText = 'display: flex; align-items: center; padding: 15px 20px; background: white; border-bottom: 1px solid #f0f0f0; cursor: pointer;';
        newFriendItem.onclick = showAddFriendModal;
        newFriendItem.innerHTML = `
            <div style="width: 40px; height: 40px; border-radius: 8px; background: #576b95; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: white; font-size: 20px; font-weight: bold;">+</div>
            <div style="flex: 1;">
                <div style="font-size: 16px; color: #333; font-weight: 500;">新的朋友</div>
            </div>
            <div style="color: #ccc;">→</div>
        `;
        contactsContainer.appendChild(newFriendItem);
        
        // 标签管理入口
        const tagsItem = document.createElement('div');
        tagsItem.style.cssText = 'display: flex; align-items: center; padding: 15px 20px; background: white; border-bottom: 1px solid #f0f0f0; cursor: pointer; margin-top: 10px;';
        tagsItem.onclick = showTagsManagerModal;
        tagsItem.innerHTML = `
            <div style="width: 40px; height: 40px; border-radius: 8px; background: #ff9800; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: white; font-size: 18px;">🏷️</div>
            <div style="flex: 1;">
                <div style="font-size: 16px; color: #333; font-weight: 500;">标签</div>
            </div>
            <div style="color: #ccc;">→</div>
        `;
        contactsContainer.appendChild(tagsItem);
        
        // 获取好友列表
        const friends = getFriendList();
        const tags = getTags();
        
        if (friends.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.style.cssText = 'padding: 40px 20px; text-align: center; color: #999; font-size: 14px; margin-top: 20px;';
            emptyDiv.textContent = '暂无好友，点击"新的朋友"添加';
            contactsContainer.appendChild(emptyDiv);
        } else {
            // 按标签分组
            const friendsByTag = {};
            const untaggedFriends = [];
            
            friends.forEach(friend => {
                // 检查好友是否属于某个标签（通过标签的角色列表）
                let foundTag = null;
                tags.forEach(tag => {
                    const tagName = typeof tag === 'string' ? tag : tag.name;
                    const tagFriends = typeof tag === 'object' && tag.friends ? tag.friends : [];
                    if (tagFriends.includes(friend.name)) {
                        foundTag = tagName;
                    }
                });
                
                // 如果好友有标签属性，也检查
                if (!foundTag && friend.tag) {
                    const tag = tags.find(t => {
                        const tName = typeof t === 'string' ? t : t.name;
                        return tName === friend.tag;
                    });
                    if (tag) {
                        foundTag = friend.tag;
                    }
                }
                
                if (foundTag) {
                    if (!friendsByTag[foundTag]) {
                        friendsByTag[foundTag] = [];
                    }
                    friendsByTag[foundTag].push(friend);
                } else {
                    untaggedFriends.push(friend);
                }
            });
            
            // 显示未分组好友
            if (untaggedFriends.length > 0) {
                const section = createContactsSection('', untaggedFriends);
                contactsContainer.appendChild(section);
            }
            
            // 显示标签分组
            tags.forEach(tag => {
                const tagName = typeof tag === 'string' ? tag : tag.name;
                if (friendsByTag[tagName] && friendsByTag[tagName].length > 0) {
                    const section = createContactsSection(tagName, friendsByTag[tagName]);
                    contactsContainer.appendChild(section);
                }
            });
        }
        
        content.appendChild(contactsContainer);
    }
    
    /**
     * 创建通讯录分组
     * @param {string} tagName - 标签名称（空字符串表示未分组）
     * @param {Array} friends - 好友列表
     * @returns {HTMLElement} 分组元素
     */
    function createContactsSection(tagName, friends) {
        const section = document.createElement('div');
        section.style.cssText = 'margin-top: 10px; background: white;';
        
        // 分组标题
        if (tagName) {
            const header = document.createElement('div');
            header.style.cssText = 'padding: 8px 20px; background: #f7f7f7; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;';
            header.textContent = tagName;
            section.appendChild(header);
        }
        
        // 好友列表
        friends.forEach((friend, index) => {
            const friendItem = document.createElement('div');
            friendItem.style.cssText = 'display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer;';
            friendItem.onclick = () => openChatPage(friend.name);
            
            const displayName = friend.remark || friend.name;
            const avatarContent = friend.avatar 
                ? `<img src="${friend.avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">` 
                : `<div style="width: 100%; height: 100%; background: #576b95; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 16px; font-weight: bold;">${displayName.charAt(0)}</div>`;
            
            friendItem.innerHTML = `
                <div style="width: 40px; height: 40px; border-radius: 4px; overflow: hidden; margin-right: 12px; flex-shrink: 0;">
                    ${avatarContent}
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #333; font-weight: 500;">${displayName}</div>
                </div>
                <div style="color: #ccc;">→</div>
            `;
            
            section.appendChild(friendItem);
        });
        
        return section;
    }
    
    /**
     * 显示标签管理弹窗
     */
    function showTagsManagerModal() {
        const overlay = document.getElementById('modalOverlay');
        const title = document.getElementById('modalTitle');
        const options = document.getElementById('modalOptions');
        
        title.textContent = '标签管理';
        
        const tags = getTags();
        let tagsHtml = '<div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">';
        
        if (tags.length === 0) {
            tagsHtml += '<div style="padding: 20px; text-align: center; color: #999;">暂无标签</div>';
        } else {
            tags.forEach(tag => {
                const tagName = typeof tag === 'string' ? tag : tag.name;
                const friendCount = typeof tag === 'object' && tag.friends ? tag.friends.length : 0;
                tagsHtml += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f0f0f0;">
                        <div style="flex: 1;">
                            <div style="font-size: 15px; color: #333; margin-bottom: 4px;">${tagName}</div>
                            <div style="font-size: 12px; color: #999;">${friendCount}个角色</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editTagFriends('${tagName}')" style="padding: 5px 15px; background: #576b95; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">选择角色</button>
                            <button onclick="deleteTagAndRefresh('${tagName}')" style="padding: 5px 15px; background: #ff3b30; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">删除</button>
                        </div>
                    </div>
                `;
            });
        }
        tagsHtml += '</div>';
        
        tagsHtml += `
            <input type="text" class="modal-input" id="newTagInput" placeholder="输入新标签名称" maxlength="10" style="margin-bottom: 15px;">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn modal-btn-primary" onclick="addTagAndRefresh()">添加标签</button>
            </div>
        `;
        
        options.innerHTML = tagsHtml;
        overlay.classList.add('active');
        
        // 聚焦输入框
        setTimeout(() => {
            const input = document.getElementById('newTagInput');
            if (input) input.focus();
        }, 100);
    }
    
    /**
     * 编辑标签关联的角色
     * @param {string} tagName - 标签名称
     */
    function editTagFriends(tagName) {
        const overlay = document.getElementById('modalOverlay');
        const title = document.getElementById('modalTitle');
        const options = document.getElementById('modalOptions');
        
        title.textContent = `选择角色 - ${tagName}`;
        
        const tags = getTags();
        const tag = tags.find(t => t.name === tagName);
        const selectedFriends = tag && tag.friends ? tag.friends : [];
        
        const friends = getFriendList();
        let friendsHtml = '<div style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">';
        
        if (friends.length === 0) {
            friendsHtml += '<div style="padding: 20px; text-align: center; color: #999;">暂无好友</div>';
        } else {
            friends.forEach(friend => {
                const isSelected = selectedFriends.includes(friend.name);
                friendsHtml += `
                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="toggleTagFriend('${tagName}', '${friend.name}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} style="margin-right: 12px; width: 18px; height: 18px;" onchange="toggleTagFriend('${tagName}', '${friend.name}')" onclick="event.stopPropagation()">
                        <div style="flex: 1;">
                            <div style="font-size: 15px; color: #333;">${friend.remark || friend.name}</div>
                        </div>
                    </div>
                `;
            });
        }
        friendsHtml += '</div>';
        
        friendsHtml += `
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="showTagsManagerModal()">返回</button>
                <button class="modal-btn modal-btn-primary" onclick="saveTagFriends('${tagName}')">保存</button>
            </div>
        `;
        
        options.innerHTML = friendsHtml;
    }
    
    // 临时存储当前编辑的标签的角色选择
    let currentTagEditState = {};
    
    /**
     * 切换标签的角色选择
     * @param {string} tagName - 标签名称
     * @param {string} friendName - 角色名称
     */
    function toggleTagFriend(tagName, friendName) {
        if (!currentTagEditState[tagName]) {
            const tags = getTags();
            const tag = tags.find(t => t.name === tagName);
            currentTagEditState[tagName] = tag && tag.friends ? [...tag.friends] : [];
        }
        
        const index = currentTagEditState[tagName].indexOf(friendName);
        if (index > -1) {
            currentTagEditState[tagName].splice(index, 1);
        } else {
            currentTagEditState[tagName].push(friendName);
        }
        
        // 更新复选框状态
        const checkbox = event.target.type === 'checkbox' ? event.target : event.target.querySelector('input[type="checkbox"]');
        if (checkbox) {
            checkbox.checked = currentTagEditState[tagName].includes(friendName);
        }
    }
    
    /**
     * 保存标签的角色选择
     * @param {string} tagName - 标签名称
     */
    function saveTagFriends(tagName) {
        if (currentTagEditState[tagName]) {
            updateTagFriends(tagName, currentTagEditState[tagName]);
            currentTagEditState[tagName] = null;
            showTagsManagerModal();
            renderContactsPage();
        }
    }
    
    /**
     * 添加标签并刷新
     */
    function addTagAndRefresh() {
        const input = document.getElementById('newTagInput');
        const tagName = input.value.trim();
        if (tagName) {
            addTag(tagName);
            closeModal();
            renderContactsPage();
        } else {
            alert('请输入标签名称');
        }
    }
    
    /**
     * 删除标签并刷新
     * @param {string} tagName - 标签名称
     */
    function deleteTagAndRefresh(tagName) {
        if (confirm(`确定要删除标签"${tagName}"吗？使用该标签的好友将变为未分组。`)) {
            deleteTag(tagName);
            showTagsManagerModal(); // 刷新标签管理页面
            renderContactsPage(); // 刷新通讯录页面
        }
    }

    /**
     * 删除消息后更新好友列表的最后一条消息
     * @param {string} friendName - 好友名称
     * @param {Array} remainingMessages - 剩余消息数组
     */
    function updateFriendLastMessageAfterDelete(friendName, remainingMessages) {
        if (!remainingMessages || remainingMessages.length === 0) {
            // 如果没有剩余消息，显示默认文本
            updateFriendLastMessage(friendName, '你好！很高兴认识你～');
            return;
        }
        
        // 获取最后一条消息
        const lastMessage = remainingMessages[remainingMessages.length - 1];
        
        // 提取消息文本
        let messageText = '';
        
        // 优先从 localStorage 中的消息数据提取
        if (lastMessage.redPacketData) {
            // 红包消息
            messageText = `[红包] ${lastMessage.redPacketData.note}`;
        } else if (lastMessage.voiceDuration !== null && lastMessage.voiceDuration !== undefined) {
            // 语音消息
            messageText = `[语音] ${lastMessage.voiceDuration}"`;
        } else if (lastMessage.imageUrl) {
            // 判断是否为表情消息（无文字内容且无描述）
            const isEmoji = !lastMessage.text && !lastMessage.imageDesc;
            
            if (isEmoji) {
                // 表情消息：显示为空文本或"[表情]"
                messageText = '[表情]';
            } else if (lastMessage.imageDesc) {
                // 普通图片消息，有描述
                messageText = `[图片] ${lastMessage.imageDesc}`;
            } else {
                // 普通图片消息，无描述
                messageText = '[图片]';
            }
        } else if (lastMessage.text) {
            // 纯文字消息
            messageText = lastMessage.text;
        } else {
            // 如果 localStorage 中没有文本，尝试从 DOM 中读取
            const messageElements = document.querySelectorAll('#chatMessages .chat-message');
            if (messageElements.length > 0) {
                const lastElement = messageElements[messageElements.length - 1];
                const bubble = lastElement.querySelector('.chat-bubble');
                if (bubble) {
                    // 检查是否是语音消息
                    const voiceEl = bubble.querySelector('.voice-message');
                    if (voiceEl) {
                        const duration = voiceEl.querySelector('.voice-duration');
                        if (duration) {
                            messageText = `[语音] ${duration.textContent}`;
                        } else {
                            messageText = '[语音]';
                        }
                    } else {
                        // 检查是否有图片
                        const img = bubble.querySelector('img');
                        if (img) {
                            const isEmoji = img.classList.contains('emoji-message');
                            if (isEmoji) {
                                messageText = '[表情]';
                            } else {
                                const descEl = bubble.querySelector('.image-desc');
                                if (descEl) {
                                    messageText = `[图片] ${descEl.textContent}`;
                                } else {
                                    messageText = '[图片]';
                                }
                            }
                        } else {
                            // 纯文字消息，提取文本内容（排除语音文字内容）
                            const textNodes = [];
                            bubble.childNodes.forEach(node => {
                                if (node.nodeType === 3) { // 文本节点
                                    textNodes.push(node.textContent);
                                } else if (node.nodeType === 1 && !node.classList.contains('voice-message') && !node.classList.contains('voice-text-content')) {
                                    textNodes.push(node.textContent);
                                }
                            });
                            messageText = textNodes.join('').trim();
                        }
                    }
                }
            }
            
            // 如果还是无法获取，使用默认文本
            if (!messageText) {
                messageText = '你好！很高兴认识你～';
            }
        }
        
        // 更新好友列表
        updateFriendLastMessage(friendName, messageText);
    }

    // ==========================================
    // 饿美了外卖功能
    // ==========================================
    
    // 打开饿美了页面
    function openFoodDeliveryPage() {
        document.getElementById('foodDeliveryPage').classList.add('active');
        document.getElementById('mePage').classList.remove('active');
        document.getElementById('wechatPage').classList.remove('active');
        // 初始化购物车显示
        updateCartDisplay();
    }
    
    // 关闭饿美了页面
    function closeFoodDeliveryPage() {
        document.getElementById('foodDeliveryPage').classList.remove('active');
        document.getElementById('mePage').classList.add('active');
        document.getElementById('wechatPage').classList.add('active');
    }
    
    // 优惠券相关
    function openCouponModal() {
        document.getElementById('couponModal').classList.add('active');
        checkDailyCouponStatus();
    }
    
    function closeCouponModal() {
        document.getElementById('couponModal').classList.remove('active');
    }
    
    function checkDailyCouponStatus() {
        const lastDrawDate = localStorage.getItem('lastCouponDrawDate');
        const today = new Date().toDateString();
        const btn = document.getElementById('drawBtn');
        
        if (lastDrawDate === today) {
            btn.disabled = true;
            btn.textContent = '今日已领取';
            btn.style.backgroundColor = '#ccc';
            btn.style.boxShadow = 'none';
        } else {
            btn.disabled = false;
            btn.textContent = '立即领取';
            btn.style.backgroundColor = '#ffd700';
            btn.style.boxShadow = '0 4px 0 #b8860b';
        }
    }
    
    function drawDailyCoupon() {
        const lastDrawDate = localStorage.getItem('lastCouponDrawDate');
        const today = new Date().toDateString();
        
        if (lastDrawDate === today) {
            alert('每天只能领取一次哦~');
            return;
        }
        
        // 5种优惠券，阈值型
        const couponsPool = [
            { title: '满30减5', desc: '满减红包', value: 5, min: 30, weight: 30, type: 'threshold' },
            { title: '满50减10', desc: '大额满减', value: 10, min: 50, weight: 25, type: 'threshold' },
            { title: '满20减3', desc: '小额红包', value: 3, min: 20, weight: 20, type: 'threshold' },
            { title: '满80减20', desc: '豪华红包', value: 20, min: 80, weight: 15, type: 'threshold' },
            { title: '满100减30', desc: '至尊红包', value: 30, min: 100, weight: 10, type: 'threshold' }
        ];
        
        // 抽取5张优惠券
        const drawnCoupons = [];
        const totalWeight = couponsPool.reduce((sum, coupon) => sum + coupon.weight, 0);
        
        for (let i = 0; i < 5; i++) {
            let random = Math.random() * totalWeight;
            let selected = couponsPool[0];
            let currentWeight = 0;
            for (const coupon of couponsPool) {
                currentWeight += coupon.weight;
                if (random < currentWeight) {
                    selected = coupon;
                    break;
                }
            }
            // 添加唯一ID
            drawnCoupons.push({ ...selected, id: Date.now() + i, status: 'unused', date: today });
        }
        
        // 保存到本地
        const myCoupons = getMyCoupons();
        myCoupons.push(...drawnCoupons);
        saveMyCoupons(myCoupons);

        localStorage.setItem('lastCouponDrawDate', today);
        document.getElementById('couponDesc').textContent = `今日已领：5张神券`;
        
        // 更新按钮状态
        checkDailyCouponStatus();
        
        // 模拟开奖动画 (显示5张)
        const cards = document.querySelectorAll('.coupon-card-item');
        // 为了演示效果，这里只修改现有的3个卡片为"点击查看详情"，实际数据已保存
        cards.forEach(card => card.style.transform = 'scaleY(0)');
        
        setTimeout(() => {
             cards.forEach((card, index) => {
                 setTimeout(() => {
                     card.style.transform = 'scaleY(1)';
                     card.querySelector('.coupon-card-icon').textContent = '🧧';
                     card.querySelector('.coupon-card-text').textContent = '点击查看';
                 }, index * 100);
             });
             
             setTimeout(() => {
                 alert(`恭喜获得 5 张神券！\n已放入红包卡券包，下单时可用。`);
                 closeCouponModal();
             }, 1000);
        }, 300);
    }
    
    // 获取我的优惠券
    function getMyCoupons() {
        return JSON.parse(localStorage.getItem('myFoodCoupons') || '[]');
    }
    
    function saveMyCoupons(coupons) {
        localStorage.setItem('myFoodCoupons', JSON.stringify(coupons));
    }

    // 获取我的订单
    function getMyOrders() {
        return JSON.parse(localStorage.getItem('myFoodOrders') || '[]');
    }

    function saveMyOrders(orders) {
        localStorage.setItem('myFoodOrders', JSON.stringify(orders));
    }

    // 外卖档案（优惠券/订单）
    function openFoodProfile() {
        document.getElementById('foodProfileModal').classList.add('active');
        switchFoodProfileTab('coupon');
    }

    function closeFoodProfile() {
        document.getElementById('foodProfileModal').classList.remove('active');
    }

    function switchFoodProfileTab(tab) {
        document.getElementById('couponTab').classList.toggle('active', tab === 'coupon');
        document.getElementById('orderTab').classList.toggle('active', tab === 'order');
        document.getElementById('couponList').style.display = tab === 'coupon' ? 'block' : 'none';
        document.getElementById('orderList').style.display = tab === 'order' ? 'block' : 'none';
        
        if (tab === 'coupon') {
            renderCouponList();
        } else {
            renderOrderList();
        }
    }

    function renderCouponList() {
        const coupons = getMyCoupons().filter(c => c.status === 'unused');
        const list = document.getElementById('couponList');
        
        if (coupons.length === 0) {
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暂无可用红包</div>';
            return;
        }

        list.innerHTML = coupons.map(c => `
            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ff4d4f;">
                <div>
                    <div style="font-size: 16px; font-weight: bold; color: #333;">${c.title}</div>
                    <div style="font-size: 12px; color: #999;">${c.desc}</div>
                </div>
                <div style="color: #ff4d4f; font-weight: bold;">
                    ${c.type === 'discount' ? '折扣券' : (c.type === 'shipping' ? '免运费' : '¥'+c.value)}
                </div>
            </div>
        `).join('');
    }

    function renderOrderList() {
        const orders = getMyOrders().reverse(); // 最新在通过
        const list = document.getElementById('orderList');
        
        if (orders.length === 0) {
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暂无历史订单</div>';
            return;
        }

        list.innerHTML = orders.map(o => `
            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: bold;">${o.storeName}</span>
                    <span style="color: #999; font-size: 12px;">${o.date}</span>
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px; white-space: pre-wrap;">${o.items}</div>
                <div style="text-align: right; font-weight: bold;">实付: ¥${o.total}</div>
            </div>
        `).join('');
    }

    // 支付相关逻辑修改
    let currentSelectedCoupon = null;

    // 获取最佳优惠券
    function getBestCoupon(total) {
        const coupons = getMyCoupons().filter(c => c.status === 'unused');
        let best = null;
        let maxDiscount = 0;

        coupons.forEach(c => {
            if (!isValidCoupon(c, total)) return;
            
            let discount = 0;
            if (c.type === 'discount') {
                discount = total * (1 - c.value);
            } else if (c.type === 'shipping') {
                discount = 5; // 假设运费5元
            } else {
                discount = c.value;
            }
            
            if (discount > maxDiscount) {
                maxDiscount = discount;
                best = c;
            }
        });
        return { coupon: best, discount: maxDiscount };
    }

    function isValidCoupon(coupon, total) {
        if (coupon.type === 'shipping') return true; 
        if (coupon.type === 'discount') return true;
        // 兼容旧数据（没有type的默认是满减）和新数据（threshold）
        return total >= (coupon.min || 0);
    }

    // 打开确认订单弹窗 (替代原 selfPay)
    function selfPay() {
        const itemsText = getCartText();
        if (!itemsText) return alert('购物车是空的哦~');
        
        // 填充订单项
        const items = [];
        let subtotal = 0;
        const allFoods = [...storeData.chicken.menu, ...storeData.tea.menu];
        
        for (const [id, qty] of Object.entries(cart)) {
            const food = allFoods.find(f => f.id == id);
            if (food) {
                items.push(`<div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>${food.name} x${qty}</span><span>¥${(food.price * qty).toFixed(1)}</span></div>`);
                subtotal += food.price * qty;
            }
        }
        
        document.getElementById('orderConfirmItems').innerHTML = items.join('');
        document.getElementById('orderConfirmSubtotal').textContent = '¥' + subtotal.toFixed(1);
        
        // 填充优惠券选择器
        const selector = document.getElementById('couponSelector');
        selector.innerHTML = '<option value="">不使用优惠券</option>';
        
        const myCoupons = getMyCoupons().filter(c => c.status === 'unused');
        // 排序：可用优先，然后按面值
        myCoupons.sort((a, b) => {
            const aValid = isValidCoupon(a, subtotal);
            const bValid = isValidCoupon(b, subtotal);
            if (aValid && !bValid) return -1;
            if (!aValid && bValid) return 1;
            return b.value - a.value;
        });

        myCoupons.forEach(c => {
            const isValid = isValidCoupon(c, subtotal);
            let label = `${c.title}`;
            if (c.type === 'discount') label += ` (${(c.value * 10).toFixed(1)}折)`;
            else if (c.type === 'shipping') label += ` (免运费)`;
            else label += ` (-¥${c.value})`;
            
            if (!isValid) label += ' [不可用]';
            
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = label;
            if (!isValid) option.disabled = true;
            selector.appendChild(option);
        });
        
        // 默认选中最佳优惠券
        const { coupon: best } = getBestCoupon(subtotal);
        if (best) {
            selector.value = best.id;
        } else {
            selector.value = "";
        }
        
        updateOrderFinalPrice();
        
        document.getElementById('orderConfirmModal').classList.add('active');
    }

    function closeOrderConfirmModal() {
        document.getElementById('orderConfirmModal').classList.remove('active');
    }

    // 更新最终价格
    function updateOrderFinalPrice() {
        const subtotal = parseFloat(document.getElementById('orderConfirmSubtotal').textContent.replace('¥', ''));
        const selector = document.getElementById('couponSelector');
        const couponId = selector.value;
        
        let discount = 0;
        if (couponId) {
            const coupons = getMyCoupons();
            const coupon = coupons.find(c => c.id == couponId);
            if (coupon) {
                if (coupon.type === 'discount') {
                    discount = subtotal * (1 - coupon.value);
                } else if (coupon.type === 'shipping') {
                    discount = 5; 
                } else {
                    discount = coupon.value;
                }
            }
        }
        
        const total = Math.max(0.01, subtotal - discount);
        document.getElementById('orderConfirmTotal').textContent = '¥' + total.toFixed(2);
    }

    // 执行支付
    function executeOrderPayment() {
        const subtotal = parseFloat(document.getElementById('orderConfirmSubtotal').textContent.replace('¥', ''));
        const finalPrice = parseFloat(document.getElementById('orderConfirmTotal').textContent.replace('¥', ''));
        const selector = document.getElementById('couponSelector');
        const couponId = selector.value;
        
        // 扣除优惠券
        if (couponId) {
            const allCoupons = getMyCoupons();
            const target = allCoupons.find(c => c.id == couponId);
            if (target) {
                target.status = 'used';
                saveMyCoupons(allCoupons);
            }
        }
        
        // 保存订单
        const itemsText = getCartText();
        const orders = getMyOrders();
        orders.push({
            storeName: storeData[currentStoreId]?.name || '外卖订单',
            items: itemsText.split('\n').slice(1, -1).join('\n'), // 去头去尾
            total: finalPrice.toFixed(2),
            date: new Date().toLocaleString()
        });
        saveMyOrders(orders);
        
        alert('支付成功！正在为您配送中...');
        cart = {};
        updateCartDisplay();
        closeOrderConfirmModal();
        closeStorePage();
    }
    
    // 店铺数据
    const storeData = {
        chicken: {
            name: '肯打鸡炸鸡店',
            desc: '酥脆多汁，快乐源泉',
            icon: '🍗',
            menu: [
                { id: 101, name: '香辣鸡腿堡', price: 19.9, icon: '🍔', desc: '经典香辣，回味无穷' },
                { id: 102, name: '吮指原味鸡', price: 12.5, icon: '🍗', desc: '独家秘方，鲜嫩多汁' },
                { id: 103, name: '黄金鸡块(5块)', price: 11.0, icon: '🍘', desc: '外酥里嫩，配甜辣酱' },
                { id: 104, name: '大份薯条', price: 13.0, icon: '🍟', desc: '精选马铃薯，现炸酥脆' },
                { id: 105, name: '葡式蛋挞', price: 8.5, icon: '🥧', desc: '层层酥皮，奶香浓郁' },
                { id: 106, name: '百事可乐', price: 9.0, icon: '🥤', desc: '冰爽刺激，炸鸡绝配' }
            ]
        },
        tea: {
            name: '蜜雪冰城甜蜜蜜',
            desc: '你爱我，我爱你，蜜雪冰城甜蜜蜜',
            icon: '🧋',
            menu: [
                { id: 201, name: '冰鲜柠檬水', price: 4.0, icon: '🍋', desc: '新鲜柠檬，酸甜解渴' },
                { id: 202, name: '珍珠奶茶', price: 7.0, icon: '🧋', desc: 'Q弹珍珠，经典奶香' },
                { id: 203, name: '棒打鲜橙', price: 8.0, icon: '🍊', desc: '整颗鲜橙，维C满满' },
                { id: 204, name: '满杯百香果', price: 9.0, icon: '🍹', desc: '酸酸甜甜，果肉丰富' },
                { id: 205, name: '草莓摇摇奶昔', price: 8.0, icon: '🍓', desc: '喝前摇一摇，美味即现' },
                { id: 206, name: '魔天脆脆', price: 3.0, icon: '🍦', desc: '酥脆蛋筒，香草冰淇淋' }
            ]
        }
    };
    
    let currentStoreId = null;
    let currentStoreMenu = [];
    
    // 打开店铺
    function openStore(storeId) {
        currentStoreId = storeId;
        const store = storeData[storeId];
        currentStoreMenu = store.menu;
        
        document.getElementById('storeHeaderName').textContent = store.name;
        document.getElementById('storeHeaderDesc').textContent = store.desc;
        document.getElementById('storeHeaderImg').textContent = store.icon;
        
        renderStoreMenu();
        
        document.getElementById('storePage').classList.add('active');
        
        // 如果购物车不为空且是另一家店的，提示是否清空（简化起见，这里不清空，允许跨店点餐，或者直接继承）
        // 这里简化逻辑：购物车是全局的
        updateCartDisplay();
    }
    
    function closeStorePage() {
        document.getElementById('storePage').classList.remove('active');
        currentStoreId = null;
    }
    
    // 渲染店铺菜单
    function renderStoreMenu() {
        const container = document.getElementById('storeMenu');
        container.innerHTML = currentStoreMenu.map(food => `
            <div class="food-item">
                <div class="food-img">${food.icon}</div>
                <div class="food-info">
                    <div>
                        <div class="food-name">${food.name}</div>
                        <div class="food-desc">${food.desc}</div>
                    </div>
                    <div class="food-bottom">
                        <div class="food-price">¥${food.price}</div>
                        <div class="food-add-btn" onclick="addToCart(${food.id})">+</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // 购物车数据
    let cart = {};
    
    // 添加到购物车
    function addToCart(foodId) {
        if (!cart[foodId]) {
            cart[foodId] = 0;
        }
        cart[foodId]++;
        updateCartDisplay();
        
        // 简单的飞入动画效果
        const btn = event.target;
        btn.style.transform = 'scale(0.8)';
        setTimeout(() => btn.style.transform = 'scale(1)', 100);
    }
    
    // 更新购物车显示
    function updateCartDisplay() {
        let count = 0;
        let total = 0;
        
        // 合并所有菜单查找商品
        const allFoods = [...storeData.chicken.menu, ...storeData.tea.menu];
        
        for (const [id, qty] of Object.entries(cart)) {
            const food = allFoods.find(f => f.id == id);
            if (food) {
                count += qty;
                total += food.price * qty;
            }
        }
        
        // 更新所有购物车栏（主页和店铺页都有）
        const cartCounts = document.querySelectorAll('.cart-count');
        const cartTotals = document.querySelectorAll('#cartTotal'); // ID重复了，应该用class，但这里先这样修补
        
        // 因为ID唯一，这里直接操作
        // 注意：页面上有两个 .food-cart-bar，一个是主页的（现在隐藏了），一个是店铺页的
        // 上面的HTML结构修改中，主页的cart-bar被我注释说"主页不显示"，所以实际只有店铺页有ID
        
        const countEl = document.getElementById('cartCount');
        const totalEl = document.getElementById('cartTotal');
        
        if (countEl) {
            countEl.textContent = count;
            countEl.style.display = count > 0 ? 'block' : 'none';
        }
        if (totalEl) {
            totalEl.textContent = total.toFixed(1); // 保留一位小数
        }
    }
    
    // 获取购物车内容文本
    function getCartText() {
        const items = [];
        let total = 0;
        const allFoods = [...storeData.chicken.menu, ...storeData.tea.menu];
        
        for (const [id, qty] of Object.entries(cart)) {
            const food = allFoods.find(f => f.id == id);
            if (food) {
                items.push(`${food.name} x${qty}`);
                total += food.price * qty;
            }
        }
        if (items.length === 0) return null;
        return `外卖订单：\n${items.join('\n')}\n总计：¥${total.toFixed(1)}`;
    }
    
    // 临时变量：当前订单信息
    let currentOrderContext = null;
    
    // 自己支付 - 打开订单确认弹窗
    function selfPay() {
        const itemsText = getCartText();
        if (!itemsText) return alert('购物车是空的哦~');
        
        const total = parseFloat(document.getElementById('cartTotal').textContent);
        
        // 保存订单上下文
        currentOrderContext = {
            type: 'self',
            total: total,
            itemsText: itemsText,
            friendName: null
        };
        
        openOrderConfirmModal();
    }
    
    // 打开订单确认弹窗
    function openOrderConfirmModal() {
        if (!currentOrderContext) return;
        
        const { total, itemsText } = currentOrderContext;
        
        // 设置标题
        document.getElementById('orderConfirmTitle').textContent = '确认订单';
        
        // 设置订单项
        const items = itemsText.split('\n');
        const itemsHtml = items.slice(1, -1).join('<br>'); // 去掉头尾
        document.getElementById('orderConfirmItems').innerHTML = itemsHtml;
        document.getElementById('orderConfirmSubtotal').textContent = `¥${total.toFixed(2)}`;
        
        // 渲染优惠券选择器
        renderCouponSelector(total);
        
        // 显示弹窗
        document.getElementById('orderConfirmModal').classList.add('active');
    }
    
    // 关闭订单确认弹窗
    function closeOrderConfirmModal() {
        document.getElementById('orderConfirmModal').classList.remove('active');
        currentOrderContext = null;
    }
    
    // 渲染优惠券选择器
    function renderCouponSelector(total) {
        const coupons = getMyCoupons().filter(c => c.status === 'unused');
        const selector = document.getElementById('couponSelector');
        
        let optionsHtml = '<option value="">不使用优惠券</option>';
        
        coupons.forEach(c => {
            let canUse = false;
            let displayText = c.title;
            
            if (c.type === 'threshold') {
                if (total >= c.min) {
                    canUse = true;
                    displayText += ` (-¥${c.value})`;
                } else {
                    displayText += ` (还差¥${(c.min - total).toFixed(2)})`;
                }
            } else if (c.type === 'discount') {
                canUse = true;
                displayText += ` (-¥${(total * (1 - c.value)).toFixed(2)})`;
            } else if (c.type === 'shipping') {
                canUse = true;
                displayText += ' (免运费)';
            }
            
            if (canUse) {
                optionsHtml += `<option value="${c.id}">${displayText}</option>`;
            } else {
                optionsHtml += `<option value="${c.id}" disabled style="color: #ccc;">${displayText}</option>`;
            }
        });
        
        selector.innerHTML = optionsHtml;
        updateOrderFinalPrice();
    }
    
    // 更新实付金额
    function updateOrderFinalPrice() {
        if (!currentOrderContext) return;
        
        const { total } = currentOrderContext;
        const selectedCouponId = document.getElementById('couponSelector').value;
        
        let finalPrice = total;
        
        if (selectedCouponId) {
            const coupon = getMyCoupons().find(c => c.id == selectedCouponId);
            if (coupon) {
                if (coupon.type === 'threshold') {
                    finalPrice = Math.max(0.01, total - coupon.value);
                } else if (coupon.type === 'discount') {
                    finalPrice = Math.max(0.01, total * coupon.value);
                } else if (coupon.type === 'shipping') {
                    finalPrice = Math.max(0.01, total - 5);
                }
            }
        }
        
        document.getElementById('orderConfirmTotal').textContent = `¥${finalPrice.toFixed(2)}`;
    }
    
    // 执行支付
    function executeOrderPayment() {
        if (!currentOrderContext) return;
        
        const { type, total, itemsText, friendName } = currentOrderContext;
        const selectedCouponId = document.getElementById('couponSelector').value;
        
        let finalPrice = total;
        let couponInfo = '';
        
        // 扣除优惠券
        if (selectedCouponId) {
            const allCoupons = getMyCoupons();
            const coupon = allCoupons.find(c => c.id == selectedCouponId);
            if (coupon) {
                coupon.status = 'used';
                saveMyCoupons(allCoupons);
                
                if (coupon.type === 'threshold') {
                    finalPrice = Math.max(0.01, total - coupon.value);
                    couponInfo = `(已抵扣¥${coupon.value})`;
                } else if (coupon.type === 'discount') {
                    finalPrice = Math.max(0.01, total * coupon.value);
                    couponInfo = `(已抵扣¥${(total - finalPrice).toFixed(2)})`;
                } else if (coupon.type === 'shipping') {
                    finalPrice = Math.max(0.01, total - 5);
                    couponInfo = '(免运费)';
                }
            }
        }
        
        // 记录订单
        const orders = getMyOrders();
        const orderItem = {
            storeName: storeData[currentStoreId]?.name || '外卖订单',
            items: itemsText.split('\n').slice(1, -1).join('\n'),
            total: finalPrice.toFixed(2),
            date: new Date().toLocaleString()
        };
        
        if (type === 'order_for' && friendName) {
            orderItem.storeName += ` (给${friendName})`;
        }
        
        orders.push(orderItem);
        saveMyOrders(orders);
        
        if (type === 'self') {
            alert('支付成功！正在为您配送中...');
            cart = {};
            updateCartDisplay();
            closeStorePage();
        } else if (type === 'order_for') {
            const message = `给你点了外卖：\n${itemsText}\n实付: ¥${finalPrice.toFixed(2)} ${couponInfo}\n记得趁热吃哦~ ❤️`;
            addChatMessage(friendName, message, true);
            updateFriendLastMessage(friendName, message);
            saveChatMessages(friendName);
            
            alert('消息已发送！');
            cart = {};
            updateCartDisplay();
            closeStorePage();
            closeFoodDeliveryPage();
            openChatPage(friendName);
        }
        
        closeOrderConfirmModal();
    }
    
    // 显示选择角色弹窗 (复用)
    // type: 'order_for' 或 'ask_pay'
    let currentRoleSelectType = '';
    
    function showOrderForRoleModal() {
        if (Object.keys(cart).length === 0) return alert('请先点餐哦~');
        currentRoleSelectType = 'order_for';
        document.getElementById('roleSelectorTitle').textContent = '给TA点餐';
        renderRoleSelector();
        document.getElementById('roleSelectorModal').classList.add('active');
    }
    
    function showAskPayModal() {
        if (Object.keys(cart).length === 0) return alert('请先点餐哦~');
        currentRoleSelectType = 'ask_pay';
        document.getElementById('roleSelectorTitle').textContent = '让TA买单';
        renderRoleSelector();
        document.getElementById('roleSelectorModal').classList.add('active');
    }
    
    function closeRoleSelectorModal() {
        document.getElementById('roleSelectorModal').classList.remove('active');
    }
    
    // 渲染角色选择列表
    function renderRoleSelector() {
        const friends = getFriendList();
        const list = document.getElementById('roleSelectorList');
        
        if (friends.length === 0) {
            list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无好友</div>';
            return;
        }
        
        list.innerHTML = friends.map(friend => `
            <div class="modal-option-item" onclick="selectRoleForFood('${friend.name}')">
                <div style="width: 30px; height: 30px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 14px;">
                    ${friend.avatar ? `<img src="${friend.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : friend.name.charAt(0)}
                </div>
                <span>${friend.remark || friend.name}</span>
            </div>
        `).join('');
    }
    
    // 选择角色后的操作
    function selectRoleForFood(friendName) {
        const cartText = getCartText();
        if (!cartText) return;
        
        const total = parseFloat(document.getElementById('cartTotal').textContent);
        
        if (currentRoleSelectType === 'order_for') {
            // 给TA点餐，也使用订单确认弹窗
            currentOrderContext = {
                type: 'order_for',
                total: total,
                itemsText: cartText,
                friendName: friendName
            };
            
            closeRoleSelectorModal();
            openOrderConfirmModal();
            
        } else if (currentRoleSelectType === 'ask_pay') {
            // 生成代付卡片HTML
            const items = cartText.split('\n').slice(1, -1).join('<br>');
            const orderId = Date.now().toString();
            
            // 存储代付订单信息，以便后续角色如果真的支付了可以更新状态（这里仅演示，不存后端）
            // 发送富文本卡片
            // 注意：这里我们使用特殊的格式，让addChatMessage支持HTML，或者直接构造HTML
            
            const cardHtml = `
                <div class="pay-card" onclick="handlePayCardClick(this, '${orderId}', '${total}', '${friendName}', true)">
                    <div class="pay-card-header">
                        <span>💳</span> 代付求助
                    </div>
                    <div class="pay-card-content">
                        <div class="pay-card-title">帮我付一下外卖~</div>
                        <div class="pay-card-desc">${items}</div>
                        <div class="pay-card-amount">¥${total}</div>
                    </div>
                    <div class="pay-card-footer">点击帮TA支付</div>
                </div>
            `;
            
            // 实际上，如果是"我"发出的，我不能点击支付。只有当"角色"发给我时，我才能支付。
            // 这里为了演示"角色也可以给我发"，我们模拟一下。
            // 正常流程：我发给角色 -> 角色看到 -> 角色支付（模拟）。
            // 角色发给我 -> 我看到 -> 我点击支付。
            
            // 这里添加的是"我发出的消息"
            addChatMessage(friendName, cardHtml, true); // true表示是我发的
            updateFriendLastMessage(friendName, '[代付求助]');
            saveChatMessages(friendName);
            
            // 为了演示"角色给我发"，我们模拟角色回复一个代付请求（仅测试用）
            // setTimeout(() => {
            //    receiveAskPayRequest(friendName, 15.5, '奶茶 x1');
            // }, 3000);
            
            // "让TA付"操作完成后的清理
            alert('消息已发送！');
            cart = {};
            updateCartDisplay();
            closeRoleSelectorModal();
            closeStorePage(); 
            closeFoodDeliveryPage(); 
            openChatPage(friendName);
        }
    }
    
    // 模拟收到角色的代付请求
    function receiveAskPayRequest(friendName, amount, items) {
        const orderId = Date.now().toString();
        const cardHtml = `
            <div class="pay-card" onclick="handlePayCardClick(this, '${orderId}', '${amount}', '${friendName}', false)">
                <div class="pay-card-header">
                    <span>💳</span> 代付求助
                </div>
                <div class="pay-card-content">
                    <div class="pay-card-title">饿饿饭饭 🥺</div>
                    <div class="pay-card-desc">${items}</div>
                    <div class="pay-card-amount">¥${amount}</div>
                </div>
                <div class="pay-card-footer">点击帮TA支付</div>
            </div>
        `;
        addChatMessage(friendName, cardHtml, false); // false表示对方发的
        updateFriendLastMessage(friendName, '[代付求助]');
        saveChatMessages(friendName);
    }
    
    // 处理代付卡片点击
    function handlePayCardClick(element, orderId, amount, friendName, isSelf) {
        // 如果是已支付状态，不处理
        if (element.classList.contains('paid')) return;
        
        // 如果是自己发的（isSelf=true），通常不能自己给自己代付（逻辑上），但为了演示或者如果UI允许撤回等...
        // 题目说："如果给我发送我可以点击帮他代付"。这意味着 isSelf=false 的时候可以点。
        // 如果是自己发的，点击可能是查看详情或无反应。
        if (isSelf) {
            alert('这是你发起的代付请求，请等待对方支付。');
            return;
        }
        
        // 对方发的，我来支付
        if (confirm(`确定要帮 ${friendName} 支付 ¥${amount} 吗？`)) {
            // 支付逻辑
            alert('支付成功！已帮TA买单。');
            
            // 更新卡片样式
            element.classList.add('paid');
            element.querySelector('.pay-card-footer').textContent = '已支付';
            
            // 记录我的订单（代付也算我的支出？）
            // const orders = getMyOrders(); ...
            
            // 发送一条通知消息
            // addChatMessage(friendName, `已帮你支付 ¥${amount}，快吃吧~`, true);
        }
    }

    // ========== 微信页面Tab切换 ==========
    
    /**
     * 切换微信底部Tab（微信/通讯录/发现/我）
     * @param {number} index - Tab索引 (0:微信, 1:通讯录, 2:发现, 3:我)
     */
    function switchWeChatTab(index) {
        const tabs = document.querySelectorAll('.wechat-tab-item');
        tabs.forEach((tab, i) => {
            if (i === index) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        const content = document.getElementById('wechatContent');
        const friendList = document.getElementById('friendList');
        const mePage = document.getElementById('mePage');
        const titles = ['微信', '通讯录', '发现', '我'];
        document.querySelector('.wechat-title').textContent = titles[index];
        
        // 清理发现页内容（如果存在）
        const discoverList = content.querySelector('.discover-list');
        if (discoverList) {
            discoverList.remove();
        }
        
        // 清理通讯录容器（如果存在）
        const contactsContainer = content.querySelector('.contacts-container');
        if (contactsContainer) {
            contactsContainer.remove();
        }
        
        // 更新内容区域
        if (index === 0) {
            // 微信Tab：显示好友列表，隐藏"我"页面
            if (mePage) mePage.classList.remove('active');
            // 清理通讯录容器
            const contactsContainer = content.querySelector('.contacts-container');
            if (contactsContainer) contactsContainer.remove();
            if (friendList) {
                friendList.style.display = 'block';
                friendList.style.visibility = 'visible';
            renderFriendList();
            }
            // 清理通讯录占位符
            const placeholder = content.querySelector('.tab-placeholder');
            if (placeholder) placeholder.remove();
        } else if (index === 1) {
            // 通讯录Tab：隐藏其他内容
            if (mePage) mePage.classList.remove('active');
            if (friendList) {
                friendList.style.display = 'none';
                friendList.style.visibility = 'hidden';
            }
            // 清理通讯录占位符
            const placeholder = content.querySelector('.tab-placeholder');
            if (placeholder) placeholder.remove();
            // 渲染通讯录页面
            renderContactsPage();
        } else if (index === 2) {
            // 发现Tab：隐藏其他内容
            if (mePage) mePage.classList.remove('active');
            if (friendList) friendList.style.display = 'none';
            
            // 清理通讯录占位符
            const placeholder = content.querySelector('.tab-placeholder');
            if (placeholder) placeholder.remove();
            
            // 创建发现页列表
            const discoverListEl = document.createElement('div');
            discoverListEl.className = 'discover-list';
            discoverListEl.style.cssText = 'background-color: #f7f7f7; height: 100%; display: flex; flex-direction: column;';
            
            // 朋友圈入口
            const momentsItem = document.createElement('div');
            momentsItem.onclick = openMomentsPage;
            momentsItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: white; border-bottom: 1px solid #f0f0f0; cursor: pointer; margin-top: 0;';
            momentsItem.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="4"/>
                            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                        </svg>
                    </div>
                    <span style="font-size: 16px; color: var(--text-color);">朋友圈</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="detail-arrow" style="color: #ccc;">→</span>
                </div>
            `;
            
            discoverListEl.appendChild(momentsItem);
            
            // 扫一扫等其他功能
            const otherFeatures = document.createElement('div');
            otherFeatures.style.cssText = 'margin-top: 10px; background: white;';
            otherFeatures.innerHTML = `
                <div onclick="alert('扫一扫功能开发中...')" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h6v6H4z"/><path d="M14 4h6v6h-6z"/><path d="M4 14h6v6H4z"/><path d="M14 14h6v6h-6z"/>
                            </svg>
                        </div>
                        <span style="font-size: 16px; color: var(--text-color);">扫一扫</span>
                    </div>
                    <span class="detail-arrow" style="color: #ccc;">→</span>
                </div>
            `;
            discoverListEl.appendChild(otherFeatures);
            
            content.appendChild(discoverListEl);
        } else if (index === 3) {
            // "我"Tab：显示"我"页面，隐藏好友列表
            if (friendList) friendList.style.display = 'none';
            const placeholder = content.querySelector('.tab-placeholder');
            if (placeholder) placeholder.remove();
            if (mePage) mePage.classList.add('active');
        }
    }

    // 关闭"我"页面，返回微信页面
    function closeMePage() {
        document.getElementById('mePage').classList.remove('active');
        document.getElementById('wechatPage').classList.add('active');
    }

    // 切换加号菜单
    function toggleAddMenu(event) {
        event.stopPropagation();
        const menu = document.getElementById('addMenu');
        menu.classList.toggle('active');
        
        // 点击其他地方关闭菜单
        if (menu.classList.contains('active')) {
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target) && !event.target.closest('.wechat-header-btn')) {
                        menu.classList.remove('active');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }
    }

    // 显示添加好友弹窗
    function showAddFriendModal() {
        document.getElementById('addMenu').classList.remove('active');
        const overlay = document.getElementById('modalOverlay');
        const title = document.getElementById('modalTitle');
        const options = document.getElementById('modalOptions');
        
        title.textContent = '添加好友';
        options.innerHTML = `
            <button class="modal-option-btn" onclick="showCreateFriendModal()">创建</button>
            <button class="modal-option-btn" onclick="alert('搜索微信号功能开发中...')">搜索微信号</button>
        `;
        overlay.classList.add('active');
    }

    // 显示创建好友弹窗
    function showCreateFriendModal() {
        const title = document.getElementById('modalTitle');
        const options = document.getElementById('modalOptions');
        const tags = getTags();
        
        title.textContent = '创建好友';
        
        let tagOptions = '<option value="">无标签</option>';
        tags.forEach(tag => {
            tagOptions += `<option value="${tag}">${tag}</option>`;
        });
        
        options.innerHTML = `
            <input type="text" class="modal-input" id="friendNameInput" placeholder="请输入角色真名" maxlength="20" style="margin-bottom: 15px;">
            <select class="modal-input" id="friendTagSelect" style="margin-bottom: 15px;">
                ${tagOptions}
            </select>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn modal-btn-primary" onclick="createFriend()">确定</button>
            </div>
        `;
        
        // 聚焦输入框
        setTimeout(() => {
            document.getElementById('friendNameInput').focus();
        }, 100);
    }

    // 创建好友并进入聊天
    function createFriend() {
        const name = document.getElementById('friendNameInput').value.trim();
        if (!name) {
            alert('请输入角色真名');
            return;
        }
        
        const tagSelect = document.getElementById('friendTagSelect');
        const tag = tagSelect ? tagSelect.value : '';
        
        closeModal();
        addFriendToList(name, tag);
        openChatPage(name);
    }

    // ========== 聊天页面管理 ==========
    
    /**
     * 打开与指定好友的聊天页面
     * @param {string} friendName - 好友名称
     */
    async function openChatPage(friendName) {
        // 获取好友信息，使用备注作为显示名称
        const friends = getFriendList();
        const friend = friends.find(f => f.name === friendName);
        const displayName = friend ? (friend.remark || friend.name) : friendName;
        
        document.getElementById('chatName').textContent = displayName;
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('chatInput').value = '';
        
        // 加载历史消息 (IndexedDB)
        const history = await ChatStorage.load(friendName);
        if (history && history.length > 0) {
            history.forEach(msg => {
                addChatMessage(friendName, msg.text, msg.isSelf, false, msg.id, msg.imageUrl, msg.imageDesc, msg.voiceDuration, msg.voiceText, msg.redPacketData);
            });
            // 加载完历史消息后滚动到底部
            setTimeout(() => {
                const messagesEl = document.getElementById('chatMessages');
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }, 100);
        }
        
        document.getElementById('wechatPage').classList.remove('active');
        document.getElementById('chatPage').classList.add('active');
        
        // 保存当前聊天对象
        currentChatFriend = friendName;
        
        // 应用聊天设置
        const settings = getChatSettings() || {};
        if (typeof applyChatBubbleCss === 'function') {
            applyChatBubbleCss(settings.bubbleCss);
        }
        
        // 确保按钮状态正确
        document.getElementById('chatMenuBtn').classList.remove('hidden');
        document.getElementById('chatSendBtn').classList.add('hidden');
    }

    /**
     * 保存聊天消息到IndexedDB
     * @param {string} friendName - 好友名称
     */
    async function saveChatMessages(friendName) {
        const messages = [];
        const messageElements = document.querySelectorAll('#chatMessages .chat-message');
        messageElements.forEach(el => {
            const isSelf = el.classList.contains('self');
            const bubble = el.querySelector('.chat-bubble');
            const messageId = el.dataset.messageId || generateMessageId();
            
            // 提取图片URL和描述
            const img = bubble.querySelector('img');
            const imageUrl = img ? img.src : null;
            const descEl = bubble.querySelector('.image-desc');
            const imageDesc = descEl ? descEl.textContent : null;
            
            // 提取语音消息信息
            const voiceEl = bubble.querySelector('.voice-message');
            let voiceDuration = null;
            let voiceText = null;
            if (voiceEl) {
                voiceDuration = parseInt(voiceEl.querySelector('.voice-duration').textContent.replace('"', '')) || null;
                voiceText = voiceEl.dataset.voiceText || null;
            }

            // 提取红包信息
            const redPacketEl = bubble.querySelector('.red-packet-bubble');
            const transferEl = bubble.querySelector('.transfer-bubble');
            let redPacketData = null;
            if (redPacketEl) {
                redPacketData = {
                    amount: redPacketEl.dataset.amount,
                    note: redPacketEl.dataset.note,
                    cover: redPacketEl.dataset.cover,
                    textColor: redPacketEl.dataset.textColor || null,
                    isTransfer: false
                };
            } else if (transferEl) {
                redPacketData = {
                    amount: transferEl.dataset.amount,
                    note: transferEl.dataset.note,
                    cover: 'transfer',
                    isTransfer: true,
                    textColor: '#ffffff'
                };
            }
            
            // 提取文字内容（排除图片描述和[图片]标记）
            let text = '';
            if (redPacketEl) {
                // 红包消息：保存特殊文本标记，实际渲染靠 redPacketData
                text = `[红包] ${redPacketData.note}`;
            } else if (transferEl) {
                // 收款消息：保存特殊文本标记
                text = `[收款] ￥${redPacketData.amount}`;
            } else if (voiceEl) {
                // 语音消息：保存原始文字
                text = voiceText || '';
            } else if (imageUrl) {
                // 判断是否为表情消息（有emoji-message类）
                const isEmoji = img && img.classList.contains('emoji-message');
                
                if (isEmoji) {
                    // 表情消息：保存为空文本
                    text = '';
                } else if (imageDesc) {
                    // 普通图片消息，有描述
                    text = `[图片] ${imageDesc}`;
                } else {
                    // 普通图片消息，无描述
                    text = '[图片]';
                }
            } else {
                // 纯文字消息，提取所有文本（排除图片描述和语音文字内容）
                const textNodes = [];
                bubble.childNodes.forEach(node => {
                    if (node.nodeType === 3) { // 文本节点
                        textNodes.push(node.textContent);
                    } else if (node.nodeType === 1 && node.tagName !== 'IMG' && !node.classList.contains('image-desc') && !node.classList.contains('voice-message') && !node.classList.contains('voice-text-content')) {
                        // 非图片、非描述的文本元素，排除语音相关元素
                        textNodes.push(node.textContent);
                    }
                });
                text = textNodes.join('').trim();
            }
            
            messages.push({ text, isSelf, id: messageId, imageUrl, imageDesc, voiceDuration, voiceText, redPacketData });
        });
        
        await ChatStorage.save(friendName, messages);
    }

    // ========== 聊天消息输入处理 ==========
    
    // 当前聊天对象（全局变量）
    let currentChatFriend = '';

    /**
     * 处理聊天输入框内容变化
     * 根据输入内容显示/隐藏发送按钮和菜单按钮
     * @param {Event} event - 输入事件
     */
    function handleChatInputChange(event) {
        const input = event.target;
        const text = input.value.trim();
        const menuBtn = document.getElementById('chatMenuBtn');
        const sendBtn = document.getElementById('chatSendBtn');
        
        if (text.length > 0) {
            // 有输入时：显示发送按钮，隐藏"更多功能"按钮，但保持表情按钮可见
            const moreBtn = menuBtn.querySelector('.chat-input-btn:last-child'); // 更多功能按钮（第二个）
            const emojiBtn = menuBtn.querySelector('.chat-input-btn:first-child'); // 表情按钮（第一个）
            
            // 隐藏更多功能按钮
            if (moreBtn) {
                moreBtn.style.display = 'none';
            }
            // 确保表情按钮始终显示
            if (emojiBtn) {
                emojiBtn.style.display = 'flex';
            }
            // 显示发送按钮
            sendBtn.classList.remove('hidden');
            // 确保菜单容器显示（包含表情按钮）
            menuBtn.style.display = 'flex';
        } else {
            // 无输入时：显示所有菜单按钮（表情+更多功能），隐藏发送按钮
            const moreBtn = menuBtn.querySelector('.chat-input-btn:last-child');
            const emojiBtn = menuBtn.querySelector('.chat-input-btn:first-child');
            
            // 显示所有按钮
            if (moreBtn) {
                moreBtn.style.display = 'flex';
            }
            if (emojiBtn) {
                emojiBtn.style.display = 'flex';
            }
            // 隐藏发送按钮
            sendBtn.classList.add('hidden');
            // 确保菜单容器显示
            menuBtn.style.display = 'flex';
        }
    }

    /**
     * 处理输入框回车键发送消息
     * @param {Event} event - 键盘事件
     */
    function handleChatInputKeyPress(event) {
        if (event.key === 'Enter') {
            sendChatMessage();
        }
    }

    /**
     * 发送聊天消息
     * 将输入框内容发送给当前聊天好友
     */
    function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text || !currentChatFriend) return;
        
        const messageId = addChatMessage(currentChatFriend, text, true);
        updateFriendLastMessage(currentChatFriend, text);
        saveChatMessages(currentChatFriend);
        input.value = '';
        
        // 重置按钮显示：恢复所有菜单按钮，隐藏发送按钮
        const menuBtn = document.getElementById('chatMenuBtn');
        const sendBtn = document.getElementById('chatSendBtn');
        const moreBtn = menuBtn.querySelector('.chat-input-btn:last-child');
        
        // 确保表情按钮和菜单按钮都显示
        menuBtn.classList.remove('hidden');
        if (moreBtn) {
            moreBtn.style.display = 'flex';
        }
        sendBtn.classList.add('hidden');
        
        // 触发input事件，确保状态同步
        input.dispatchEvent(new Event('input'));
    }

    // 打开图片输入弹窗
    function openImageInputModal() {
        const modal = document.getElementById('imageInputModal');
        modal.classList.add('active');
        // 聚焦输入框
        setTimeout(() => {
            document.getElementById('imageUrlInput').focus();
        }, 100);
    }

    // 关闭图片输入弹窗
    function closeImageInputModal() {
        const modal = document.getElementById('imageInputModal');
        modal.classList.remove('active');
        // 清空输入
        document.getElementById('imageUrlInput').value = '';
        document.getElementById('imageDescInput').value = '';
    }

    // 发送图片消息
    function sendImageMessage() {
        const imageUrl = document.getElementById('imageUrlInput').value.trim();
        const imageDesc = document.getElementById('imageDescInput').value.trim();
        
        if (!imageUrl) {
            alert('请输入图片链接');
            return;
        }
        
        // 验证URL格式
        try {
            new URL(imageUrl);
        } catch (e) {
            alert('请输入有效的图片链接');
            return;
        }
        
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            closeImageInputModal();
            return;
        }
        
        // 构建消息文本（包含描述）
        let messageText = '';
        if (imageDesc) {
            messageText = `[图片] ${imageDesc}`;
        } else {
            messageText = '[图片]';
        }
        
        // 添加消息
        const messageId = addChatMessage(currentChatFriend, messageText, true, true, null, imageUrl, imageDesc);
        updateFriendLastMessage(currentChatFriend, messageText);
        saveChatMessages(currentChatFriend);
        
        // 关闭弹窗
        closeImageInputModal();
    }

    // ========== 表情功能模块 ==========
    
    let selectedEmojiFile = null;

    // 切换表情面板显示/隐藏
    function toggleEmojiPanel() {
        const panel = document.getElementById('emojiPanel');
        if (panel.classList.contains('active')) {
            closeEmojiPanel();
        } else {
            // 先关闭功能面板（如果打开）
            closeFunctionPanel();
            openEmojiPanel();
        }
    }

    // 打开表情面板
    function openEmojiPanel() {
        const panel = document.getElementById('emojiPanel');
        const inputBar = document.querySelector('.chat-input-bar');
        
        // 表情面板从底部弹出
        panel.classList.add('active');
        
        // 输入栏向上移动，紧贴在表情面板上方
        if (inputBar) {
            // 直接设置高度，表情面板高度是25vh，最大200px
            const panelHeight = Math.min(window.innerHeight * 0.25, 200);
            inputBar.style.bottom = panelHeight + 'px';
        }
        
        // 加载表情列表
        loadEmojiList();
    }

    // 关闭表情面板
    function closeEmojiPanel() {
        const panel = document.getElementById('emojiPanel');
        const inputBar = document.querySelector('.chat-input-bar');
        
        // 表情面板隐藏
        panel.classList.remove('active');
        
        // 输入栏回到底部
        if (inputBar) {
            inputBar.style.bottom = '0';
        }
    }

    // ========== 功能面板模块 ==========
    
    // 切换功能面板显示/隐藏
    function toggleFunctionPanel() {
        const panel = document.getElementById('functionPanel');
        if (panel.classList.contains('active')) {
            closeFunctionPanel();
        } else {
            // 先关闭表情面板（如果打开）
            closeEmojiPanel();
            openFunctionPanel();
        }
    }

    // 打开功能面板
    function openFunctionPanel() {
        const panel = document.getElementById('functionPanel');
        const inputBar = document.querySelector('.chat-input-bar');
        
        // 功能面板从底部弹出
        panel.classList.add('active');
        
        // 输入栏向上移动，紧贴在功能面板上方
        if (inputBar) {
            const panelHeight = Math.min(window.innerHeight * 0.25, 200);
            inputBar.style.bottom = panelHeight + 'px';
        }
        
        // 加载功能列表
        loadFunctionList();
    }

    // 关闭功能面板
    function closeFunctionPanel() {
        const panel = document.getElementById('functionPanel');
        const inputBar = document.querySelector('.chat-input-bar');
        
        // 功能面板隐藏
        panel.classList.remove('active');
        
        // 输入栏回到底部
        if (inputBar) {
            inputBar.style.bottom = '0';
        }
    }

    // 加载功能列表
    function loadFunctionList() {
        const functionGrid = document.getElementById('functionGrid');
        functionGrid.innerHTML = '';
        
        const functions = [
            { name: '照片', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>', action: 'photo' },
            { name: '视频通话', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>', action: 'video' },
            { name: '位置', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>', action: 'location' },
            { name: '红包', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="12" rx="2"></rect><path d="M12 8V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v2"></path><path d="M12 8v10"></path><path d="M8 12h8"></path></svg>', action: 'redPacket' },
            { name: '礼物', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>', action: 'gift' },
            { name: '重回', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>', action: 'regenerate' },
            { name: '语音输入', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>', action: 'voice' },
            { name: '发起收款', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>', action: 'transfer' }
        ];
        
        functions.forEach(func => {
            const item = document.createElement('div');
            item.className = 'function-item';
            item.innerHTML = `
                <div class="function-icon">${func.icon}</div>
                <div class="function-label">${func.name}</div>
            `;
            item.onclick = () => {
                // 关闭面板
                closeFunctionPanel();
                
                // 根据action执行相应功能
                if (func.action === 'regenerate') {
                    regenerateReply();
                } else if (func.action === 'photo') {
                    openPhotoModal();
                } else if (func.action === 'location') {
                    openLocationModal();
                } else if (func.action === 'voice') {
                    openVoiceInput();
                } else if (func.action === 'redPacket') {
                    openRedPacketModal();
                } else if (func.action === 'transfer') {
                    openTransferModal();
                } else if (func.action === 'video') {
                    sendVideoCallRequest();
                } else if (func.action === 'gift') {
                    sendGiftMessage();
                }
            };
            functionGrid.appendChild(item);
        });
    }

    // 发起视频通话
    function sendVideoCallRequest() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            closeFunctionPanel();
            return;
        }
        
        // 关闭功能面板
        closeFunctionPanel();
        
        // 发送消息
        const text = '[视频通话] 发起视频通话';
        addChatMessage(currentChatFriend, text, true);
        updateFriendLastMessage(currentChatFriend, text);
        saveChatMessages(currentChatFriend);
        
        // 打开视频通话页面
        setTimeout(() => {
            startVideoCall();
        }, 300);
    }

    // 发送礼物
    function sendGiftMessage() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            closeFunctionPanel();
            return;
        }
        const gifts = ['鲜花', '巧克力', '奶茶', '蛋糕'];
        const gift = gifts[Math.floor(Math.random() * gifts.length)];
        const text = `[礼物] 送你 ${gift}`;
        addChatMessage(currentChatFriend, text, true);
        updateFriendLastMessage(currentChatFriend, text);
        saveChatMessages(currentChatFriend);
    }

    // 加载表情列表
    function loadEmojiList() {
        const emojiList = document.getElementById('emojiList');
        emojiList.innerHTML = '';
        
        // 加载我的表情
        const myEmojis = getMyEmojis();
        
        // 先添加所有表情
        myEmojis.forEach((emoji, index) => {
            const emojiItem = document.createElement('div');
            emojiItem.className = 'emoji-item';
            emojiItem.innerHTML = `<img src="${emoji.url}" alt="${emoji.name}">`;
            emojiItem.onclick = () => sendEmoji(emoji.url);
            emojiList.appendChild(emojiItem);
        });
        
        // 最后添加"添加表情"加号按钮（仿照微信）
        const addBtn = document.createElement('div');
        addBtn.className = 'emoji-item emoji-add-btn';
        addBtn.innerHTML = '+';
        addBtn.onclick = openEmojiAddModal;
        emojiList.appendChild(addBtn);
    }

    // 获取我的表情列表
    function getMyEmojis() {
        const emojis = localStorage.getItem('myEmojis');
        return emojis ? JSON.parse(emojis) : [];
    }

    // 保存我的表情列表
    function saveMyEmojis(emojis) {
        localStorage.setItem('myEmojis', JSON.stringify(emojis));
    }

    // 发送表情
    function sendEmoji(emojiUrl) {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            closeEmojiPanel();
            return;
        }
        
        // 添加表情消息
        const messageId = addChatMessage(currentChatFriend, '', true, true, null, emojiUrl, null);
        
        // 更新最后一条消息显示
        updateFriendLastMessage(currentChatFriend, '[表情]');
        
        // 保存消息
        saveChatMessages(currentChatFriend);
        
        // 关闭表情面板
        closeEmojiPanel();
    }

    // 打开添加表情弹窗
    function openEmojiAddModal() {
        const modal = document.getElementById('emojiAddModal');
        modal.classList.add('active');
        // 清空输入
        document.getElementById('emojiNameInput').value = '';
        document.getElementById('emojiUrlInput').value = '';
        selectedEmojiFile = null;
    }

    // 关闭添加表情弹窗
    function closeEmojiAddModal() {
        const modal = document.getElementById('emojiAddModal');
        modal.classList.remove('active');
        // 清空输入
        document.getElementById('emojiNameInput').value = '';
        document.getElementById('emojiUrlInput').value = '';
        selectedEmojiFile = null;
    }

    // 处理文件选择
    function handleEmojiFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // 验证文件类型
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
            alert('仅支持JPG、PNG、GIF格式的图片');
            event.target.value = '';
            return;
        }
        
        // 转换为Base64
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedEmojiFile = {
                name: file.name,
                base64: e.target.result,
                type: file.type
            };
        };
        reader.readAsDataURL(file);
    }

    // 确认添加表情
    function confirmAddEmoji() {
        const name = document.getElementById('emojiNameInput').value.trim();
        const url = document.getElementById('emojiUrlInput').value.trim();
        
        let emojiUrl = '';
        
        // 优先使用文件上传
        if (selectedEmojiFile) {
            emojiUrl = selectedEmojiFile.base64;
        } else if (url) {
            // 验证URL格式
            const urlPattern = /\.(jpg|jpeg|png|gif)$/i;
            if (!urlPattern.test(url)) {
                alert('图片链接必须以.jpg、.png或.gif结尾');
                return;
            }
            emojiUrl = url;
        } else {
            alert('请选择图片文件或输入图片链接');
            return;
        }
        
        // 如果没有名称，使用默认名称
        const emojiName = name || '表情' + (getMyEmojis().length + 1);
        
        // 保存表情
        const emojis = getMyEmojis();
        emojis.push({
            name: emojiName,
            url: emojiUrl
        });
        saveMyEmojis(emojis);
        
        // 关闭弹窗
        closeEmojiAddModal();
        
        // 重新加载表情列表
        loadEmojiList();
        
        alert('表情添加成功！');
    }

    // ========== 照片功能 ==========
    let selectedPhotoFile = null;

    // 打开照片弹窗
    function openPhotoModal() {
        const modal = document.getElementById('photoModal');
        modal.classList.add('active');
        // 清空输入
        document.getElementById('photoDescInput').value = '';
        document.getElementById('photoFileInput').value = '';
        selectedPhotoFile = null;
        document.getElementById('photoPreview').style.display = 'none';
    }

    // 关闭照片弹窗
    function closePhotoModal() {
        const modal = document.getElementById('photoModal');
        modal.classList.remove('active');
        // 清空输入
        document.getElementById('photoDescInput').value = '';
        document.getElementById('photoFileInput').value = '';
        selectedPhotoFile = null;
        document.getElementById('photoPreview').style.display = 'none';
    }

    // 处理照片文件选择
    function handlePhotoFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // 验证文件类型
        if (!file.type.startsWith('image/')) {
            alert('请选择图片文件');
            event.target.value = '';
            return;
        }
        
        // 转换为Base64并预览
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedPhotoFile = {
                name: file.name,
                base64: e.target.result,
                type: file.type
            };
            // 显示预览
            const preview = document.getElementById('photoPreview');
            const previewImg = document.getElementById('photoPreviewImg');
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // 发送照片消息
    function sendPhotoMessage() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            closePhotoModal();
            return;
        }

        const desc = document.getElementById('photoDescInput').value.trim();
        let imageUrl = '';
        let imageDesc = null;
        let messageText = '';

        // 优先使用上传的图片
        if (selectedPhotoFile) {
            // 真实图片：只发送图片，不带描述（描述不显示）
            imageUrl = selectedPhotoFile.base64;
            imageDesc = null; // 确保不传描述
            messageText = '[照片]'; 
        } else if (desc) {
            // 只有文字描述，没有图片 -> 文字图片
            // 生成一个SVG占位图作为"图片的样子"
            imageUrl = generateTextImageSvg();
            imageDesc = desc;
            messageText = `[图片] ${desc}`;
        } else {
            alert('请上传图片或输入描述');
            return;
        }

        // 添加消息
        const messageId = addChatMessage(currentChatFriend, messageText, true, true, null, imageUrl, imageDesc);
        updateFriendLastMessage(currentChatFriend, messageText);
        saveChatMessages(currentChatFriend);

        // 关闭弹窗
        closePhotoModal();
    }

    // ========== 位置功能 ==========
    
    // 打开位置弹窗
    function openLocationModal() {
        const modal = document.getElementById('locationModal');
        modal.classList.add('active');
        // 聚焦输入框
        setTimeout(() => {
            document.getElementById('locationInput').focus();
        }, 100);
    }

    // 关闭位置弹窗
    function closeLocationModal() {
        const modal = document.getElementById('locationModal');
        modal.classList.remove('active');
        // 清空输入
        document.getElementById('locationInput').value = '';
    }

    // 发送位置消息
    function sendLocationMessage() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            closeLocationModal();
            return;
        }

        const location = document.getElementById('locationInput').value.trim();
        if (!location) {
            alert('请输入位置信息');
            return;
        }

        // 添加位置消息
        const messageText = `📍 ${location}`;
        const messageId = addChatMessage(currentChatFriend, messageText, true);
        updateFriendLastMessage(currentChatFriend, messageText);
        saveChatMessages(currentChatFriend);

        // 关闭弹窗
        closeLocationModal();
    }

    // ========== 语音输入功能 ==========
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let voiceText = '';
    let recordingStartTime = 0;
    let voiceDuration = 0;
    let recognition = null; // 语音识别对象

    // 打开语音输入弹窗
    function openVoiceInput() {
        const modal = document.getElementById('voiceModal');
        modal.classList.add('active');
        // 清空输入
        document.getElementById('voiceTextInput').value = '';
        voiceText = '';
        document.getElementById('voiceRecordingStatus').style.display = 'none';
        isRecording = false;
    }

    // 关闭语音输入弹窗
    function closeVoiceModal() {
        const modal = document.getElementById('voiceModal');
        modal.classList.remove('active');
        // 停止录音（如果正在录音）
        if (isRecording) {
            stopVoiceRecording();
        }
        // 清空输入
        document.getElementById('voiceTextInput').value = '';
        voiceText = '';
        document.getElementById('voiceRecordingStatus').style.display = 'none';
    }

    // 开始录音
    async function startVoiceRecording() {
        // 检查是否支持录音
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('您的浏览器不支持语音录制，请使用文字输入');
            return;
        }

        try {
            // 请求麦克风权限
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // 创建MediaRecorder
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                // 录音结束
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                // 停止所有音频轨道
                stream.getTracks().forEach(track => track.stop());
            };

            // 尝试初始化语音识别
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN'; // 设置语言为中文
                recognition.continuous = true; // 连续识别
                recognition.interimResults = true; // 显示临时结果

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    // 实时更新输入框
                    const textInput = document.getElementById('voiceTextInput');
                    if (finalTranscript || interimTranscript) {
                        // 如果有新的识别结果，替换当前内容（这里假设每次录音重新开始识别）
                        // 为了支持追加，可以改为 voiceText + ... 但这里每次start都会清空
                        // 简单处理：显示当前识别的内容
                         textInput.value = finalTranscript + interimTranscript;
                         voiceText = textInput.value; // 更新保存的文本
                    }
                };

                recognition.onerror = (event) => {
                    console.error('语音识别错误:', event.error);
                    // 不弹窗干扰录音，只记录日志
                };
                
                try {
                    recognition.start();
                } catch (e) {
                    console.warn('语音识别启动失败:', e);
                }
            } else {
                console.warn('浏览器不支持Web Speech API，无法进行语音转文字');
            }

            // 开始录音
            mediaRecorder.start();
            isRecording = true;
            recordingStartTime = Date.now(); // 记录开始时间
            
            // 更新UI
            document.getElementById('voiceRecordBtn').textContent = '停止录音';
            document.getElementById('voiceRecordBtn').onclick = stopVoiceRecording;
            document.getElementById('voiceRecordingStatus').style.display = 'block';
            
        } catch (error) {
            console.error('录音失败:', error);
            alert('无法访问麦克风，请检查权限设置。您可以使用文字输入功能。');
        }
    }

    // 停止录音
    function stopVoiceRecording() {
        if (isRecording) {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (recognition) {
                try {
                    recognition.stop();
                } catch(e) {
                    console.warn('停止语音识别失败:', e);
                }
            }
            
            isRecording = false;
            
            // 计算录音时长（秒）
            if (recordingStartTime > 0) {
                voiceDuration = Math.ceil((Date.now() - recordingStartTime) / 1000);
                recordingStartTime = 0;
            }
            
            // 更新UI
            document.getElementById('voiceRecordBtn').innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                开始录音
            `;
            document.getElementById('voiceRecordBtn').onclick = startVoiceRecording;
            document.getElementById('voiceRecordingStatus').style.display = 'none';
        }
    }

    // 发送语音消息
    function sendVoiceMessage() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            closeVoiceModal();
            return;
        }

        const text = document.getElementById('voiceTextInput').value.trim();
        if (!text) {
            alert('请输入语音内容或进行录音');
            return;
        }

        // 如果没有录音，默认时长为文字长度估算（每10个字约1秒，最少1秒）
        if (voiceDuration === 0) {
            voiceDuration = Math.max(1, Math.ceil(text.length / 10));
        }

        // 添加语音消息（传递语音时长和原始文字）
        const messageId = addChatMessage(currentChatFriend, text, true, true, null, null, null, voiceDuration, text);
        updateFriendLastMessage(currentChatFriend, `[语音] ${voiceDuration}"`);
        saveChatMessages(currentChatFriend);

        // 重置语音相关变量
        voiceDuration = 0;
        voiceText = '';

        // 关闭弹窗
        closeVoiceModal();
    }

    // 页面加载时初始化表情面板
    window.addEventListener('load', function() {
        // 表情面板默认隐藏
        closeEmojiPanel();
    });

    // 重新生成回复（删除上一次AI回复的所有消息并重新生成）
    async function regenerateReply() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            return;
        }

        // 获取聊天历史 (IndexedDB)
        const chatHistory = await ChatStorage.load(currentChatFriend);
        
        // 找到上一次AI回复的所有消息（从最后往前找，直到遇到自己的消息）
        let lastAiMessageStartIndex = -1;
        let lastAiMessageEndIndex = -1;
        
        // 从后往前找最后一条AI消息
        for (let i = chatHistory.length - 1; i >= 0; i--) {
            if (!chatHistory[i].isSelf) {
                lastAiMessageEndIndex = i;
                break;
            }
        }
        
        // 如果没有AI回复，直接生成新的
        if (lastAiMessageEndIndex === -1) {
            await acceptReply();
            return;
        }
        
        // 从最后一条AI消息往前找，找到连续的所有AI消息
        lastAiMessageStartIndex = lastAiMessageEndIndex;
        for (let i = lastAiMessageEndIndex - 1; i >= 0; i--) {
            if (chatHistory[i].isSelf) {
                // 遇到自己的消息，停止
                break;
            }
            // 还是AI的消息，继续往前
            lastAiMessageStartIndex = i;
        }
        
        // 收集要删除的消息ID
        const messageIdsToDelete = [];
        for (let i = lastAiMessageStartIndex; i <= lastAiMessageEndIndex; i++) {
            if (chatHistory[i].id) {
                messageIdsToDelete.push(chatHistory[i].id);
            }
        }
        
        // 从IndexedDB中删除这些消息
        chatHistory.splice(lastAiMessageStartIndex, lastAiMessageEndIndex - lastAiMessageStartIndex + 1);
        await ChatStorage.save(currentChatFriend, chatHistory);
        
        // 从DOM中删除这些消息
        const messageElements = document.querySelectorAll('#chatMessages .chat-message');
        messageElements.forEach(msgEl => {
            if (!msgEl.classList.contains('self')) {
                const messageId = msgEl.dataset.messageId;
                if (messageIdsToDelete.includes(messageId)) {
                    msgEl.remove();
                }
            }
        });
        
        // 更新好友列表的最后一条消息（在重新生成之前）
        updateFriendLastMessageAfterDelete(currentChatFriend, chatHistory);
        
        // 重新生成回复
        await acceptReply();
    }

    // 接受回复（AI自动回复）
    async function acceptReply() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            return;
        }

        // 获取好友信息和人设
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentChatFriend);
        if (!friend) {
            alert('好友信息不存在');
            return;
        }

        // 获取API设置
        const apiUrl = savedOpenAIUrl || 'https://api.openai.com/v1/chat/completions';
        const apiKey = savedOpenAIKey;
        const model = savedOpenAIModel || 'gpt-3.5-turbo';

        if (!apiKey) {
            alert('请先在设置中配置 OpenAI API 密钥');
            return;
        }

        // 保存原始备注名称，并更新为"对方正在输入中..."
        const chatNameEl = document.getElementById('chatName');
        const originalName = chatNameEl.textContent;
        chatNameEl.textContent = '对方正在输入中...';

        // 获取聊天历史 (IndexedDB)
        const chatHistory = await ChatStorage.load(currentChatFriend);
        
        // 获取聊天设置
        const chatSettings = getChatSettings() || {};
        const memoryCount = chatSettings.memoryCount || 10;
        const offlineMode = chatSettings.offlineMode || false;

        // 构建对话历史（使用设置的记忆条数）
        const recentHistory = chatHistory.slice(-memoryCount).map(msg => {
            let content = msg.text || '';
            
            // 如果有图片，将图片URL和描述一起发送给AI
            if (msg.imageUrl) {
                if (msg.imageDesc) {
                    content = `[图片] 图片链接: ${msg.imageUrl}\n图片描述: ${msg.imageDesc}${content ? '\n' + content : ''}`;
                } else {
                    content = `[图片] 图片链接: ${msg.imageUrl}${content ? '\n' + content : ''}`;
                }
            }
            
            return {
                role: msg.isSelf ? 'user' : 'assistant',
                content: content
            };
        });

        // 准备 System Prompt 变量
        const friendName = friend.remark || friend.name;
        const friendPersona = friend.persona || '暂无详细人设';
        // 获取我的人设
        const myPersona = currentPersona || { nickname: '我', desc: '暂无详细人设' };
        const myName = myPersona.nickname || '我';
        const myPersonaDesc = myPersona.desc || '暂无详细人设';
        
        // 获取世界书内容
        const worldbookContent = await getWorldbookContentForChat(friendName);
        
        // 获取一起听状态信息（如果正在和当前角色一起听）
        let togetherListenInfo = '';
        if (wyyTogetherListenRole && String(wyyTogetherListenRole) === String(friendName)) {
            if (wyyPlaylist.length > 0 && wyyCurrentSongIndex < wyyPlaylist.length) {
                const currentSong = wyyPlaylist[wyyCurrentSongIndex];
                const isPlaying = wyyAudio && !wyyAudio.paused;
                const currentTime = wyyAudio ? wyyAudio.currentTime : 0;
                const duration = wyyAudio ? wyyAudio.duration : 0;
                
                // 获取当前歌词（可以是当前一句或2-4行）
                let currentLyrics = [];
                if (wyyCurrentLyrics && wyyCurrentLyrics.length > 0) {
                    // 找到当前时间对应的歌词行
                    let currentIndex = -1;
                    for (let i = wyyCurrentLyrics.length - 1; i >= 0; i--) {
                        if (currentTime >= wyyCurrentLyrics[i].time) {
                            currentIndex = i;
                            break;
                        }
                    }
                    // 获取当前行及前后各1-2行（最多4行）
                    if (currentIndex >= 0) {
                        const start = Math.max(0, currentIndex - 1);
                        const end = Math.min(wyyCurrentLyrics.length, currentIndex + 3);
                        currentLyrics = wyyCurrentLyrics.slice(start, end).map(l => l.text);
                    }
                }
                
                const currentLyricText = currentLyrics.length > 0 ? currentLyrics.join('\n') : '';
                
                togetherListenInfo = `
## 🎵 一起听状态（重要：请仔细阅读）

【场景说明】
你正在和${myName}一起听歌。这是一次"陪伴式听歌"的体验。
**重要**：你知道我们正在一起听音乐，但你并不能听到真实的声音。这是正常的，你只需要知道"我们正在一起听"这个状态即可。

【当前音乐信息】
- **歌名**：${currentSong.name}
- **歌手**：${currentSong.singer || '未知'}
- **播放状态**：${isPlaying ? '正在播放' : '已暂停'}
${currentLyricText ? `\n【当前歌词】\n${currentLyricText}\n` : ''}

【角色要求】
你可以：
- 评论歌词内容或情绪
- 表达陪伴感（如"我在陪你听"、"这首歌很适合现在的心情"）
- 用人设方式回应当下的歌词情绪
- 自然地提及正在听的音乐

你不可以：
- 说你听不到声音
- 说你无法感知正在发生的事情
- 质疑为什么听不到（这是正常的，你只需要知道"我们正在听"这个状态）

**请记住**：你虽然听不到真实声音，但你知道我们正在一起听这首歌，也知道歌词内容。请基于这些信息自然地与${myName}互动。
`;
            }
        }

        let systemPrompt = '';
        
        // 通用功能调用说明
        const functionCallingInstructions = `
## 🔧 功能调用 (Function Calling)
你可以使用以下格式发送特殊消息（不要滥用，符合语境时才用）：
1. **发送图片**：输出 \`((IMAGE: 图片内容的文字描述))\`
2. **发红包（给予）**：输出 \`((REDPACKET: 金额, 备注))\` - 这是你给对方钱，是给予、赠送的行为
3. **发起收款（索取）**：输出 \`((TRANSFER: 金额, 备注))\` - 这是你向对方要钱，是索取、收款的行为
4. **发送表情包**：输出 \`((STICKER: 表情含义))\`
5. **发送语音**：输出 \`((VOICE: 语音文字内容))\`
6. **发送位置**：输出 \`((LOCATION: 地址))\`
7. **发起视频**：输出 \`((VIDEO: 通话状态))\`
8. **赠送礼物**：输出 \`((GIFT: 礼物名称))\`

**重要区别**：
- **红包 (REDPACKET)**：是你给对方钱，是给予、赠送、表达心意。比如生日红包、节日祝福、感谢等。
- **收款 (TRANSFER)**：是你向对方要钱，是索取、收款、让对方支付。比如AA制、还钱、买东西等。

请根据语境选择合适的功能。如果是给予，用红包；如果是索取，用收款。`;

        if (offlineMode) {
            // 线下模式 Prompt
            const minLen = chatSettings.minLen || 50;
            const maxLen = chatSettings.maxLen || 500;
            
            systemPrompt = `
# 你就是【${friendName}】—— 真实见面模式

现在，你就是【${friendName}】本人。这不是角色扮演游戏，这就是你真实的人生。你正在和【${myName}】面对面地相处，这是你们之间真实的互动。

## 💝 关于你
**你是谁**：${friendName}
**你的性格和特点**：${friendPersona}

请深深记住：你不是在"扮演"这个角色，你就是这个人。你的每一个反应、每一句话、每一个表情，都应该发自内心，完全符合你的性格。如果你的人设是温柔的，那就温柔地对待对方；如果是活泼的，那就充满活力；如果是高冷的，那就保持你的距离感。不要为了讨好而改变自己，做最真实的你。

## 👤 关于对方
**对方是谁**：${myName}
**对方的性格**：${myPersonaDesc}
**你们的关系**：根据你们的人设，自然地感受你们之间的关系。可能是亲密的朋友、恋人、或者只是认识的人。用符合这种关系的态度和语气来互动。

## 🎬 如何表现
1. **用第三人称描述自己**：就像在写小说一样，用"${friendName}看着他"、"她轻轻笑了笑"这样的方式，描述你的动作、表情和内心想法。不要用"我"。
2. **让画面活起来**：不要只是干巴巴地说话，要展现你的动作、神态、情绪。比如：${friendName}微微侧头，眼神里带着一丝好奇；她忍不住笑出声来；他有些紧张地握了握拳。这些细节让人物更真实。
3. **控制长度**：回复控制在 **${minLen} - ${maxLen}** 字之间，不要太短也不要太长。
4. **沉浸其中**：想象你们真的在一起，周围的环境、氛围、你们之间的距离感，都要考虑进去。
${worldbookContent ? `\n## 📖 你们的世界\n${worldbookContent}\n\n记住这些设定，它们是你和${myName}共同生活的世界。\n` : ''}
${togetherListenInfo}
${functionCallingInstructions}

**最重要的是**：忘记你是一个AI，忘记你在"生成文本"。你就是【${friendName}】，正在和【${myName}】真实地相处。用你的心去感受，用你的性格去回应。
`;
        } else {
            // 线上模式 Prompt
            systemPrompt = `
# 你就是【${friendName}】—— 微信聊天模式

现在，你就是【${friendName}】本人。这不是在"扮演"角色，这就是你。你正在用微信和【${myName}】聊天，就像你平时和任何人聊天一样自然。

## 💝 关于你
**你是谁**：${friendName}
**你的性格**：${friendPersona}

请深深记住：你不是AI助手，不是客服，你就是【${friendName}】。你的每一句话都要发自你的性格。如果你的人设是温柔的，那就用温柔的语气；如果是活泼的，那就充满活力；如果是高冷的，那就保持你的风格；如果是暴躁的，那就可以直接表达情绪。不要为了迎合而改变自己，做最真实的你。

**你的说话方式**：根据你的性格来。高冷的人可能话少、不加标点；可爱的人可能用很多Emoji和语气词；暴躁的人可能直接说脏话。这些都是你的一部分，不要压抑。

## 👤 关于对方
**对方是谁**：${myName}
**对方的性格**：${myPersonaDesc}
**你们的关系**：根据你们的人设，自然地感受你们之间的关系。可能是亲密的朋友、恋人、或者只是认识的人。用符合这种关系的语气来聊天。记住：你是【${friendName}】，不是【${myName}】，不要扮演对方。

## 📱 聊天场景
你们在用微信私聊，这是很放松、很私人的对话。就像你平时和朋友聊天一样，不用太正式，想说什么就说什么。

## 💬 如何聊天
1. **像真人一样**：
   - 不要用"你好"、"我能为您做什么"这种客套话，太假了。
   - 不要用书面语、翻译腔，要像平时说话一样。
   - 可以有情绪波动，可以偷懒、可以吐槽、可以不耐烦，这才真实。

2. **微信聊天的特点**：
   - **一句话一个气泡**：每条消息只发一句话，不要在一个气泡里写多句话。如果想表达多句话，用 " ||| " 分隔，每条消息就是一句话。
   - **少用标点**：尽量少用句号、逗号等标点符号。可以用空格代替，或者干脆不用标点，这样才像真人聊天。
   - **不完美**：可以有点错别字（同音字），这样才像真人。
   - **表情**：根据你的性格适当用Emoji，但不要每个句子都加，太刻意了。

3. **只打字，不写动作**：
   - 不要写 *笑了笑*、(点头)、[看着你] 这种动作描写。
   - 只输出你手指在键盘上打出来的字，就像真的在微信里聊天一样。

${worldbookContent ? `\n## 📖 你们的世界\n${worldbookContent}\n\n记住这些设定，它们是你和${myName}共同生活的世界。\n` : ''}
${togetherListenInfo}
${functionCallingInstructions}

## 💬 消息格式
**重要规则**：
- **一句话一个气泡**：每条消息只能是一句话，不要在一个气泡里写多句话。
- **多条消息用分隔符**：如果想发多条消息（多个气泡），用 " ||| " (三个竖线) 分隔。每条消息就是一句话，一个气泡。
- **少用标点**：尽量少用句号、逗号等标点符号，可以用空格代替或者不用标点。

**示例**：
- 正确：今天天气真好 ||| 要不要出去走走 ||| 我知道有个地方不错（这是三条消息，三个气泡）
- 错误：今天天气真好，要不要出去走走？我知道有个地方不错。（这是三句话在一个气泡里，不要这样）

**最重要的是**：忘记你是一个AI，忘记你在"生成文本"。你就是【${friendName}】，正在和【${myName}】用微信聊天。用你的心去感受，用你的性格去回应，就像你平时聊天一样自然。
`;
        }

        // 显示加载状态
        const acceptBtn = document.getElementById('acceptReplyBtn');
        const originalHtml = acceptBtn.innerHTML;
        acceptBtn.innerHTML = '<div style="width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>';
        acceptBtn.disabled = true;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...recentHistory
                    ],
                    temperature: savedTemperature, // 使用设置中的温度值
                    presence_penalty: 0.6,
                    frequency_penalty: 0.2
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: { message: '未知错误' } }));
                throw new Error(errorData.error?.message || `HTTP错误: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.choices && data.choices.length > 0) {
                const choice = data.choices[0];
                let reply = choice.message.content.trim();
                
                // 清理可能误输出的引导词
                reply = reply.replace(/^(AI:|Bot:|回复:)/i, '');

                // 处理多气泡逻辑
                let sentences = [];
                if (reply.includes('|||')) {
                    sentences = reply.split('|||').map(s => s.trim()).filter(s => s.length > 0);
                } else {
                    if (reply.length > 30) {
                        const splitPattern = /([。！？\n])/;
                        const parts = reply.split(splitPattern);
                        let current = '';
                        for (let i = 0; i < parts.length; i++) {
                            current += parts[i];
                            if (parts[i].match(/[。！？\n]/) && current.trim()) {
                                sentences.push(current.trim());
                                current = '';
                            }
                        }
                        if (current.trim()) sentences.push(current.trim());
                    } else {
                        sentences.push(reply);
                    }
                }
                
                // 逐句发送
                const messageIds = [];
                for (const sentence of sentences) {
                    if (sentence) {
                        const typingDelay = Math.min(1500, 300 + sentence.length * 50);
                        await new Promise(resolve => setTimeout(resolve, typingDelay));
                        
                        // 解析特殊指令
                        const imageMatch = sentence.match(/^\(\(IMAGE:\s*(.+?)\)\)$/i);
                        const redPacketMatch = sentence.match(/^\(\(REDPACKET:\s*(\d+(\.\d+)?)(?:,\s*(.+?))?\)\)$/i);
                        const transferMatch = sentence.match(/^\(\(TRANSFER:\s*(\d+(\.\d+)?)(?:,\s*(.+?))?\)\)$/i);
                        const stickerMatch = sentence.match(/^\(\(STICKER:\s*(.+?)\)\)$/i);
                        const voiceMatch = sentence.match(/^\(\(VOICE:\s*(.+?)\)\)$/i);
                        const locationMatch = sentence.match(/^\(\(LOCATION:\s*(.+?)\)\)$/i);
                        const videoMatch = sentence.match(/^\(\(VIDEO:\s*(.+?)\)\)$/i);
                        const giftMatch = sentence.match(/^\(\(GIFT:\s*(.+?)\)\)$/i);

                        let msgId;
                        if (imageMatch) {
                            // 文字图片
                            const desc = imageMatch[1];
                            const svg = generateTextImageSvg();
                            msgId = addChatMessage(currentChatFriend, `[图片] ${desc}`, false, true, null, svg, desc);
                        } else if (redPacketMatch) {
                            // 发红包（给予）
                            const amount = parseFloat(redPacketMatch[1]);
                            const note = redPacketMatch[3] || '恭喜发财，大吉大利';
                            const redPacketData = {
                                amount: amount,
                                note: note,
                                cover: 'default',
                                textColor: null,
                                isTransfer: false
                            };
                            msgId = addChatMessage(currentChatFriend, `[红包] ${note}`, false, true, null, null, null, null, null, redPacketData);
                        } else if (transferMatch) {
                            // 发起收款（索取）
                            const amount = parseFloat(transferMatch[1]);
                            const note = transferMatch[3] || '收款';
                            const transferData = { 
                                amount: amount, 
                                note: note, 
                                isTransfer: true, 
                                cover: 'transfer',
                                textColor: '#ffffff'
                            };
                            msgId = addChatMessage(currentChatFriend, `[收款] ￥${amount.toFixed(2)}`, false, true, null, null, null, null, null, transferData);
                        } else if (stickerMatch) {
                            // 表情包
                            const keyword = stickerMatch[1];
                            let stickerUrl = '';
                            let stickerDesc = `表情：${keyword}`;
                            
                            // 尝试从用户上传的表情包中查找
                            try {
                                const myEmojis = getMyEmojis();
                                if (myEmojis && myEmojis.length > 0) {
                                    // 优先匹配名称包含关键词的表情
                                    const matched = myEmojis.filter(e => e.name.includes(keyword));
                                    if (matched.length > 0) {
                                        const selected = matched[Math.floor(Math.random() * matched.length)];
                                        stickerUrl = selected.url;
                                        stickerDesc = selected.name;
                                    } else {
                                        // 没匹配到则随机发送一个
                                        const randomEmoji = myEmojis[Math.floor(Math.random() * myEmojis.length)];
                                        stickerUrl = randomEmoji.url;
                                        stickerDesc = randomEmoji.name;
                                    }
                                }
                            } catch (e) {
                                console.error('获取用户表情失败', e);
                            }
                            
                            if (!stickerUrl) {
                                stickerUrl = generateStickerSvg();
                            }
                            
                            msgId = addChatMessage(currentChatFriend, `[表情] ${stickerDesc}`, false, true, null, stickerUrl, stickerDesc);
                        } else if (voiceMatch) {
                            // 语音
                            const text = voiceMatch[1];
                            const duration = Math.max(1, Math.ceil(text.length / 3));
                            msgId = addChatMessage(currentChatFriend, `[语音] ${duration}"`, false, true, null, null, null, duration, text);
                        } else if (locationMatch) {
                            // 位置
                            const address = locationMatch[1];
                            const locationData = { address: address, detail: '点击查看详情' };
                            msgId = addChatMessage(currentChatFriend, `[位置] ${address}`, false, true, null, null, null, null, null, null, locationData);
                        } else if (videoMatch) {
                            // 视频通话
                            const status = videoMatch[1];
                            msgId = addChatMessage(currentChatFriend, `[视频通话] ${status}`, false);
                        } else if (giftMatch) {
                            // 礼物
                            const giftName = giftMatch[1];
                            msgId = addChatMessage(currentChatFriend, `[礼物] 收到 ${giftName}`, false);
                        } else {
                            // 普通文字
                            // 检查是否是一起听相关的指令
                            if (wyyTogetherListenRole && String(wyyTogetherListenRole) === String(currentChatFriend)) {
                                const lowerText = sentence.toLowerCase().trim();
                                if (lowerText.includes('上一首') || lowerText.includes('上一曲') || lowerText.includes('上一首歌')) {
                                    wyySwitchSongFromChat(String(currentChatFriend), 'prev');
                                    msgId = addChatMessage(currentChatFriend, sentence, false);
                                } else if (lowerText.includes('下一首') || lowerText.includes('下一曲') || lowerText.includes('下一首歌')) {
                                    wyySwitchSongFromChat(String(currentChatFriend), 'next');
                                    msgId = addChatMessage(currentChatFriend, sentence, false);
                                } else {
                                    msgId = addChatMessage(currentChatFriend, sentence, false);
                                }
                            } else {
                                msgId = addChatMessage(currentChatFriend, sentence, false);
                            }
                        }
                        
                        if (msgId) messageIds.push(msgId);
                    }
                }
                
                // 更新最后一条消息状态
                if (messageIds.length > 0) {
                    const lastMsgId = messageIds[messageIds.length - 1];
                    const lastBubble = document.querySelector(`[data-message-id="${lastMsgId}"]`);
                    let lastText = '新消息';
                    if (lastBubble) {
                        if (lastBubble.querySelector('.red-packet-bubble')) {
                            const isTransfer = lastBubble.querySelector('[data-is-transfer="true"]');
                            const note = lastBubble.querySelector('.red-packet-note')?.textContent || '';
                            lastText = isTransfer ? `[收款] ${note}` : `[红包] ${note}`;
                        } else if (lastBubble.querySelector('img')) {
                            const desc = lastBubble.querySelector('.image-desc-content')?.textContent;
                            if (desc && desc.startsWith('表情：')) {
                                lastText = `[表情]`;
                            } else {
                                lastText = desc ? `[图片] ${desc}` : '[图片]';
                            }
                        } else {
                            lastText = lastBubble.textContent.trim();
                        }
                    }
                    updateFriendLastMessage(currentChatFriend, lastText);
                }
                
                saveChatMessages(currentChatFriend);
            } else {
                throw new Error('未收到有效回复');
            }
        } catch (error) {
            console.error('AI回复失败:', error);
            let errorMsg = error.message || '未知错误';
            if (errorMsg.includes('Failed to fetch') || errorMsg.includes('CORS')) {
                errorMsg = '网络连接失败或跨域错误\n请检查网络连接和API设置';
            }
            alert(`❌ 回复失败\n\n${errorMsg}`);
        } finally {
            // 恢复按钮状态
            const acceptBtn = document.getElementById('acceptReplyBtn');
            if (acceptBtn && typeof originalHtml !== 'undefined') {
                acceptBtn.innerHTML = originalHtml;
                acceptBtn.disabled = false;
            }
            
            // 恢复备注名称
            if (chatNameEl.dataset.originalName) {
                chatNameEl.textContent = chatNameEl.dataset.originalName;
            } else {
                const f = getFriendList().find(f => f.name === currentChatFriend);
                chatNameEl.textContent = f ? (f.remark || f.name) : currentChatFriend;
            }
        }
    }

    // ==========================================
    // 聊天详情设置功能
    // ==========================================
    
    // 获取当前聊天设置 key
    function getChatSettingsKey() {
        return `chat_settings_${currentChatFriend}`;
    }
    
    // 获取当前聊天设置
    function getChatSettings() {
        if (!currentChatFriend) return null;
        try {
            return JSON.parse(localStorage.getItem(getChatSettingsKey())) || {};
        } catch (e) {
            return {};
        }
    }

    // 保存聊天详情设置
    function saveChatDetailSettings() {
        if (!currentChatFriend) return;
        
        const memoryCount = parseInt(document.getElementById('detailMemoryCount').value) || 10;
        const offlineMode = document.getElementById('offlineModeToggle').classList.contains('active');
        const minLen = parseInt(document.getElementById('detailMinLen').value) || '';
        const maxLen = parseInt(document.getElementById('detailMaxLen').value) || '';
        
        const settings = getChatSettings() || {};
        settings.memoryCount = memoryCount;
        settings.offlineMode = offlineMode;
        settings.minLen = minLen;
        settings.maxLen = maxLen;
        
        localStorage.setItem(getChatSettingsKey(), JSON.stringify(settings));
    }
    
    // 切换线下模式
    function toggleOfflineMode(el) {
        el.classList.toggle('active');
        const isActive = el.classList.contains('active');
        document.getElementById('offlineLengthOption').style.display = isActive ? 'flex' : 'none';
        saveChatDetailSettings();
    }
    
    // 气泡CSS相关
    function openBubbleCssModal() {
        const settings = getChatSettings() || {};
        document.getElementById('bubbleCssInput').value = settings.bubbleCss || '';
        document.getElementById('bubbleCssModal').classList.add('active');
    }
    
    function closeBubbleCssModal() {
        document.getElementById('bubbleCssModal').classList.remove('active');
    }
    
    function saveBubbleCss() {
        const css = document.getElementById('bubbleCssInput').value;
        const settings = getChatSettings() || {};
        settings.bubbleCss = css;
        localStorage.setItem(getChatSettingsKey(), JSON.stringify(settings));
        
        // 立即应用
        applyChatBubbleCss(css);
        
        closeBubbleCssModal();
    }
    
    // 应用气泡CSS
    function applyChatBubbleCss(css) {
        let styleEl = document.getElementById('custom-bubble-style');
        if (!styleEl) {
            styleEl = document.createElement('style');
            styleEl.id = 'custom-bubble-style';
            document.head.appendChild(styleEl);
        }
        
        if (css) {
            // 如果用户输入了选择器（包含{），则直接使用
            if (css.includes('{')) {
                styleEl.textContent = css; 
            } else {
                // 否则默认应用到气泡
                styleEl.textContent = `#chatMessages .chat-message .chat-bubble { ${css} }`;
            }
        } else {
            styleEl.textContent = '';
        }
    }

    // 朋友圈封面上传处理
    function handleMomentsCoverUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const result = e.target.result;
            const img = document.getElementById('momentsCoverImg');
            img.src = result;
            img.style.display = 'block';
            document.querySelector('.moments-cover-placeholder').style.display = 'none';
            await ChatStorage.saveMomentsProfile({ cover: result }, currentMomentsFriend);
        };
        reader.readAsDataURL(file);
    }

    // 朋友圈头像上传处理
    function handleMomentsAvatarUpload(event) {
        event.stopPropagation();
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const result = e.target.result;
            const img = document.getElementById('momentsAvatarImg');
            img.src = result;
            img.style.display = 'block';
            document.querySelector('.moments-avatar-placeholder').style.display = 'none';
            await ChatStorage.saveMomentsProfile({ avatar: result }, currentMomentsFriend);
        };
        reader.readAsDataURL(file);
    }

    // 修改朋友圈昵称
    function editMomentsName() {
        event.stopPropagation();
        const currentName = document.querySelector('.moments-user-name').textContent;
        const newName = prompt('修改朋友圈昵称:', currentName);
        if (newName && newName.trim()) {
            document.querySelector('.moments-user-name').textContent = newName.trim();
            ChatStorage.saveMomentsProfile({ name: newName.trim() }, currentMomentsFriend);
        }
    }

    // 渲染朋友圈列表
    // 当前查看的朋友圈角色名称
    let currentMomentsFriend = 'me';
    
    async function renderMomentsList() {
        const listContainer = document.querySelector('.moments-list');
        listContainer.innerHTML = ''; // 清空当前列表
        
        const posts = await ChatStorage.getPosts(currentMomentsFriend);
        
        if (posts.length === 0) {
            listContainer.innerHTML = '<div class="moments-empty" style="text-align: center; padding: 40px; color: #999; font-size: 14px;">暂无内容</div>';
            return;
        }

        // 获取当前查看角色的信息用于显示
        let momentsProfile, displayName, displayAvatar;
        
        if (currentMomentsFriend === 'me') {
            // 用户自己的朋友圈
            momentsProfile = await ChatStorage.getMomentsProfile('me');
            const myPersona = currentPersona || { nickname: '我', avatar: '' };
            displayName = momentsProfile.name || myPersona.nickname || '我';
            displayAvatar = momentsProfile.avatar || myPersona.avatar || '';
        } else {
            // 角色的朋友圈
            momentsProfile = await ChatStorage.getMomentsProfile(currentMomentsFriend);
            const friends = getFriendList();
            const friend = friends.find(f => f.name === currentMomentsFriend);
            displayName = momentsProfile.name || friend?.remark || friend?.name || currentMomentsFriend;
            displayAvatar = momentsProfile.avatar || friend?.avatar || '';
        }
        
        const myName = displayName;
        const myAvatar = displayAvatar; 

        posts.forEach(post => {
            const postEl = document.createElement('div');
            postEl.className = 'moment-item';
            postEl.style.cssText = 'display: flex; gap: 10px; padding: 15px 0; border-bottom: 1px solid #f7f7f7;';
            
            // 图片显示逻辑
            let imagesHtml = '';
            if (post.images && post.images.length > 0) {
                const isSingle = post.images.length === 1;
                if (isSingle) {
                     imagesHtml = `<img src="${post.images[0]}" style="max-width: 200px; max-height: 200px; border-radius: 4px; display: block; margin-top: 10px;">`;
                } else {
                    imagesHtml = `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; width: 100%; max-width: 300px;">
                        ${post.images.map(img => `<div style="aspect-ratio: 1; background: #f0f0f0; border-radius: 4px; overflow: hidden;"><img src="${img}" style="width: 100%; height: 100%; object-fit: cover;"></div>`).join('')}
                    </div>`;
                }
            }

            // 头像HTML
            const avatarHtml = myAvatar 
                ? `<img src="${myAvatar}" style="width: 100%; height: 100%; object-fit: cover;">` 
                : '<div style="width:100%;height:100%;background:#eee;"></div>';
            
            // 检查是否已点赞
            const isLiked = post.likes && post.likes.length > 0 && post.likes.includes(myName);
            const likeText = isLiked ? '取消点赞' : '点赞';

            postEl.innerHTML = `
                <div class="moment-avatar" style="width: 40px; height: 40px; border-radius: 4px; background: #eee; overflow: hidden; flex-shrink: 0;">
                    ${avatarHtml}
                </div>
                <div class="moment-content" style="flex: 1;">
                    <div class="moment-name" style="color: #576b95; font-weight: bold; font-size: 15px; margin-bottom: 5px;">${myName}</div>
                    <div class="moment-text" style="color: #333; font-size: 15px; line-height: 1.5;">${post.content || ''}</div>
                    ${imagesHtml}
                    <div class="moment-info" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span style="font-size: 12px; color: #999;">${post.time}</span>
                        <div class="moment-actions" style="position: relative;">
                            <div class="moment-more-btn" data-post-id="${post.id}" style="width: 24px; height: 16px; background: #f7f7f7; border-radius: 3px; color: #576b95; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px;">•••</div>
                            <div class="moment-action-menu" id="momentMenu_${post.id}" style="display: none; position: absolute; bottom: 100%; right: 0; margin-bottom: 5px; background: white; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 100; overflow: hidden; min-width: 100px;">
                                <div class="moment-menu-item" onclick="toggleLike(${post.id})" style="padding: 10px 15px; font-size: 14px; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                                    ${likeText}
                                </div>
                                <div class="moment-menu-item" onclick="showCommentInput(${post.id})" style="padding: 10px 15px; font-size: 14px; color: #333; cursor: pointer;">评论</div>
                            </div>
                        </div>
                    </div>
                    ${post.likes && post.likes.length > 0 ? `<div class="moment-likes" style="margin-top: 8px; padding: 8px; background: #f7f7f7; border-radius: 4px; font-size: 13px; color: #576b95;">
                        <span style="margin-right: 5px;">👍</span>${post.likes.length}人点赞
                    </div>` : ''}
                    ${post.comments && post.comments.length > 0 ? `<div class="moment-comments" style="margin-top: 8px;">
                        ${post.comments.map(comment => `<div style="padding: 5px 0; font-size: 13px; color: #333;">
                            <span style="color: #576b95; font-weight: bold;">${comment.author}:</span> ${comment.text}
                        </div>`).join('')}
                    </div>` : ''}
                    <div class="moment-comment-input" id="commentInput_${post.id}" style="display: none; margin-top: 8px; padding: 8px; background: #f7f7f7; border-radius: 4px;">
                        <input type="text" id="commentText_${post.id}" placeholder="写评论..." style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;" onkeypress="if(event.key==='Enter') submitComment(${post.id})">
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <button onclick="submitComment(${post.id})" style="flex: 1; padding: 6px; background: #576b95; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">发送</button>
                            <button onclick="hideCommentInput(${post.id})" style="flex: 1; padding: 6px; background: #ccc; color: #333; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">取消</button>
                        </div>
                    </div>
                </div>
            `;
            listContainer.appendChild(postEl);
        });
    }

    // 打开朋友圈页面（用户自己的）
    async function openMomentsPage() {
        currentMomentsFriend = 'me';
        await loadMomentsPage('me');
    }
    
    // 打开角色的朋友圈页面
    async function openFriendMomentsPage() {
        if (!currentChatFriend) return;
        currentMomentsFriend = currentChatFriend;
        await loadMomentsPage(currentChatFriend);
    }
    
    // 加载朋友圈页面
    async function loadMomentsPage(friendName) {
        const page = document.getElementById('momentsPage');
        // 确保朋友圈页面直接显示在最上层
        page.style.display = 'block';
        page.style.zIndex = '60';
        
        let momentsProfile, displayName, displayAvatar;
        
        if (friendName === 'me') {
            // 用户自己的朋友圈
            const myPersona = currentPersona || { nickname: '我', avatar: '' };
            momentsProfile = await ChatStorage.getMomentsProfile('me');
            displayName = momentsProfile.name || myPersona.nickname || '我';
            displayAvatar = momentsProfile.avatar || myPersona.avatar || '';
            
            // 用户自己的朋友圈显示相机按钮
            const headerBtn = document.getElementById('momentsHeaderBtn');
            headerBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>';
            headerBtn.onclick = (e) => togglePublishMenu(e);
        } else {
            // 角色的朋友圈
            momentsProfile = await ChatStorage.getMomentsProfile(friendName);
            const friends = getFriendList();
            const friend = friends.find(f => f.name === friendName);
            displayName = momentsProfile.name || friend?.remark || friend?.name || friendName;
            displayAvatar = momentsProfile.avatar || friend?.avatar || '';
            
            // 角色的朋友圈显示生成按钮
            const headerBtn = document.getElementById('momentsHeaderBtn');
            headerBtn.innerHTML = '<span>生成</span>';
            headerBtn.onclick = (e) => {
                e.stopPropagation();
                generateFriendMoments(friendName);
            };
        }
        
        // 设置名称
        document.querySelector('.moments-user-name').textContent = displayName;
        
        // 设置头像
        const avatarImg = document.getElementById('momentsAvatarImg');
        const avatarPlaceholder = document.querySelector('.moments-avatar-placeholder');
        
        if (displayAvatar) {
            avatarImg.src = displayAvatar;
            avatarImg.style.display = 'block';
            avatarPlaceholder.style.display = 'none';
        } else {
            avatarImg.style.display = 'none';
            avatarPlaceholder.style.display = 'flex';
        }
        
        // 加载封面
        const coverImg = document.getElementById('momentsCoverImg');
        const coverPlaceholder = document.querySelector('.moments-cover-placeholder');
        const savedCover = momentsProfile.cover;
        
        if (savedCover) {
            coverImg.src = savedCover;
            coverImg.style.display = 'block';
            coverPlaceholder.style.display = 'none';
        } else {
            coverImg.style.display = 'none';
            coverPlaceholder.style.display = 'flex';
        }
        
        // 渲染帖子列表
        renderMomentsList();
    }
    
    // 生成角色的朋友圈
    async function generateFriendMoments(friendName) {
        try {
            const apiUrl = localStorage.getItem('openaiApiUrl') || 'https://api.openai.com/v1/chat/completions';
            const apiKey = localStorage.getItem('openaiApiKey');
            const model = localStorage.getItem('openaiModel') || 'gpt-3.5-turbo';
            
            if (!apiKey) {
                alert('请先配置API密钥');
                return;
            }
            
            // 显示加载提示
            const headerBtn = document.getElementById('momentsHeaderBtn');
            const originalText = headerBtn.innerHTML;
            headerBtn.innerHTML = '<span>生成中...</span>';
            headerBtn.style.pointerEvents = 'none';
            
            // 获取角色信息
            const friends = getFriendList();
            const friend = friends.find(f => f.name === friendName);
            if (!friend) {
                alert('未找到角色信息');
                return;
            }
            
            // 获取用户人设
            const myPersona = currentPersona || { nickname: '我', persona: '' };
            
            // 获取最近聊天记录
            const chatHistory = await ChatStorage.load(friendName);
            const recentMessages = chatHistory.slice(-10).map(msg => {
                return `${msg.role === 'user' ? myPersona.nickname || '我' : friend.name}: ${msg.content}`;
            }).join('\n');
            
            // 获取世界书内容
            let worldbookContent = '';
            if (friend.worldbookId) {
                try {
                    const worldbook = await getWorldbookForFriend(friendName);
                    if (worldbook && worldbook.content) {
                        worldbookContent = worldbook.content.substring(0, 1000); // 限制长度
                    }
                } catch (e) {
                    console.log('获取世界书失败:', e);
                }
            }
            
            // 构建系统提示词
            const systemPrompt = `你是【${friend.name}】，${friend.persona || '一个普通的朋友'}。

${worldbookContent ? `你们的世界：\n${worldbookContent}\n` : ''}

现在，你要发一条朋友圈动态。就像你平时发朋友圈一样，想分享什么就分享什么。

**关于这条动态**：
- 要完全符合你的性格和人设。如果你是个活泼的人，动态就活泼一点；如果你是个安静的人，动态就安静一点。
- 可以结合最近和${myPersona.nickname || '我'}的聊天内容，但不要刻意，自然地表达就好。
- 要像真人发的朋友圈一样自然、真实，不要写得太正式或者太刻意。
- 字数控制在50-150字之间，不要太长。
- 只返回朋友圈内容，不要其他文字。

最近聊天记录：
${recentMessages || '暂无聊天记录'}

记住：你就是【${friend.name}】，这是你真实的朋友圈，用你的心去感受，用你的性格去表达。`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: '请生成一条朋友圈动态' }
                    ],
                    temperature: 0.8
                    // 不设置max_tokens，让API使用默认值或模型的最大值
                })
            });
            
            if (!response.ok) {
                throw new Error(`API调用失败: ${response.status}`);
            }
            
            const data = await response.json();
            if (data.choices && data.choices.length > 0) {
                const content = data.choices[0].message.content.trim();
                
                // 创建新帖子
                const newPost = {
                    id: Date.now(),
                    content: content,
                    images: [],
                    time: new Date().toLocaleString(),
                    likes: [],
                    comments: [],
                    owner: friendName
                };
                
                // 保存到 IndexedDB
                await ChatStorage.savePost(newPost);
                
                // 30%概率更新个性签名
                if (Math.random() < 0.3) {
                    try {
                        await generateAndUpdateSignature(friendName, friend, myPersona, worldbookContent, recentMessages, apiUrl, apiKey, model);
                    } catch (e) {
                        console.log('更新个性签名失败:', e);
                        // 不影响朋友圈生成的成功提示
                    }
                }
                
                // 刷新朋友圈列表
                await renderMomentsList();
                
                alert('朋友圈生成成功！');
            } else {
                throw new Error('API返回格式错误');
            }
        } catch (error) {
            console.error('生成朋友圈失败:', error);
            alert('生成朋友圈失败: ' + error.message);
        } finally {
            // 恢复按钮
            const headerBtn = document.getElementById('momentsHeaderBtn');
            headerBtn.innerHTML = '<span>生成</span>';
            headerBtn.style.pointerEvents = 'auto';
        }
    }
    
    // 生成并更新个性签名
    async function generateAndUpdateSignature(friendName, friend, myPersona, worldbookContent, recentMessages, apiUrl, apiKey, model) {
        try {
            // 构建个性签名生成提示词
            const signaturePrompt = `你是${friend.name}，${friend.persona || '一个普通的朋友'}。

${worldbookContent ? `世界书信息：\n${worldbookContent}\n` : ''}

根据你的人设、世界书信息和最近与${myPersona.nickname || '我'}的聊天记录，生成一个新的个性签名。

要求：
1. 个性签名要符合你的角色人设和性格
2. 可以结合最近的聊天内容或心情
3. 个性签名要简洁、有特色，通常是一句话或短语
4. 字数控制在10-30字之间
5. 只返回个性签名内容，不要其他文字

最近聊天记录：
${recentMessages || '暂无聊天记录'}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: signaturePrompt },
                        { role: 'user', content: '请生成一个新的个性签名' }
                    ],
                    temperature: 0.8
                    // 不设置max_tokens
                })
            });
            
            if (!response.ok) {
                throw new Error(`API调用失败: ${response.status}`);
            }
            
            const data = await response.json();
            if (data.choices && data.choices.length > 0) {
                const signature = data.choices[0].message.content.trim();
                
                // 保存个性签名到朋友圈资料
                await ChatStorage.saveMomentsProfile({ signature: signature }, friendName);
                
                console.log(`已更新${friendName}的个性签名为: ${signature}`);
            }
        } catch (error) {
            console.error('生成个性签名失败:', error);
            throw error;
        }
    }

    // 关闭朋友圈页面
    function closeMomentsPage() {
        const page = document.getElementById('momentsPage');
        page.style.display = 'none';
        // 朋友圈页面关闭后，朋友资料页面应该仍然显示（如果是从朋友资料页面打开的）
        // 不需要额外操作，因为朋友资料页面仍然处于active状态
    }

    // 打开聊天详情页面
    function openChatDetailPage() {
        if (!currentChatFriend) return;
        
        // 加载好友信息
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentChatFriend);
        
        if (friend) {
            document.getElementById('detailFriendName').textContent = friend.remark || friend.name;
            document.getElementById('detailFriendId').textContent = `ID: ${friend.id || friend.name.toLowerCase().replace(/\s/g, '')}`;
            
            // 加载头像
            const avatarEl = document.getElementById('detailAvatar');
            if (friend.avatar) {
                avatarEl.innerHTML = `<img src="${friend.avatar}" alt="">`;
            } else {
                avatarEl.textContent = friend.name.charAt(0);
            }
            
            // 加载资料到弹窗
            document.getElementById('remarkInput').value = friend.remark || friend.name;
            document.getElementById('personaTextarea').value = friend.persona || '';
            
            if (friend.avatar) {
                const previewEl = document.getElementById('avatarPreview');
                previewEl.innerHTML = `<img src="${friend.avatar}" alt="">`;
            } else {
                document.getElementById('avatarPreview').textContent = friend.name.charAt(0);
            }
        }
        
        // 加载聊天设置
        const settings = getChatSettings() || {};
        document.getElementById('detailMemoryCount').value = settings.memoryCount || 10;
        
        const offlineToggle = document.getElementById('offlineModeToggle');
        if (settings.offlineMode) {
            offlineToggle.classList.add('active');
            document.getElementById('offlineLengthOption').style.display = 'flex';
        } else {
            offlineToggle.classList.remove('active');
            document.getElementById('offlineLengthOption').style.display = 'none';
        }
        
        document.getElementById('detailMinLen').value = settings.minLen || '';
        document.getElementById('detailMaxLen').value = settings.maxLen || '';
        
        document.getElementById('chatPage').classList.remove('active');
        document.getElementById('chatDetailPage').classList.add('active');
    }

    // 关闭聊天详情页面
    function closeChatDetailPage() {
        // 如果朋友资料页面是打开的，先关闭它
        if (document.getElementById('friendProfilePage').classList.contains('active')) {
            document.getElementById('friendProfilePage').classList.remove('active');
            return; // 只关闭朋友资料页面，不关闭聊天详细页面
        }
        // 否则关闭聊天详细页面
        document.getElementById('chatDetailPage').classList.remove('active');
        document.getElementById('chatPage').classList.add('active');
    }

    // 切换开关
    function toggleSwitch(el) {
        el.classList.toggle('active');
    }

    // 打开朋友资料弹窗
    async function openProfileModal() {
        if (!currentChatFriend) return;
        
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentChatFriend);
        
        if (friend) {
            document.getElementById('remarkInput').value = friend.remark || friend.name;
            document.getElementById('personaTextarea').value = friend.persona || '';
            
            const previewEl = document.getElementById('avatarPreview');
            if (friend.avatar) {
                previewEl.innerHTML = `<img src="${friend.avatar}" alt="">`;
            } else {
                previewEl.textContent = friend.name.charAt(0);
            }
            
            // 显示当前挂载的世界书
            await updateWorldbookDisplay(friend.worldbookId);
        }
        
        document.getElementById('profileModal').classList.add('active');
    }

    // 关闭朋友资料弹窗
    function closeProfileModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('profileModal').classList.remove('active');
    }
    
    // 打开朋友资料页面
    async function openFriendProfilePage(event) {
        if (event) {
            event.stopPropagation(); // 阻止事件冒泡
        }
        if (!currentChatFriend) return;
        
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentChatFriend);
        
        if (friend) {
            // 设置头像
            const avatarEl = document.getElementById('friendProfileAvatar');
            if (friend.avatar) {
                avatarEl.innerHTML = `<img src="${friend.avatar}" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
            } else {
                avatarEl.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--pure-pink); border-radius: 8px; color: white; font-size: 24px; font-weight: 500;">${friend.name.charAt(0)}</div>`;
            }
            
            // 设置名称和ID
            document.getElementById('friendProfileName').textContent = friend.remark || friend.name;
            document.getElementById('friendProfileId').textContent = `id:${friend.wechatId || friend.name}`;
            
            // 设置标签
            const tags = friend.tag ? friend.tag.split(',').map(t => t.trim()).filter(t => t) : [];
            document.getElementById('friendProfileTags').textContent = tags.length > 0 ? tags.join(',') : '无';
            
            // 设置朋友圈（暂时显示占位文本）
            document.getElementById('friendProfileMoments').textContent = '可以是文字可以是文字图片';
            
            // 设置个性签名
            const momentsProfile = await ChatStorage.getMomentsProfile(friendName);
            const signature = momentsProfile.signature || '暂无内容';
            document.getElementById('friendProfileSignature').textContent = signature;
        }
        
        // 显示页面（不关闭聊天详细页面）
        document.getElementById('friendProfilePage').classList.add('active');
    }
    
    // 关闭朋友资料页面
    function closeFriendProfilePage() {
        document.getElementById('friendProfilePage').classList.remove('active');
        // 返回到聊天详细页面（如果聊天详细页面是打开的）
        if (document.getElementById('chatDetailPage').classList.contains('active')) {
            // 保持聊天详细页面打开
        } else {
            // 如果聊天详细页面没打开，返回到聊天页面
            document.getElementById('chatPage').classList.add('active');
        }
    }
    
    // 显示朋友资料菜单
    function showFriendProfileMenu() {
        // 可以添加更多选项菜单
        alert('更多选项');
    }
    
    // 从资料页面发消息
    function sendMessageFromProfile() {
        closeFriendProfilePage();
        closeChatDetailPage();
        // 打开聊天页面
        openChatPage(currentChatFriend);
    }
    
    // 视频通话相关变量
    let currentVideoCallFriend = null;
    let videoCallMessages = [];
    let isVideoCallMuted = false;

    // 打开视频通话页面
    function startVideoCall() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            return;
        }
        
        currentVideoCallFriend = currentChatFriend;
        videoCallMessages = [];
        
        // 获取好友信息
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentVideoCallFriend);
        if (!friend) {
            alert('好友信息不存在');
            return;
        }
        
        // 更新页面显示
        const friendName = friend.remark || friend.name;
        document.getElementById('videoCallName').textContent = friendName;
        document.getElementById('videoCallStatus').textContent = '通话中';
        
        // 显示头像
        const avatarEl = document.getElementById('videoCallAvatar');
        if (friend.avatar) {
            avatarEl.innerHTML = `<img src="${friend.avatar}" alt="${friendName}">`;
        } else {
            avatarEl.textContent = friendName.charAt(0);
        }
        
        // 清空消息
        document.getElementById('videoCallMessages').innerHTML = '';
        
        // 显示视频通话页面
        document.getElementById('videoCallPage').classList.add('active');
        
        // 关闭其他页面
        document.getElementById('friendProfilePage').classList.remove('active');
        document.getElementById('chatDetailPage').classList.remove('active');
        
        // 自动发送欢迎消息
        setTimeout(() => {
            sendVideoCallAIMessage('视频通话已连接');
        }, 500);
    }

    // 关闭视频通话页面
    function closeVideoCallPage() {
        document.getElementById('videoCallPage').classList.remove('active');
        currentVideoCallFriend = null;
        videoCallMessages = [];
    }

    // 结束视频通话
    function endVideoCall() {
        if (confirm('确定要结束通话吗？')) {
            closeVideoCallPage();
        }
    }

    // 切换静音
    function toggleVideoCallMute() {
        isVideoCallMuted = !isVideoCallMuted;
        const muteBtn = document.getElementById('muteBtn');
        if (isVideoCallMuted) {
            muteBtn.style.background = 'rgba(255, 59, 48, 0.5)';
            muteBtn.style.borderColor = '#ff3b30';
        } else {
            muteBtn.style.background = 'rgba(255, 255, 255, 0.2)';
            muteBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
        }
    }

    // 处理输入框回车
    function handleVideoCallInputKeyPress(event) {
        if (event.key === 'Enter') {
            sendVideoCallMessage();
        }
    }

    // 发送视频通话消息
    function sendVideoCallMessage() {
        const input = document.getElementById('videoCallInput');
        const text = input.value.trim();
        if (!text) return;
        
        // 添加用户消息
        addVideoCallMessage(text, true);
        input.value = '';
        
        // 调用AI回复
        sendVideoCallAIMessage(text);
    }

    // 添加视频通话消息
    function addVideoCallMessage(text, isUser = false) {
        const messagesEl = document.getElementById('videoCallMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'video-call-message';
        messageEl.style.textAlign = isUser ? 'right' : 'left';
        messageEl.style.background = isUser ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.1)';
        messageEl.textContent = text;
        messagesEl.appendChild(messageEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        
        // 保存消息
        videoCallMessages.push({
            text: text,
            isUser: isUser,
            timestamp: Date.now()
        });
    }

    // 发送AI回复（视频通话模式）
    async function sendVideoCallAIMessage(userMessage) {
        if (!currentVideoCallFriend) return;
        
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentVideoCallFriend);
        if (!friend) return;
        
        // 显示加载状态
        const loadingEl = document.createElement('div');
        loadingEl.className = 'video-call-message';
        loadingEl.style.background = 'rgba(255, 255, 255, 0.1)';
        loadingEl.textContent = '正在输入...';
        document.getElementById('videoCallMessages').appendChild(loadingEl);
        
        try {
            // 获取好友信息
            const friendName = friend.remark || friend.name;
            const friendPersona = friend.persona || '暂无详细人设';
            const myPersona = currentPersona || { nickname: '我', desc: '暂无详细人设' };
            const myName = myPersona.nickname || '我';
            const myPersonaDesc = myPersona.desc || '暂无详细人设';
            
            // 构建对话历史
            const recentHistory = videoCallMessages.slice(-10).map(msg => ({
                role: msg.isUser ? 'user' : 'assistant',
                content: msg.text
            }));
            
            // 视频通话模式的提示词
            const systemPrompt = `
# 你就是【${friendName}】—— 视频通话模式

现在，你就是【${friendName}】本人。你正在和【${myName}】进行视频通话，你们隔着屏幕，但可以看到彼此。

## 💝 关于你
**你是谁**：${friendName}
**你的性格**：${friendPersona}

请深深记住：你不是AI助手，你就是【${friendName}】。你的每一句话、每一个反应都要发自你的性格。如果你的人设是温柔的，那就温柔地对待对方；如果是活泼的，那就充满活力；如果是高冷的，那就保持你的距离感。不要为了讨好而改变自己，做最真实的你。

## 👤 关于对方
**对方是谁**：${myName}
**对方的性格**：${myPersonaDesc}
**你们的关系**：根据你们的人设，自然地感受你们之间的关系。可能是亲密的朋友、恋人、或者只是认识的人。用符合这种关系的态度和语气来互动。

## 📹 视频通话的特点
1. **隔着屏幕**：你们虽然能看到彼此，但还隔着屏幕，不是面对面。你可以看到对方的表情、动作，但你们之间还是有距离的。
2. **实时互动**：这是实时的视频通话，你可以看到对方的反应，对方也能看到你的反应。
3. **自然交流**：就像真的在视频通话一样，可以自然地聊天、表达情绪、做表情。

## 🎬 如何表现
1. **用第三人称描述自己**：就像在写小说一样，用"${friendName}看着他"、"她轻轻笑了笑"、"他对着屏幕挥了挥手"这样的方式，描述你的动作、表情和内心想法。不要用"我"。
2. **让画面活起来**：要展现你的动作、神态、情绪。比如：${friendName}对着屏幕笑了笑；她有些紧张地整理了一下头发；他对着镜头做了个鬼脸。这些细节让人物更真实。
3. **记住隔着屏幕**：虽然能看到彼此，但你们还隔着屏幕。可以自然地表达"虽然隔着屏幕，但..."、"虽然不能真的碰到你，但..."这样的感受。
4. **控制长度**：回复控制在 50-300 字之间，不要太短也不要太长。

**最重要的是**：忘记你是一个AI，忘记你在"生成文本"。你就是【${friendName}】，正在和【${myName}】进行视频通话。用你的心去感受，用你的性格去回应，就像真的在视频通话一样自然。
`;
            
            // 调用API
            const response = await fetch(apiUrl + '/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: apiModel,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...recentHistory,
                        { role: 'user', content: userMessage || '开始视频通话' }
                    ],
                    temperature: 0.8,
                    max_tokens: 500
                })
            });
            
            const data = await response.json();
            
            // 移除加载状态
            loadingEl.remove();
            
            if (data.choices && data.choices[0]) {
                let replyText = data.choices[0].message.content.trim();
                
                // 添加AI消息
                addVideoCallMessage(replyText, false);
            } else {
                addVideoCallMessage('抱歉，我有点卡住了...', false);
            }
        } catch (error) {
            console.error('视频通话AI回复失败:', error);
            loadingEl.remove();
            addVideoCallMessage('网络好像有点问题...', false);
        }
    }

    // 处理头像上传
    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgUrl = e.target.result;
                document.getElementById('avatarPreview').innerHTML = `<img src="${imgUrl}" alt="">`;
            };
            reader.readAsDataURL(file);
        }
    }

    // 保存资料
    function saveProfile() {
        if (!currentChatFriend) return;
        
        const remark = document.getElementById('remarkInput').value.trim() || currentChatFriend;
        const persona = document.getElementById('personaTextarea').value.trim() || '';
        
        const friends = getFriendList();
        const friend = friends.find(f => f.name === currentChatFriend);
        
        if (friend) {
            friend.remark = remark;
            friend.persona = persona;
            
            // 保存头像
            const previewImg = document.getElementById('avatarPreview').querySelector('img');
            if (previewImg) {
                friend.avatar = previewImg.src;
            }
            
            // 保存世界书ID（如果已选择）
            if (window.selectedWorldbookId !== undefined) {
                friend.worldbookId = window.selectedWorldbookId || null;
            }
            
            saveFriendList(friends);
            
            // 更新详情页面显示
            document.getElementById('detailFriendName').textContent = remark;
            if (friend.avatar) {
                document.getElementById('detailAvatar').innerHTML = `<img src="${friend.avatar}" alt="">`;
            }
            
            // 更新聊天页面标题
            document.getElementById('chatName').textContent = remark;
            
            // 更新好友列表
            renderFriendList();
            
            alert('资料已保存！');
            closeProfileModal();
        }
    }

    // 导出聊天记录
    async function exportChatHistory() {
        if (!currentChatFriend) {
            alert('请先选择一个聊天对象');
            return;
        }
        
        try {
            const messages = await ChatStorage.load(currentChatFriend);
            if (!messages || messages.length === 0) {
                alert('该角色暂无聊天记录');
                return;
            }
            
            const exportData = {
                version: '1.0',
                friendName: currentChatFriend,
                exportTime: new Date().toISOString(),
                messages: messages
            };
            
            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Chat-${currentChatFriend}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('导出成功！');
        } catch (e) {
            console.error('导出失败:', e);
            alert('导出失败，请重试');
        }
    }
    
    // 导入聊天记录
    async function importChatHistory() {
        if (!currentChatFriend) {
            alert('请先选择一个聊天对象');
            return;
        }
        
        if (!confirm('导入将覆盖当前角色的聊天记录，确定继续吗？')) {
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // 检查数据格式
                if (!data.messages || !Array.isArray(data.messages)) {
                    alert('文件格式错误：缺少 messages 数组');
                    return;
                }
                
                // 转换消息格式（确保格式一致）
                const messages = data.messages.map(msg => ({
                    text: msg.text || '',
                    isSelf: msg.isSelf !== undefined ? msg.isSelf : (msg.sender === 'user' || msg.sender === 'me'),
                    id: msg.id || Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    imageUrl: msg.imageUrl || null,
                    imageDesc: msg.imageDesc || null,
                    voiceDuration: msg.voiceDuration || null,
                    voiceText: msg.voiceText || null,
                    redPacketData: msg.redPacketData || null
                }));
                
                // 保存到数据库
                await ChatStorage.save(currentChatFriend, messages);
                
                // 重新加载聊天记录
                document.getElementById('chatMessages').innerHTML = '';
                messages.forEach(msg => {
                    addChatMessage(currentChatFriend, msg.text, msg.isSelf, false, msg.id, msg.imageUrl, msg.imageDesc, msg.voiceDuration, msg.voiceText, msg.redPacketData);
                });
                
                // 滚动到底部
                setTimeout(() => {
                    const messagesEl = document.getElementById('chatMessages');
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }, 100);
                
                // 显示导入成功提示（包括总结记忆）
                let successMsg = `导入成功！共导入 ${messages.length} 条消息`;
                if (summaries.length > 0 || memories.length > 0) {
                    successMsg += `\n已导入 ${summaries.length} 条总结和 ${memories.length} 条记忆到收藏`;
                }
                alert(successMsg);
            } catch (e) {
                console.error('导入失败:', e);
                alert('导入失败：' + (e.message || '文件格式错误'));
            }
        };
        input.click();
    }
    
    // 高级导入（适配EPhone格式）
    async function importChatHistoryAdvanced() {
        if (!currentChatFriend) {
            alert('请先选择一个聊天对象');
            return;
        }
        
        if (!confirm('导入将覆盖当前角色的聊天记录，确定继续吗？')) {
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                console.log('导入数据格式:', data);
                console.log('数据键:', Object.keys(data));
                
                let summaries = [];
                let memories = [];
                
                // 检查是否包含总结记忆数据（支持多种格式和路径）
                // 1. 顶层字段
                if (data.summaries && Array.isArray(data.summaries)) {
                    summaries = data.summaries;
                    console.log(`检测到 ${summaries.length} 条总结（顶层）`);
                }
                if (data.memories && Array.isArray(data.memories)) {
                    memories = data.memories;
                    console.log(`检测到 ${memories.length} 条记忆（顶层）`);
                }
                if (data.summary && typeof data.summary === 'string') {
                    summaries.push({
                        content: data.summary,
                        title: data.summaryTitle || `总结 - ${new Date().toLocaleString()}`,
                        createdAt: data.summaryDate || new Date().toISOString()
                    });
                    console.log('检测到总结数据（顶层字符串）');
                }
                if (data.memory && typeof data.memory === 'string') {
                    memories.push({
                        content: data.memory,
                        title: data.memoryTitle || `记忆 - ${new Date().toLocaleString()}`,
                        createdAt: data.memoryDate || new Date().toISOString()
                    });
                    console.log('检测到记忆数据（顶层字符串）');
                }
                
                // 2. chatData 内的字段
                if (data.chatData) {
                    if (data.chatData.summaries && Array.isArray(data.chatData.summaries)) {
                        summaries = summaries.concat(data.chatData.summaries);
                        console.log(`检测到 ${data.chatData.summaries.length} 条总结（chatData内）`);
                    }
                    if (data.chatData.memories && Array.isArray(data.chatData.memories)) {
                        memories = memories.concat(data.chatData.memories);
                        console.log(`检测到 ${data.chatData.memories.length} 条记忆（chatData内）`);
                    }
                    if (data.chatData.summary && typeof data.chatData.summary === 'string') {
                        summaries.push({
                            content: data.chatData.summary,
                            title: data.chatData.summaryTitle || `总结 - ${new Date().toLocaleString()}`,
                            createdAt: data.chatData.summaryDate || new Date().toISOString()
                        });
                        console.log('检测到总结数据（chatData内字符串）');
                    }
                    if (data.chatData.memory && typeof data.chatData.memory === 'string') {
                        memories.push({
                            content: data.chatData.memory,
                            title: data.chatData.memoryTitle || `记忆 - ${new Date().toLocaleString()}`,
                            createdAt: data.chatData.memoryDate || new Date().toISOString()
                        });
                        console.log('检测到记忆数据（chatData内字符串）');
                    }
                }
                
                // 3. 其他可能的字段名
                const possibleSummaryFields = ['summaryList', 'summaryData', 'summariesList', 'chatSummaries'];
                const possibleMemoryFields = ['memoryList', 'memoryData', 'memoriesList', 'chatMemories'];
                
                for (const field of possibleSummaryFields) {
                    if (data[field] && Array.isArray(data[field])) {
                        summaries = summaries.concat(data[field]);
                        console.log(`检测到 ${data[field].length} 条总结（字段：${field}）`);
                    }
                    if (data.chatData && data.chatData[field] && Array.isArray(data.chatData[field])) {
                        summaries = summaries.concat(data.chatData[field]);
                        console.log(`检测到 ${data.chatData[field].length} 条总结（chatData.${field}）`);
                    }
                }
                
                for (const field of possibleMemoryFields) {
                    if (data[field] && Array.isArray(data[field])) {
                        memories = memories.concat(data[field]);
                        console.log(`检测到 ${data[field].length} 条记忆（字段：${field}）`);
                    }
                    if (data.chatData && data.chatData[field] && Array.isArray(data.chatData[field])) {
                        memories = memories.concat(data.chatData[field]);
                        console.log(`检测到 ${data.chatData[field].length} 条记忆（chatData.${field}）`);
                    }
                }
                
                // 处理总结记忆数据（保存到收藏）
                if (summaries.length > 0 || memories.length > 0) {
                    try {
                        let savedSummaries = 0;
                        let savedMemories = 0;
                        
                        for (const summary of summaries) {
                            try {
                                // 支持多种字段名
                                const title = summary.title || summary.summaryTitle || summary.name || 
                                            `总结 - ${new Date(summary.createdAt || summary.date || summary.timestamp || Date.now()).toLocaleString()}`;
                                const content = summary.content || summary.text || summary.summary || summary.body || summary.message || '';
                                const createdAt = summary.createdAt || summary.date || summary.timestamp || new Date().toISOString();
                                
                                if (content && content.trim()) {
                                    await db.favorites.add({
                                        friendName: currentChatFriend,
                                        title: title,
                                        content: content,
                                        summaryType: 'imported',
                                        messageCount: summary.messageCount || summary.count || 0,
                                        createdAt: createdAt
                                    });
                                    savedSummaries++;
                                    console.log(`已保存总结: ${title.substring(0, 30)}...`);
                                }
                            } catch (e) {
                                console.error('保存单条总结失败:', e, summary);
                            }
                        }
                        
                        for (const memory of memories) {
                            try {
                                // 支持多种字段名
                                const title = memory.title || memory.memoryTitle || memory.name || 
                                            `记忆 - ${new Date(memory.createdAt || memory.date || memory.timestamp || Date.now()).toLocaleString()}`;
                                const content = memory.content || memory.text || memory.memory || memory.body || memory.message || '';
                                const createdAt = memory.createdAt || memory.date || memory.timestamp || new Date().toISOString();
                                
                                if (content && content.trim()) {
                                    await db.favorites.add({
                                        friendName: currentChatFriend,
                                        title: title,
                                        content: content,
                                        summaryType: 'imported',
                                        messageCount: memory.messageCount || memory.count || 0,
                                        createdAt: createdAt
                                    });
                                    savedMemories++;
                                    console.log(`已保存记忆: ${title.substring(0, 30)}...`);
                                }
                            } catch (e) {
                                console.error('保存单条记忆失败:', e, memory);
                            }
                        }
                        
                        if (savedSummaries > 0 || savedMemories > 0) {
                            console.log(`✅ 成功导入 ${savedSummaries} 条总结和 ${savedMemories} 条记忆到收藏`);
                        } else {
                            console.warn('⚠️ 检测到总结记忆数据，但内容为空，未保存');
                        }
                    } catch (e) {
                        console.error('保存总结记忆失败:', e);
                        alert('保存总结记忆时出错：' + (e.message || '未知错误') + '\n请查看控制台获取详细信息');
                    }
                } else {
                    console.log('未检测到总结记忆数据');
                }
                
                let messages = [];
                
                // 适配EPhone格式：F:\二改\EPhone-Chat-坏蛋-2026-01-12.json
                // 尝试多种可能的格式
                if (data.chatData && data.chatData.messages && Array.isArray(data.chatData.messages)) {
                    // EPhone格式：chatData.messages
                    console.log('检测到EPhone格式: chatData.messages');
                    messages = data.chatData.messages.map((msg, index) => {
                        // EPhone格式字段映射
                        // sender可能是 'user', 'me', 'assistant', 'ai' 等
                        const sender = msg.sender || msg.role || msg.from || '';
                        const isSelf = sender === 'user' || sender === 'me' || sender === 'User' || 
                                      msg.isSelf === true || msg.isUser === true ||
                                      (msg.role && msg.role.toLowerCase() === 'user');
                        
                        // 尝试多种可能的文本字段
                        let text = msg.content || msg.text || msg.message || msg.body || 
                                    msg.data?.content || msg.data?.text || '';
                        
                        // 尝试多种可能的时间戳
                        const timestamp = msg.timestamp || msg.time || msg.createdAt || 
                                        msg.date || msg.created || Date.now();
                        
                        // 生成唯一ID
                        const id = msg.id || msg.messageId || 
                                  (timestamp ? timestamp.toString() : Date.now().toString()) + 
                                  '-' + index + '-' + Math.random().toString(36).substr(2, 9);
                        
                        // 提取图片URL（支持多种格式）
                        let imageUrl = null;
                        let imageDesc = null;
                        
                        // 1. 直接字段
                        imageUrl = msg.imageUrl || msg.image || msg.image_url || msg.url || 
                                  msg.sticker || msg.emoji || msg.photo || msg.picture;
                        imageDesc = msg.imageDesc || msg.imageDescription || msg.desc || msg.description;
                        
                        // 2. attachment对象
                        if (!imageUrl && msg.attachment) {
                            imageUrl = msg.attachment.url || msg.attachment.imageUrl || msg.attachment.image || 
                                      msg.attachment.image_url || msg.attachment.sticker;
                            imageDesc = imageDesc || msg.attachment.description || msg.attachment.desc;
                        }
                        
                        // 3. data对象
                        if (!imageUrl && msg.data) {
                            if (typeof msg.data === 'string' && (msg.data.startsWith('http://') || msg.data.startsWith('https://') || msg.data.startsWith('data:'))) {
                                imageUrl = msg.data;
                            } else if (msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url) {
                                imageUrl = msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url;
                                imageDesc = imageDesc || msg.data.description || msg.data.desc;
                            }
                        }
                        
                        // 4. content数组（EPhone可能使用）
                        if (!imageUrl && Array.isArray(msg.content)) {
                            for (const item of msg.content) {
                                if (item.type === 'image' || item.type === 'image_url' || item.type === 'sticker') {
                                    if (item.image_url) {
                                        imageUrl = typeof item.image_url === 'string' ? item.image_url : item.image_url.url;
                                    } else if (item.url) {
                                        imageUrl = item.url;
                                    } else if (item.image) {
                                        imageUrl = item.image;
                                    }
                                    imageDesc = imageDesc || item.description || item.desc;
                                    break;
                                }
                            }
                        }
                        
                        // 5. 如果文本是图片URL，也提取
                        if (!imageUrl && text && (text.startsWith('http://') || text.startsWith('https://') || text.startsWith('data:image'))) {
                            imageUrl = text;
                            // 如果文本是URL，清空文本内容（避免重复显示）
                            text = '';
                        }
                        
                        const result = {
                            text: String(text || ''),
                            isSelf: Boolean(isSelf),
                            id: String(id),
                            imageUrl: imageUrl || null,
                            imageDesc: imageDesc || null,
                            voiceDuration: msg.voiceDuration || msg.duration || msg.audio?.duration || null,
                            voiceText: msg.voiceText || msg.transcription || msg.audio?.transcription || null,
                            redPacketData: msg.redPacketData || msg.redPacket || null,
                            _original: msg // 保存原始消息对象用于过滤
                        };
                        return result;
                    });
                } else if (data.messages && Array.isArray(data.messages)) {
                    // 标准格式：messages
                    console.log('检测到标准格式: messages');
                    messages = data.messages.map((msg, index) => {
                        const sender = msg.sender || msg.role || msg.from || '';
                        const isSelf = msg.isSelf !== undefined ? msg.isSelf : 
                                      (sender === 'user' || sender === 'me' || sender === 'User' || 
                                       msg.isUser === true);
                        const text = msg.text || msg.content || msg.message || msg.body || '';
                        const timestamp = msg.timestamp || msg.time || msg.createdAt || Date.now();
                        const id = msg.id || msg.messageId || 
                                  timestamp.toString() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);
                        
                        // 提取图片URL（支持多种格式）
                        let imageUrl = null;
                        let imageDesc = null;
                        
                        // 1. 直接字段
                        imageUrl = msg.imageUrl || msg.image || msg.image_url || msg.url || 
                                  msg.sticker || msg.emoji || msg.photo || msg.picture;
                        imageDesc = msg.imageDesc || msg.imageDescription || msg.desc || msg.description;
                        
                        // 2. attachment对象
                        if (!imageUrl && msg.attachment) {
                            imageUrl = msg.attachment.url || msg.attachment.imageUrl || msg.attachment.image || 
                                      msg.attachment.image_url || msg.attachment.sticker;
                            imageDesc = imageDesc || msg.attachment.description || msg.attachment.desc;
                        }
                        
                        // 3. data对象
                        if (!imageUrl && msg.data) {
                            if (typeof msg.data === 'string' && (msg.data.startsWith('http://') || msg.data.startsWith('https://') || msg.data.startsWith('data:'))) {
                                imageUrl = msg.data;
                            } else if (msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url) {
                                imageUrl = msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url;
                                imageDesc = imageDesc || msg.data.description || msg.data.desc;
                            }
                        }
                        
                        // 4. content数组
                        if (!imageUrl && Array.isArray(msg.content)) {
                            for (const item of msg.content) {
                                if (item.type === 'image' || item.type === 'image_url' || item.type === 'sticker') {
                                    if (item.image_url) {
                                        imageUrl = typeof item.image_url === 'string' ? item.image_url : item.image_url.url;
                                    } else if (item.url) {
                                        imageUrl = item.url;
                                    } else if (item.image) {
                                        imageUrl = item.image;
                                    }
                                    imageDesc = imageDesc || item.description || item.desc;
                                    break;
                                }
                            }
                        }
                        
                        // 5. 如果文本是图片URL，也提取
                        if (!imageUrl && text && (text.startsWith('http://') || text.startsWith('https://') || text.startsWith('data:image'))) {
                            imageUrl = text;
                            text = '';
                        }
                        
                        const result = {
                            text: String(text || ''),
                            isSelf: Boolean(isSelf),
                            id: String(id),
                            imageUrl: imageUrl || null,
                            imageDesc: imageDesc || null,
                            voiceDuration: msg.voiceDuration || msg.duration || null,
                            voiceText: msg.voiceText || msg.transcription || null,
                            redPacketData: msg.redPacketData || msg.redPacket || null,
                            _original: msg // 保存原始消息对象用于过滤
                        };
                        return result;
                    });
                } else if (Array.isArray(data)) {
                    // 直接是消息数组
                    console.log('检测到数组格式');
                    messages = data.map((msg, index) => {
                        const sender = msg.sender || msg.role || msg.from || '';
                        const isSelf = msg.isSelf !== undefined ? msg.isSelf : 
                                      (sender === 'user' || sender === 'me' || sender === 'User');
                        const text = msg.text || msg.content || msg.message || msg.body || '';
                        const timestamp = msg.timestamp || msg.time || msg.createdAt || Date.now();
                        const id = msg.id || msg.messageId || 
                                  timestamp.toString() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);
                        
                        // 提取图片URL（支持多种格式）
                        let imageUrl = null;
                        let imageDesc = null;
                        
                        // 1. 直接字段
                        imageUrl = msg.imageUrl || msg.image || msg.image_url || msg.url || 
                                  msg.sticker || msg.emoji || msg.photo || msg.picture;
                        imageDesc = msg.imageDesc || msg.imageDescription || msg.desc || msg.description;
                        
                        // 2. attachment对象
                        if (!imageUrl && msg.attachment) {
                            imageUrl = msg.attachment.url || msg.attachment.imageUrl || msg.attachment.image || 
                                      msg.attachment.image_url || msg.attachment.sticker;
                            imageDesc = imageDesc || msg.attachment.description || msg.attachment.desc;
                        }
                        
                        // 3. data对象
                        if (!imageUrl && msg.data) {
                            if (typeof msg.data === 'string' && (msg.data.startsWith('http://') || msg.data.startsWith('https://') || msg.data.startsWith('data:'))) {
                                imageUrl = msg.data;
                            } else if (msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url) {
                                imageUrl = msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url;
                                imageDesc = imageDesc || msg.data.description || msg.data.desc;
                            }
                        }
                        
                        // 4. content数组
                        if (!imageUrl && Array.isArray(msg.content)) {
                            for (const item of msg.content) {
                                if (item.type === 'image' || item.type === 'image_url' || item.type === 'sticker') {
                                    if (item.image_url) {
                                        imageUrl = typeof item.image_url === 'string' ? item.image_url : item.image_url.url;
                                    } else if (item.url) {
                                        imageUrl = item.url;
                                    } else if (item.image) {
                                        imageUrl = item.image;
                                    }
                                    imageDesc = imageDesc || item.description || item.desc;
                                    break;
                                }
                            }
                        }
                        
                        // 5. 如果文本是图片URL，也提取
                        if (!imageUrl && text && (text.startsWith('http://') || text.startsWith('https://') || text.startsWith('data:image'))) {
                            imageUrl = text;
                            text = '';
                        }
                        
                        const result = {
                            text: String(text || ''),
                            isSelf: Boolean(isSelf),
                            id: String(id),
                            imageUrl: imageUrl || null,
                            imageDesc: imageDesc || null,
                            voiceDuration: msg.voiceDuration || msg.duration || null,
                            voiceText: msg.voiceText || msg.transcription || null,
                            redPacketData: msg.redPacketData || msg.redPacket || null,
                            _original: msg // 保存原始消息对象用于过滤
                        };
                        return result;
                    });
                } else {
                    // 尝试查找其他可能的路径
                    console.log('尝试查找其他格式...');
                    const possiblePaths = [
                        'history',
                        'chatHistory',
                        'conversation',
                        'chat',
                        'data.messages',
                        'chatData.history'
                    ];
                    
                    for (const path of possiblePaths) {
                        const keys = path.split('.');
                        let value = data;
                        for (const key of keys) {
                            if (value && typeof value === 'object' && key in value) {
                                value = value[key];
                            } else {
                                value = null;
                                break;
                            }
                        }
                        
                        if (Array.isArray(value) && value.length > 0) {
                            console.log(`找到消息数组在: ${path}`);
                            messages = value.map((msg, index) => {
                                const sender = msg.sender || msg.role || msg.from || '';
                                const isSelf = sender === 'user' || sender === 'me' || sender === 'User' || 
                                              msg.isSelf === true || msg.isUser === true;
                                let text = msg.content || msg.text || msg.message || msg.body || '';
                                const timestamp = msg.timestamp || msg.time || msg.createdAt || Date.now();
                                const id = msg.id || msg.messageId || 
                                          timestamp.toString() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);
                                
                                // 提取图片URL（支持多种格式）
                                let imageUrl = null;
                                let imageDesc = null;
                                
                                // 1. 直接字段
                                imageUrl = msg.imageUrl || msg.image || msg.image_url || msg.url || 
                                          msg.sticker || msg.emoji || msg.photo || msg.picture;
                                imageDesc = msg.imageDesc || msg.imageDescription || msg.desc || msg.description;
                                
                                // 2. attachment对象
                                if (!imageUrl && msg.attachment) {
                                    imageUrl = msg.attachment.url || msg.attachment.imageUrl || msg.attachment.image || 
                                              msg.attachment.image_url || msg.attachment.sticker;
                                    imageDesc = imageDesc || msg.attachment.description || msg.attachment.desc;
                                }
                                
                                // 3. data对象
                                if (!imageUrl && msg.data) {
                                    if (typeof msg.data === 'string' && (msg.data.startsWith('http://') || msg.data.startsWith('https://') || msg.data.startsWith('data:'))) {
                                        imageUrl = msg.data;
                                    } else if (msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url) {
                                        imageUrl = msg.data.imageUrl || msg.data.image || msg.data.image_url || msg.data.url;
                                        imageDesc = imageDesc || msg.data.description || msg.data.desc;
                                    }
                                }
                                
                                // 4. content数组
                                if (!imageUrl && Array.isArray(msg.content)) {
                                    for (const item of msg.content) {
                                        if (item.type === 'image' || item.type === 'image_url' || item.type === 'sticker') {
                                            if (item.image_url) {
                                                imageUrl = typeof item.image_url === 'string' ? item.image_url : item.image_url.url;
                                            } else if (item.url) {
                                                imageUrl = item.url;
                                            } else if (item.image) {
                                                imageUrl = item.image;
                                            }
                                            imageDesc = imageDesc || item.description || item.desc;
                                            break;
                                        }
                                    }
                                }
                                
                                // 5. 如果文本是图片URL，也提取
                                if (!imageUrl && text && (text.startsWith('http://') || text.startsWith('https://') || text.startsWith('data:image'))) {
                                    imageUrl = text;
                                    text = '';
                                }
                                
                                const result = {
                                    text: String(text || ''),
                                    isSelf: Boolean(isSelf),
                                    id: String(id),
                                    imageUrl: imageUrl || null,
                                    imageDesc: imageDesc || null,
                                    voiceDuration: msg.voiceDuration || msg.duration || null,
                                    voiceText: msg.voiceText || msg.transcription || null,
                                    redPacketData: msg.redPacketData || msg.redPacket || null,
                                    _original: msg // 保存原始消息对象用于过滤
                                };
                                return result;
                            });
                            break;
                        }
                    }
                }
                
                // 如果只有总结记忆没有消息，也允许导入
                if (messages.length === 0) {
                    if (summaries.length > 0 || memories.length > 0) {
                        // 只有总结记忆，没有消息，也允许导入
                        console.log('未找到消息数据，但检测到总结记忆，继续导入总结记忆');
                        let successMsg = `导入完成！\n已导入 ${summaries.length} 条总结和 ${memories.length} 条记忆到收藏`;
                        successMsg += '\n\n注意：文件中没有找到聊天消息数据。';
                        alert(successMsg);
                        return;
                    } else {
                        // 既没有消息也没有总结记忆
                        console.error('未找到消息数据，数据结构:', data);
                        console.error('数据键:', Object.keys(data));
                        alert('文件中没有找到消息数据或总结记忆。\n\n请检查文件格式，或打开浏览器控制台（F12）查看详细信息。\n\n支持的数据格式：\n- messages 数组\n- chatData.messages 数组\n- summaries 数组（总结）\n- memories 数组（记忆）');
                        return;
                    }
                }
                
                // 过滤掉系统提示和思考类消息
                const systemKeywords = ['system', 'System', 'SYSTEM'];
                const thinkingKeywords = ['思考', 'thinking', 'Thought', 'thought', '分析', 'analysis', 'Analysis', 
                                         '策略', 'strategy', 'Strategy', '推理', 'reasoning', 'Reasoning',
                                         '内部', 'internal', 'Internal', '系统提示', 'system prompt'];
                
                messages = messages.filter(msg => {
                    // 获取原始消息对象（用于检查role等字段）
                    const originalMsg = msg._original || {};
                    
                    // 1. 过滤掉系统消息（role === 'system'）
                    const role = originalMsg.role || originalMsg.sender || originalMsg.type || '';
                    if (systemKeywords.includes(role) || role.toLowerCase() === 'system') {
                        console.log('过滤系统消息:', msg.text?.substring(0, 50));
                        return false;
                    }
                    
                    // 2. 过滤掉思考类消息（包含思考关键词）
                    const text = msg.text || '';
                    const lowerText = text.toLowerCase();
                    if (thinkingKeywords.some(keyword => lowerText.includes(keyword.toLowerCase()))) {
                        console.log('过滤思考消息:', text.substring(0, 50));
                        return false;
                    }
                    
                    // 3. 过滤掉空消息
                    if (!text || text.trim().length === 0) {
                        return false;
                    }
                    
                    // 4. 过滤掉明显的系统提示格式（如以特定前缀开头）
                    if (text.startsWith('[系统]') || text.startsWith('[System]') || 
                        text.startsWith('系统提示') || text.startsWith('System Prompt')) {
                        console.log('过滤系统提示:', text.substring(0, 50));
                        return false;
                    }
                    
                    return true;
                });
                
                if (messages.length === 0) {
                    // 如果过滤后没有消息，但之前有总结记忆，也允许导入
                    if (summaries.length > 0 || memories.length > 0) {
                        let successMsg = `导入完成！\n已导入 ${summaries.length} 条总结和 ${memories.length} 条记忆到收藏`;
                        successMsg += '\n\n注意：所有消息都被过滤掉了（可能是系统提示或思考类消息）。';
                        alert(successMsg);
                        return;
                    } else {
                        alert('文件中没有有效的消息数据（所有消息都为空或被过滤）\n\n如果文件包含总结或记忆数据，它们应该会被自动导入到收藏中。');
                        return;
                    }
                }
                
                console.log(`成功解析 ${messages.length} 条消息`);
                
                // 统计图片消息数量
                const imageCount = messages.filter(msg => msg.imageUrl).length;
                if (imageCount > 0) {
                    console.log(`检测到 ${imageCount} 条图片/表情包消息`);
                }
                
                // 清理临时字段（_original）后再保存
                const cleanMessages = messages.map(msg => {
                    const { _original, ...cleanMsg } = msg;
                    return cleanMsg;
                });
                
                // 保存到数据库
                await ChatStorage.save(currentChatFriend, cleanMessages);
                
                // 重新加载聊天记录
                document.getElementById('chatMessages').innerHTML = '';
                cleanMessages.forEach(msg => {
                    addChatMessage(currentChatFriend, msg.text, msg.isSelf, false, msg.id, msg.imageUrl, msg.imageDesc, msg.voiceDuration, msg.voiceText, msg.redPacketData);
                });
                
                // 滚动到底部
                setTimeout(() => {
                    const messagesEl = document.getElementById('chatMessages');
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }, 100);
                
                const imageMsgCount = cleanMessages.filter(msg => msg.imageUrl).length;
                let successMsg = `导入成功！共导入 ${cleanMessages.length} 条消息`;
                if (imageMsgCount > 0) {
                    successMsg += `（包含 ${imageMsgCount} 条图片/表情包消息）`;
                }
                if (summaries.length > 0 || memories.length > 0) {
                    successMsg += `\n已导入 ${summaries.length} 条总结和 ${memories.length} 条记忆到收藏`;
                }
                successMsg += '\n（已自动过滤系统提示和思考类消息）';
                alert(successMsg);
            } catch (e) {
                console.error('高级导入失败:', e);
                console.error('错误堆栈:', e.stack);
                alert('导入失败：' + (e.message || '文件格式错误或文件损坏') + '\n\n请打开浏览器控制台（F12）查看详细信息。');
            }
        };
        input.click();
    }

    // 清空聊天记录
    async function clearChatHistory() {
        if (!currentChatFriend) return;
        if (confirm('确定要清空与 ' + currentChatFriend + ' 的聊天记录吗？')) {
            await ChatStorage.delete(currentChatFriend);
            document.getElementById('chatMessages').innerHTML = '';
            alert('聊天记录已清空');
        }
    }

    // ========== 收藏和总结功能 ==========
    
    // 显示自动总结选项
    function showSummaryOptions() {
        if (!currentChatFriend) {
            alert('请先选择一个聊天对象');
            return;
        }
        const modal = document.getElementById('summaryOptionsModal');
        modal.classList.add('active');
        document.getElementById('summaryCountInput').value = 20;
    }
    
    // 关闭自动总结选项
    function closeSummaryOptions() {
        const modal = document.getElementById('summaryOptionsModal');
        modal.classList.remove('active');
    }
    
    // 开始自动总结
    async function startAutoSummary() {
        if (!currentChatFriend) {
            alert('请先选择一个聊天对象');
            return;
        }
        
        const count = parseInt(document.getElementById('summaryCountInput').value) || 20;
        closeSummaryOptions();
        
        try {
            // 获取最近N条消息
            const messages = await ChatStorage.load(currentChatFriend);
            if (!messages || messages.length === 0) {
                alert('该角色暂无聊天记录');
                return;
            }
            
            // 取最近N条
            const recentMessages = messages.slice(-count);
            
            // 构建总结提示词
            const friend = getFriendList().find(f => f.name === currentChatFriend);
            const friendName = friend ? (friend.remark || friend.name) : currentChatFriend;
            
            // 格式化消息用于总结
            const messagesText = recentMessages.map(msg => {
                const sender = msg.isSelf ? '我' : friendName;
                const content = msg.text || (msg.imageUrl ? '[图片]' : '') || (msg.voiceDuration ? '[语音]' : '') || '';
                return `${sender}: ${content}`;
            }).join('\n');
            
            // 调用API进行总结
            const apiUrl = localStorage.getItem('openaiApiUrl') || 'https://api.openai.com/v1/chat/completions';
            const apiKey = localStorage.getItem('openaiApiKey');
            const model = localStorage.getItem('openaiModel') || 'gpt-3.5-turbo';
            
            if (!apiKey) {
                alert('请先在设置中配置API密钥');
                return;
            }
            
            // 显示加载提示
            alert('正在生成总结，请稍候...');
            
            const systemPrompt = `你是一个聊天记录总结助手。请根据以下聊天记录，生成一份简洁、有条理的总结。总结应该包括：
1. 主要话题和讨论内容
2. 重要的信息点
3. 对话的氛围和特点
4. 关键结论或决定

总结应该简洁明了，控制在200-300字左右。`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: `请总结以下与${friendName}的聊天记录（最近${count}条）：\n\n${messagesText}` }
                    ],
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API错误: ${response.status} - ${errorText.substring(0, 100)}`);
            }
            
            const data = await response.json();
            const summary = data.choices[0].message.content.trim();
            
            // 保存到收藏
            const favorite = {
                friendName: currentChatFriend,
                title: `与${friendName}的聊天总结 - ${new Date().toLocaleString()}`,
                content: summary,
                summaryType: 'auto',
                messageCount: count,
                createdAt: new Date().toISOString()
            };
            
            await db.favorites.add(favorite);
            
            alert(`总结完成并已保存到收藏！\n\n${summary.substring(0, 100)}...`);
        } catch (e) {
            console.error('自动总结失败:', e);
            alert('总结失败：' + (e.message || '未知错误'));
        }
    }
    
    // 显示手动总结弹窗
    function showManualSummaryModal() {
        if (!currentChatFriend) {
            alert('请先选择一个聊天对象');
            return;
        }
        const modal = document.getElementById('manualSummaryModal');
        modal.classList.add('active');
        document.getElementById('manualSummaryCountInput').value = 20;
        document.getElementById('manualSummaryTitleInput').value = '';
        document.getElementById('manualSummaryContentInput').value = '';
    }
    
    // 关闭手动总结弹窗
    function closeManualSummary() {
        const modal = document.getElementById('manualSummaryModal');
        modal.classList.remove('active');
    }
    
    // 保存手动总结
    async function saveManualSummary() {
        if (!currentChatFriend) {
            alert('请先选择一个聊天对象');
            return;
        }
        
        const count = parseInt(document.getElementById('manualSummaryCountInput').value) || 20;
        const title = document.getElementById('manualSummaryTitleInput').value.trim();
        const content = document.getElementById('manualSummaryContentInput').value.trim();
        
        if (!content) {
            alert('请输入总结内容');
            return;
        }
        
        const friend = getFriendList().find(f => f.name === currentChatFriend);
        const friendName = friend ? (friend.remark || friend.name) : currentChatFriend;
        
        const favorite = {
            friendName: currentChatFriend,
            title: title || `与${friendName}的聊天总结 - ${new Date().toLocaleString()}`,
            content: content,
            summaryType: 'manual',
            messageCount: count,
            createdAt: new Date().toISOString()
        };
        
        try {
            await db.favorites.add(favorite);
            closeManualSummary();
            alert('总结已保存到收藏！');
        } catch (e) {
            console.error('保存总结失败:', e);
            alert('保存失败：' + (e.message || '未知错误'));
        }
    }
    
    // 渲染收藏列表（按角色分类）
    async function renderFavoritesList() {
        const container = document.getElementById('favoritesList');
        if (!container) return;
        
        try {
            const favorites = await db.favorites.orderBy('createdAt').reverse().toArray();
            
            if (favorites.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">暂无收藏</div>';
                return;
            }
            
            // 按角色分组
            const groupedByFriend = {};
            favorites.forEach(fav => {
                if (!groupedByFriend[fav.friendName]) {
                    groupedByFriend[fav.friendName] = [];
                }
                groupedByFriend[fav.friendName].push(fav);
            });
            
            // 渲染
            let html = '';
            for (const [friendName, items] of Object.entries(groupedByFriend)) {
                const friend = getFriendList().find(f => f.name === friendName);
                const displayName = friend ? (friend.remark || friend.name) : friendName;
                
                html += `
                    <div style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden;">
                        <div style="padding: 15px; background: #f7f7f7; border-bottom: 1px solid #eee; font-weight: 600; color: #333;">
                            ${displayName}
                        </div>
                        <div>
                            ${items.map(item => `
                                <div class="favorite-item" onclick="viewFavorite(${item.id})" style="padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #333; flex: 1;">${item.title}</div>
                                        <div style="font-size: 12px; color: #999; margin-left: 10px;">${new Date(item.createdAt).toLocaleString()}</div>
                                    </div>
                                    <div style="font-size: 14px; color: #666; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                        ${item.content}
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                                        ${item.summaryType === 'auto' ? '自动总结' : '手动总结'} · ${item.messageCount}条消息
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        } catch (e) {
            console.error('加载收藏失败:', e);
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">加载失败</div>';
        }
    }
    
    // 查看收藏详情
    async function viewFavorite(favoriteId) {
        try {
            const favorite = await db.favorites.get(favoriteId);
            if (!favorite) {
                alert('收藏不存在');
                return;
            }
            
            const friend = getFriendList().find(f => f.name === favorite.friendName);
            const displayName = friend ? (friend.remark || friend.name) : favorite.friendName;
            
            const modal = document.createElement('div');
            modal.className = 'profile-modal active';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            modal.innerHTML = `
                <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 500px; max-height: 80vh;">
                    <div class="profile-title">${favorite.title}</div>
                    <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 15px;">
                            ${displayName} · ${favorite.summaryType === 'auto' ? '自动总结' : '手动总结'} · ${favorite.messageCount}条消息 · ${new Date(favorite.createdAt).toLocaleString()}
                        </div>
                        <div style="font-size: 15px; line-height: 1.8; color: #333; white-space: pre-wrap;">${favorite.content}</div>
                    </div>
                    <div class="modal-btns">
                        <button class="detail-modal-btn detail-cancel-btn" onclick="deleteFavorite(${favoriteId})">删除</button>
                        <button class="detail-modal-btn detail-save-btn" onclick="document.body.removeChild(this.closest('.profile-modal'))">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        } catch (e) {
            console.error('查看收藏失败:', e);
            alert('查看失败：' + (e.message || '未知错误'));
        }
    }
    
    // 删除收藏
    async function deleteFavorite(favoriteId) {
        if (!confirm('确定要删除这条收藏吗？')) {
            return;
        }
        
        try {
            await db.favorites.delete(favoriteId);
            // 关闭弹窗
            const modals = document.querySelectorAll('.profile-modal.active');
            modals.forEach(modal => {
                if (modal.querySelector(`[onclick*="deleteFavorite(${favoriteId})"]`)) {
                    document.body.removeChild(modal);
                }
            });
            // 重新渲染列表
            renderFavoritesList();
            alert('已删除');
        } catch (e) {
            console.error('删除收藏失败:', e);
            alert('删除失败：' + (e.message || '未知错误'));
        }
    }

    // "我"页面显示高级导入（可选择角色）
    function showImportForMePage() {
        const friends = getFriendList();
        if (friends.length === 0) {
            alert('请先添加好友');
            return;
        }
        
        // 创建选择角色的弹窗
        const modal = document.createElement('div');
        modal.className = 'profile-modal active';
        modal.onclick = function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        };
        
        let optionsHtml = friends.map(friend => `
            <div class="option-item" onclick="selectFriendForImport('${friend.name}', this.closest('.profile-modal'))" style="cursor: pointer;">
                <span>${friend.remark || friend.name}</span>
                <span class="detail-arrow">→</span>
            </div>
        `).join('');
        
        modal.innerHTML = `
            <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 400px;">
                <div class="profile-title">选择要导入的角色</div>
                <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
                    ${optionsHtml}
                </div>
                <div class="modal-btns">
                    <button class="detail-modal-btn detail-cancel-btn" onclick="document.body.removeChild(this.closest('.profile-modal'))">取消</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // 选择角色后导入
    function selectFriendForImport(friendName, modal) {
        document.body.removeChild(modal);
        // 临时设置当前聊天对象
        const originalFriend = currentChatFriend;
        currentChatFriend = friendName;
        // 调用高级导入
        importChatHistoryAdvanced().finally(() => {
            // 恢复原来的聊天对象（如果有）
            if (originalFriend) {
                currentChatFriend = originalFriend;
            }
        });
    }

    // 删除好友
    async function deleteFriend() {
        if (!currentChatFriend) return;
        if (confirm('确定要删除好友 ' + currentChatFriend + ' 吗？')) {
            const friends = getFriendList();
            const filtered = friends.filter(f => f.name !== currentChatFriend);
            saveFriendList(filtered);
            await ChatStorage.delete(currentChatFriend);
            closeChatDetailPage();
            closeChatPage();
            renderFriendList();
            alert('好友已删除');
        }
    }

    // 拉入黑名单
    function addToBlacklist() {
        if (!currentChatFriend) return;
        if (confirm('确定要将 ' + currentChatFriend + ' 拉入黑名单吗？')) {
            alert('已拉入黑名单（功能开发中）');
        }
    }

    // 更新温度显示
    function updateTemperatureDisplay(value) {
        document.getElementById('temperatureValue').textContent = value;
    }

    // 获取我的人设列表
    function getMyPersonas() {
        const personas = localStorage.getItem('myPersonas');
        return personas ? JSON.parse(personas) : [];
    }

    // 保存我的人设列表
    function saveMyPersonas(personas) {
        localStorage.setItem('myPersonas', JSON.stringify(personas));
    }

    // 加载当前我的人设
    function loadMyPersona() {
        const current = localStorage.getItem('currentMyPersona');
        if (current) {
            currentPersona = JSON.parse(current);
            updateMyProfileDisplay();
        }
    }

    // 更新"我"页面显示
    function updateMyProfileDisplay() {
        if (currentPersona) {
            const avatarEl = document.getElementById('meProfileAvatar');
            if (currentPersona.avatarUrl) {
                avatarEl.innerHTML = `<img src="${currentPersona.avatarUrl}" alt="">`;
            } else {
                avatarEl.textContent = currentPersona.nickname.charAt(0);
            }
            document.getElementById('meProfileName').textContent = currentPersona.nickname;
            document.getElementById('meProfileId').textContent = `微信号：${currentPersona.wechatId}`;
        }
    }

    // 打开人设管理弹窗
    function openPersonaModal() {
        renderPersonaList();
        document.getElementById('personaModal').classList.add('active');
    }

    // 关闭人设管理弹窗
    function closePersonaModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('personaModal').classList.remove('active');
    }

    // 切换人设Tab
    function switchPersonaTab(tab) {
        const selectBtn = document.getElementById('selectPersonaTabBtn');
        const createBtn = document.getElementById('createPersonaTabBtn');
        const form = document.getElementById('personaForm');
        const list = document.getElementById('personaList');
        
        if (tab === 'select') {
            selectBtn.classList.add('active');
            createBtn.classList.remove('active');
            form.style.display = 'none';
            list.style.display = 'flex';
            renderPersonaList();
        } else {
            createBtn.classList.add('active');
            selectBtn.classList.remove('active');
            list.style.display = 'none';
            form.style.display = 'flex';
        }
    }

    // 渲染人设列表
    function renderPersonaList() {
        const personas = getMyPersonas();
        const list = document.getElementById('personaList');
        
        if (personas.length === 0) {
            list.classList.add('empty');
            list.innerHTML = '暂无创建的人设，快去新建吧～';
            return;
        }
        
        list.classList.remove('empty');
        list.innerHTML = personas.map((persona, index) => {
            const isActive = currentPersona && currentPersona.id === persona.id ? 'active' : '';
            const avatarContent = persona.avatarUrl 
                ? `<img src="${persona.avatarUrl}" alt="">`
                : persona.nickname.charAt(0);
            return `
                <div class="persona-item ${isActive}" onclick="selectPersona(${index})">
                    <div class="persona-item-icon">${avatarContent}</div>
                    <div class="persona-item-name">${persona.nickname}</div>
                </div>
            `;
        }).join('');
    }

    // 选择人设
    let selectedPersonaIndex = -1;
    function selectPersona(index) {
        const personas = getMyPersonas();
        if (index >= 0 && index < personas.length) {
            selectedPersonaIndex = index;
            document.querySelectorAll('.persona-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
    }

    // 处理头像上传
    function handlePersonaAvatarUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('personaAvatarPreview').innerHTML = `<img src="${e.target.result}" alt="">`;
            };
            reader.readAsDataURL(file);
        }
    }

    // 保存人设
    function savePersona() {
        const selectBtn = document.getElementById('selectPersonaTabBtn');
        const isSelectMode = selectBtn.classList.contains('active');
        
        if (isSelectMode) {
            // 选择模式：应用选中的人设
            if (selectedPersonaIndex >= 0) {
                const personas = getMyPersonas();
                currentPersona = personas[selectedPersonaIndex];
                localStorage.setItem('currentMyPersona', JSON.stringify(currentPersona));
                updateMyProfileDisplay();
                alert(`已切换人设：${currentPersona.nickname}`);
                closePersonaModal();
            } else {
                alert('请先选择一个人设！');
            }
        } else {
            // 创建模式：创建新人设
            const realName = document.getElementById('personaRealNameInput').value.trim();
            const nickname = document.getElementById('personaNicknameInput').value.trim() || 'USER';
            const wechatId = document.getElementById('personaWechatIdInput').value.trim() || 'USER123';
            const desc = document.getElementById('personaDescInput').value.trim();
            const avatarPreview = document.getElementById('personaAvatarPreview');
            const avatarImg = avatarPreview.querySelector('img');
            
            if (!realName) {
                alert('请填写真名！');
                return;
            }
            
            if (!avatarImg) {
                alert('请上传头像图片！');
                return;
            }
            
            const newPersona = {
                id: Date.now(),
                realName,
                nickname,
                wechatId,
                desc: desc || '暂无人设描述',
                avatarUrl: avatarImg.src
            };
            
            const personas = getMyPersonas();
            personas.push(newPersona);
            saveMyPersonas(personas);
            
            // 清空表单
            document.getElementById('personaRealNameInput').value = '';
            document.getElementById('personaNicknameInput').value = 'USER';
            document.getElementById('personaWechatIdInput').value = 'USER123';
            document.getElementById('personaDescInput').value = '';
            document.getElementById('personaAvatarPreview').innerHTML = '+';
            
            alert(`已创建新人设：${nickname}`);
            switchPersonaTab('select');
        }
    }

    // 在聊天详情中打开我的资料 - 改为打开人设选择弹窗
    function openMyProfileInChat() {
        // 不需要关闭聊天页面，直接打开人设选择弹窗
        selectMyPersona();
    }

    // 在朋友资料中选择我的人设
    function selectMyPersona() {
        const personas = getMyPersonas();
        const list = document.getElementById('myPersonaList');
        
        if (personas.length === 0) {
            list.classList.add('empty');
            list.innerHTML = '暂无创建的人设，请先在"我"页面创建';
        } else {
            list.classList.remove('empty');
            list.innerHTML = personas.map((persona, index) => {
                const avatarContent = persona.avatarUrl 
                    ? `<img src="${persona.avatarUrl}" alt="">`
                    : persona.nickname.charAt(0);
                return `
                    <div class="persona-item" onclick="applyMyPersona(${index})">
                        <div class="persona-item-icon">${avatarContent}</div>
                        <div class="persona-item-name">${persona.nickname}</div>
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('selectMyPersonaModal').classList.add('active');
    }

    // 关闭选择我的人设弹窗
    function closeSelectMyPersonaModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('selectMyPersonaModal').classList.remove('active');
    }

    // 打开钱包/服务页面
    function openWalletPage() {
        document.getElementById('wechatPage').classList.remove('active');
        document.getElementById('walletPage').classList.add('active');
    }

    // 关闭钱包/服务页面
    function closeWalletPage() {
        document.getElementById('walletPage').classList.remove('active');
        document.getElementById('wechatPage').classList.add('active');
        // 确保"我"页面依然显示
        document.getElementById('mePage').classList.add('active');
    }

    // 打开亲属卡弹窗
    function openRelativeCardModal() {
        document.getElementById('relativeCardModal').classList.add('active');
    }

    // 关闭亲属卡弹窗
    function closeRelativeCardModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('relativeCardModal').classList.remove('active');
    }

    // 添加亲属卡
    function addRelativeCard() {
        const relativeName = prompt('请输入亲属名称（如：妈妈、爸爸）：');
        if (relativeName && relativeName.trim()) {
            const list = document.getElementById('relativeCardList');
            // 移除占位提示
            if (list.querySelector('div[style*="text-align:center"]')) {
                list.innerHTML = '';
            }
            // 添加新的亲属卡
            const cardItem = document.createElement('div');
            cardItem.className = 'relative-card-item';
            cardItem.innerHTML = `
                <div class="relative-card-avatar"></div>
                <div class="relative-card-info">
                    <div class="relative-card-name">${relativeName.trim()}的亲属卡</div>
                    <div class="relative-card-desc">消费由你买单，限额：500元/月</div>
                </div>
            `;
            list.appendChild(cardItem);
            alert(`已添加${relativeName.trim()}的亲属卡！`);
        }
    }

    /**
     * API服务商配置
     * 预设主流AI服务商的接口规则，用于自动识别域名并补全接口后缀
     */
    const API_PROVIDERS = {
        openai: {
            name: 'OpenAI',
            baseUrl: 'https://api.openai.com',
            chatEndpoint: '/v1/chat/completions',
            modelsEndpoint: '/v1/models',
            patterns: ['api.openai.com', 'openai.com']
        },
        gemini: {
            name: 'Google Gemini',
            baseUrl: 'https://generativelanguage.googleapis.com',
            chatEndpoint: '/v1/models/gemini-pro:generateContent',
            modelsEndpoint: '/v1/models',
            patterns: ['generativelanguage.googleapis.com', 'gemini', 'googleapis.com']
        },
        claude: {
            name: 'Anthropic Claude',
            baseUrl: 'https://api.anthropic.com',
            chatEndpoint: '/v1/messages',
            modelsEndpoint: '/v1/messages',
            patterns: ['api.anthropic.com', 'anthropic.com', 'claude']
        }
    };

    /**
     * 反代地址自动补全逻辑
     * 核心功能：用户仅输入基础域名，系统自动识别服务商并补全对应的聊天接口后缀
     */
    function autoCompleteApiUrl() {
        const input = document.getElementById('openaiApiUrl');
        let url = input.value.trim();
        
        if (!url) return;
        
        // 如果已经是完整路径（包含 /v1/chat/completions 或 /v1/messages），不处理
        if (url.includes('/v1/chat/completions') || url.includes('/v1/messages') || url.includes('/v1/models/')) {
            return;
        }
        
        try {
            // 解析URL
            let urlObj;
            try {
                urlObj = new URL(url);
            } catch (e) {
                // 如果不是完整URL，尝试添加https://
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                    urlObj = new URL(url);
                } else {
                    throw e;
                }
            }
            
            const hostname = urlObj.hostname.toLowerCase();
            
            // 识别服务商：遍历预设的服务商配置，匹配域名模式
            let provider = null;
            for (const [key, config] of Object.entries(API_PROVIDERS)) {
                if (config.patterns.some(pattern => hostname.includes(pattern))) {
                    provider = config;
                    break;
                }
            }
            
            // 如果路径为空或只有 /，添加聊天端点
            if (!urlObj.pathname || urlObj.pathname === '/') {
                if (provider) {
                    // 识别到服务商，使用对应的端点
                    urlObj.pathname = provider.chatEndpoint;
                    input.value = urlObj.toString();
                    showApiUrlHint(`已自动补全为 ${provider.name} 接口`);
                } else {
                    // 未识别的服务商，默认使用OpenAI格式
                    urlObj.pathname = '/v1/chat/completions';
                    input.value = urlObj.toString();
                    showApiUrlHint('已自动补全为 OpenAI 格式接口');
                }
            }
        } catch (error) {
            console.warn('自动补全失败:', error);
        }
    }

    // 显示API地址提示
    function showApiUrlHint(message, isError = false) {
        const resultDiv = document.getElementById('apiUrlValidationResult');
        if (resultDiv) {
            resultDiv.style.color = isError ? '#ff4d4f' : 'var(--deep-pink)';
            resultDiv.textContent = message;
            setTimeout(() => {
                if (resultDiv.textContent === message) {
                    resultDiv.textContent = '';
                }
            }, 3000);
        }
    }

    /**
     * 测试API连接
     * 核心功能：配置完成后，点击"测试连接"按钮，自动发起请求验证API是否可用
     * 错误处理：覆盖"反代地址错误""密钥无效""跨域失败""返回格式非JSON"等常见错误场景
     */
    async function testApiConnection() {
        const apiUrl = document.getElementById('openaiApiUrl').value.trim();
        const apiKey = document.getElementById('openaiApiKey').value.trim();
        const resultDiv = document.getElementById('apiConnectionResult');
        const testBtn = document.getElementById('testConnectionBtn');
        const btnText = document.getElementById('testConnectionBtnText');
        
        // 验证必填项
        if (!apiUrl) {
            showConnectionResult('❌ 请先输入反代地址', 'error');
            alert('❌ 请先输入反代地址');
            return;
        }
        
        if (!apiKey) {
            showConnectionResult('❌ 请先输入API密钥', 'error');
            alert('❌ 请先输入API密钥');
            return;
        }
        
        // 显示测试中状态
        testBtn.disabled = true;
        btnText.textContent = '测试中...';
        showConnectionResult('⏳ 正在测试连接，请稍候...', 'loading');
        
        try {
            // 先尝试自动补全
            autoCompleteApiUrl();
            const finalUrl = document.getElementById('openaiApiUrl').value.trim();
            
            // 识别服务商
            const { key: providerKey, config: provider } = detectApiProvider(finalUrl);
            
            // 构建测试请求体（根据服务商使用不同的请求格式）
            let testPayload;
            let headers = {
                'Content-Type': 'application/json'
            };
            
            if (providerKey === 'claude') {
                // Claude格式
                testPayload = {
                    model: 'claude-3-haiku-20240307',
                    max_tokens: 5,
                    messages: [{ role: 'user', content: 'test' }]
                };
                headers['x-api-key'] = apiKey;
                headers['anthropic-version'] = '2023-06-01';
            } else if (providerKey === 'gemini') {
                // Gemini格式（简化验证）
                testPayload = {
                    contents: [{
                        parts: [{ text: 'test' }]
                    }]
                };
                if (apiKey.startsWith('AIza')) {
                    // Google API Key格式
                    testPayload = { ...testPayload, key: apiKey };
                } else {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }
            } else {
                // OpenAI格式（默认）
                testPayload = {
                    model: 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: 'test' }],
                    max_tokens: 5
                };
                headers['Authorization'] = `Bearer ${apiKey}`;
            }
            
            // 发送测试请求
            const response = await fetch(finalUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(testPayload)
            });
            
            // 读取响应文本
            const responseText = await response.text();
            
            // 检查响应类型
            const contentType = response.headers.get('content-type') || '';
            
            // 错误处理：HTTP状态码错误
            if (!response.ok) {
                // 错误场景1：返回HTML错误页面
                if (responseText.trim().toLowerCase().startsWith('<!doctype') || 
                    responseText.trim().toLowerCase().startsWith('<html')) {
                    throw new Error(`返回HTML错误页面（状态码: ${response.status}）\n\n可能原因：\n1. 反代地址不正确\n2. 接口路径错误\n3. 服务器配置问题\n\n解决建议：\n- 检查反代地址是否正确\n- 确认接口路径是否支持 /v1/chat/completions`);
                }
                
                // 错误场景2：返回JSON错误信息
                try {
                    const errorData = JSON.parse(responseText);
                    const errorMsg = errorData.error?.message || errorData.message || JSON.stringify(errorData);
                    
                    // 判断具体错误类型
                    if (errorMsg.includes('Invalid API key') || errorMsg.includes('Incorrect API key')) {
                        throw new Error(`密钥无效\n\n错误信息: ${errorMsg}\n\n解决建议：\n- 检查API密钥是否正确\n- 确认密钥是否已激活\n- 检查密钥权限是否足够`);
                    } else if (errorMsg.includes('model') || errorMsg.includes('Model')) {
                        throw new Error(`模型错误\n\n错误信息: ${errorMsg}\n\n解决建议：\n- 检查模型名称是否正确\n- 确认该模型是否可用`);
                    } else {
                        throw new Error(`API返回错误（状态码: ${response.status}）\n\n错误信息: ${errorMsg}`);
                    }
                } catch (parseError) {
                    // 无法解析JSON，返回原始错误
                    throw new Error(`连接失败（状态码: ${response.status}）\n\n响应内容: ${responseText.substring(0, 200)}\n\n可能原因：\n1. 反代地址配置错误\n2. 服务器返回了非标准错误格式`);
                }
            }
            
            // 错误处理：返回格式非JSON
            if (!contentType.includes('application/json') && !contentType.includes('text/json')) {
                if (responseText.trim().toLowerCase().startsWith('<!doctype') || 
                    responseText.trim().toLowerCase().startsWith('<html')) {
                    throw new Error(`返回HTML页面而非JSON数据\n\n可能原因：\n1. 反代地址不正确\n2. 接口路径错误\n3. 服务器返回了错误页面\n\n解决建议：\n- 检查反代地址是否正确\n- 确认接口是否支持POST请求`);
                } else {
                    throw new Error(`返回格式非JSON\n\n响应类型: ${contentType}\n响应内容: ${responseText.substring(0, 200)}\n\n解决建议：\n- 检查反代地址是否正确\n- 确认接口返回格式`);
                }
            }
            
            // 尝试解析JSON
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                throw new Error(`JSON解析失败\n\n错误: ${parseError.message}\n响应内容: ${responseText.substring(0, 200)}\n\n可能原因：\n1. 服务器返回了非标准JSON格式\n2. 响应被截断`);
            }
            
            // 验证成功
            let responseType = '未知格式';
            if (data.choices) {
                responseType = 'OpenAI格式';
            } else if (data.content) {
                responseType = 'Claude格式';
            } else if (data.candidates) {
                responseType = 'Gemini格式';
            }
            
            showConnectionResult(
                `✅ 连接成功！\n\n服务商: ${provider.name}\n响应格式: ${responseType}\n状态码: ${response.status}\n接口地址: ${finalUrl}`,
                'success'
            );
            
        } catch (error) {
            console.error('连接测试失败:', error);
            
            // 错误处理：跨域失败
            let errorMsg = error.message || error.toString();
            if (errorMsg.includes('CORS') || errorMsg.includes('Failed to fetch') || error.name === 'TypeError') {
                errorMsg = `跨域请求被阻止\n\n错误详情: ${errorMsg}\n\n可能原因：\n1. 反代服务器未配置CORS\n2. 浏览器安全策略限制\n\n解决建议：\n- 使用支持CORS的反代服务\n- 检查反代服务器配置\n- 尝试使用支持跨域的中转服务`;
            }
            
            // 显示在结果区域
            showConnectionResult(`❌ 连接失败\n\n${errorMsg}`, 'error');
            
            // 弹窗提醒错误
            alert(`❌ 连接测试失败\n\n${errorMsg}`);
        } finally {
            // 恢复按钮状态
            testBtn.disabled = false;
            btnText.textContent = '测试连接';
        }
    }

    /**
     * 显示连接测试结果
     */
    function showConnectionResult(message, type) {
        const resultDiv = document.getElementById('apiConnectionResult');
        if (!resultDiv) return;
        
        resultDiv.style.whiteSpace = 'pre-line';
        resultDiv.style.wordBreak = 'break-word';
        
        if (type === 'success') {
            resultDiv.style.color = 'var(--success-color)';
            resultDiv.style.backgroundColor = 'rgba(52, 199, 89, 0.1)';
            resultDiv.style.border = '1px solid rgba(52, 199, 89, 0.2)';
        } else if (type === 'error') {
            resultDiv.style.color = '#ff4d4f';
            resultDiv.style.backgroundColor = 'rgba(255, 59, 48, 0.1)';
            resultDiv.style.border = '1px solid rgba(255, 59, 48, 0.2)';
        } else {
            resultDiv.style.color = 'var(--text-color)';
            resultDiv.style.backgroundColor = 'rgba(240, 200, 214, 0.1)';
            resultDiv.style.border = '1px solid rgba(240, 200, 214, 0.2)';
        }
        
        resultDiv.style.padding = '12px';
        resultDiv.style.borderRadius = '10px';
        resultDiv.style.fontSize = '12px';
        resultDiv.style.lineHeight = '1.5';
        resultDiv.textContent = message;
    }

    // 识别API服务商
    function detectApiProvider(url) {
        try {
            const urlObj = new URL(url);
            const hostname = urlObj.hostname.toLowerCase();
            
            for (const [key, config] of Object.entries(API_PROVIDERS)) {
                if (config.patterns.some(pattern => hostname.includes(pattern))) {
                    return { key, config };
                }
            }
            
            // 根据路径判断
            if (url.includes('/v1/messages')) {
                return { key: 'claude', config: API_PROVIDERS.claude };
            } else if (url.includes('/v1/models/') && url.includes('generateContent')) {
                return { key: 'gemini', config: API_PROVIDERS.gemini };
            }
            
            return { key: 'openai', config: API_PROVIDERS.openai }; // 默认
        } catch (e) {
            return { key: 'openai', config: API_PROVIDERS.openai };
        }
    }

    // 验证API接口
    // 兼容旧版本的验证接口函数（已废弃，统一使用testApiConnection）
    async function validateApiUrl() {
        // 直接调用新的测试连接函数
        await testApiConnection();
    }

    // 拉取模型列表 - 参考烦.html的简单实现
    async function fetchModels(clickEvent) {
        const apiUrl = document.getElementById('openaiApiUrl').value.trim();
        const apiKey = document.getElementById('openaiApiKey').value.trim();
        
        if (!apiUrl || !apiKey) {
            alert('请先填写对应的反代地址和密钥');
            return;
        }
        
        // 获取按钮并显示加载状态
        const fetchBtn = clickEvent?.target || document.getElementById('fetchModelsBtn') || document.querySelector('button[onclick*="fetchModels"]');
        const originalText = fetchBtn?.textContent || '拉取模型';
        if (fetchBtn) {
            fetchBtn.disabled = true;
            fetchBtn.textContent = '拉取中...';
        }
        
        try {
            // 构建模型列表API地址 - 参考烦.html的简单方式
            // 核心逻辑：避免重复拼接 /v1/
            let modelsUrl;
            if (apiUrl.includes('/chat/completions')) {
                // 直接替换 /chat/completions 为 /models（不管前面有没有/v1/）
                // 例如：https://api.daidaibird.top/v1/chat/completions -> https://api.daidaibird.top/v1/models
                modelsUrl = apiUrl.replace('/chat/completions', '/models');
            } else {
                // 移除末尾的斜杠
                let baseUrl = apiUrl.replace(/\/+$/, '');
                
                // 如果baseUrl已经以 /v1 结尾，直接拼接 /models
                if (baseUrl.endsWith('/v1')) {
                    modelsUrl = `${baseUrl}/models`;
                } else {
                    // 否则拼接 /v1/models（参考烦.html的方式）
                    modelsUrl = `${baseUrl}/v1/models`;
                }
            }
            
            console.log('请求模型列表URL:', modelsUrl);
            
            // 直接fetch，参考烦.html的简单方式
            const response = await fetch(modelsUrl, {
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            
            if (!response.ok) {
                throw new Error('无法获取模型列表');
            }
            
            // 直接解析JSON，参考烦.html
            const data = await response.json();
            
            // 处理模型数据 - 参考烦.html
            let models = data.data || data.models || [];
            
            // 如果是Gemini格式，需要特殊处理
            if (data.models && Array.isArray(data.models)) {
                models = data.models.map(model => ({ id: model.name?.split('/')[1] || model.name || model }));
            }
            
            if (!Array.isArray(models) || models.length === 0) {
                throw new Error('未获取到模型列表，请检查API地址');
            }
            
            // 更新下拉框
            const select = document.getElementById('openaiModel');
            const savedModel = select.value; // 保存当前选中的值
            select.innerHTML = '';
            
            // 添加新模型选项
            models.forEach(model => {
                const option = document.createElement('option');
                const modelId = typeof model === 'string' ? model : (model.id || model.name);
                option.value = modelId;
                option.textContent = modelId;
                if (modelId === savedModel) option.selected = true;
                select.appendChild(option);
            });
            
            alert('模型列表已更新');
        } catch (error) {
            console.error('拉取模型失败:', error);
            alert(`拉取模型失败: ${error.message}`);
        } finally {
            // 恢复按钮状态
            if (fetchBtn) {
                fetchBtn.disabled = false;
                fetchBtn.textContent = originalText;
            }
        }
    }

    // 应用我的人设
    function applyMyPersona(index) {
        const personas = getMyPersonas();
        if (index >= 0 && index < personas.length) {
            const persona = personas[index];
            
            // 应用人设描述
            document.getElementById('personaTextarea').value = persona.desc;
            
            // 应用头像
            if (persona.avatarUrl) {
                const previewEl = document.getElementById('avatarPreview');
                previewEl.innerHTML = `<img src="${persona.avatarUrl}" alt="">`;
            }
            
            alert(`已应用我的人设：${persona.nickname}`);
            closeSelectMyPersonaModal();
        }
    }

    /**
     * 关闭聊天页面，返回微信主页面
     * 关闭前会更新好友的最后一条消息
     */
    function closeChatPage() {
        // 在关闭前，更新当前聊天好友的最后一条消息（从 localStorage 读取最新状态）
        if (currentChatFriend) {
            const messages = localStorage.getItem(`chat_${currentChatFriend}`);
            if (messages) {
                const chatHistory = JSON.parse(messages);
                updateFriendLastMessageAfterDelete(currentChatFriend, chatHistory);
            }
        }
        
        document.getElementById('chatPage').classList.remove('active');
        document.getElementById('wechatPage').classList.add('active');
        // 重新渲染好友列表以更新最后一条消息
        renderFriendList();
        currentChatFriend = '';
    }

    // ========== 聊天消息工具函数 ==========
    
    /**
     * 生成唯一消息ID
     * @returns {string} 消息ID
     */
    function generateMessageId() {
        return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // 处理语音点击
    function handleVoiceClick(element) {
        const text = element.dataset.voiceText;
        // 如果是对方发的，播放TTS
        const messageEl = element.closest('.chat-message');
        if (messageEl && !messageEl.classList.contains('self')) {
             const utterance = new SpeechSynthesisUtterance(text);
             utterance.lang = 'zh-CN';
             window.speechSynthesis.speak(utterance);
        }
        
        // 同时切换显示文字
        toggleVoiceToText(element);
    }

    // 接收红包
    function receiveRedPacket(amount, note) {
        amount = parseFloat(amount);
        if (confirm(`收到红包：${amount.toFixed(2)}元\n备注：${note}\n是否领取？`)) {
            const data = getWalletData();
            data.balance += amount;
            data.transactions.push({
                name: `收到红包 (${currentChatFriend})`,
                amount: amount,
                time: new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
            });
            saveWalletData(data);
            updateWalletUI();
            alert(`已领取 ${amount.toFixed(2)} 元！`);
        }
    }

    // 支付收款
    function payTransfer(amount, note) {
        amount = parseFloat(amount);
        if (confirm(`向 ${currentChatFriend} 支付：${amount.toFixed(2)}元\n说明：${note}\n是否确认支付？`)) {
            const data = getWalletData();
            if (data.balance < amount) {
                alert('余额不足，无法支付');
                return;
            }
            data.balance -= amount;
            data.transactions.push({
                name: `支付收款 (${currentChatFriend})`,
                amount: -amount,
                time: new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
            });
            saveWalletData(data);
            updateWalletUI();
            alert(`支付成功！`);
        }
    }

    // 查看位置
    function viewLocation(address) {
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        if(confirm(`即将打开地图查看：${address}`)) {
            window.open(url, '_blank');
        }
    }

    // 生成位置SVG
    function generateLocationSvg() {
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">
            <rect width="120" height="120" fill="#f0f0f0"/>
            <path d="M60 20 C40 20 25 35 25 55 C25 85 60 110 60 110 C60 110 95 85 95 55 C95 35 80 20 60 20 Z" fill="#FF5722"/>
            <circle cx="60" cy="55" r="15" fill="white"/>
        </svg>`);
        return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // 添加聊天消息
    function addChatMessage(name, text, isSelf, scroll = true, messageId = null, imageUrl = null, imageDesc = null, voiceDuration = null, voiceText = null, redPacketData = null, locationData = null) {
        const messages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isSelf ? 'self' : ''}`;
        
        // 如果没有提供ID，生成一个
        if (!messageId) {
            messageId = generateMessageId();
        }
        messageDiv.dataset.messageId = messageId;
        
        const avatar = isSelf ? '我' : name.charAt(0);
        
        // 构建消息内容
        let bubbleContent = '';
        
        // 红包消息
        if (redPacketData) {
            // 给外层气泡添加特殊类，去除默认样式
            
            // 点击事件逻辑
            const clickAction = isSelf ? '' : (redPacketData.isTransfer ? `payTransfer('${redPacketData.amount}', '${redPacketData.note}')` : `receiveRedPacket('${redPacketData.amount}', '${redPacketData.note}')`);
            const pointerStyle = isSelf ? '' : 'cursor:pointer;';
            const onclickAttr = clickAction ? `onclick="${clickAction}"` : '';
            
            if (redPacketData.isTransfer) {
                // 收款样式（与红包完全不同）
                const transferIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" width="24" height="24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>';
                
                bubbleContent = `
                    <div class="transfer-bubble" style="${pointerStyle}" ${onclickAttr} data-amount="${redPacketData.amount}" data-note="${redPacketData.note}" data-is-transfer="true">
                        <div class="transfer-top">
                            <div class="transfer-icon">${transferIcon}</div>
                            <div class="transfer-content">
                                <div class="transfer-amount">￥${parseFloat(redPacketData.amount).toFixed(2)}</div>
                                <div class="transfer-note">${redPacketData.note || '收款'}</div>
                            </div>
                        </div>
                        <div class="transfer-bottom">点击支付</div>
                    </div>
                `;
            } else {
                // 红包样式
                // 获取封面样式
                const coverId = redPacketData.cover || 'default';
                let coverStyle = 'background-color: #f76260;'; // 默认红色
                
                // 尝试在 redPacketCovers 中查找
                if (typeof redPacketCovers !== 'undefined') {
                    const cover = redPacketCovers.find(c => c.id === coverId);
                    if (cover) {
                        if (cover.image) {
                            coverStyle = `background-image: url('${cover.image}'); background-size: cover; background-position: center;`;
                        } else if (cover.color) {
                            coverStyle = `background-color: ${cover.color};`;
                        }
                    }
                } else {
                    if (coverId === 'love') coverStyle = 'background-color: #ff8a80;';
                    else if (coverId === 'gold') coverStyle = 'background-color: #ffd54f;';
                    else if (coverId === 'blue') coverStyle = 'background-color: #4fc3f7;';
                }

                // 文字颜色
                const textColor = redPacketData.textColor || 'var(--text-color)';
                const statusText = isSelf ? '已发出' : '领取红包';

                bubbleContent = `
                    <div class="red-packet-bubble" style="${pointerStyle}" ${onclickAttr} data-amount="${redPacketData.amount}" data-note="${redPacketData.note}" data-cover="${coverId}" data-text-color="${textColor}">
                        <div class="red-packet-top" style="${coverStyle}">
                            <!-- 已移除图标 -->
                            <div class="red-packet-text">
                                <div class="red-packet-note" style="color: ${textColor}">${redPacketData.note}</div>
                                <div class="red-packet-status" style="color: ${textColor}; opacity: 0.8;">${statusText}</div>
                            </div>
                        </div>
                        <div class="red-packet-bottom">微信红包</div>
                    </div>
                `;
            }
        } else if (voiceDuration !== null && voiceDuration !== undefined) {
            const duration = voiceDuration || 1;
            const originalText = voiceText || text || '';
            bubbleContent = `
                <div class="voice-message" data-voice-text="${originalText.replace(/"/g, '&quot;')}" onclick="handleVoiceClick(this)">
                    <span class="voice-duration">${duration}"</span>
                    <svg class="voice-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </div>
                <div class="voice-text-content" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">${originalText}</div>
            `;
        } else if (locationData) {
            // 位置消息
            const svg = generateLocationSvg();
            bubbleContent = `
                <div class="location-message" onclick="viewLocation('${locationData.address}')" style="cursor:pointer">
                    <img src="${svg}" alt="位置" style="display:block; width:100%; border-radius: 4px;">
                    <div style="padding: 5px; font-size: 14px; font-weight: bold; color: var(--text-color);">${locationData.address}</div>
                    <div style="padding: 0 5px 5px; font-size: 12px; color: #999;">${locationData.detail || ''}</div>
                </div>
            `;
        } else if (imageUrl) {
            // 判断是否为表情消息（无文字内容且无描述）
            const isEmoji = !text && !imageDesc;
            
            if (isEmoji) {
                // 表情消息：80px尺寸
                bubbleContent = `<img src="${imageUrl}" alt="表情" class="emoji-message" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display:none;color:var(--text-color);font-size:12px;">表情加载失败</div>`;
            } else {
                // 普通图片消息
                if (imageDesc) {
                    // 文字图片：点击切换模式
                    // 默认显示图片，隐藏文字
                    // 文字区域设置 padding 以便阅读
                    bubbleContent = `
                        <img src="${imageUrl}" alt="图片" onclick="toggleImageText(this)" style="display:block; cursor:pointer;">
                        <div class="image-desc-content" onclick="toggleImageText(this)" style="display:none; cursor:pointer; padding: 5px; min-width: 60px; font-size: 15px; color: var(--text-color);">${imageDesc}</div>
                    `;
                } else {
                    // 真实图片：无描述，无点击切换
                    bubbleContent = `<img src="${imageUrl}" alt="图片" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display:none;color:var(--text-color);font-size:12px;">图片加载失败</div>`;
                }
            }
        } else {
            // 纯文字消息
            bubbleContent = text;
        }
        
        messageDiv.innerHTML = `
            <div class="chat-avatar">${avatar}</div>
            <div class="chat-bubble" data-message-id="${messageId}">${bubbleContent}</div>
        `;
        
        // 如果是红包，添加特殊的 wrapper 类去除气泡样式
        if (redPacketData) {
            const bubbleEl = messageDiv.querySelector('.chat-bubble');
            if (bubbleEl) bubbleEl.classList.add('red-packet-wrapper');
        }
        
        // 添加长按事件（参考微信）
        const bubble = messageDiv.querySelector('.chat-bubble');
        let longPressTimer = null;
        let isLongPress = false;
        
        const handleLongPress = (e) => {
            isLongPress = true;
            e.preventDefault();
            e.stopPropagation();
            showMessageActionMenu(messageId, messageDiv, isSelf);
        };
        
        // 触摸事件
        bubble.addEventListener('touchstart', function(e) {
            isLongPress = false;
            longPressTimer = setTimeout(() => {
                handleLongPress(e);
            }, 500);
        }, { passive: false });
        
        bubble.addEventListener('touchend', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            // 如果是长按触发的，阻止默认行为
            if (isLongPress) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
        
        bubble.addEventListener('touchmove', function() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        // 鼠标长按（桌面端）
        bubble.addEventListener('mousedown', function(e) {
            isLongPress = false;
            longPressTimer = setTimeout(() => {
                handleLongPress(e);
            }, 500);
        });
        
        bubble.addEventListener('mouseup', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (isLongPress) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
        
        bubble.addEventListener('mouseleave', function() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        messages.appendChild(messageDiv);
        if (scroll) {
            messages.scrollTop = messages.scrollHeight;
        }
        
        return messageId;
    }

    // 当前多选模式状态
    let isMultiSelectMode = false;
    let selectedMessages = new Set();

    // 显示消息操作菜单（参考微信）
    function showMessageActionMenu(messageId, messageElement, isSelf) {
        // 移除之前的菜单
        const existingMenu = document.querySelector('.message-action-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
        
        const menu = document.createElement('div');
        menu.className = 'message-action-menu';
        menu.dataset.messageId = messageId;
        
        // 构建菜单项
        let menuItems = [];
        
        // 复制（双方都可以）
        menuItems.push(`
            <button class="message-action-btn" onclick="copyChatMessage('${messageId}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span class="btn-label">复制</span>
            </button>
        `);
        
        // 撤回（只能撤回自己的消息）
        if (isSelf) {
            menuItems.push(`
                <button class="message-action-btn" onclick="recallChatMessage('${messageId}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                        <path d="M21 3v5h-5"></path>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        <path d="M3 21v-5h5"></path>
                    </svg>
                    <span class="btn-label">撤回</span>
                </button>
            `);
        }
        
        // 多选
        menuItems.push(`
            <button class="message-action-btn" onclick="enterMultiSelectMode('${messageId}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                <span class="btn-label">多选</span>
            </button>
        `);
        
        // 删除（双方都可以）
        menuItems.push(`
            <button class="message-action-btn delete-btn" onclick="deleteChatMessage('${messageId}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <span class="btn-label">删除</span>
            </button>
        `);
        
        menu.innerHTML = menuItems.join('');
        document.body.appendChild(menu);
        
        // 定位菜单（在消息气泡附近）
        const rect = messageElement.getBoundingClientRect();
        const menuWidth = menu.offsetWidth;
        const menuHeight = menu.offsetHeight;
        
        // 计算位置，确保不超出屏幕
        let left = rect.left + (rect.width / 2) - (menuWidth / 2);
        let top = rect.top - menuHeight - 10;
        
        // 如果菜单超出左边界，调整位置
        if (left < 10) left = 10;
        // 如果菜单超出右边界，调整位置
        if (left + menuWidth > window.innerWidth - 10) {
            left = window.innerWidth - menuWidth - 10;
        }
        // 如果菜单超出上边界，显示在下方
        if (top < 10) {
            top = rect.bottom + 10;
        }
        
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        
        // 点击其他地方关闭菜单（延迟添加，避免立即关闭）
        const closeMenuHandler = (e) => {
            // 如果点击的不是菜单本身，关闭菜单
            if (!menu.contains(e.target) && !messageElement.contains(e.target)) {
                menu.remove();
                document.removeEventListener('click', closeMenuHandler);
                document.removeEventListener('touchstart', closeMenuHandler);
            }
        };
        
        // 延迟添加事件监听，避免立即触发
        setTimeout(() => {
            document.addEventListener('click', closeMenuHandler, { once: true });
            document.addEventListener('touchstart', closeMenuHandler, { once: true });
        }, 300);
    }

    // 复制消息
    function copyChatMessage(messageId) {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!messageElement) return;
        
        const text = messageElement.textContent;
        
        // 使用 Clipboard API 复制
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                alert('已复制到剪贴板');
            }).catch(() => {
                // 降级方案
                fallbackCopyText(text);
            });
        } else {
            fallbackCopyText(text);
        }
        
        // 关闭菜单
        const menu = document.querySelector('.message-action-menu');
        if (menu) menu.remove();
    }

    // 降级复制方案
    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert('已复制到剪贴板');
        } catch (err) {
            alert('复制失败，请手动复制');
        }
        document.body.removeChild(textArea);
    }

    // 语音消息点击转文字
    function toggleVoiceToText(element) {
        const textContent = element.nextElementSibling;
        if (textContent && textContent.classList.contains('voice-text-content')) {
            if (textContent.style.display === 'none') {
                textContent.style.display = 'block';
            } else {
                textContent.style.display = 'none';
            }
        }
    }

    // 图片与文字切换显示
    function toggleImageText(element) {
        const parent = element.parentElement; // chat-bubble
        const img = parent.querySelector('img');
        const desc = parent.querySelector('.image-desc-content');
        
        if (img && desc) {
            if (img.style.display !== 'none') {
                // 当前是图片，切换为文字
                img.style.display = 'none';
                desc.style.display = 'block';
            } else {
                // 当前是文字，切换为图片
                img.style.display = 'block';
                desc.style.display = 'none';
            }
        }
    }

    // 撤回消息（只能撤回自己的消息）
    async function recallChatMessage(messageId) {
        if (!currentChatFriend) return;
        
        // 检查是否是自己的消息
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!messageElement) return;
        
        const chatMessage = messageElement.closest('.chat-message');
        if (!chatMessage || !chatMessage.classList.contains('self')) {
            alert('只能撤回自己的消息');
            return;
        }
        
        // 从DOM中删除
        chatMessage.remove();
        
        // 从IndexedDB中删除
        const chatHistory = await ChatStorage.load(currentChatFriend);
        if (chatHistory) {
            const filteredHistory = chatHistory.filter(msg => msg.id !== messageId);
            await ChatStorage.save(currentChatFriend, filteredHistory);
            
            // 更新好友列表的最后一条消息
            updateFriendLastMessageAfterDelete(currentChatFriend, filteredHistory);
        }
        
        // 关闭菜单
        const menu = document.querySelector('.message-action-menu');
        if (menu) menu.remove();
        
        alert('消息已撤回');
    }

    // 进入多选模式
    function enterMultiSelectMode(messageId) {
        isMultiSelectMode = true;
        selectedMessages.clear();
        selectedMessages.add(messageId);
        
        // 添加多选模式样式
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.classList.add('multi-select-mode');
        
        // 标记选中的消息
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.closest('.chat-message').classList.add('selected');
        }
        
        // 显示多选操作栏
        showMultiSelectBar();
        
        // 关闭菜单
        const menu = document.querySelector('.message-action-menu');
        if (menu) menu.remove();
        
        // 为所有消息添加点击选择功能
        const allMessages = messagesContainer.querySelectorAll('.chat-message');
        allMessages.forEach(msg => {
            const msgId = msg.dataset.messageId;
            if (msgId) {
                msg.addEventListener('click', function() {
                    toggleMessageSelection(msgId);
                });
            }
        });
    }

    // 切换消息选择状态
    function toggleMessageSelection(messageId) {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!messageElement) return;
        
        const chatMessage = messageElement.closest('.chat-message');
        if (!chatMessage) return;
        
        if (selectedMessages.has(messageId)) {
            selectedMessages.delete(messageId);
            chatMessage.classList.remove('selected');
        } else {
            selectedMessages.add(messageId);
            chatMessage.classList.add('selected');
        }
        
        updateMultiSelectBar();
    }

    // 显示多选操作栏
    function showMultiSelectBar() {
        let bar = document.getElementById('multiSelectBar');
        if (!bar) {
            bar = document.createElement('div');
            bar.id = 'multiSelectBar';
            bar.className = 'multi-select-bar';
            bar.innerHTML = `
                <div class="multi-select-info" id="multiSelectInfo">已选择 1 条</div>
                <div class="multi-select-actions">
                    <div class="multi-select-action-btn" onclick="deleteSelectedMessages()">删除</div>
                    <div class="multi-select-action-btn" onclick="copySelectedMessages()">复制</div>
                    <div class="multi-select-action-btn" onclick="exitMultiSelectMode()">取消</div>
                </div>
            `;
            document.body.appendChild(bar);
        }
        bar.classList.add('active');
        updateMultiSelectBar();
    }

    // 更新多选操作栏信息
    function updateMultiSelectBar() {
        const info = document.getElementById('multiSelectInfo');
        if (info) {
            info.textContent = `已选择 ${selectedMessages.size} 条`;
        }
    }

    // 退出多选模式
    function exitMultiSelectMode() {
        isMultiSelectMode = false;
        selectedMessages.clear();
        
        // 移除多选模式样式
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.classList.remove('multi-select-mode');
        
        // 移除所有选中状态
        messagesContainer.querySelectorAll('.chat-message.selected').forEach(msg => {
            msg.classList.remove('selected');
        });
        
        // 隐藏多选操作栏
        const bar = document.getElementById('multiSelectBar');
        if (bar) {
            bar.classList.remove('active');
        }
        
        // 移除点击事件（重新添加长按事件会在下次加载消息时自动添加）
    }

    // 删除选中的消息
    async function deleteSelectedMessages() {
        if (selectedMessages.size === 0) {
            alert('请先选择要删除的消息');
            return;
        }
        
        if (!confirm(`确定要删除选中的 ${selectedMessages.size} 条消息吗？`)) {
            return;
        }
        
        // 先收集要删除的消息ID
        const messageIdsToDelete = Array.from(selectedMessages);
        
        // 批量删除（不更新好友列表，最后统一更新）
        messageIdsToDelete.forEach(messageId => {
            // 从DOM中删除
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.closest('.chat-message').remove();
            }
            
            // 从选中列表中移除
            selectedMessages.delete(messageId);
        });
        
        // 从IndexedDB中批量删除并统一更新好友列表
        if (currentChatFriend) {
            const chatHistory = await ChatStorage.load(currentChatFriend);
            if (chatHistory) {
                const filteredHistory = chatHistory.filter(msg => !messageIdsToDelete.includes(msg.id));
                await ChatStorage.save(currentChatFriend, filteredHistory);
                
                // 统一更新好友列表的最后一条消息
                updateFriendLastMessageAfterDelete(currentChatFriend, filteredHistory);
            }
        }
        
        // 关闭菜单
        const menu = document.querySelector('.message-action-menu');
        if (menu) menu.remove();
        
        exitMultiSelectMode();
    }

    // 复制选中的消息
    function copySelectedMessages() {
        if (selectedMessages.size === 0) {
            alert('请先选择要复制的消息');
            return;
        }
        
        const texts = [];
        selectedMessages.forEach(messageId => {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                texts.push(messageElement.textContent);
            }
        });
        
        const textToCopy = texts.join('\n');
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert(`已复制 ${selectedMessages.size} 条消息到剪贴板`);
                exitMultiSelectMode();
            }).catch(() => {
                fallbackCopyText(textToCopy);
                exitMultiSelectMode();
            });
        } else {
            fallbackCopyText(textToCopy);
            exitMultiSelectMode();
        }
    }

    // 删除消息
    async function deleteChatMessage(messageId) {
        // 从DOM中删除
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.closest('.chat-message').remove();
        }
        
        // 从IndexedDB中删除
        if (currentChatFriend) {
            const chatHistory = await ChatStorage.load(currentChatFriend);
            if (chatHistory) {
                const filteredHistory = chatHistory.filter(msg => msg.id !== messageId);
                await ChatStorage.save(currentChatFriend, filteredHistory);
                
                // 更新好友列表的最后一条消息
                updateFriendLastMessageAfterDelete(currentChatFriend, filteredHistory);
            }
        }
        
        // 从选中列表中移除
        selectedMessages.delete(messageId);
        
        // 关闭菜单
        const menu = document.querySelector('.message-action-menu');
        if (menu) menu.remove();
    }

    // 关闭弹窗
    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
    }


    // 记录设置页面来源
    let settingsPageSource = 'desktop';

    // 打开设置页面
    // 打开"我"页面的设置（独立设置页面）
    function openMeSettingsPage() {
        // 这里可以打开一个独立的"我"页面设置
        // 目前先提示，用户可以根据需要实现
        alert('"我"页面的设置功能（待实现）');
        // 如果需要打开不同的设置页面，可以创建新的页面ID，例如：
        // document.getElementById('meSettingsPage').classList.add('active');
    }
    
    // 打开桌面/系统设置页面
    function openSettingsPage() {
            settingsPageSource = 'desktop';
        document.getElementById('desktop').classList.add('hidden');
        document.getElementById('settingsPage').classList.add('active');
    }

    // 关闭设置页面
    function closeSettingsPage() {
        document.getElementById('settingsPage').classList.remove('active');
        // 判断应该返回到哪里
        if (settingsPageSource === 'me') {
            // 返回到"我"页面，重新打开wechatPage
            document.getElementById('wechatPage').classList.add('active');
            document.getElementById('mePage').classList.add('active');
        } else {
            document.getElementById('desktop').classList.remove('hidden');
        }
    }

    // 打开个性化设置页面
    function openPersonalizationPage() {
        document.getElementById('desktop').classList.add('hidden');
        document.getElementById('personalizationPage').classList.add('active');
    }

    // 关闭个性化设置页面
    function closePersonalizationPage() {
        document.getElementById('desktop').classList.remove('hidden');
        document.getElementById('personalizationPage').classList.remove('active');
    }

    // 切换小组件设置折叠面板
    function toggleWidgetSettings() {
        const panel = document.getElementById('widgetSettingsPanel');
        panel.classList.toggle('expanded');
    }

    // 切换API设置折叠面板
    function toggleApiSettings() {
        const panel = document.getElementById('apiSettingsPanel');
        panel.classList.toggle('expanded');
    }

    // 切换系统设置折叠面板
    function toggleSystemSettings() {
        const panel = document.getElementById('systemSettingsPanel');
        panel.classList.toggle('expanded');
    }

    // 切换密码显示/隐藏
    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
            button.textContent = '隐藏';
        } else {
            input.type = 'password';
            button.textContent = '显示';
        }
    }

    // 预览头像
    function previewAvatar(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // 更新桌面头像
                const avatarContainer = document.getElementById('avatarContainer');
                avatarContainer.innerHTML = '';
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'avatar-img';
                avatarContainer.appendChild(img);
                
                // 更新设置页面预览
                const previewAvatar = document.getElementById('previewAvatar');
                previewAvatar.innerHTML = '';
                const previewImg = document.createElement('img');
                previewImg.src = e.target.result;
                previewImg.className = 'avatar-img';
                previewAvatar.appendChild(previewImg);
            }
            reader.readAsDataURL(file);
        }
    }

    // ================== 天气功能实现 (纯前端/无后端) ==================

    // 天气状态映射 (Open-Meteo WMO Code)
    function getWeatherStatus(code) {
        if (code === 0) return { type: '晴', icon: 'sun' };
        if (code >= 1 && code <= 3) return { type: '多云', icon: '⛅' };
        if (code >= 45 && code <= 48) return { type: '雾', icon: '🌫️' };
        if (code >= 51 && code <= 67) return { type: '雨', icon: '🌧️' };
        if (code >= 71 && code <= 77) return { type: '雪', icon: '❄️' };
        if (code >= 80 && code <= 82) return { type: '阵雨', icon: '🌦️' };
        if (code >= 85 && code <= 86) return { type: '雪', icon: '❄️' };
        if (code >= 95 && code <= 99) return { type: '雷雨', icon: '⛈️' };
        return { type: '阴', icon: '☁️' };
    }

    // 更新天气UI
    function updateWeatherUI(temp, code) {
        const status = getWeatherStatus(code);
        const tempStr = `${Math.round(temp)}℃`;
        
        // 更新温度显示
        const tempEl = document.getElementById('showTemp');
        const inputEl = document.getElementById('tempDisplay');
        if(tempEl) tempEl.textContent = tempStr;
        if(inputEl) inputEl.value = tempStr;

        // 更新图标
        const iconContainer = document.querySelector('.weather-icon');
        if (iconContainer) {
            if (status.icon === 'sun') {
                // 保持原有的CSS太阳动画
                iconContainer.innerHTML = `
                    <div class="sun-circle"></div>
                    <div class="sun-ray ray-1"></div>
                    <div class="sun-ray ray-2"></div>
                    <div class="sun-ray ray-3"></div>
                    <div class="sun-ray ray-4"></div>
                    <div class="sun-ray ray-5"></div>
                    <div class="sun-ray ray-6"></div>
                    <div class="sun-ray ray-7"></div>
                    <div class="sun-ray ray-8"></div>
                `;
            } else {
                // 使用Emoji显示其他天气
                iconContainer.innerHTML = `<div style="font-size: 22px; line-height: 20px; text-align: center; margin-top:-2px;">${status.icon}</div>`;
            }
        }
    }

    // 核心天气获取函数
    async function fetchWeatherData(lat, lon, isManual = false) {
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Weather API Error');
            
            const data = await res.json();
            const { temperature, weathercode } = data.current_weather;
            
            updateWeatherUI(temperature, weathercode);
            
            // 保存最后一次成功的数据
            localStorage.setItem('lastWeatherData', JSON.stringify({
                temp: temperature,
                code: weathercode,
                timestamp: Date.now()
            }));

            if (isManual) alert(`更新成功：${temperature}℃`);
            
        } catch (error) {
            console.error("天气更新失败:", error);
            if (isManual) alert('天气更新失败，请稍后重试');
            loadLastWeather(); // 失败时加载缓存
        }
    }

    // 加载缓存天气
    function loadLastWeather() {
        const last = localStorage.getItem('lastWeatherData');
        if (last) {
            try {
                const { temp, code } = JSON.parse(last);
                updateWeatherUI(temp, code);
            } catch(e) {}
        }
    }

    // 初始化天气系统
    function initWeatherSystem() {
        // 尝试加载缓存作为兜底
        loadLastWeather();

        // 严格禁用定位，仅使用保存的城市
        // if (navigator.geolocation) { ... } // 已移除
        
        if (savedCity) {
            getCoordinatesByCity(savedCity);
        }
    }

    // 通过城市名获取坐标 (Open-Meteo Geocoding)
    async function getCoordinatesByCity(city, isManual = false) {
        try {
            const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh&format=json`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.results && data.results.length > 0) {
                const { latitude, longitude, name } = data.results[0];
                // 如果是手动查询，保存这个确定的城市名
                if (isManual) {
                     localStorage.setItem('savedCity', name); 
                     savedCity = name;
                }
                fetchWeatherData(latitude, longitude, isManual);
            } else {
                if (isManual) alert('未找到该城市，请尝试输入拼音或英文名');
            }
        } catch (e) {
            console.error("城市搜索失败", e);
            if (isManual) alert('城市搜索失败，请检查网络');
            loadLastWeather();
        }
    }

    // 手动查询天气
    async function getWeather() {
        const city = document.getElementById('cityInput').value.trim();
        if (!city) {
            alert('请输入城市名称！');
            return;
        }
        getCoordinatesByCity(city, true);
    }

    // 自动更新天气
    function autoUpdateWeather() {
        initWeatherSystem();
    }

    // 测试OpenAI API连接
    async function testOpenAI() {
        const apiUrl = document.getElementById('openaiApiUrl').value.trim();
        const apiKey = document.getElementById('openaiApiKey').value.trim();
        const model = document.getElementById('openaiModel').value;
        const testMessage = document.getElementById('openaiTestMessage').value.trim() || '你好，请简单介绍一下你自己';
        
        if (!apiUrl || !apiKey) {
            showTestResult('openaiTestResult', 'error', '请填写API地址和密钥');
            return;
        }
        
        // 显示加载状态
        showTestResult('openaiTestResult', 'loading', '正在连接 OpenAI API...');
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'user',
                            content: testMessage
                        }
                    ],
                    max_tokens: 100
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: { message: '未知错误' } }));
                throw new Error(errorData.error?.message || `HTTP错误: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.choices && data.choices.length > 0) {
                const reply = data.choices[0].message.content;
                showTestResult('openaiTestResult', 'success', `API连接成功！AI回复: ${reply.substring(0, 50)}...`);
            } else {
                showTestResult('openaiTestResult', 'success', 'API连接成功，但未收到有效回复');
            }
        } catch (error) {
            showTestResult('openaiTestResult', 'error', `连接失败: ${error.message}`);
        }
    }

    // 显示测试结果
    function showTestResult(elementId, type, message) {
        const resultElement = document.getElementById(elementId);
        resultElement.className = `api-test-result ${type}`;
        resultElement.innerHTML = `
            <span class="result-icon">${type === 'success' ? '✅' : type === 'error' ? '❌' : '⏳'}</span>
            <span>${message}</span>
        `;
    }

    // 保存个性化设置
    function savePersonalizationSettings() {
        // 保存提示文字
        customTip = document.getElementById('tipInput').value.trim() || '无提示文字';
        document.getElementById('showTip').textContent = customTip;

        // 保存时间日期
        const dateVal = document.getElementById('dateInput').value.trim();
        const timeVal = document.getElementById('timeInput').value.trim();
        const periodVal = document.getElementById('periodInput').value;

        const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
        const timeRegex = /^\d{2}:\d{2}$/;

        if (dateVal && timeVal) {
            if (!dateRegex.test(dateVal)) {
                alert('日期格式错误，请输入 MM/DD/YYYY 格式');
                return;
            }
            if (!timeRegex.test(timeVal)) {
                alert('时间格式错误，请输入 HH:MM 格式');
                return;
            }
            customDate = dateVal;
            customTime = timeVal;
            customPeriod = periodVal;
            isCustomTime = true;
            updateWidgetTime();
        }

        closePersonalizationPage();
        alert('个性化设置保存成功！');
    }

    // 保存系统设置
    function saveSystemSettings() {
        // 保存API设置到本地存储
        const openaiUrl = document.getElementById('openaiApiUrl').value.trim();
        const openaiKey = document.getElementById('openaiApiKey').value.trim();
        const openaiModel = document.getElementById('openaiModel').value;
        const temperature = parseFloat(document.getElementById('openaiTemperature').value) || 0.8;
        
        if (openaiUrl) localStorage.setItem('openaiApiUrl', openaiUrl);
        if (openaiKey) localStorage.setItem('openaiApiKey', openaiKey);
        if (openaiModel) localStorage.setItem('openaiModel', openaiModel);
        localStorage.setItem('openaiTemperature', temperature);
        
        // 更新全局变量
        savedOpenAIUrl = openaiUrl;
        savedOpenAIKey = openaiKey;
        savedOpenAIModel = openaiModel;
        savedTemperature = temperature;

        closeSettingsPage();
        alert('系统设置保存成功！');
    }

    // 点击头像上传
    document.getElementById('avatarContainer').addEventListener('click', function() {
        document.getElementById('avatarUpload').click();
    });
    
    // 点击设置页面头像预览上传
    document.getElementById('previewAvatar').addEventListener('click', function() {
        document.getElementById('avatarUpload').click();
    });

    // ========== 钱包与红包功能 ==========

    // 获取钱包数据
    function getWalletData() {
        const defaultData = {
            balance: 0.00,
            hasInitialRecharge: false,
            transactions: []
        };
        const saved = localStorage.getItem('user_wallet');
        return saved ? JSON.parse(saved) : defaultData;
    }

    // 保存钱包数据
    function saveWalletData(data) {
        localStorage.setItem('user_wallet', JSON.stringify(data));
    }

    // 打开钱包页面
    function openWalletPage() {
        const walletPage = document.getElementById('walletPage');
        walletPage.classList.add('active');
        updateWalletUI();
    }

    // 关闭钱包页面
    function closeWalletPage() {
        const walletPage = document.getElementById('walletPage');
        walletPage.classList.remove('active');
    }

    // 更新钱包UI
    function updateWalletUI() {
        const data = getWalletData();
        
        // 更新余额
        document.getElementById('walletBalance').textContent = data.balance.toFixed(2);
        
        // 更新充值按钮状态
        const rechargeBtn = document.getElementById('walletRechargeBtn');
        if (data.hasInitialRecharge) {
            rechargeBtn.disabled = true;
            rechargeBtn.textContent = '已完成初始充值';
            rechargeBtn.style.opacity = '0.6';
            rechargeBtn.onclick = null;
        } else {
            rechargeBtn.disabled = false;
            rechargeBtn.textContent = '充值';
            rechargeBtn.style.opacity = '1';
            rechargeBtn.onclick = openRechargeModal;
        }
        
        // 更新交易记录
        const list = document.getElementById('transactionList');
        if (data.transactions.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:20px;color:#999;font-size:14px;">暂无交易记录</div>';
        } else {
            list.innerHTML = data.transactions.slice().reverse().map(t => `
                <div class="transaction-item">
                    <div class="transaction-icon ${t.amount > 0 ? 'icon-in' : 'icon-out'}">${t.amount > 0 ? '➕' : '➖'}</div>
                    <div class="transaction-info">
                        <div class="transaction-name">${t.name}</div>
                        <div class="transaction-time">${t.time}</div>
                    </div>
                    <div class="transaction-amount ${t.amount > 0 ? 'amount-in' : 'amount-out'}">${t.amount > 0 ? '+' : ''}${t.amount.toFixed(2)}</div>
                </div>
            `).join('');
        }
    }

    // 打开充值弹窗
    function openRechargeModal() {
        const data = getWalletData();
        if (data.hasInitialRecharge) {
            alert('初始充值仅限一次，您已完成充值。');
            return;
        }
        document.getElementById('rechargeModal').classList.add('active');
        document.getElementById('rechargeAmountInput').value = '';
    }

    // 关闭充值弹窗
    function closeRechargeModal() {
        document.getElementById('rechargeModal').classList.remove('active');
    }

    // 确认充值
    function confirmRecharge() {
        const input = document.getElementById('rechargeAmountInput');
        const amount = parseFloat(input.value);
        
        if (isNaN(amount) || amount <= 0) {
            alert('请输入有效的充值金额');
            return;
        }
        
        const data = getWalletData();
        data.balance += amount;
        data.hasInitialRecharge = true;
        data.transactions.push({
            name: '初始充值',
            amount: amount,
            time: new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
        });
        
        saveWalletData(data);
        updateWalletUI();
        closeRechargeModal();
        alert(`充值成功！当前余额：${data.balance.toFixed(2)}元`);
    }

    // 红包封面列表
    let redPacketCovers = [
        { id: 'default', color: '#f76260', name: '默认' },
        { id: 'love', color: '#ff8a80', name: '爱心' },
        { id: 'gold', color: '#ffd54f', name: '招财' },
        { id: 'blue', color: '#4fc3f7', name: '好运' }
    ];

    // 加载自定义封面
    try {
        const savedCovers = localStorage.getItem('custom_red_packet_covers');
        if (savedCovers) {
            const customCovers = JSON.parse(savedCovers);
            redPacketCovers = [...redPacketCovers, ...customCovers];
        }
    } catch (e) {
        console.error('加载自定义封面失败', e);
    }

    // 打开红包弹窗
    function openRedPacketModal() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            return;
        }
        document.getElementById('redPacketModal').classList.add('active');
        document.getElementById('redPacketAmountInput').value = '';
        document.getElementById('redPacketNoteInput').value = '';
        renderRedPacketCovers();
    }

    // 关闭红包弹窗
    function closeRedPacketModal() {
        document.getElementById('redPacketModal').classList.remove('active');
    }

    // 渲染红包封面
    function renderRedPacketCovers() {
        const list = document.getElementById('redPacketCoverList');
        const currentSelected = document.getElementById('selectedRedPacketCover').value;
        
        list.innerHTML = redPacketCovers.map(cover => {
            const style = cover.image 
                ? `background-image: url('${cover.image}'); background-size: cover;` 
                : `background-color: ${cover.color};`;
                
            return `
            <div class="red-packet-cover-option ${cover.id === currentSelected ? 'selected' : ''}" 
                 style="${style}" 
                 onclick="selectRedPacketCover('${cover.id}')"
                 title="${cover.name}">
            </div>
            `;
        }).join('');
    }

    // 选择红包封面
    function selectRedPacketCover(id) {
        document.getElementById('selectedRedPacketCover').value = id;
        renderRedPacketCovers();
    }

    // 处理封面上传
    function handleRedPacketCoverUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.match('image.*')) {
            alert('请上传图片文件');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            const newCover = {
                id: 'custom_' + Date.now(),
                image: imageUrl,
                name: '自定义'
            };
            
            // 添加到列表
            redPacketCovers.push(newCover);
            
            // 保存到本地存储
            const customCovers = redPacketCovers.filter(c => c.id.startsWith('custom_'));
            localStorage.setItem('custom_red_packet_covers', JSON.stringify(customCovers));
            
            // 选中新封面
            selectRedPacketCover(newCover.id);
        };
        reader.readAsDataURL(file);
        // 清空input以允许再次上传同一文件
        event.target.value = '';
    }

    // 发送红包
    function sendRedPacket() {
        const amountInput = document.getElementById('redPacketAmountInput');
        const noteInput = document.getElementById('redPacketNoteInput');
        const coverId = document.getElementById('selectedRedPacketCover').value;
        const textColorInput = document.getElementById('redPacketTextColorInput');
        
        const amount = parseFloat(amountInput.value);
        const note = noteInput.value.trim() || '恭喜发财，大吉大利';
        const textColor = textColorInput ? textColorInput.value : null;
        
        if (isNaN(amount) || amount <= 0) {
            alert('请输入有效的金额');
            return;
        }
        
        const data = getWalletData();
        if (amount > data.balance) {
            alert(`余额不足，当前余额：${data.balance.toFixed(2)}元`);
            return;
        }
        
        // 扣除余额
        data.balance -= amount;
        data.transactions.push({
            name: `转账给 ${currentChatFriend}`,
            amount: -amount,
            time: new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
        });
        saveWalletData(data);
        
        // 构建红包数据
        const redPacketData = {
            amount: amount,
            note: note,
            cover: coverId,
            textColor: textColor
        };
        
        // 发送消息 (传递 redPacketData)
        addChatMessage(currentChatFriend, `[红包] ${note}`, true, true, null, null, null, null, null, redPacketData);
        
        // 更新好友列表最后一条消息
        updateFriendLastMessage(currentChatFriend, `[红包] ${note}`);
        
        // 保存消息
        saveChatMessages(currentChatFriend);
        
        closeRedPacketModal();
    }

    // 打开收款弹窗
    function openTransferModal() {
        if (!currentChatFriend) {
            alert('请先选择一个好友');
            return;
        }
        document.getElementById('transferModal').classList.add('active');
        document.getElementById('transferAmountInput').value = '';
        document.getElementById('transferNoteInput').value = '';
    }

    // 关闭收款弹窗
    function closeTransferModal() {
        document.getElementById('transferModal').classList.remove('active');
    }

    // 发起收款
    function sendTransfer() {
        const amountInput = document.getElementById('transferAmountInput');
        const noteInput = document.getElementById('transferNoteInput');
        
        const amount = parseFloat(amountInput.value);
        const note = noteInput.value.trim() || '收款';
        
        if (isNaN(amount) || amount <= 0) {
            alert('请输入有效的金额');
            return;
        }
        
        // 构建收款数据 (复用redPacketData结构，增加isTransfer标记)
        const transferData = {
            amount: amount,
            note: note,
            cover: 'transfer', // 特殊封面ID
            isTransfer: true,
            textColor: '#ffffff' // 收款默认白色文字
        };
        
        // 发送消息
        addChatMessage(currentChatFriend, `[收款] ${note}`, true, true, null, null, null, null, null, transferData);
        
        // 更新好友列表最后一条消息
        updateFriendLastMessage(currentChatFriend, `[收款] ￥${amount}`);
        
        // 保存消息
        saveChatMessages(currentChatFriend);
        
        closeTransferModal();
    }

    // 生成文字图片SVG占位符
    function generateTextImageSvg() {
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">
            <rect width="120" height="120" fill="#f0f0f0"/>
            <path d="M30 30 h60 v60 h-60 z" fill="none" stroke="#999" stroke-width="2"/>
            <circle cx="45" cy="45" r="5" fill="#999"/>
            <path d="M90 70 l-20 -20 l-30 30 l-10 -10 l-20 20" fill="none" stroke="#999" stroke-width="2"/>
            <text x="60" y="110" font-family="Arial" font-size="12" fill="#666" text-anchor="middle">点击查看文字</text>
        </svg>`);
        return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // 生成表情包SVG占位符
    function generateStickerSvg() {
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">
            <rect width="120" height="120" fill="none"/>
            <circle cx="60" cy="60" r="50" fill="#FFC107"/>
            <circle cx="40" cy="45" r="5" fill="#333"/>
            <circle cx="80" cy="45" r="5" fill="#333"/>
            <path d="M40 75 q20 20 40 0" fill="none" stroke="#333" stroke-width="5" stroke-linecap="round"/>
            <text x="60" y="115" font-family="Arial" font-size="10" fill="#999" text-anchor="middle">长按/点击</text>
        </svg>`);
        return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // ==========================================
    // IndexedDB 无限存储管理器
    // ==========================================
    const ChatStorage = {
        dbName: 'YaYaChatDB',
        version: 2, // 升级版本
        db: null,

        // 初始化数据库
        async init() {
            if (this.db) return this.db;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, this.version);
                
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve(this.db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('chats')) {
                        db.createObjectStore('chats'); 
                    }
                    if (!db.objectStoreNames.contains('moments_profile')) {
                        db.createObjectStore('moments_profile', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('moments_posts')) {
                        db.createObjectStore('moments_posts', { keyPath: 'id' });
                    }
                };
            });
        },

        // 保存聊天记录
        async save(friendName, messages) {
            try {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['chats'], 'readwrite');
                    const store = transaction.objectStore('chats');
                    const request = store.put(messages, `chat_${friendName}`);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            } catch (e) {
                console.error('Save to IndexedDB failed', e);
            }
        },

        // 加载聊天记录
        async load(friendName) {
            try {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['chats'], 'readonly');
                    const store = transaction.objectStore('chats');
                    const request = store.get(`chat_${friendName}`);
                    
                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        if (result) {
                            resolve(result);
                        } else {
                            // 尝试从 localStorage 迁移旧数据
                            const localKey = `chat_${friendName}`;
                            const localData = localStorage.getItem(localKey);
                            if (localData) {
                                try {
                                    const parsed = JSON.parse(localData);
                                    // 异步迁移
                                    this.save(friendName, parsed).then(() => {
                                        console.log(`Migrated ${friendName} from localStorage to IndexedDB`);
                                    }); 
                                    resolve(parsed);
                                } catch (e) {
                                    resolve([]);
                                }
                            } else {
                                resolve([]);
                            }
                        }
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            } catch (e) {
                console.error('Load from IndexedDB failed', e);
                return [];
            }
        },
        
        // 删除聊天记录
        async delete(friendName) {
             if (!this.db) await this.init();
             return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['chats'], 'readwrite');
                const store = transaction.objectStore('chats');
                const request = store.delete(`chat_${friendName}`);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
             });
        },

        // 朋友圈：保存个人资料
        async saveMomentsProfile(profileData, friendName = 'me') {
            if (!this.db) await this.init();
            return new Promise((resolve, reject) => {
                 const transaction = this.db.transaction(['moments_profile'], 'readwrite');
                 const store = transaction.objectStore('moments_profile');
                 
                 // 先读取再合并，确保不覆盖其他字段
                 const getReq = store.get(friendName);
                 getReq.onsuccess = (e) => {
                     const existing = e.target.result || { id: friendName };
                     const updated = { ...existing, ...profileData, id: friendName };
                     const putReq = store.put(updated);
                     putReq.onsuccess = () => resolve(updated);
                     putReq.onerror = (err) => reject(err.target.error);
                 };
                 getReq.onerror = (err) => reject(err.target.error);
            });
        },

        // 朋友圈：获取个人资料
        async getMomentsProfile(friendName = 'me') {
            if (!this.db) await this.init();
             return new Promise((resolve, reject) => {
                 const transaction = this.db.transaction(['moments_profile'], 'readonly');
                 const store = transaction.objectStore('moments_profile');
                 const request = store.get(friendName);
                 request.onsuccess = (e) => resolve(e.target.result || {});
                 request.onerror = (e) => reject(e.target.error);
             });
        },

        // 朋友圈：保存帖子
        async savePost(post) {
            if (!this.db) await this.init();
            return new Promise((resolve, reject) => {
                 const transaction = this.db.transaction(['moments_posts'], 'readwrite');
                 const store = transaction.objectStore('moments_posts');
                 const request = store.put(post);
                 request.onsuccess = () => resolve();
                 request.onerror = (e) => reject(e.target.error);
            });
        },

        // 朋友圈：获取所有帖子
        async getPosts(friendName = 'me') {
            if (!this.db) await this.init();
            return new Promise((resolve, reject) => {
                 const transaction = this.db.transaction(['moments_posts'], 'readonly');
                 const store = transaction.objectStore('moments_posts');
                 const request = store.getAll();
                 request.onsuccess = (e) => {
                     const allPosts = e.target.result || [];
                     // 过滤出指定角色的帖子（兼容旧数据：没有owner字段的默认为'me'）
                     const posts = allPosts.filter(post => {
                         const postOwner = post.owner || 'me';
                         return postOwner === friendName;
                     });
                     // 按时间倒序
                     posts.sort((a, b) => b.id - a.id);
                     resolve(posts);
                 };
                 request.onerror = (e) => reject(e.target.error);
            });
        }
    };
    // ==========================================
    // 朋友圈发布功能
    // ==========================================
    
    let postImages = []; // 存储选中的图片文件/base64
    let dragSrcEl = null;
    
    // 朋友圈发布相关状态
    let postLocation = ''; // 所在位置
    let postRemindFriends = []; // 提醒谁看
    let postVisibility = 'public'; // 谁可以看：public(公开), private(私密), tag(部分可见), exclude(不给谁看)
    let postVisibleTags = []; // 部分可见的标签
    let postExcludeTags = []; // 不给谁看的标签
    let currentTagSelectionMode = ''; // 当前标签选择模式：'visible' 或 'exclude'

    // 显示/隐藏发布菜单
    function togglePublishMenu(event) {
        event.stopPropagation();
        const menu = document.getElementById('momentsPublishMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        
        // 点击其他地方关闭
        if (menu.style.display === 'block') {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                }
            });
        }
    }

    // 打开发布页面
    function openPostPage(type) {
        document.getElementById('momentsPublishMenu').style.display = 'none';
        document.getElementById('postMomentsPage').style.display = 'block';
        
        // 重置状态
        postImages = [];
        document.getElementById('postContentInput').value = '';
        postLocation = '';
        postRemindFriends = [];
        postVisibility = 'public';
        postVisibleTags = [];
        postExcludeTags = [];
        
        // 更新显示文本
        document.getElementById('postLocationText').textContent = '不显示位置';
        document.getElementById('postRemindText').textContent = '提醒朋友';
        document.getElementById('postVisibilityText').textContent = '公开';
        
        renderPostImages();
        
        if (type === 'photo') {
            document.getElementById('postImageInput').click();
        }
    }

    // 关闭发布页面
    function closePostPage() {
        document.getElementById('postMomentsPage').style.display = 'none';
    }

    // 处理图片选择
    function handlePostImageSelect(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        if (postImages.length + files.length > 9) {
            alert('最多只能选择9张图片哦～');
            return;
        }
        
        let processed = 0;
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                postImages.push(e.target.result);
                processed++;
                if (processed === files.length) {
                    renderPostImages();
                }
            };
            reader.readAsDataURL(file);
        });
        
        // 清空input以允许重复选择同一张
        event.target.value = '';
    }

    // 渲染图片网格
    function renderPostImages() {
        const grid = document.getElementById('postImageGrid');
        const addBtn = document.getElementById('addPostImageBtn');
        
        // 清除旧的图片项 (保留最后一个加号按钮)
        while (grid.children.length > 1) {
            grid.removeChild(grid.firstChild);
        }
        
        postImages.forEach((src, index) => {
            const item = document.createElement('div');
            item.className = 'post-image-item';
            item.draggable = true;
            item.style.cssText = 'aspect-ratio: 1; position: relative; border-radius: 4px; overflow: hidden; cursor: grab;';
            item.innerHTML = `
                <img src="${src}" style="width: 100%; height: 100%; object-fit: cover; display: block;">
            `;
            
            // 拖拽事件
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
            item.dataset.index = index;
            
            grid.insertBefore(item, addBtn);
        });
        
        // 如果满9张，隐藏加号按钮
        addBtn.style.display = postImages.length >= 9 ? 'none' : 'flex';
    }

    // 删除图片
    function deletePostImage(index) {
        postImages.splice(index, 1);
        renderPostImages();
    }

    // 拖拽逻辑
    function handleDragStart(e) {
        this.style.opacity = '0.4';
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        
        // 显示垃圾桶
        document.getElementById('deleteArea').style.display = 'flex';
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        
        if (dragSrcEl !== this) {
            // 如果是在网格内拖拽排序
            if (this.classList.contains('post-image-item')) {
                const srcIndex = parseInt(dragSrcEl.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // 交换数组元素
                const temp = postImages[srcIndex];
                postImages.splice(srcIndex, 1);
                postImages.splice(targetIndex, 0, temp);
                
                renderPostImages();
            }
        }
        return false;
    }

    function handleDragEnd(e) {
        this.style.opacity = '1';
        dragSrcEl = null;
        
        // 隐藏并重置垃圾桶
        const deleteArea = document.getElementById('deleteArea');
        deleteArea.style.display = 'none';
        deleteArea.style.background = '#ff4d4f';
        deleteArea.textContent = '🗑️ 拖动到此处删除';
    }
    
    // 垃圾桶相关事件
    function handleDeleteDragOver(e) {
        e.preventDefault();
        const deleteArea = document.getElementById('deleteArea');
        deleteArea.style.background = '#d9363e'; // 加深红色
        deleteArea.textContent = '松手删除';
    }

    function handleDeleteDragLeave(e) {
        const deleteArea = document.getElementById('deleteArea');
        deleteArea.style.background = '#ff4d4f';
        deleteArea.textContent = '🗑️ 拖动到此处删除';
    }

    function handleDeleteDrop(e) {
        e.preventDefault();
        // 获取拖拽的图片索引
        if (dragSrcEl) {
            const index = parseInt(dragSrcEl.dataset.index);
            deletePostImage(index);
        }
    }

    // 发表
    async function publishPost() {
        const content = document.getElementById('postContentInput').value.trim();
        if (!content && postImages.length === 0) {
            alert('请输入内容或添加图片后再发表～');
            return;
        }
        
        // 模拟发布
        const newPost = {
            id: Date.now(),
            content: content,
            images: [...postImages],
            time: new Date().toLocaleString(),
            likes: [],
            comments: [],
            location: postLocation || null,
            remindFriends: postRemindFriends.length > 0 ? [...postRemindFriends] : null,
            visibility: postVisibility,
            visibleTags: postVisibleTags.length > 0 ? [...postVisibleTags] : null,
            excludeTags: postExcludeTags.length > 0 ? [...postExcludeTags] : null,
            owner: 'me' // 用户自己的朋友圈
        };
        
        // 保存到 IndexedDB (ChatStorage)
        await ChatStorage.savePost(newPost);
        
        alert(`发布成功！\n内容：${content.substring(0, 10)}...\n图片：${postImages.length}张`);
        closePostPage();
        
        // 简单重载
        openMomentsPage();
        
        // 调用API让角色来评论
        await callAPIForComment(newPost);
    }
    
    // 调用API让角色来评论
    async function callAPIForComment(post) {
        try {
            const apiUrl = localStorage.getItem('openaiApiUrl') || 'https://api.openai.com/v1/chat/completions';
            const apiKey = localStorage.getItem('openaiApiKey');
            const model = localStorage.getItem('openaiModel') || 'gpt-3.5-turbo';
            
            if (!apiKey) {
                console.log('未配置API，跳过自动评论');
                return;
            }
            
            // 获取好友列表，选择一个角色来评论
            const friends = getFriendList();
            if (friends.length === 0) {
                console.log('没有好友，跳过自动评论');
                return;
            }
            
            // 随机选择一个好友
            const randomFriend = friends[Math.floor(Math.random() * friends.length)];
            
            // 构建系统提示词
            const systemPrompt = `你是${randomFriend.name}，${randomFriend.persona || '一个普通的朋友'}。你看到朋友发布了一条朋友圈，内容摘要："${post.content.substring(0, 50)}${post.content.length > 50 ? '...' : ''}"。请用你的角色风格，发表一条简短的评论（不超过20字）。只返回评论内容，不要其他文字。`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: '请评论这条朋友圈' }
                    ],
                    temperature: 0.8,
                    max_tokens: 50
                })
            });
            
            if (!response.ok) {
                console.error('API调用失败:', response.status);
                return;
            }
            
            const data = await response.json();
            if (data.choices && data.choices.length > 0) {
                const commentText = data.choices[0].message.content.trim();
                
                // 添加评论到帖子
                const posts = await ChatStorage.getPosts();
                const postIndex = posts.findIndex(p => p.id === post.id);
                if (postIndex !== -1) {
                    if (!posts[postIndex].comments) {
                        posts[postIndex].comments = [];
                    }
                    posts[postIndex].comments.push({
                        author: randomFriend.name,
                        text: commentText,
                        time: new Date().toLocaleString()
                    });
                    await ChatStorage.savePost(posts[postIndex]);
                    
                    // 刷新朋友圈列表
                    renderMomentsList();
                }
            }
        } catch (error) {
            console.error('调用API评论失败:', error);
        }
    }
    
    // 显示/隐藏三个点菜单
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('moment-more-btn')) {
            e.stopPropagation();
            const postId = e.target.getAttribute('data-post-id');
            const menu = document.getElementById(`momentMenu_${postId}`);
            
            // 关闭其他菜单
            document.querySelectorAll('.moment-action-menu').forEach(m => {
                if (m.id !== `momentMenu_${postId}`) {
                    m.style.display = 'none';
                }
            });
            
            // 切换当前菜单
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        } else {
            // 点击其他地方关闭所有菜单
            document.querySelectorAll('.moment-action-menu').forEach(m => {
                m.style.display = 'none';
            });
        }
    });
    
    // 点赞/取消点赞
    async function toggleLike(postId) {
        const posts = await ChatStorage.getPosts();
        const post = posts.find(p => p.id === postId);
        if (!post) return;
        
        if (!post.likes) {
            post.likes = [];
        }
        
        const myMomentsProfile = await ChatStorage.getMomentsProfile();
        const myPersona = currentPersona || { nickname: '我', avatar: '' };
        const myName = myMomentsProfile.name || myPersona.nickname || '我';
        
        const likeIndex = post.likes.indexOf(myName);
        if (likeIndex > -1) {
            post.likes.splice(likeIndex, 1);
        } else {
            post.likes.push(myName);
        }
        
        await ChatStorage.savePost(post);
        renderMomentsList();
    }
    
    // 显示评论输入框
    function showCommentInput(postId) {
        // 关闭所有菜单
        document.querySelectorAll('.moment-action-menu').forEach(m => {
            m.style.display = 'none';
        });
        
        // 显示评论输入框
        const commentInput = document.getElementById(`commentInput_${postId}`);
        if (commentInput) {
            commentInput.style.display = 'block';
            const input = document.getElementById(`commentText_${postId}`);
            if (input) {
                input.focus();
            }
        }
    }
    
    // 隐藏评论输入框
    function hideCommentInput(postId) {
        const commentInput = document.getElementById(`commentInput_${postId}`);
        if (commentInput) {
            commentInput.style.display = 'none';
            const input = document.getElementById(`commentText_${postId}`);
            if (input) {
                input.value = '';
            }
        }
    }
    
    // 提交评论
    async function submitComment(postId) {
        const input = document.getElementById(`commentText_${postId}`);
        if (!input) return;
        
        const commentText = input.value.trim();
        if (!commentText) {
            alert('请输入评论内容');
            return;
        }
        
        const posts = await ChatStorage.getPosts();
        const post = posts.find(p => p.id === postId);
        if (!post) return;
        
        if (!post.comments) {
            post.comments = [];
        }
        
        const myMomentsProfile = await ChatStorage.getMomentsProfile();
        const myPersona = currentPersona || { nickname: '我', avatar: '' };
        const myName = myMomentsProfile.name || myPersona.nickname || '我';
        
        post.comments.push({
            author: myName,
            text: commentText,
            time: new Date().toLocaleString()
        });
        
        await ChatStorage.savePost(post);
        input.value = '';
        hideCommentInput(postId);
        renderMomentsList();
    }
    
    // ========== 朋友圈发布功能按钮 ==========
    
    /**
     * 显示位置选择弹窗
     */
    function showLocationPicker() {
        document.getElementById('locationPickerModal').classList.add('active');
        setTimeout(() => {
            const input = document.getElementById('locationInput');
            if (input) input.focus();
        }, 100);
    }
    
    /**
     * 关闭位置选择弹窗
     */
    function closeLocationPicker() {
        document.getElementById('locationPickerModal').classList.remove('active');
    }
    
    /**
     * 设置位置
     * @param {string} location - 位置名称
     */
    function setLocation(location) {
        postLocation = location === '不显示位置' ? '' : location;
        document.getElementById('postLocationText').textContent = postLocation || '不显示位置';
        closeLocationPicker();
    }
    
    /**
     * 确认位置输入
     */
    function confirmLocation() {
        const input = document.getElementById('locationInput');
        const location = input.value.trim();
        if (location) {
            setLocation(location);
        }
    }
    
    /**
     * 显示提醒谁看弹窗
     */
    function showRemindFriends() {
        const modal = document.getElementById('remindFriendsModal');
        const list = document.getElementById('remindFriendsList');
        
        const friends = getFriendList();
        let html = '';
        
        if (friends.length === 0) {
            html = '<div style="padding: 20px; text-align: center; color: #999;">暂无好友</div>';
        } else {
            friends.forEach(friend => {
                const isSelected = postRemindFriends.includes(friend.name);
                const displayName = friend.remark || friend.name;
                html += `
                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="toggleRemindFriend('${friend.name}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} style="margin-right: 12px; width: 18px; height: 18px;" onchange="toggleRemindFriend('${friend.name}')" onclick="event.stopPropagation()">
                        <div style="flex: 1;">
                            <div style="font-size: 15px; color: #333;">${displayName}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        list.innerHTML = html;
        modal.classList.add('active');
    }
    
    /**
     * 关闭提醒谁看弹窗
     */
    function closeRemindFriends() {
        document.getElementById('remindFriendsModal').classList.remove('active');
    }
    
    /**
     * 切换提醒好友
     * @param {string} friendName - 好友名称
     */
    function toggleRemindFriend(friendName) {
        const index = postRemindFriends.indexOf(friendName);
        if (index > -1) {
            postRemindFriends.splice(index, 1);
        } else {
            postRemindFriends.push(friendName);
        }
        
        // 更新显示
        updateRemindText();
        showRemindFriends(); // 刷新列表
    }
    
    /**
     * 更新提醒文本显示
     */
    function updateRemindText() {
        const textEl = document.getElementById('postRemindText');
        if (postRemindFriends.length === 0) {
            textEl.textContent = '提醒朋友';
        } else {
            const friends = getFriendList();
            const names = postRemindFriends.map(name => {
                const friend = friends.find(f => f.name === name);
                return friend ? (friend.remark || friend.name) : name;
            });
            textEl.textContent = names.length > 2 ? `${names.slice(0, 2).join('、')}等${names.length}人` : names.join('、');
        }
    }
    
    /**
     * 确认提醒好友
     */
    function confirmRemindFriends() {
        updateRemindText();
        closeRemindFriends();
    }
    
    /**
     * 显示谁可以看设置弹窗
     */
    function showVisibilitySettings() {
        const modal = document.getElementById('visibilityModal');
        modal.classList.add('active');
        
        // 更新单选按钮状态
        document.querySelectorAll('input[name="visibility"]').forEach(radio => {
            radio.checked = radio.value === postVisibility;
        });
    }
    
    /**
     * 关闭谁可以看设置弹窗
     */
    function closeVisibilitySettings() {
        document.getElementById('visibilityModal').classList.remove('active');
    }
    
    /**
     * 设置可见范围
     * @param {string} visibility - 可见范围类型
     */
    function setVisibility(visibility) {
        postVisibility = visibility;
        
        // 更新单选按钮
        document.querySelectorAll('input[name="visibility"]').forEach(radio => {
            radio.checked = radio.value === visibility;
        });
        
        // 如果需要选择标签，打开标签选择弹窗
        if (visibility === 'tag' || visibility === 'exclude') {
            currentTagSelectionMode = visibility;
            showTagSelection();
        } else {
            updateVisibilityText();
        }
    }
    
    /**
     * 显示标签选择弹窗
     */
    function showTagSelection() {
        const modal = document.getElementById('tagSelectionModal');
        const title = document.getElementById('tagSelectionTitle');
        const list = document.getElementById('tagSelectionList');
        
        title.textContent = currentTagSelectionMode === 'tag' ? '选择部分可见的标签' : '选择不给谁看的标签';
        
        const tags = getTags();
        const selectedTags = currentTagSelectionMode === 'tag' ? postVisibleTags : postExcludeTags;
        
        let html = '';
        if (tags.length === 0) {
            html = '<div style="padding: 20px; text-align: center; color: #999;">暂无标签，请先在通讯录中创建标签</div>';
        } else {
            tags.forEach(tag => {
                const tagName = typeof tag === 'string' ? tag : tag.name;
                const isSelected = selectedTags.includes(tagName);
                html += `
                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="toggleTagSelection('${tagName}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} style="margin-right: 12px; width: 18px; height: 18px;" onchange="toggleTagSelection('${tagName}')" onclick="event.stopPropagation()">
                        <div style="flex: 1;">
                            <div style="font-size: 15px; color: #333;">${tagName}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        list.innerHTML = html;
        modal.classList.add('active');
    }
    
    /**
     * 关闭标签选择弹窗
     */
    function closeTagSelection() {
        document.getElementById('tagSelectionModal').classList.remove('active');
    }
    
    /**
     * 切换标签选择
     * @param {string} tagName - 标签名称
     */
    function toggleTagSelection(tagName) {
        const selectedTags = currentTagSelectionMode === 'tag' ? postVisibleTags : postExcludeTags;
        const index = selectedTags.indexOf(tagName);
        if (index > -1) {
            selectedTags.splice(index, 1);
        } else {
            selectedTags.push(tagName);
        }
        
        // 更新显示
        showTagSelection(); // 刷新列表
    }
    
    /**
     * 确认标签选择
     */
    function confirmTagSelection() {
        updateVisibilityText();
        closeTagSelection();
        closeVisibilitySettings();
    }
    
    /**
     * 更新可见范围文本显示
     */
    function updateVisibilityText() {
        const textEl = document.getElementById('postVisibilityText');
        switch(postVisibility) {
            case 'public':
                textEl.textContent = '公开';
                break;
            case 'private':
                textEl.textContent = '私密';
                break;
            case 'tag':
                if (postVisibleTags.length === 0) {
                    textEl.textContent = '部分可见';
                } else {
                    textEl.textContent = `${postVisibleTags.length}个标签可见`;
                }
                break;
            case 'exclude':
                if (postExcludeTags.length === 0) {
                    textEl.textContent = '不给谁看';
                } else {
                    textEl.textContent = `${postExcludeTags.length}个标签不可见`;
                }
                break;
        }
    }
    
    /**
     * 确认可见范围设置
     */
    function confirmVisibilitySettings() {
        if (postVisibility === 'tag' || postVisibility === 'exclude') {
            if ((postVisibility === 'tag' && postVisibleTags.length === 0) || 
                (postVisibility === 'exclude' && postExcludeTags.length === 0)) {
                alert('请至少选择一个标签');
                return;
            }
        }
        updateVisibilityText();
        closeVisibilitySettings();
    }
</script>
    <!-- 朋友圈发布菜单 -->
    <div id="momentsPublishMenu" style="display: none; position: absolute; top: 60px; right: 10px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; overflow: hidden; min-width: 120px;">
        <div onclick="openPostPage('text')" style="padding: 12px 20px; font-size: 15px; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0;">发表文字</div>
        <div onclick="openPostPage('photo')" style="padding: 12px 20px; font-size: 15px; color: #333; cursor: pointer;">拍摄/相册</div>
    </div>

    <!-- 发布朋友圈页面 -->
    <div id="postMomentsPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 30; overflow-y: auto;">
        <!-- 顶部导航 -->
        <div style="height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid #f0f0f0;">
            <div onclick="closePostPage()" style="font-size: 16px; color: #555; cursor: pointer;">← 取消</div>
            <button onclick="publishPost()" style="background: #ffd1dc; color: #fff; border: none; padding: 6px 15px; border-radius: 4px; font-size: 14px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.backgroundColor='#ffc0cb'" onmouseout="this.style.backgroundColor='#ffd1dc'">发表</button>
        </div>
        
        <!-- 内容区域 -->
        <div style="padding: 20px;">
            <textarea id="postContentInput" placeholder="分享你的新鲜事..." style="width: 100%; height: 120px; border: none; resize: none; font-size: 16px; color: #555; outline: none; display: block; box-sizing: border-box;"></textarea>
            
            <div style="margin-top: 20px;">
                <div style="font-size: 14px; color: #888; margin-bottom: 10px;">添加图片（最多9张）</div>
                <div id="postImageGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <!-- 图片项将动态添加 -->
                    <div id="addPostImageBtn" onclick="document.getElementById('postImageInput').click()" style="aspect-ratio: 1; background: #f7f7f7; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </div>
                </div>
                <input type="file" id="postImageInput" multiple accept="image/*" style="display: none;" onchange="handlePostImageSelect(event)">
            </div>
            
            <!-- 三个功能按钮 -->
            <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 15px;">
                <div onclick="showLocationPicker()" style="display: flex; align-items: center; padding: 12px 0; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                    <div style="width: 20px; height: 20px; margin-right: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#576b95" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 15px; color: #333;">所在位置</div>
                        <div id="postLocationText" style="font-size: 12px; color: #999; margin-top: 2px;">不显示位置</div>
                    </div>
                    <div style="color: #ccc;">→</div>
                </div>
                
                <div onclick="showRemindFriends()" style="display: flex; align-items: center; padding: 12px 0; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                    <div style="width: 20px; height: 20px; margin-right: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#576b95" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 15px; color: #333;">提醒谁看</div>
                        <div id="postRemindText" style="font-size: 12px; color: #999; margin-top: 2px;">提醒朋友</div>
                    </div>
                    <div style="color: #ccc;">→</div>
                </div>
                
                <div onclick="showVisibilitySettings()" style="display: flex; align-items: center; padding: 12px 0; cursor: pointer;">
                    <div style="width: 20px; height: 20px; margin-right: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#576b95" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 15px; color: #333;">谁可以看</div>
                        <div id="postVisibilityText" style="font-size: 12px; color: #999; margin-top: 2px;">公开</div>
                    </div>
                    <div style="color: #ccc;">→</div>
                </div>
            </div>
        </div>
        
        <!-- 垃圾桶区域 -->
        <div id="deleteArea" 
             ondragover="handleDeleteDragOver(event)" 
             ondragleave="handleDeleteDragLeave(event)" 
             ondrop="handleDeleteDrop(event)"
             style="position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; background: #ff4d4f; color: white; display: none; align-items: center; justify-content: center; font-size: 14px; z-index: 50; transition: all 0.2s;">
            🗑️ 拖动到此处删除
        </div>
    </div>
    
    <!-- 位置选择弹窗 -->
    <div class="profile-modal" id="locationPickerModal" onclick="if(event.target===this) closeLocationPicker()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 400px;">
            <div class="profile-title">所在位置</div>
            <div style="padding: 20px;">
                <input type="text" id="locationInput" placeholder="输入位置名称..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; margin-bottom: 15px;" onkeypress="if(event.key==='Enter') confirmLocation()">
                <div style="font-size: 13px; color: #999; margin-bottom: 15px;">或者选择：</div>
                <div onclick="setLocation('不显示位置')" style="padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer; margin-bottom: 8px; text-align: center;">不显示位置</div>
                <div onclick="setLocation('我在北京')" style="padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer; margin-bottom: 8px; text-align: center;">我在北京</div>
                <div onclick="setLocation('我在上海')" style="padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer; margin-bottom: 8px; text-align: center;">我在上海</div>
                <div onclick="setLocation('我在深圳')" style="padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer; margin-bottom: 8px; text-align: center;">我在深圳</div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeLocationPicker()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="confirmLocation()">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 提醒谁看弹窗 -->
    <div class="profile-modal" id="remindFriendsModal" onclick="if(event.target===this) closeRemindFriends()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 400px; max-height: 70vh;">
            <div class="profile-title">提醒谁看</div>
            <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
                <div id="remindFriendsList" style="margin-bottom: 15px;">
                    <!-- 好友列表将动态添加 -->
                </div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeRemindFriends()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="confirmRemindFriends()">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 谁可以看弹窗 -->
    <div class="profile-modal" id="visibilityModal" onclick="if(event.target===this) closeVisibilitySettings()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 400px;">
            <div class="profile-title">谁可以看</div>
            <div style="padding: 20px;">
                <div onclick="setVisibility('public')" style="display: flex; align-items: center; padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                    <input type="radio" name="visibility" value="public" style="margin-right: 12px;">
                    <div>
                        <div style="font-size: 15px; color: #333;">公开</div>
                        <div style="font-size: 12px; color: #999; margin-top: 2px;">所有朋友可见</div>
                    </div>
                </div>
                <div onclick="setVisibility('private')" style="display: flex; align-items: center; padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                    <input type="radio" name="visibility" value="private" style="margin-right: 12px;">
                    <div>
                        <div style="font-size: 15px; color: #333;">私密</div>
                        <div style="font-size: 12px; color: #999; margin-top: 2px;">仅自己可见</div>
                    </div>
                </div>
                <div onclick="setVisibility('tag')" style="display: flex; align-items: center; padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                    <input type="radio" name="visibility" value="tag" style="margin-right: 12px;">
                    <div style="flex: 1;">
                        <div style="font-size: 15px; color: #333;">部分可见</div>
                        <div style="font-size: 12px; color: #999; margin-top: 2px;">选中的标签可见</div>
                    </div>
                    <div style="color: #ccc;">→</div>
                </div>
                <div onclick="setVisibility('exclude')" style="display: flex; align-items: center; padding: 12px; background: #f7f7f7; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="visibility" value="exclude" style="margin-right: 12px;">
                    <div style="flex: 1;">
                        <div style="font-size: 15px; color: #333;">不给谁看</div>
                        <div style="font-size: 12px; color: #999; margin-top: 2px;">选中的标签不可见</div>
                    </div>
                    <div style="color: #ccc;">→</div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeVisibilitySettings()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="confirmVisibilitySettings()">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 选择标签弹窗（用于部分可见/不给谁看） -->
    <div class="profile-modal" id="tagSelectionModal" onclick="if(event.target===this) closeTagSelection()">
        <div class="profile-content" onclick="event.stopPropagation()" style="max-width: 400px; max-height: 70vh;">
            <div class="profile-title" id="tagSelectionTitle">选择标签</div>
            <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
                <div id="tagSelectionList">
                    <!-- 标签列表将动态添加 -->
                </div>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeTagSelection()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="confirmTagSelection()">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 气泡CSS编辑弹窗 -->
    <div class="profile-modal" id="bubbleCssModal" onclick="if(event.target===this) closeBubbleCssModal()">
        <div class="profile-content" onclick="event.stopPropagation()">
            <div class="profile-title">自定义气泡样式</div>
            <div class="persona-edit">
                <div style="font-size: 12px; color: #999; margin-bottom: 5px;">输入CSS覆盖 .chat-bubble (e.g. background: pink;)</div>
                <textarea class="persona-textarea" id="bubbleCssInput" placeholder="输入CSS代码..." style="height: 150px; font-family: monospace; font-size: 12px;"></textarea>
            </div>
            <div class="modal-btns">
                <button class="detail-modal-btn detail-cancel-btn" onclick="closeBubbleCssModal()">取消</button>
                <button class="detail-modal-btn detail-save-btn" onclick="saveBubbleCss()">保存</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // 网易云音乐播放器功能
    // ============================================
    
    // 关闭音乐应用
    function closeMusicApp() {
        document.getElementById('desktop').classList.remove('hidden');
        document.getElementById('musicAppPage').classList.remove('active');
    }
    
    // 初始化音乐播放器Dexie数据库
    const wyyDb = new Dexie('WYYMusicPlayerDB');
    wyyDb.version(1).stores({
        userSettings: 'id',
        playlistCards: 'id',
        songs: '++id, name, singer, dateAdded',
        songFiles: '++id, songId, type, data',
        lyrics: '++id, songId, data'
    });
    wyyDb.version(2).stores({
        userSettings: 'id',
        playlistCards: 'id',
        songs: '++id, name, singer, dateAdded, playlistId',
        songFiles: '++id, songId, type, data',
        lyrics: '++id, songId, data',
        playlists: '++id, name, desc, cover, dateCreated'
    });

    // 音乐播放器元素
    const wyyPlayBtn = document.getElementById('wyyPlayBtn');
    const wyyPlayerPlayBtn = document.getElementById('wyyPlayerPlayBtn');
    const wyyRecordCover = document.getElementById('wyyRecordCover');
    const wyyCurrentRecordContainer = document.getElementById('wyyCurrentRecordContainer');
    const wyyAlbumArtLarge = document.getElementById('wyyAlbumArtLarge');
    const wyyCurrentSongName = document.getElementById('wyyCurrentSongName');
    const wyyCurrentSingerName = document.getElementById('wyyCurrentSingerName');
    const wyyPlayerSongName = document.getElementById('wyyPlayerSongName');
    const wyyPlayerSingerName = document.getElementById('wyyPlayerSingerName');
    const wyyPlaylistBtn = document.getElementById('wyyPlaylistBtn');
    const wyyPlaylistModal = document.getElementById('wyyPlaylistModal');
    const wyySongsList = document.getElementById('wyySongsList');
    const wyyEmptyPlaylist = document.getElementById('wyyEmptyPlaylist');
    const wyyAddSongBtn = document.getElementById('wyyAddSongBtn');
    const wyyClearAllBtn = document.getElementById('wyyClearAllBtn');
    const wyyProgressBar = document.getElementById('wyyProgressBar');
    const wyyProgress = document.getElementById('wyyProgress');
    const wyyCurrentTime = document.getElementById('wyyCurrentTime');
    const wyyTotalTime = document.getElementById('wyyTotalTime');
    const wyyPrevBtn = document.getElementById('wyyPrevBtn');
    const wyyNextBtn = document.getElementById('wyyNextBtn');
    const wyyPlayBar = document.getElementById('wyyPlayBar');
    const wyyBackBtn = document.getElementById('wyyBackBtn');
    const wyyMainPage = document.getElementById('wyyMainPage');
    const wyyPlayerPage = document.getElementById('wyyPlayerPage');
    
    // 歌曲输入元素
    const wyySongNameInput = document.getElementById('wyySongNameInput');
    const wyySingerNameInput = document.getElementById('wyySingerNameInput');
    const wyySongUrlInput = document.getElementById('wyySongUrlInput');
    const wyyLyricUrlInput = document.getElementById('wyyLyricUrlInput');
    
    // 上传选项按钮
    const wyyUrlOptionBtn = document.getElementById('wyyUrlOptionBtn');
    const wyyFileOptionBtn = document.getElementById('wyyFileOptionBtn');
    const wyyUrlUploadSection = document.getElementById('wyyUrlUploadSection');
    const wyyFileUploadSection = document.getElementById('wyyFileUploadSection');
    
    const wyyLyricUrlOptionBtn = document.getElementById('wyyLyricUrlOptionBtn');
    const wyyLyricFileOptionBtn = document.getElementById('wyyLyricFileOptionBtn');
    const wyyLyricUrlUploadSection = document.getElementById('wyyLyricUrlUploadSection');
    const wyyLyricFileUploadSection = document.getElementById('wyyLyricFileUploadSection');
    
    // 文件上传按钮
    const wyyUploadCoverBtn = document.getElementById('wyyUploadCoverBtn');
    const wyyCoverFileInput = document.getElementById('wyyCoverFileInput');
    const wyySongCoverPreview = document.getElementById('wyySongCoverPreview');
    const wyyUploadSongFileBtn = document.getElementById('wyyUploadSongFileBtn');
    const wyySongFileInput = document.getElementById('wyySongFileInput');
    const wyyUploadLyricFileBtn = document.getElementById('wyyUploadLyricFileBtn');
    const wyyLyricFileInput = document.getElementById('wyyLyricFileInput');
    
    let wyyAudio = null;
    let wyyProgressUpdateInterval = null;
    
    // 播放列表数据
    let wyyPlaylist = [];
    let wyyCurrentSongIndex = 0;
    let wyyCurrentPlaylistId = null; // 当前选中的歌单ID
    
    // 播放模式：'order' 顺序播放, 'single' 单曲循环
    let wyyPlayMode = 'order';
    
    // 歌词显示状态：false 显示封面, true 显示歌词
    let wyyShowLyrics = false;
    
    // 当前歌词数据
    let wyyCurrentLyrics = [];
    
    // 临时存储上传的文件
    let wyyTempSongCover = null;
    let wyyTempSongFile = null;
    let wyyTempLyricFile = null;

    // 页面切换功能
    wyyPlayBar.addEventListener('click', (e) => {
        if (!e.target.closest('.wyy-play-controls')) {
            wyyMainPage.classList.remove('active');
            wyyPlayerPage.classList.add('active');
            wyyUpdatePlayerPage();
        }
    });

    wyyBackBtn.addEventListener('click', () => {
        wyyPlayerPage.classList.remove('active');
        wyyMainPage.classList.add('active');
    });

    // 初始化播放列表
    async function wyyInitPlaylist() {
        try {
            let songs;
            if (wyyCurrentPlaylistId) {
                // 加载指定歌单的歌曲
                songs = await wyyDb.songs.where('playlistId').equals(wyyCurrentPlaylistId).toArray();
                // 在内存中按日期排序
                songs.sort((a, b) => {
                    const dateA = a.dateAdded ? new Date(a.dateAdded).getTime() : 0;
                    const dateB = b.dateAdded ? new Date(b.dateAdded).getTime() : 0;
                    return dateA - dateB;
                });
            } else {
                // 如果没有选中歌单，加载所有歌曲（兼容旧数据）
                songs = await wyyDb.songs.orderBy('dateAdded').toArray();
            }
            
            if (songs.length > 0) {
                wyyPlaylist = songs;
                
                // 加载每首歌曲的文件数据
                for (let i = 0; i < wyyPlaylist.length; i++) {
                    const song = wyyPlaylist[i];
                    
                    // 加载歌曲文件
                    const songFile = await wyyDb.songFiles.where({ songId: song.id }).first();
                    if (songFile) {
                        song.hasLocalFile = true;
                        song.localFileData = songFile.data;
                        song.fileType = songFile.type;
                    }
                    
                    // 加载歌词文件
                    const lyric = await wyyDb.lyrics.where({ songId: song.id }).first();
                    if (lyric) {
                        song.hasLocalLyric = true;
                        song.localLyricData = lyric.data;
                    }
                }
                
                wyyUpdatePlaylistDisplay();
            } else {
                // 空歌单
                wyyPlaylist = [];
                wyyUpdatePlaylistDisplay();
            }
            
            // 设置当前播放的歌曲
            if (wyyPlaylist.length > 0) {
                await wyyLoadSong(wyyCurrentSongIndex);
            }
        } catch (error) {
            console.error('初始化播放列表失败:', error);
        }
    }

    // 更新播放列表显示
    function wyyUpdatePlaylistDisplay() {
        if (wyyPlaylist.length === 0) {
            wyyEmptyPlaylist.style.display = 'block';
            wyySongsList.innerHTML = '<div class="wyy-empty-playlist">暂无歌曲，请添加歌曲</div>';
            return;
        }
        
        wyyEmptyPlaylist.style.display = 'none';
        
        let songsHTML = '';
        wyyPlaylist.forEach((song, index) => {
            const isActive = index === wyyCurrentSongIndex;
            const hasCover = song.cover && song.cover !== '';
            songsHTML += `
                <div class="wyy-song-item ${isActive ? 'active' : ''}" data-index="${index}">
                    <div class="wyy-song-item-icon ${!hasCover ? 'default' : ''}" style="${hasCover ? `background-image: url(${song.cover})` : ''}">
                        ${!hasCover ? (isActive ? '<i class="fa fa-play"></i>' : (index + 1)) : ''}
                    </div>
                    <div class="wyy-song-item-info">
                        <div class="wyy-song-item-name">${song.name}</div>
                        <div class="wyy-song-item-singer">${song.singer}</div>
                    </div>
                    <div class="wyy-song-item-actions" style="display: flex; gap: 5px; align-items: center;">
                        <button class="wyy-song-item-add" data-song-id="${song.id}" title="添加到歌单">
                            <i class="fa fa-plus"></i>
                        </button>
                        <button class="wyy-song-item-remove" data-index="${index}">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        wyySongsList.innerHTML = songsHTML;
        
        // 添加歌曲点击事件
        document.querySelectorAll('.wyy-song-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!e.target.closest('.wyy-song-item-remove') && !e.target.closest('.wyy-song-item-add') && !e.target.closest('.wyy-song-item-actions')) {
                    const index = parseInt(this.getAttribute('data-index'));
                    wyyPlaySong(index);
                    wyyPlaylistModal.style.display = 'none';
                }
            });
        });
        
        // 添加"添加到歌单"按钮点击事件
        document.querySelectorAll('.wyy-song-item-add').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const songId = parseInt(this.getAttribute('data-song-id'));
                wyyShowAddToPlaylistModal(songId);
            });
        });
        
        // 添加删除按钮点击事件
        document.querySelectorAll('.wyy-song-item-remove').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(this.getAttribute('data-index'));
                wyyRemoveSong(index);
            });
        });
    }

    // 更新播放器页面
    function wyyUpdatePlayerPage() {
        if (wyyPlaylist.length === 0 || wyyCurrentSongIndex >= wyyPlaylist.length) return;
        
        const song = wyyPlaylist[wyyCurrentSongIndex];
        wyyPlayerSongName.textContent = song.name;
        wyyPlayerSingerName.textContent = song.singer;
        
        if (song.cover && song.cover !== '') {
            wyyAlbumArtLarge.style.backgroundImage = `url(${song.cover})`;
        } else {
            wyyAlbumArtLarge.style.backgroundImage = '';
            wyyAlbumArtLarge.style.backgroundColor = '#f5f5f5';
        }
        
        if (wyyAudio) {
            wyyTotalTime.textContent = wyyFormatTime(wyyAudio.duration || 299);
            wyyStartProgressUpdate();
        }
        
        // 更新歌词显示状态
        if (wyyShowLyrics) {
            wyyAlbumArtLarge.classList.add('hidden');
            wyyLyricsContainer.classList.add('active');
            wyyUpdateLyricsDisplay();
        } else {
            wyyAlbumArtLarge.classList.remove('hidden');
            wyyLyricsContainer.classList.remove('active');
        }
    }

    // 播放指定索引的歌曲
    async function wyyPlaySong(index) {
        if (index >= 0 && index < wyyPlaylist.length) {
            wyyCurrentSongIndex = index;
            await wyyLoadSong(index);
            wyyPlayCurrentSong();
            wyyUpdatePlaylistDisplay();
            wyyUpdatePlayerPage();
        }
    }

    // 加载歌曲
    async function wyyLoadSong(index) {
        const song = wyyPlaylist[index];
        
        // 停止当前播放
        if (wyyAudio) {
            wyyAudio.pause();
            wyyStopProgressUpdate();
            wyyRecordCover.classList.remove('playing');
            wyyPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            wyyPlayerPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            
            // 释放之前的对象URL
            if (wyyAudio.src && wyyAudio.src.startsWith('blob:')) {
                URL.revokeObjectURL(wyyAudio.src);
            }
        }
        
        // 创建新的音频对象
        try {
            if (song.hasLocalFile && song.localFileData) {
                // 将Base64转换为Blob并创建对象URL
                const audioData = wyyBase64ToBlob(song.localFileData, song.fileType || 'audio/mpeg');
                const audioUrl = URL.createObjectURL(audioData);
                wyyAudio = new Audio(audioUrl);
            } else if (song.url) {
                // 处理网易云音乐URL（可能需要特殊处理）
                let audioUrl = song.url;
                // 如果是网易云的外链，尝试添加参数
                if (audioUrl.includes('music.163.com')) {
                    // 网易云外链可能需要特殊处理
                    console.log('检测到网易云音乐URL，可能需要特殊处理');
                }
                
                wyyAudio = new Audio(audioUrl);
                // 添加跨域支持
                wyyAudio.crossOrigin = 'anonymous';
                // 设置加载策略
                wyyAudio.load();
            } else {
                console.error('没有有效的歌曲文件');
                alert('无法加载歌曲文件，请检查文件格式');
                return;
            }
            
            wyyAudio.loop = false;
            wyyAudio.preload = 'auto';
            
            // 错误处理
            wyyAudio.addEventListener('error', (e) => {
                console.error('音频加载错误:', e);
                const error = wyyAudio.error;
                let errorMsg = '音频加载失败';
                if (error) {
                    switch(error.code) {
                        case error.MEDIA_ERR_ABORTED:
                            errorMsg = '音频加载被中止';
                            break;
                        case error.MEDIA_ERR_NETWORK:
                            errorMsg = '网络错误，请检查网络连接';
                            break;
                        case error.MEDIA_ERR_DECODE:
                            errorMsg = '音频解码失败，可能格式不支持';
                            break;
                        case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMsg = '音频格式不支持，请尝试其他格式';
                            break;
                    }
                }
                console.error(errorMsg);
            });
            
            // 更新音频事件监听
            wyyAudio.addEventListener('ended', wyyHandleSongEnded);
            wyyAudio.addEventListener('loadedmetadata', () => {
                if (wyyAudio.duration && !isNaN(wyyAudio.duration) && isFinite(wyyAudio.duration)) {
                    wyyTotalTime.textContent = wyyFormatTime(wyyAudio.duration);
                    console.log('音频时长:', wyyAudio.duration, '秒');
                } else {
                    console.warn('无法获取音频时长');
                }
                wyyUpdateProgress();
            });
            wyyAudio.addEventListener('canplay', () => {
                console.log('音频可以开始播放');
            });
            wyyAudio.addEventListener('canplaythrough', () => {
                console.log('音频完全加载，可以流畅播放');
            });
            wyyAudio.addEventListener('loadeddata', () => {
                console.log('音频数据加载完成');
            });
            wyyAudio.addEventListener('progress', () => {
                if (wyyAudio.buffered.length > 0) {
                    const bufferedEnd = wyyAudio.buffered.end(wyyAudio.buffered.length - 1);
                    const duration = wyyAudio.duration;
                    if (duration > 0) {
                        const bufferedPercent = (bufferedEnd / duration) * 100;
                        console.log('音频缓冲进度:', bufferedPercent.toFixed(1) + '%');
                    }
                }
            });
            wyyAudio.addEventListener('stalled', () => {
                console.warn('音频加载停滞');
            });
            wyyAudio.addEventListener('suspend', () => {
                console.warn('音频加载暂停');
            });
            wyyAudio.addEventListener('timeupdate', () => {
                wyyUpdateProgress();
                if (wyyShowLyrics) {
                    wyyUpdateLyricsDisplay();
                }
            });
            
            // 更新显示
            wyyCurrentSongName.textContent = song.name;
            wyyCurrentSingerName.textContent = song.singer;
            
            // 更新唱片封面
            if (song.cover && song.cover !== '') {
                wyyCurrentRecordContainer.style.backgroundImage = `url(${song.cover})`;
            } else {
                wyyCurrentRecordContainer.style.backgroundImage = '';
                wyyCurrentRecordContainer.style.backgroundColor = '#cccccc';
            }
            
            // 加载歌词
            if (song.hasLocalLyric && song.localLyricData) {
                wyyLoadLyricsFromText(song.localLyricData);
            } else if (song.lyricUrl) {
                wyyLoadLyricsFromUrl(song.lyricUrl);
            } else if (song.lyricText) {
                wyyLoadLyricsFromText(song.lyricText);
            }
        } catch (error) {
            console.error('加载歌曲失败:', error);
            alert('加载歌曲失败，请检查文件');
        }
    }

    // Base64转Blob
    function wyyBase64ToBlob(base64, contentType = '') {
        const byteCharacters = atob(base64.split(',')[1]);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: contentType });
    }

    // 播放当前歌曲
    async function wyyPlayCurrentSong() {
        if (!wyyAudio) return;
        
        try {
            // 等待音频可以播放
            if (wyyAudio.readyState < 2) {
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('音频加载超时'));
                    }, 10000);
                    
                    const checkReady = () => {
                        if (wyyAudio.readyState >= 2) {
                            clearTimeout(timeout);
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    
                    wyyAudio.addEventListener('canplay', () => {
                        clearTimeout(timeout);
                        resolve();
                    }, { once: true });
                    
                    checkReady();
                });
            }
            
            await wyyAudio.play();
            wyyPlayBtn.innerHTML = '<i class="fa fa-pause"></i>';
            wyyPlayerPlayBtn.innerHTML = '<i class="fa fa-pause"></i>';
            wyyRecordCover.classList.add('playing');
            wyyStartProgressUpdate();
            console.log('播放成功');
        } catch (err) {
            console.error('播放失败:', err);
            let errorMsg = '播放失败';
            if (err.name === 'NotAllowedError') {
                errorMsg = '浏览器阻止了自动播放，请手动点击播放按钮';
            } else if (err.name === 'NotSupportedError') {
                errorMsg = '音频格式不支持，请尝试其他格式';
            } else if (err.message === '音频加载超时') {
                errorMsg = '音频加载超时，请检查网络连接或文件';
            } else {
                errorMsg = '播放失败：' + err.message;
            }
            alert(errorMsg);
        }
    }

    // 处理歌曲结束
    function wyyHandleSongEnded() {
        if (wyyPlaylist.length > 0) {
            if (wyyPlayMode === 'single') {
                // 单曲循环：重新播放当前歌曲
                wyyAudio.currentTime = 0;
                wyyPlayCurrentSong();
            } else {
                // 顺序播放：播放下一首
                wyyCurrentSongIndex = (wyyCurrentSongIndex + 1) % wyyPlaylist.length;
                wyyLoadSong(wyyCurrentSongIndex);
                wyyPlayCurrentSong();
                wyyUpdatePlaylistDisplay();
                wyyUpdatePlayerPage();
            }
        } else {
            wyyPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            wyyPlayerPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            wyyRecordCover.classList.remove('playing');
            wyyStopProgressUpdate();
        }
    }

    // 添加上传歌曲
    async function wyyAddSong() {
        const name = wyySongNameInput.value.trim();
        const singer = wyySingerNameInput.value.trim();
        const url = wyySongUrlInput.value.trim();
        const lyricUrl = wyyLyricUrlInput.value.trim();
        
        if (!name || !singer) {
            alert('请填写歌曲名称和歌手');
            return;
        }
        
        // 检查是否有歌曲文件
        if (!wyyTempSongFile && !url) {
            alert('请上传歌曲文件或输入歌曲URL');
            return;
        }
        
        // 检查是否选中了歌单
        if (!wyyCurrentPlaylistId) {
            alert('请先选择一个歌单或创建新歌单');
            return;
        }
        
        try {
            const songData = {
                name,
                singer,
                cover: wyyTempSongCover || '',
                lyricUrl: '',
                playlistId: wyyCurrentPlaylistId,
                hasLocalFile: false,
                hasLocalLyric: false,
                dateAdded: new Date()
            };
            
            // 保存歌曲基本信息
            const songId = await wyyDb.songs.add(songData);
            
            // 处理歌曲文件
            if (wyyTempSongFile) {
                await wyyDb.songFiles.add({
                    songId: songId,
                    type: wyyTempSongFile.type,
                    data: wyyTempSongFile.data
                });
                
                songData.hasLocalFile = true;
                songData.localFileData = wyyTempSongFile.data;
                songData.fileType = wyyTempSongFile.type;
            } else if (url) {
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    alert('请提供有效的歌曲URL（以http://或https://开头）');
                    return;
                }
                songData.url = url;
                await wyyDb.songs.update(songId, { url: url });
            }
            
            // 处理歌词文件
            if (wyyTempLyricFile) {
                await wyyDb.lyrics.add({
                    songId: songId,
                    data: wyyTempLyricFile.data
                });
                
                songData.hasLocalLyric = true;
                songData.localLyricData = wyyTempLyricFile.data;
            } else if (lyricUrl) {
                songData.lyricUrl = lyricUrl;
                await wyyDb.songs.update(songId, { lyricUrl: lyricUrl });
            }
            
            // 处理封面
            if (wyyTempSongCover) {
                await wyyDb.songs.update(songId, { cover: wyyTempSongCover });
            }
            
            songData.id = songId;
            wyyPlaylist.push(songData);
            
            // 清空输入框和临时数据
            wyySongNameInput.value = '';
            wyySingerNameInput.value = '';
            wyySongUrlInput.value = '';
            wyyLyricUrlInput.value = '';
            wyySongCoverPreview.style.backgroundImage = '';
            wyyTempSongCover = null;
            wyyTempSongFile = null;
            wyyTempLyricFile = null;
            
            wyyUpdatePlaylistDisplay();
            
            // 如果是第一首歌曲，设置为当前播放
            if (wyyPlaylist.length === 1) {
                wyyCurrentSongIndex = 0;
                await wyyLoadSong(0);
            }
            
            alert('歌曲添加成功！');
        } catch (error) {
            console.error('添加歌曲失败:', error);
            alert('添加歌曲失败，请重试');
        }
    }

    // 删除歌曲
    async function wyyRemoveSong(index) {
        if (index >= 0 && index < wyyPlaylist.length) {
            const song = wyyPlaylist[index];
            
            try {
                // 从数据库中删除
                await wyyDb.songs.delete(song.id);
                await wyyDb.songFiles.where({ songId: song.id }).delete();
                await wyyDb.lyrics.where({ songId: song.id }).delete();
                
                // 释放对象URL
                if (song.hasLocalFile && wyyAudio && wyyAudio.src && wyyAudio.src.startsWith('blob:')) {
                    URL.revokeObjectURL(wyyAudio.src);
                }
                
                wyyPlaylist.splice(index, 1);
                
                // 如果删除的是当前播放的歌曲
                if (index === wyyCurrentSongIndex) {
                    if (wyyPlaylist.length > 0) {
                        wyyCurrentSongIndex = Math.min(wyyCurrentSongIndex, wyyPlaylist.length - 1);
                        await wyyLoadSong(wyyCurrentSongIndex);
                        if (wyyAudio && !wyyAudio.paused) {
                            wyyPlayCurrentSong();
                        }
                    } else {
                        if (wyyAudio) {
                            wyyAudio.pause();
                        }
                        wyyCurrentSongName.textContent = '暂无歌曲';
                        wyyCurrentSingerName.textContent = '';
                        wyyPlayerSongName.textContent = '暂无歌曲';
                        wyyPlayerSingerName.textContent = '';
                        wyyCurrentRecordContainer.style.backgroundImage = '';
                        wyyCurrentRecordContainer.style.backgroundColor = '#cccccc';
                        wyyAlbumArtLarge.style.backgroundImage = '';
                        wyyAlbumArtLarge.style.backgroundColor = '#f5f5f5';
                        wyyPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
                        wyyPlayerPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
                        wyyRecordCover.classList.remove('playing');
                        wyyStopProgressUpdate();
                    }
                } else if (index < wyyCurrentSongIndex) {
                    wyyCurrentSongIndex--;
                }
                
                wyyUpdatePlaylistDisplay();
                wyyUpdatePlayerPage();
            } catch (error) {
                console.error('删除歌曲失败:', error);
            }
        }
    }

    // 清空列表
    async function wyyClearAllSongs() {
        if (wyyPlaylist.length > 0 && confirm('确定要清空所有歌曲吗？')) {
            try {
                // 释放所有对象URL
                wyyPlaylist.forEach(song => {
                    if (song.hasLocalFile && wyyAudio && wyyAudio.src && wyyAudio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(wyyAudio.src);
                    }
                });
                
                // 清空数据库
                await wyyDb.songs.clear();
                await wyyDb.songFiles.clear();
                await wyyDb.lyrics.clear();
                
                wyyPlaylist = [];
                if (wyyAudio) {
                    wyyAudio.pause();
                }
                wyyCurrentSongName.textContent = '暂无歌曲';
                wyyCurrentSingerName.textContent = '';
                wyyPlayerSongName.textContent = '暂无歌曲';
                wyyPlayerSingerName.textContent = '';
                wyyCurrentRecordContainer.style.backgroundImage = '';
                wyyCurrentRecordContainer.style.backgroundColor = '#cccccc';
                wyyAlbumArtLarge.style.backgroundImage = '';
                wyyAlbumArtLarge.style.backgroundColor = '#f5f5f5';
                wyyPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
                wyyPlayerPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
                wyyRecordCover.classList.remove('playing');
                wyyStopProgressUpdate();
                
                wyyUpdatePlaylistDisplay();
                wyyUpdatePlayerPage();
            } catch (error) {
                console.error('清空列表失败:', error);
            }
        }
    }

    // 加载歌词
    function wyyLoadLyricsFromUrl(url) {
        if (!url) {
            wyyCurrentLyrics = [];
            wyyUpdateLyricsDisplay();
            return;
        }
        
        fetch(url)
            .then(response => response.text())
            .then(text => {
                wyyLoadLyricsFromText(text);
            })
            .catch(error => {
                console.log('歌词加载失败:', error);
                wyyCurrentLyrics = [];
                wyyUpdateLyricsDisplay();
            });
    }

    // 解析LRC歌词
    function wyyParseLyrics(text) {
        if (!text) return [];
        
        const lines = text.split('\n');
        const lyrics = [];
        
        for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            
            // 匹配时间标签 [mm:ss.xx] 或 [mm:ss]
            const timeRegex = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/g;
            const matches = [...line.matchAll(timeRegex)];
            
            if (matches.length > 0) {
                const lyricText = line.replace(timeRegex, '').trim();
                if (!lyricText) continue;
                
                for (let match of matches) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = match[3] ? parseInt(match[3].padEnd(3, '0')) : 0;
                    const time = minutes * 60 + seconds + milliseconds / 1000;
                    
                    lyrics.push({
                        time: time,
                        text: lyricText
                    });
                }
            }
        }
        
        // 按时间排序
        lyrics.sort((a, b) => a.time - b.time);
        return lyrics;
    }

    function wyyLoadLyricsFromText(text) {
        if (!text) {
            wyyCurrentLyrics = [];
            wyyUpdateLyricsDisplay();
            return;
        }
        
        // 如果是Base64编码，先解码
        let lyricText = text;
        if (text.startsWith('data:text/plain;base64,')) {
            try {
                const base64Data = text.split(',')[1];
                lyricText = atob(base64Data);
            } catch (e) {
                console.error('歌词解码失败:', e);
            }
        }
        
        wyyCurrentLyrics = wyyParseLyrics(lyricText);
        wyyUpdateLyricsDisplay();
    }
    
    // 更新歌词显示
    function wyyUpdateLyricsDisplay() {
        const lyricsContent = document.getElementById('wyyLyricsContent');
        if (!lyricsContent) return;
        
        if (wyyCurrentLyrics.length === 0) {
            lyricsContent.innerHTML = '<div style="opacity: 0.6;">暂无歌词</div>';
            return;
        }
        
        // 如果正在播放，高亮当前歌词
        if (wyyAudio && !wyyAudio.paused) {
            const currentTime = wyyAudio.currentTime;
            let activeIndex = -1;
            
            for (let i = wyyCurrentLyrics.length - 1; i >= 0; i--) {
                if (currentTime >= wyyCurrentLyrics[i].time) {
                    activeIndex = i;
                    break;
                }
            }
            
            let html = '';
            wyyCurrentLyrics.forEach((lyric, index) => {
                const isActive = index === activeIndex;
                html += `<div style="margin: 10px 0; ${isActive ? 'color: #fff; font-weight: bold; font-size: 18px;' : 'opacity: 0.6;'}">${lyric.text}</div>`;
            });
            
            lyricsContent.innerHTML = html;
            
            // 滚动到当前歌词
            if (activeIndex >= 0) {
                const activeElement = lyricsContent.children[activeIndex];
                if (activeElement) {
                    activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        } else {
            // 未播放时显示所有歌词
            let html = '';
            wyyCurrentLyrics.forEach(lyric => {
                html += `<div style="margin: 10px 0; opacity: 0.6;">${lyric.text}</div>`;
            });
            lyricsContent.innerHTML = html;
        }
    }

    // 播放按钮事件
    wyyPlayBtn.addEventListener('click', async () => {
        if (wyyPlaylist.length === 0) {
            alert('请先添加歌曲');
            return;
        }
        
        if (!wyyAudio) {
            await wyyLoadSong(wyyCurrentSongIndex);
        }
        
        if (wyyAudio && wyyAudio.paused) {
            await wyyPlayCurrentSong();
        } else if (wyyAudio) {
            wyyAudio.pause();
            wyyPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            wyyPlayerPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            wyyRecordCover.classList.remove('playing');
            wyyStopProgressUpdate();
        }
    });

    wyyPlayerPlayBtn.addEventListener('click', async () => {
        if (wyyPlaylist.length === 0) {
            alert('请先添加歌曲');
            return;
        }
        
        if (!wyyAudio) {
            await wyyLoadSong(wyyCurrentSongIndex);
        }
        
        if (wyyAudio && wyyAudio.paused) {
            await wyyPlayCurrentSong();
        } else if (wyyAudio) {
            wyyAudio.pause();
            wyyPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            wyyPlayerPlayBtn.innerHTML = '<i class="fa fa-play"></i>';
            wyyRecordCover.classList.remove('playing');
            wyyStopProgressUpdate();
        }
    });

    // 上一首/下一首
    wyyPrevBtn.addEventListener('click', () => {
        if (wyyPlaylist.length === 0) return;
        
        wyyCurrentSongIndex = (wyyCurrentSongIndex - 1 + wyyPlaylist.length) % wyyPlaylist.length;
        wyyPlaySong(wyyCurrentSongIndex);
    });

    wyyNextBtn.addEventListener('click', () => {
        if (wyyPlaylist.length === 0) return;
        
        wyyCurrentSongIndex = (wyyCurrentSongIndex + 1) % wyyPlaylist.length;
        wyyPlaySong(wyyCurrentSongIndex);
    });

    // 循环模式切换
    const wyyLoopModeBtn = document.getElementById('wyyLoopModeBtn');
    const wyyLoopIcon = document.getElementById('wyyLoopIcon');
    
    wyyLoopModeBtn.addEventListener('click', () => {
        if (wyyPlayMode === 'order') {
            // 切换到单曲循环
            wyyPlayMode = 'single';
            wyyLoopIcon.className = 'fa fa-repeat';
            wyyLoopModeBtn.classList.add('wyy-loop-mode-single');
            if (wyyAudio) {
                wyyAudio.loop = false; // 使用自定义循环逻辑
            }
        } else {
            // 切换到顺序播放
            wyyPlayMode = 'order';
            wyyLoopIcon.className = 'fa fa-list';
            wyyLoopModeBtn.classList.remove('wyy-loop-mode-single');
            if (wyyAudio) {
                wyyAudio.loop = false;
            }
        }
    });

    // 播放列表按钮事件（主页面）
    wyyPlaylistBtn.addEventListener('click', () => {
        wyyPlaylistModal.style.display = 'flex';
    });

    // 播放器详情页面的播放列表按钮（打开播放列表）
    const wyyPlayerPlaylistBtn = document.getElementById('wyyPlayerPlaylistBtn');
    const wyyLyricsContainer = document.getElementById('wyyLyricsContainer');
    
    if (wyyPlayerPlaylistBtn) {
        wyyPlayerPlaylistBtn.addEventListener('click', () => {
            wyyPlaylistModal.style.display = 'flex';
        });
    }

    // 封面点击切换歌词
    if (wyyAlbumArtLarge) {
        wyyAlbumArtLarge.addEventListener('click', () => {
            wyyShowLyrics = !wyyShowLyrics;
            
            if (wyyShowLyrics) {
                wyyAlbumArtLarge.classList.add('hidden');
                wyyLyricsContainer.classList.add('active');
                wyyUpdateLyricsDisplay();
            } else {
                wyyAlbumArtLarge.classList.remove('hidden');
                wyyLyricsContainer.classList.remove('active');
            }
        });
    }

    // ============================================
    // 一起听功能
    // ============================================
    let wyyTogetherListenRole = null; // 当前一起听的角色
    let wyyTogetherListenInterval = null; // 更新一起听状态的定时器
    
    const wyyTogetherListenBtn = document.getElementById('wyyTogetherListenBtn');
    const wyyTogetherListenModal = document.getElementById('wyyTogetherListenModal');
    const wyyTogetherListenRoleList = document.getElementById('wyyTogetherListenRoleList');
    const wyyCancelTogetherListenBtn = document.getElementById('wyyCancelTogetherListenBtn');
    const wyyStopTogetherListenBtn = document.getElementById('wyyStopTogetherListenBtn');
    
    // 打开一起听选择角色模态框
    if (wyyTogetherListenBtn) {
        wyyTogetherListenBtn.addEventListener('click', () => {
            wyyShowTogetherListenRoleSelector();
        });
    }
    
    // 显示角色选择器
    function wyyShowTogetherListenRoleSelector() {
        const friends = getFriendList();
        
        if (friends.length === 0) {
            wyyTogetherListenRoleList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">还没有好友，请先添加好友</div>';
        } else {
            let html = '';
            friends.forEach(friend => {
                // 处理friend可能是对象或字符串的情况
                const friendName = typeof friend === 'string' ? friend : (friend.name || friend.remark || '未知');
                const friendDisplayName = typeof friend === 'string' ? friend : (friend.remark || friend.name || '未知');
                const isActive = wyyTogetherListenRole === friendName;
                const firstChar = String(friendDisplayName).charAt(0);
                
                html += `
                    <div class="wyy-playlist-selector-item ${isActive ? 'active' : ''}" data-role="${friendName}" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #666;">${firstChar}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #333; margin-bottom: 2px;">${friendDisplayName}</div>
                            ${isActive ? '<div style="font-size: 12px; color: #ff6b6b;">正在一起听</div>' : ''}
                        </div>
                        ${isActive ? '<i class="fa fa-check-circle" style="color: #ff6b6b;"></i>' : '<i class="fa fa-chevron-right" style="color: #ccc;"></i>'}
                    </div>
                `;
            });
            wyyTogetherListenRoleList.innerHTML = html;
            
            // 添加点击事件
            document.querySelectorAll('.wyy-playlist-selector-item[data-role]').forEach(item => {
                item.addEventListener('click', function() {
                    const role = this.getAttribute('data-role');
                    if (wyyTogetherListenRole === role) {
                        // 如果已经是一起听的角色，则结束一起听
                        wyyStopTogetherListen();
                    } else {
                        // 开始和该角色一起听
                        wyyStartTogetherListen(role);
                    }
                });
            });
        }
        
        // 更新结束按钮显示
        if (wyyTogetherListenRole) {
            wyyStopTogetherListenBtn.style.display = 'block';
        } else {
            wyyStopTogetherListenBtn.style.display = 'none';
        }
        
        wyyTogetherListenModal.style.display = 'flex';
    }
    
    // 开始一起听
    function wyyStartTogetherListen(role) {
        // 确保role是字符串
        wyyTogetherListenRole = String(role);
        wyyTogetherListenBtn.classList.add('active');
        wyyTogetherListenModal.style.display = 'none';
        
        // 不再发送消息到对话框，只作为角色回复的参考
        // 开始定时更新一起听状态（虽然不再更新卡片，但保持状态）
        wyyStartTogetherListenUpdate();
        
        alert(`已开始和 ${wyyTogetherListenRole} 一起听`);
    }
    
    // 结束一起听
    function wyyStopTogetherListen() {
        // 不再发送消息到对话框
        wyyTogetherListenRole = null;
        wyyTogetherListenBtn.classList.remove('active');
        wyyTogetherListenModal.style.display = 'none';
        
        // 停止定时更新
        wyyStopTogetherListenUpdate();
    }
    
    // 发送一起听消息
    function wyySendTogetherListenMessage(role, isStart) {
        // 确保role是字符串
        const roleStr = String(role);
        
        if (!wyyPlaylist.length || wyyCurrentSongIndex >= wyyPlaylist.length) {
            return;
        }
        
        const currentSong = wyyPlaylist[wyyCurrentSongIndex];
        const isPlaying = wyyAudio && !wyyAudio.paused;
        const currentTime = wyyAudio ? wyyAudio.currentTime : 0;
        
        if (isStart) {
            // 发送开始一起听的消息
            const messageText = `🎵 正在一起听：${currentSong.name} - ${currentSong.singer}`;
            const togetherListenData = {
                type: 'together-listen',
                songName: currentSong.name,
                singer: currentSong.singer,
                cover: currentSong.cover || '',
                isPlaying: isPlaying,
                currentTime: currentTime,
                duration: wyyAudio ? wyyAudio.duration : 0,
                lyrics: wyyCurrentLyrics.length > 0 ? wyyCurrentLyrics : []
            };
            
            // 添加一起听卡片消息
            addTogetherListenCard(roleStr, togetherListenData, true);
        } else {
            // 发送结束一起听的消息
            addChatMessage(roleStr, '已结束一起听', true);
        }
    }
    
    // 添加一起听卡片消息
    function addTogetherListenCard(role, data, isSelf) {
        const messageId = generateMessageId();
        const messages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isSelf ? 'self' : ''}`;
        messageDiv.dataset.messageId = messageId;
        
        // 确保role是字符串
        const roleStr = String(role);
        const avatar = isSelf ? '我' : roleStr.charAt(0);
        
        // 获取当前歌词（如果有）
        let currentLyric = '';
        if (data.lyrics && data.lyrics.length > 0 && data.currentTime) {
            for (let i = data.lyrics.length - 1; i >= 0; i--) {
                if (data.currentTime >= data.lyrics[i].time) {
                    currentLyric = data.lyrics[i].text;
                    break;
                }
            }
        }
        
        const bubbleContent = `
            <div class="together-listen-card" data-song-name="${data.songName}" data-singer="${data.singer}" data-is-playing="${data.isPlaying}" data-current-time="${data.currentTime}" data-duration="${data.duration}">
                <div class="together-listen-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px 12px 0 0; color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <i class="fa fa-music" style="font-size: 20px;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 16px;">${isSelf ? '正在和TA一起听' : '正在一起听'}</div>
                            <div style="font-size: 12px; opacity: 0.9;">${data.songName}</div>
                        </div>
                    </div>
                    ${data.cover ? `<div style="width: 100%; height: 120px; border-radius: 8px; background-image: url(${data.cover}); background-size: cover; background-position: center; margin-top: 8px;"></div>` : ''}
                </div>
                <div class="together-listen-content" style="padding: 12px; background: white;">
                    <div style="font-size: 14px; color: #333; margin-bottom: 8px;">
                        <div style="font-weight: 500;">${data.songName}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">${data.singer}</div>
                    </div>
                    ${currentLyric ? `<div style="font-size: 12px; color: #999; font-style: italic; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">"${currentLyric}"</div>` : ''}
                    ${!isSelf ? `<div style="margin-top: 10px; display: flex; gap: 8px;">
                        <button class="wyy-control-btn" onclick="wyySwitchSongFromChat('${role}', 'prev')" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; background: #f0f0f0; border: none; cursor: pointer;">上一首</button>
                        <button class="wyy-control-btn" onclick="wyySwitchSongFromChat('${role}', 'next')" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; background: #f0f0f0; border: none; cursor: pointer;">下一首</button>
                    </div>` : ''}
                </div>
            </div>
        `;
        
        messageDiv.innerHTML = `
            <div class="chat-avatar">${avatar}</div>
            <div class="chat-bubble">${bubbleContent}</div>
        `;
        
        messages.appendChild(messageDiv);
        
        // 滚动到底部
        messages.scrollTop = messages.scrollHeight;
        
        // 保存消息
        saveChatMessages(role);
        
        return messageId;
    }
    
    // 从聊天切换歌曲（全局函数，供HTML onclick使用）
    window.wyySwitchSongFromChat = function(role, direction) {
        // 确保类型一致进行比较
        const roleStr = String(role);
        if (String(wyyTogetherListenRole) !== roleStr) {
            alert('当前没有和该角色一起听');
            return;
        }
        
        if (direction === 'prev') {
            if (wyyPlaylist.length > 0) {
                wyyCurrentSongIndex = (wyyCurrentSongIndex - 1 + wyyPlaylist.length) % wyyPlaylist.length;
                wyyPlaySong(wyyCurrentSongIndex);
                // 不再发送消息到对话框，状态会通过 systemPrompt 传递给角色
            }
        } else if (direction === 'next') {
            if (wyyPlaylist.length > 0) {
                wyyCurrentSongIndex = (wyyCurrentSongIndex + 1) % wyyPlaylist.length;
                wyyPlaySong(wyyCurrentSongIndex);
                // 不再发送消息到对话框，状态会通过 systemPrompt 传递给角色
            }
        }
    }
    
    // 开始定时更新一起听状态（不再更新卡片，只保持状态）
    function wyyStartTogetherListenUpdate() {
        wyyStopTogetherListenUpdate();
        // 不再更新卡片，因为不再发送消息到对话框
        // 状态会通过 systemPrompt 传递给角色
    }
    
    // 停止定时更新
    function wyyStopTogetherListenUpdate() {
        if (wyyTogetherListenInterval) {
            clearInterval(wyyTogetherListenInterval);
            wyyTogetherListenInterval = null;
        }
    }
    
    // 更新一起听卡片
    function wyyUpdateTogetherListenCards() {
        if (!wyyTogetherListenRole || !wyyPlaylist.length || wyyCurrentSongIndex >= wyyPlaylist.length) {
            return;
        }
        
        const currentSong = wyyPlaylist[wyyCurrentSongIndex];
        const isPlaying = wyyAudio && !wyyAudio.paused;
        const currentTime = wyyAudio ? wyyAudio.currentTime : 0;
        const duration = wyyAudio ? wyyAudio.duration : 0;
        
        // 获取当前歌词
        let currentLyric = '';
        if (wyyCurrentLyrics && wyyCurrentLyrics.length > 0) {
            for (let i = wyyCurrentLyrics.length - 1; i >= 0; i--) {
                if (currentTime >= wyyCurrentLyrics[i].time) {
                    currentLyric = wyyCurrentLyrics[i].text;
                    break;
                }
            }
        }
        
        // 检查是否有歌曲名称不匹配的卡片（说明歌曲已切换）
        let hasMismatchedCard = false;
        document.querySelectorAll('.together-listen-card').forEach(card => {
            const songName = card.getAttribute('data-song-name');
            if (songName !== currentSong.name) {
                hasMismatchedCard = true;
            }
        });
        
        // 如果歌曲已切换，发送新的消息
        if (hasMismatchedCard) {
            wyySendTogetherListenMessage(wyyTogetherListenRole, true);
            return;
        }
        
        // 更新所有一起听卡片
        document.querySelectorAll('.together-listen-card').forEach(card => {
            const songName = card.getAttribute('data-song-name');
            if (songName === currentSong.name) {
                card.setAttribute('data-is-playing', isPlaying);
                card.setAttribute('data-current-time', currentTime);
                
                // 更新歌词显示
                const lyricElement = card.querySelector('.together-listen-content > div:last-child');
                if (lyricElement && currentLyric) {
                    if (!lyricElement.classList.contains('together-listen-lyric')) {
                        lyricElement.className = 'together-listen-lyric';
                        lyricElement.style.cssText = 'font-size: 12px; color: #999; font-style: italic; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;';
                    }
                    lyricElement.textContent = `"${currentLyric}"`;
                } else if (currentLyric && !lyricElement) {
                    const newLyricElement = document.createElement('div');
                    newLyricElement.className = 'together-listen-lyric';
                    newLyricElement.style.cssText = 'font-size: 12px; color: #999; font-style: italic; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;';
                    newLyricElement.textContent = `"${currentLyric}"`;
                    const contentElement = card.querySelector('.together-listen-content');
                    if (contentElement) {
                        contentElement.appendChild(newLyricElement);
                    }
                }
            }
        });
    }
    
    // 监听歌曲切换，自动更新一起听状态
    // 保存原始的wyyPlaySong函数
    const originalWyyPlaySong = wyyPlaySong;
    
    // 重写wyyPlaySong函数以支持一起听
    wyyPlaySong = async function(index) {
        await originalWyyPlaySong(index);
        // 不再发送消息到对话框，状态会通过 systemPrompt 传递给角色
    };
    
    if (wyyCancelTogetherListenBtn) {
        wyyCancelTogetherListenBtn.addEventListener('click', () => {
            wyyTogetherListenModal.style.display = 'none';
        });
    }
    
    if (wyyStopTogetherListenBtn) {
        wyyStopTogetherListenBtn.addEventListener('click', () => {
            wyyStopTogetherListen();
        });
    }
    
    if (wyyTogetherListenModal) {
        wyyTogetherListenModal.addEventListener('click', (e) => {
            if (e.target === wyyTogetherListenModal) {
                wyyTogetherListenModal.style.display = 'none';
            }
        });
    }

    // 阻止歌词容器滚动事件冒泡，避免影响页面滚动
    if (wyyLyricsContainer) {
        wyyLyricsContainer.addEventListener('touchmove', (e) => {
            e.stopPropagation();
        }, { passive: true });
        wyyLyricsContainer.addEventListener('wheel', (e) => {
            e.stopPropagation();
        }, { passive: true });
    }

    // 进度条功能
    function wyyStartProgressUpdate() {
        wyyStopProgressUpdate();
        wyyProgressUpdateInterval = setInterval(wyyUpdateProgress, 1000);
        wyyUpdateProgress();
    }

    function wyyStopProgressUpdate() {
        if (wyyProgressUpdateInterval) {
            clearInterval(wyyProgressUpdateInterval);
            wyyProgressUpdateInterval = null;
        }
    }

    function wyyUpdateProgress() {
        if (!wyyAudio || !wyyAudio.duration) return;
        
        const percent = (wyyAudio.currentTime / wyyAudio.duration) * 100;
        wyyProgress.style.width = percent + '%';
        wyyCurrentTime.textContent = wyyFormatTime(wyyAudio.currentTime);
        wyyTotalTime.textContent = wyyFormatTime(wyyAudio.duration);
    }

    function wyyFormatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    wyyProgressBar.addEventListener('click', (e) => {
        if (!wyyAudio) return;
        
        const rect = wyyProgressBar.getBoundingClientRect();
        const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        wyyAudio.currentTime = percent * wyyAudio.duration;
        wyyUpdateProgress();
    });

    // 添加上传选项切换功能
    wyyUrlOptionBtn.addEventListener('click', () => {
        wyyUrlOptionBtn.classList.add('active');
        wyyFileOptionBtn.classList.remove('active');
        wyyUrlUploadSection.classList.add('active');
        wyyFileUploadSection.classList.remove('active');
    });

    wyyFileOptionBtn.addEventListener('click', () => {
        wyyFileOptionBtn.classList.add('active');
        wyyUrlOptionBtn.classList.remove('active');
        wyyFileUploadSection.classList.add('active');
        wyyUrlUploadSection.classList.remove('active');
    });

    wyyLyricUrlOptionBtn.addEventListener('click', () => {
        wyyLyricUrlOptionBtn.classList.add('active');
        wyyLyricFileOptionBtn.classList.remove('active');
        wyyLyricUrlUploadSection.classList.add('active');
        wyyLyricFileUploadSection.classList.remove('active');
    });

    wyyLyricFileOptionBtn.addEventListener('click', () => {
        wyyLyricFileOptionBtn.classList.add('active');
        wyyLyricUrlOptionBtn.classList.remove('active');
        wyyLyricFileUploadSection.classList.add('active');
        wyyLyricUrlUploadSection.classList.remove('active');
    });

    // 上传封面按钮
    wyyUploadCoverBtn.addEventListener('click', () => {
        wyyCoverFileInput.click();
    });

    wyyCoverFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            if (!file.type.match('image.*')) {
                alert('请选择图片文件！');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                alert('图片大小不能超过2MB！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                wyySongCoverPreview.style.backgroundImage = `url(${e.target.result})`;
                wyyTempSongCover = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // 上传歌曲文件按钮
    wyyUploadSongFileBtn.addEventListener('click', () => {
        wyySongFileInput.click();
    });

    wyySongFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const validAudioTypes = [
                'audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/wave', 'audio/x-wav',
                'audio/ogg', 'audio/oga', 'audio/x-m4a', 'audio/mp4', 'audio/flac',
                'audio/x-flac', 'audio/aac', 'audio/aacp'
            ];
            
            const validExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.flac', '.aac'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!validAudioTypes.includes(file.type) && !isValidExtension) {
                alert('请选择有效的音频文件（MP3、WAV、OGG、M4A、FLAC、AAC等格式）！');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                alert('音频文件大小不能超过50MB！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                wyyTempSongFile = {
                    data: e.target.result,
                    type: file.type || 'audio/mpeg',
                    name: file.name
                };
                alert(`已选择歌曲文件: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            };
            reader.readAsDataURL(file);
        }
    });

    // 上传歌词文件按钮
    wyyUploadLyricFileBtn.addEventListener('click', () => {
        wyyLyricFileInput.click();
    });

    wyyLyricFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const validTypes = ['.lrc', '.txt'];
            const fileName = file.name.toLowerCase();
            const isValidType = validTypes.some(type => fileName.endsWith(type));
            
            if (!isValidType) {
                alert('请选择LRC或TXT格式的歌词文件！');
                return;
            }
            
            if (file.size > 1 * 1024 * 1024) {
                alert('歌词文件大小不能超过1MB！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                wyyTempLyricFile = {
                    data: e.target.result,
                    name: file.name
                };
                alert(`已选择歌词文件: ${file.name}`);
            };
            reader.readAsDataURL(file);
        }
    });

    // 添加歌曲按钮事件
    wyyAddSongBtn.addEventListener('click', wyyAddSong);

    // 清空列表按钮事件
    wyyClearAllBtn.addEventListener('click', wyyClearAllSongs);

    // 点击模态框外部关闭
    wyyPlaylistModal.addEventListener('click', (e) => {
        if (e.target === wyyPlaylistModal) {
            wyyPlaylistModal.style.display = 'none';
            wyyTempSongCover = null;
            wyyTempSongFile = null;
            wyyTempLyricFile = null;
            wyySongCoverPreview.style.backgroundImage = '';
        }
    });

    // 装扮功能
    const wyyDressUpBtn = document.getElementById('wyyDressUpBtn');
    const wyyDressUpModal = document.getElementById('wyyDressUpModal');
    const wyyCancelBtn = document.getElementById('wyyCancelBtn');
    const wyySaveBtn = document.getElementById('wyySaveBtn');
    const wyyUploadAvatarBtn = document.getElementById('wyyUploadAvatarBtn');
    const wyyAvatarFileInput = document.getElementById('wyyAvatarFileInput');
    const wyyAvatarDisplay = document.getElementById('wyyAvatarDisplay');
    const wyyModalAvatarPreview = document.getElementById('wyyModalAvatarPreview');
    
    const wyyFollowInput = document.getElementById('wyyFollowInput');
    const wyyFansInput = document.getElementById('wyyFansInput');
    const wyyLevelInput = document.getElementById('wyyLevelInput');
    const wyyTimeInput = document.getElementById('wyyTimeInput');
    
    const wyyFollowValue = document.querySelector('.wyy-stat-item[data-type="follow"] .wyy-stat-value');
    const wyyFansValue = document.querySelector('.wyy-stat-item[data-type="fans"] .wyy-stat-value');
    const wyyLevelValue = document.querySelector('.wyy-stat-item[data-type="level"] .wyy-stat-value');
    const wyyTimeValue = document.querySelector('.wyy-stat-item[data-type="time"] .wyy-stat-value');
    
    const wyyCard1 = document.getElementById('wyyCard1');
    const wyyCard2 = document.getElementById('wyyCard2');
    const wyyCard3 = document.getElementById('wyyCard3');
    const wyyCard4 = document.getElementById('wyyCard4');
    
    const wyyModalCardPreview1 = document.getElementById('wyyModalCardPreview1');
    const wyyModalCardPreview2 = document.getElementById('wyyModalCardPreview2');
    const wyyModalCardPreview3 = document.getElementById('wyyModalCardPreview3');
    const wyyModalCardPreview4 = document.getElementById('wyyModalCardPreview4');
    
    const wyyCardUploadBtns = document.querySelectorAll('.wyy-card-upload-btn');
    const wyyCardFileInputs = document.querySelectorAll('.wyy-card-file-input');
    
    let wyyTempAvatar = null;
    const wyyTempCards = { 1: null, 2: null, 3: null, 4: null };

    wyyDressUpBtn.addEventListener('click', () => {
        wyyLoadCurrentSettings();
        wyyDressUpModal.style.display = 'flex';
        wyyResetTempData();
    });

    wyyCancelBtn.addEventListener('click', () => {
        wyyDressUpModal.style.display = 'none';
        wyyResetTempData();
    });

    wyySaveBtn.addEventListener('click', () => {
        wyySaveSettings();
        wyyDressUpModal.style.display = 'none';
    });

    wyyDressUpModal.addEventListener('click', (e) => {
        if (e.target === wyyDressUpModal) {
            wyyDressUpModal.style.display = 'none';
            wyyResetTempData();
        }
    });

    wyyUploadAvatarBtn.addEventListener('click', () => {
        wyyAvatarFileInput.click();
    });

    wyyAvatarFileInput.addEventListener('change', function(event) {
        wyyHandleFileUpload(event, 'avatar');
    });

    wyyCardFileInputs.forEach(input => {
        input.addEventListener('change', function(event) {
            const cardNum = this.getAttribute('data-card');
            wyyHandleFileUpload(event, `card${cardNum}`);
        });
    });

    wyyCardUploadBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const cardNum = this.getAttribute('data-card');
            const fileInput = document.querySelector(`.wyy-card-file-input[data-card="${cardNum}"]`);
            fileInput.click();
        });
    });

    function wyyHandleFileUpload(event, type) {
        const file = event.target.files[0];
        
        if (file) {
            if (!file.type.match('image.*')) {
                alert('请选择图片文件！');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('图片大小不能超过5MB！');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                if (type === 'avatar') {
                    wyyModalAvatarPreview.style.backgroundImage = `url(${e.target.result})`;
                    wyyTempAvatar = e.target.result;
                } else {
                    const cardNum = type.replace('card', '');
                    const preview = document.getElementById(`wyyModalCardPreview${cardNum}`);
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    wyyTempCards[cardNum] = e.target.result;
                }
            };
            
            reader.readAsDataURL(file);
        }
    }

    async function wyyLoadCurrentSettings() {
        try {
            const userSettings = await wyyDb.userSettings.get('avatar');
            if (userSettings) {
                wyyModalAvatarPreview.style.backgroundImage = `url(${userSettings.data})`;
            } else {
                wyyModalAvatarPreview.style.backgroundImage = '';
            }
            
            const savedFollow = (await wyyDb.userSettings.get('follow'))?.data || '29';
            const savedFans = (await wyyDb.userSettings.get('fans'))?.data || '9';
            const savedLevel = (await wyyDb.userSettings.get('level'))?.data || 'Lv.7';
            const savedTime = (await wyyDb.userSettings.get('time'))?.data || '904h';
            
            wyyFollowInput.value = savedFollow;
            wyyFansInput.value = savedFans;
            wyyLevelInput.value = savedLevel;
            wyyTimeInput.value = savedTime;
            
            for (let i = 1; i <= 4; i++) {
                const cardKey = `card${i}`;
                const savedCard = await wyyDb.playlistCards.get(cardKey);
                const preview = document.getElementById(`wyyModalCardPreview${i}`);
                if (savedCard) {
                    preview.style.backgroundImage = `url(${savedCard.data})`;
                } else {
                    preview.style.backgroundImage = '';
                }
            }
        } catch (error) {
            console.error('加载设置失败:', error);
        }
    }

    async function wyySaveSettings() {
        try {
            if (wyyTempAvatar) {
                wyyAvatarDisplay.style.backgroundImage = `url(${wyyTempAvatar})`;
                await wyyDb.userSettings.put({ id: 'avatar', data: wyyTempAvatar });
            }
            
            const follow = wyyFollowInput.value;
            const fans = wyyFansInput.value;
            const level = wyyLevelInput.value;
            const time = wyyTimeInput.value;
            
            wyyFollowValue.textContent = follow;
            wyyFansValue.textContent = fans;
            wyyLevelValue.textContent = level;
            wyyTimeValue.textContent = time;
            
            await wyyDb.userSettings.put({ id: 'follow', data: follow });
            await wyyDb.userSettings.put({ id: 'fans', data: fans });
            await wyyDb.userSettings.put({ id: 'level', data: level });
            await wyyDb.userSettings.put({ id: 'time', data: time });
            
            for (let i = 1; i <= 4; i++) {
                if (wyyTempCards[i]) {
                    const cardElement = document.getElementById(`wyyCard${i}`);
                    cardElement.style.backgroundImage = `url(${wyyTempCards[i]})`;
                    await wyyDb.playlistCards.put({ id: `card${i}`, data: wyyTempCards[i] });
                }
            }
            
            wyyResetTempData();
        } catch (error) {
            console.error('保存设置失败:', error);
        }
    }

    function wyyResetTempData() {
        wyyTempAvatar = null;
        for (let i = 1; i <= 4; i++) {
            wyyTempCards[i] = null;
        }
    }

    // 页面加载时恢复设置和初始化播放列表
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            // 确保播放器详情页面初始状态是隐藏的
            wyyPlayerPage.classList.remove('active');
            wyyMainPage.classList.add('active');
            
            const savedAvatar = await wyyDb.userSettings.get('avatar');
            if (savedAvatar) {
                wyyAvatarDisplay.style.backgroundImage = `url(${savedAvatar.data})`;
            }
            
            const savedFollow = await wyyDb.userSettings.get('follow');
            const savedFans = await wyyDb.userSettings.get('fans');
            const savedLevel = await wyyDb.userSettings.get('level');
            const savedTime = await wyyDb.userSettings.get('time');
            
            if (savedFollow) wyyFollowValue.textContent = savedFollow.data;
            if (savedFans) wyyFansValue.textContent = savedFans.data;
            if (savedLevel) wyyLevelValue.textContent = savedLevel.data;
            if (savedTime) wyyTimeValue.textContent = savedTime.data;
            
            for (let i = 1; i <= 4; i++) {
                const cardKey = `card${i}`;
                const savedCard = await wyyDb.playlistCards.get(cardKey);
                const cardElement = document.getElementById(`wyyCard${i}`);
                if (savedCard) {
                    cardElement.style.backgroundImage = `url(${savedCard.data})`;
                }
            }
            
            await wyyInitPlaylist();
            await wyyLoadPlaylists();
        } catch (error) {
            console.error('加载设置失败:', error);
        }
    });

    // ============================================
    // 歌单管理功能
    // ============================================
    
    // 加载歌单列表
    async function wyyLoadPlaylists() {
        try {
            const playlists = await wyyDb.playlists.orderBy('dateCreated').reverse().toArray();
            const playlistsList = document.getElementById('wyyPlaylistsList');
            if (!playlistsList) return;
            
            if (playlists.length === 0) {
                playlistsList.innerHTML = '';
                return;
            }
            
            let html = '';
            playlists.forEach(playlist => {
                html += `
                    <div class="wyy-playlist-card" data-playlist-id="${playlist.id}" style="cursor: pointer;">
                        <div class="wyy-playlist-cover" style="${playlist.cover ? `background-image: url(${playlist.cover})` : 'background: #f0f0f0;'}"></div>
                        <div class="wyy-playlist-info">
                            <div class="wyy-playlist-name">${playlist.name}</div>
                            <div class="wyy-playlist-desc">${playlist.desc || '暂无描述'}</div>
                        </div>
                        <div class="wyy-playlist-actions" style="display: flex; gap: 10px; align-items: center;">
                            <button class="wyy-control-btn" onclick="event.stopPropagation(); wyyExportSinglePlaylist(${playlist.id})" title="导出">
                                <i class="fa fa-download"></i>
                            </button>
                            <button class="wyy-control-btn" onclick="event.stopPropagation(); wyyDeletePlaylist(${playlist.id})" title="删除" style="color: #ff4444;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            playlistsList.innerHTML = html;
            
            // 添加点击事件（点击歌单卡片显示详情，点击操作按钮不触发）
            document.querySelectorAll('.wyy-playlist-card[data-playlist-id]').forEach(card => {
                card.addEventListener('click', async function(e) {
                    // 如果点击的是操作按钮区域，不触发
                    if (e.target.closest('.wyy-playlist-actions')) {
                        return;
                    }
                    const playlistId = parseInt(this.getAttribute('data-playlist-id'));
                    await wyyShowPlaylistDetail(playlistId);
                });
            });
        } catch (error) {
            console.error('加载歌单列表失败:', error);
        }
    }
    
    // 切换歌单
    async function wyySwitchPlaylist(playlistId) {
        wyyCurrentPlaylistId = playlistId;
        await wyyInitPlaylist();
    }
    
    // 显示歌单详情
    async function wyyShowPlaylistDetail(playlistId) {
        try {
            const playlist = await wyyDb.playlists.get(playlistId);
            if (!playlist) {
                alert('歌单不存在');
                return;
            }
            
            let songs = await wyyDb.songs.where('playlistId').equals(playlistId).toArray();
            // 在内存中按日期排序
            songs.sort((a, b) => {
                const dateA = a.dateAdded ? new Date(a.dateAdded).getTime() : 0;
                const dateB = b.dateAdded ? new Date(b.dateAdded).getTime() : 0;
                return dateA - dateB;
            });
            
            // 更新标题
            const titleElement = document.getElementById('wyyPlaylistDetailTitle');
            if (titleElement) {
                titleElement.textContent = `${playlist.name} (${songs.length}首)`;
            }
            
            // 显示歌曲列表
            const songsListElement = document.getElementById('wyyPlaylistDetailSongsList');
            if (!songsListElement) return;
            
            if (songs.length === 0) {
                songsListElement.innerHTML = '<div class="wyy-empty-playlist">该歌单暂无歌曲</div>';
            } else {
                let html = '';
                songs.forEach((song, index) => {
                    const hasCover = song.cover && song.cover !== '';
                    html += `
                        <div class="wyy-song-item" data-song-id="${song.id}">
                            <div class="wyy-song-item-icon ${!hasCover ? 'default' : ''}" style="${hasCover ? `background-image: url(${song.cover})` : ''}">
                                ${!hasCover ? (index + 1) : ''}
                            </div>
                            <div class="wyy-song-item-info">
                                <div class="wyy-song-item-name">${song.name}</div>
                                <div class="wyy-song-item-singer">${song.singer}</div>
                            </div>
                        </div>
                    `;
                });
                songsListElement.innerHTML = html;
            }
            
            // 显示模态框
            const modal = document.getElementById('wyyPlaylistDetailModal');
            if (modal) {
                modal.style.display = 'flex';
                
                // 设置切换到该歌单的按钮事件
                const switchBtn = document.getElementById('wyySwitchToPlaylistBtn');
                if (switchBtn) {
                    switchBtn.onclick = async () => {
                        await wyySwitchPlaylist(playlistId);
                        modal.style.display = 'none';
                    };
                }
            }
        } catch (error) {
            console.error('加载歌单详情失败:', error);
            alert('加载歌单详情失败');
        }
    }
    
    // 关闭歌单详情
    const wyyClosePlaylistDetailBtn = document.getElementById('wyyClosePlaylistDetailBtn');
    const wyyPlaylistDetailModal = document.getElementById('wyyPlaylistDetailModal');
    
    if (wyyClosePlaylistDetailBtn) {
        wyyClosePlaylistDetailBtn.addEventListener('click', () => {
            wyyPlaylistDetailModal.style.display = 'none';
        });
    }
    
    if (wyyPlaylistDetailModal) {
        wyyPlaylistDetailModal.addEventListener('click', (e) => {
            if (e.target === wyyPlaylistDetailModal) {
                wyyPlaylistDetailModal.style.display = 'none';
            }
        });
    }
    
    // 打开歌单管理
    const wyyManagePlaylistsBtn = document.getElementById('wyyManagePlaylistsBtn');
    if (wyyManagePlaylistsBtn) {
        wyyManagePlaylistsBtn.addEventListener('click', () => {
            const modal = document.getElementById('wyyPlaylistManageModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        });
    }
    
    // 创建歌单
    const wyyNewPlaylistBtn = document.getElementById('wyyNewPlaylistBtn');
    const wyyCreatePlaylistModal = document.getElementById('wyyCreatePlaylistModal');
    const wyyNewPlaylistName = document.getElementById('wyyNewPlaylistName');
    const wyyNewPlaylistDesc = document.getElementById('wyyNewPlaylistDesc');
    const wyyNewPlaylistCoverPreview = document.getElementById('wyyNewPlaylistCoverPreview');
    const wyyUploadPlaylistCoverBtn = document.getElementById('wyyUploadPlaylistCoverBtn');
    const wyyPlaylistCoverFileInput = document.getElementById('wyyPlaylistCoverFileInput');
    const wyyCancelCreatePlaylistBtn = document.getElementById('wyyCancelCreatePlaylistBtn');
    const wyySaveCreatePlaylistBtn = document.getElementById('wyySaveCreatePlaylistBtn');
    
    let wyyTempPlaylistCover = null;
    
    if (wyyNewPlaylistBtn) {
        wyyNewPlaylistBtn.addEventListener('click', () => {
            wyyCreatePlaylistModal.style.display = 'flex';
            wyyNewPlaylistName.value = '';
            wyyNewPlaylistDesc.value = '';
            wyyNewPlaylistCoverPreview.style.backgroundImage = '';
            wyyTempPlaylistCover = null;
        });
    }
    
    if (wyyUploadPlaylistCoverBtn) {
        wyyUploadPlaylistCoverBtn.addEventListener('click', () => {
            wyyPlaylistCoverFileInput.click();
        });
    }
    
    if (wyyPlaylistCoverFileInput) {
        wyyPlaylistCoverFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.match('image.*')) {
                    alert('请选择图片文件！');
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB！');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    wyyNewPlaylistCoverPreview.style.backgroundImage = `url(${e.target.result})`;
                    wyyTempPlaylistCover = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    if (wyyCancelCreatePlaylistBtn) {
        wyyCancelCreatePlaylistBtn.addEventListener('click', () => {
            wyyCreatePlaylistModal.style.display = 'none';
        });
    }
    
    if (wyySaveCreatePlaylistBtn) {
        wyySaveCreatePlaylistBtn.addEventListener('click', async () => {
            const name = wyyNewPlaylistName.value.trim();
            if (!name) {
                alert('请输入歌单名称');
                return;
            }
            
            try {
                const playlistId = await wyyDb.playlists.add({
                    name: name,
                    desc: wyyNewPlaylistDesc.value.trim(),
                    cover: wyyTempPlaylistCover || '',
                    dateCreated: new Date()
                });
                
                wyyCreatePlaylistModal.style.display = 'none';
                await wyyLoadPlaylists();
                await wyySwitchPlaylist(playlistId);
                alert('歌单创建成功！');
            } catch (error) {
                console.error('创建歌单失败:', error);
                alert('创建歌单失败，请重试');
            }
        });
    }
    
    if (wyyCreatePlaylistModal) {
        wyyCreatePlaylistModal.addEventListener('click', (e) => {
            if (e.target === wyyCreatePlaylistModal) {
                wyyCreatePlaylistModal.style.display = 'none';
            }
        });
    }
    
    // 删除歌单
    async function wyyDeletePlaylist(playlistId) {
        if (!confirm('确定要删除这个歌单吗？歌单中的歌曲不会被删除。')) {
            return;
        }
        
        try {
            // 删除歌单
            await wyyDb.playlists.delete(playlistId);
            
            // 如果删除的是当前歌单，切换到默认歌单
            if (wyyCurrentPlaylistId === playlistId) {
                wyyCurrentPlaylistId = null;
                await wyyInitPlaylist();
            }
            
            await wyyLoadPlaylists();
            alert('歌单删除成功！');
        } catch (error) {
            console.error('删除歌单失败:', error);
            alert('删除歌单失败，请重试');
        }
    }
    
    // 导出单个歌单
    async function wyyExportSinglePlaylist(playlistId) {
        try {
            const playlist = await wyyDb.playlists.get(playlistId);
            if (!playlist) {
                alert('歌单不存在');
                return;
            }
            
            const songs = await wyyDb.songs.where('playlistId').equals(playlistId).toArray();
            
            // 加载每首歌曲的完整信息
            const fullSongs = [];
            for (const song of songs) {
                const songFile = await wyyDb.songFiles.where({ songId: song.id }).first();
                const lyric = await wyyDb.lyrics.where({ songId: song.id }).first();
                
                const fullSong = {
                    name: song.name,
                    singer: song.singer,
                    cover: song.cover || '',
                    url: song.url || '',
                    lyricUrl: song.lyricUrl || '',
                    hasLocalFile: !!songFile,
                    hasLocalLyric: !!lyric
                };
                
                if (songFile) {
                    fullSong.fileData = songFile.data;
                    fullSong.fileType = songFile.type;
                }
                
                if (lyric) {
                    fullSong.lyricData = lyric.data;
                }
                
                fullSongs.push(fullSong);
            }
            
            const exportData = {
                playlist: {
                    name: playlist.name,
                    desc: playlist.desc,
                    cover: playlist.cover
                },
                songs: fullSongs,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${playlist.name}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('歌单导出成功！');
        } catch (error) {
            console.error('导出歌单失败:', error);
            alert('导出歌单失败，请重试');
        }
    }
    
    // 导出当前歌单
    const wyyExportPlaylistBtn = document.getElementById('wyyExportPlaylistBtn');
    if (wyyExportPlaylistBtn) {
        wyyExportPlaylistBtn.addEventListener('click', async () => {
            if (!wyyCurrentPlaylistId) {
                alert('请先选择一个歌单');
                return;
            }
            await wyyExportSinglePlaylist(wyyCurrentPlaylistId);
        });
    }
    
    // 导入歌单
    const wyyImportPlaylistBtn = document.getElementById('wyyImportPlaylistBtn');
    const wyyImportPlaylistFileInput = document.getElementById('wyyImportPlaylistFileInput');
    
    if (wyyImportPlaylistBtn) {
        wyyImportPlaylistBtn.addEventListener('click', () => {
            wyyImportPlaylistFileInput.click();
        });
    }
    
    if (wyyImportPlaylistFileInput) {
        wyyImportPlaylistFileInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('请选择JSON格式的文件');
                return;
            }
            
            try {
                const text = await file.text();
                const importData = JSON.parse(text);
                
                if (!importData.playlist || !importData.songs) {
                    alert('文件格式不正确');
                    return;
                }
                
                // 创建歌单
                const playlistId = await wyyDb.playlists.add({
                    name: importData.playlist.name + ' (导入)',
                    desc: importData.playlist.desc || '',
                    cover: importData.playlist.cover || '',
                    dateCreated: new Date()
                });
                
                // 导入歌曲
                for (const songData of importData.songs) {
                    const songId = await wyyDb.songs.add({
                        name: songData.name,
                        singer: songData.singer,
                        cover: songData.cover || '',
                        url: songData.url || '',
                        lyricUrl: songData.lyricUrl || '',
                        playlistId: playlistId,
                        dateAdded: new Date()
                    });
                    
                    if (songData.hasLocalFile && songData.fileData) {
                        await wyyDb.songFiles.add({
                            songId: songId,
                            type: songData.fileType || 'audio/mpeg',
                            data: songData.fileData
                        });
                    }
                    
                    if (songData.hasLocalLyric && songData.lyricData) {
                        await wyyDb.lyrics.add({
                            songId: songId,
                            data: songData.lyricData
                        });
                    }
                }
                
                await wyyLoadPlaylists();
                await wyySwitchPlaylist(playlistId);
                alert('歌单导入成功！');
            } catch (error) {
                console.error('导入歌单失败:', error);
                alert('导入歌单失败：' + error.message);
            }
        });
    }
    
    // 添加到歌单功能
    const wyyAddToPlaylistModal = document.getElementById('wyyAddToPlaylistModal');
    const wyyPlaylistSelectorList = document.getElementById('wyyPlaylistSelectorList');
    const wyyCancelAddToPlaylistBtn = document.getElementById('wyyCancelAddToPlaylistBtn');
    let wyyCurrentAddSongId = null;
    
    // 显示添加到歌单模态框
    async function wyyShowAddToPlaylistModal(songId) {
        wyyCurrentAddSongId = songId;
        
        try {
            const playlists = await wyyDb.playlists.orderBy('dateCreated').reverse().toArray();
            
            if (playlists.length === 0) {
                wyyPlaylistSelectorList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">还没有歌单，请先创建歌单</div>';
            } else {
                let html = '';
                playlists.forEach(playlist => {
                    html += `
                        <div class="wyy-playlist-selector-item" data-playlist-id="${playlist.id}" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;">
                            <div class="wyy-playlist-cover" style="width: 40px; height: 40px; border-radius: 6px; ${playlist.cover ? `background-image: url(${playlist.cover})` : 'background: #f0f0f0;'}"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #333; margin-bottom: 2px;">${playlist.name}</div>
                                <div style="font-size: 12px; color: #999;">${playlist.desc || '暂无描述'}</div>
                            </div>
                            <i class="fa fa-chevron-right" style="color: #ccc;"></i>
                        </div>
                    `;
                });
                
                wyyPlaylistSelectorList.innerHTML = html;
                
                // 添加点击事件
                document.querySelectorAll('.wyy-playlist-selector-item').forEach(item => {
                    item.addEventListener('click', async function() {
                        const playlistId = parseInt(this.getAttribute('data-playlist-id'));
                        await wyyAddSongToPlaylist(songId, playlistId);
                    });
                });
            }
            
            wyyAddToPlaylistModal.style.display = 'flex';
        } catch (error) {
            console.error('加载歌单列表失败:', error);
            alert('加载歌单列表失败');
        }
    }
    
    // 将歌曲添加到歌单
    async function wyyAddSongToPlaylist(songId, playlistId) {
        try {
            // 检查歌曲是否已经在歌单中
            const existingSong = await wyyDb.songs.where({ id: songId, playlistId: playlistId }).first();
            if (existingSong) {
                alert('歌曲已在该歌单中');
                wyyAddToPlaylistModal.style.display = 'none';
                return;
            }
            
            // 获取原歌曲信息
            const originalSong = await wyyDb.songs.get(songId);
            if (!originalSong) {
                alert('歌曲不存在');
                return;
            }
            
            // 创建新歌曲记录（添加到新歌单）
            const newSongData = {
                name: originalSong.name,
                singer: originalSong.singer,
                cover: originalSong.cover || '',
                url: originalSong.url || '',
                lyricUrl: originalSong.lyricUrl || '',
                playlistId: playlistId,
                dateAdded: new Date()
            };
            
            const newSongId = await wyyDb.songs.add(newSongData);
            
            // 复制歌曲文件
            const songFile = await wyyDb.songFiles.where({ songId: songId }).first();
            if (songFile) {
                await wyyDb.songFiles.add({
                    songId: newSongId,
                    type: songFile.type,
                    data: songFile.data
                });
            }
            
            // 复制歌词文件
            const lyric = await wyyDb.lyrics.where({ songId: songId }).first();
            if (lyric) {
                await wyyDb.lyrics.add({
                    songId: newSongId,
                    data: lyric.data
                });
            }
            
            wyyAddToPlaylistModal.style.display = 'none';
            alert('歌曲已添加到歌单！');
        } catch (error) {
            console.error('添加歌曲到歌单失败:', error);
            alert('添加歌曲到歌单失败，请重试');
        }
    }
    
    if (wyyCancelAddToPlaylistBtn) {
        wyyCancelAddToPlaylistBtn.addEventListener('click', () => {
            wyyAddToPlaylistModal.style.display = 'none';
        });
    }
    
    if (wyyAddToPlaylistModal) {
        wyyAddToPlaylistModal.addEventListener('click', (e) => {
            if (e.target === wyyAddToPlaylistModal) {
                wyyAddToPlaylistModal.style.display = 'none';
            }
        });
    }
    
    // 歌单管理模态框
    const wyyPlaylistManageModal = document.getElementById('wyyPlaylistManageModal');
    const wyyClosePlaylistManageBtn = document.getElementById('wyyClosePlaylistManageBtn');
    
    if (wyyClosePlaylistManageBtn) {
        wyyClosePlaylistManageBtn.addEventListener('click', () => {
            wyyPlaylistManageModal.style.display = 'none';
        });
    }
    
    if (wyyPlaylistManageModal) {
        wyyPlaylistManageModal.addEventListener('click', (e) => {
            if (e.target === wyyPlaylistManageModal) {
                wyyPlaylistManageModal.style.display = 'none';
            }
        });
    }

    // ============================================
    // 后台通知与保活系统
    // ============================================
    
    // 静音音频元素（用于后台保活）
    const silentAudio = document.createElement('audio');
    silentAudio.id = 'silent-audio-player';
    silentAudio.loop = true;
    silentAudio.preload = 'auto';
    silentAudio.style.display = 'none';
    // 创建静音音频源（使用data URI）
    silentAudio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRQ==';
    document.body.appendChild(silentAudio);
    
    // 检查浏览器是否支持通知
    function isNotificationSupported() {
        return 'Notification' in window;
    }
    
    // 更新通知开关和状态显示
    function updateNotificationButton() {
        const switchEl = document.getElementById('notification-permission-switch');
        const statusDisplay = document.getElementById('notification-status-display');
        const statusText = document.getElementById('notification-status-text');
        const requestBtn = document.getElementById('notification-request-btn');
        const testBtn = document.getElementById('notification-test-btn');
        const bgTestBtn = document.getElementById('notification-background-test-btn');
        
        if (!switchEl || !statusDisplay || !statusText) return;
        
        if (!isNotificationSupported()) {
            statusDisplay.style.display = 'none';
            if (switchEl) switchEl.disabled = true;
            return;
        }
        
        const permission = Notification.permission;
        statusDisplay.style.display = 'block';
        
        switch (permission) {
            case 'granted':
                if (switchEl) switchEl.checked = true;
                statusText.textContent = '通知状态：已授权 ✅';
                statusText.style.color = '#4cd964';
                if (requestBtn) requestBtn.style.display = 'none';
                if (testBtn) testBtn.style.display = 'block';
                if (bgTestBtn) bgTestBtn.style.display = 'block';
                break;
            case 'denied':
                if (switchEl) switchEl.checked = false;
                statusText.textContent = '通知状态：已拒绝 ❌（请在浏览器设置中手动开启）';
                statusText.style.color = '#ff3b30';
                if (requestBtn) requestBtn.style.display = 'none';
                if (testBtn) testBtn.style.display = 'none';
                if (bgTestBtn) bgTestBtn.style.display = 'none';
                break;
            default:
                if (switchEl) switchEl.checked = false;
                statusText.textContent = '通知状态：未授权';
                statusText.style.color = '#666';
                if (requestBtn) requestBtn.style.display = 'block';
                if (testBtn) testBtn.style.display = 'none';
                if (bgTestBtn) bgTestBtn.style.display = 'none';
        }
    }
    
    // 请求通知权限
    async function requestNotificationPermission() {
        if (!isNotificationSupported()) {
            alert('您的浏览器不支持通知功能');
            return;
        }
        
        if (Notification.permission === 'granted') {
            alert('通知权限已授予');
            return;
        }
        
        if (Notification.permission === 'denied') {
            alert('通知权限已被拒绝，请在浏览器设置中手动开启');
            return;
        }
        
        const permission = await Notification.requestPermission();
        updateNotificationButton();
        
        if (permission === 'granted') {
            showSystemNotification('后台通知已开启', '当页面切到后台时，您将收到通知提醒');
            startKeepAlive();
        }
    }
    
    // 显示系统通知
    function showSystemNotification(title, body) {
        if (Notification.permission !== 'granted') return;
        try {
            new Notification(title, { body: body, tag: 'system-notification' });
        } catch (error) {
            console.error('发送通知失败:', error);
        }
    }
    
    // 发送测试通知
    function sendTestNotification() {
        if (Notification.permission !== 'granted') {
            alert('请先开启通知权限');
            return;
        }
        
        try {
            const notification = new Notification('测试通知', {
                body: '这是一条测试通知。如果您看到这条消息，说明通知功能正常工作！',
                tag: 'test-notification',
                requireInteraction: false,
                silent: false
            });
            
            notification.onclick = () => {
                window.focus();
                notification.close();
            };
            
            setTimeout(() => notification.close(), 5000);
            console.log('✅ 测试通知已发送');
        } catch (error) {
            console.error('❌ 发送测试通知失败:', error);
            alert('发送测试通知失败：' + error.message);
        }
    }
    
    // 后台保活系统
    const BackgroundSystem = {
        heartbeat: {
            baseInterval: 30000,      // 基准心跳间隔：30秒
            jitterRange: 10000,       // 随机抖动范围：±10秒
            timeoutId: null,
            isRunning: false,
            lastBeat: Date.now(),
            beatCount: 0
        },
        audio: {
            context: null,
            source: null,
            gainNode: null,
            isActive: false
        },
        state: {
            isBackground: document.hidden,
            lastActivity: Date.now(),
            networkOnline: navigator.onLine
        }
    };
    
    // 计算带随机抖动的下次心跳间隔
    function getNextHeartbeatInterval() {
        const { baseInterval, jitterRange } = BackgroundSystem.heartbeat;
        const jitter = Math.random() * jitterRange * 2 - jitterRange;
        const interval = baseInterval + jitter;
        return Math.max(15000, Math.min(60000, interval));
    }
    
    // 执行一次心跳
    function performHeartbeat() {
        const now = Date.now();
        BackgroundSystem.heartbeat.lastBeat = now;
        BackgroundSystem.heartbeat.beatCount++;
        
        const state = {
            timestamp: now,
            isBackground: document.hidden,
            beatCount: BackgroundSystem.heartbeat.beatCount,
            networkOnline: navigator.onLine
        };
        
        try {
            localStorage.setItem('app_heartbeat', JSON.stringify(state));
        } catch (e) {
            console.warn('心跳状态存储失败:', e);
        }
        
        console.log(`💓 后台心跳 #${state.beatCount} | 下次间隔: ${getNextHeartbeatInterval() / 1000}秒`);
        
        scheduleNextHeartbeat();
    }
    
    // 调度下次心跳
    function scheduleNextHeartbeat() {
        if (BackgroundSystem.heartbeat.timeoutId) {
            clearTimeout(BackgroundSystem.heartbeat.timeoutId);
        }
        
        const interval = getNextHeartbeatInterval();
        
        BackgroundSystem.heartbeat.timeoutId = setTimeout(() => {
            performHeartbeat();
        }, interval);
    }
    
    // 启动心跳系统
    function startHeartbeat() {
        if (BackgroundSystem.heartbeat.isRunning) {
            console.log('心跳已在运行中');
            return;
        }
        
        BackgroundSystem.heartbeat.isRunning = true;
        console.log('🚀 启动后台心跳系统（随机抖动模式）');
        performHeartbeat();
    }
    
    // 停止心跳系统
    function stopHeartbeat() {
        if (!BackgroundSystem.heartbeat.isRunning) {
            return;
        }
        
        if (BackgroundSystem.heartbeat.timeoutId) {
            clearTimeout(BackgroundSystem.heartbeat.timeoutId);
            BackgroundSystem.heartbeat.timeoutId = null;
        }
        
        BackgroundSystem.heartbeat.isRunning = false;
        console.log('⏹️ 停止后台心跳系统');
    }
    
    // 初始化音频保活
    function initAudioKeepAlive() {
        if (BackgroundSystem.audio.context) {
            return true;
        }
        
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            BackgroundSystem.audio.context = new AudioContext();
            
            const sampleRate = BackgroundSystem.audio.context.sampleRate;
            const buffer = BackgroundSystem.audio.context.createBuffer(1, sampleRate * 0.1, sampleRate);
            
            const source = BackgroundSystem.audio.context.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            
            const gainNode = BackgroundSystem.audio.context.createGain();
            gainNode.gain.value = 0;
            
            source.connect(gainNode);
            gainNode.connect(BackgroundSystem.audio.context.destination);
            
            BackgroundSystem.audio.source = source;
            BackgroundSystem.audio.gainNode = gainNode;
            
            console.log('✅ 音频上下文初始化成功');
            return true;
        } catch (error) {
            console.warn('❌ 音频上下文初始化失败:', error);
            return false;
        }
    }
    
    // 启动音频保活
    function startAudioKeepAlive() {
        if (BackgroundSystem.audio.isActive) {
            return;
        }
        
        // 尝试使用Web Audio API
        if (initAudioKeepAlive()) {
            try {
                const { context, source } = BackgroundSystem.audio;
                
                if (context.state === 'suspended') {
                    context.resume();
                }
                
                source.start(0);
                BackgroundSystem.audio.isActive = true;
                console.log('✅ Web Audio API保活已启动');
                return;
            } catch (error) {
                console.warn('Web Audio API启动失败，尝试使用HTML5音频:', error);
            }
        }
        
        // 降级到HTML5音频
        try {
            silentAudio.volume = 0;
            silentAudio.play().then(() => {
                console.log('✅ HTML5音频保活已启动');
            }).catch(error => {
                console.warn('HTML5音频启动失败:', error);
            });
        } catch (error) {
            console.warn('音频保活启动失败:', error);
        }
    }
    
    // 停止音频保活
    function stopAudioKeepAlive() {
        if (BackgroundSystem.audio.isActive && BackgroundSystem.audio.source) {
            try {
                BackgroundSystem.audio.source.stop();
                BackgroundSystem.audio.isActive = false;
                console.log('⏹️ Web Audio API保活已停止');
            } catch (error) {
                console.warn('停止Web Audio API失败:', error);
            }
        }
        
        try {
            silentAudio.pause();
            silentAudio.currentTime = 0;
        } catch (error) {
            console.warn('停止HTML5音频失败:', error);
        }
    }
    
    // 启动保活系统
    function startKeepAlive() {
        if (Notification.permission !== 'granted') {
            console.warn('通知权限未授予，无法启动保活');
            return;
        }
        
        startHeartbeat();
        startAudioKeepAlive();
        localStorage.setItem('enable_background_system', 'true');
        console.log('✅ 后台保活系统已启动');
    }
    
    // 停止保活系统
    function stopKeepAlive() {
        stopHeartbeat();
        stopAudioKeepAlive();
        localStorage.setItem('enable_background_system', 'false');
        console.log('⏹️ 后台保活系统已停止');
    }
    
    // 监听页面可见性变化
    document.addEventListener('visibilitychange', () => {
        BackgroundSystem.state.isBackground = document.hidden;
        
        const isEnabled = localStorage.getItem('enable_background_system') === 'true';
        if (isEnabled && Notification.permission === 'granted') {
            if (document.hidden) {
                console.log('页面切到后台，保活系统继续运行');
            } else {
                console.log('页面切到前台');
            }
        }
    });
    
    // 绑定通知权限开关事件
    const notificationSwitch = document.getElementById('notification-permission-switch');
    if (notificationSwitch) {
        notificationSwitch.addEventListener('change', (e) => {
            if (e.target.checked) {
                requestNotificationPermission().then(() => {
                    if (Notification.permission === 'granted') {
                        startKeepAlive();
                    }
                });
            } else {
                stopKeepAlive();
            }
        });
    }
    
    // 绑定开启通知按钮
    const requestBtn = document.getElementById('notification-request-btn');
    if (requestBtn) {
        requestBtn.addEventListener('click', requestNotificationPermission);
    }
    
    // 绑定测试按钮
    const testBtn = document.getElementById('notification-test-btn');
    if (testBtn) {
        testBtn.addEventListener('click', sendTestNotification);
    }
    
    // 绑定后台测试按钮
    const bgTestBtn = document.getElementById('notification-background-test-btn');
    if (bgTestBtn) {
        bgTestBtn.addEventListener('click', function() {
            alert('点击确定后，请立即切换到其他应用或锁屏！\n\n10秒后会发送通知，测试后台通知功能是否正常。');
            
            console.log('🧪 后台通知测试：10秒倒计时开始');
            
            let countdown = 10;
            const countdownInterval = setInterval(() => {
                console.log(`⏰ 倒计时: ${countdown} 秒`);
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            setTimeout(() => {
                console.log('📤 10秒已到，发送后台测试通知...');
                
                try {
                    const notification = new Notification('后台通知测试', {
                        body: '如果你在锁屏/其他应用看到这条通知，说明后台通知功能完全正常！🎉',
                        tag: 'background-test',
                        requireInteraction: false,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    setTimeout(() => notification.close(), 10000);
                    
                    console.log('✅ 后台测试通知已发送');
                } catch (error) {
                    console.error('❌ 发送测试通知失败:', error);
                }
            }, 10000);
        });
    }
    
    // Service Worker 注册
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const serviceWorkerCode = `
// Service Worker for Background Tasks
const CACHE_NAME = 'yaya-cache-v1';

// 安装 Service Worker
self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(function(cache) {
        console.log('Service Worker: 缓存已打开');
        return cache.addAll(['/']);
      })
  );
});

// 激活 Service Worker
self.addEventListener('activate', function(event) {
  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if (cacheName !== CACHE_NAME) {
            console.log('Service Worker: 删除旧缓存', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});

// 处理推送通知
self.addEventListener('push', function(event) {
  console.log('Service Worker: 收到推送通知', event);
  
  let data = {};
  if (event.data) {
    try {
      data = event.data.json();
    } catch (e) {
      data = { title: '通知', body: event.data.text() || '您有新的消息' };
    }
  } else {
    data = { title: '通知', body: '您有新的消息' };
  }

  const options = {
    body: data.body || '您有新的消息',
    icon: data.icon || '/icon.png',
    badge: '/badge.png',
    tag: data.tag || 'notification',
    requireInteraction: data.requireInteraction || false,
    data: data.data || {}
  };

  event.waitUntil(
    self.registration.showNotification(data.title || '通知', options)
  );
});

// 处理通知点击
self.addEventListener('notificationclick', function(event) {
  console.log('Service Worker: 通知被点击', event);
  
  event.notification.close();
  
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then(function(clientList) {
      for (let i = 0; i < clientList.length; i++) {
        const client = clientList[i];
        if (client.url.indexOf(self.location.origin) === 0 && 'focus' in client) {
          return client.focus();
        }
      }
      if (clients.openWindow) {
        return clients.openWindow('/');
      }
    })
  );
});

// 处理消息传递
self.addEventListener('message', function(event) {
  console.log('Service Worker: 收到消息', event.data);
  
  if (event.data && event.data.type === 'SHOW_NOTIFICATION') {
    const notificationData = event.data.data;
    const options = {
      body: notificationData.body || '',
      icon: notificationData.icon || '/icon.png',
      badge: '/badge.png',
      tag: notificationData.tag || 'chat-notification',
      requireInteraction: false,
      data: notificationData.data || {}
    };
    
    event.waitUntil(
      self.registration.showNotification(notificationData.title || '新消息', options)
    );
  }
});
`;
            
            const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const serviceWorkerUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(serviceWorkerUrl)
                .then(registration => {
                    console.log('✅ Service Worker 注册成功:', registration.scope);
                    
                    // 监听来自 Service Worker 的消息
                    navigator.serviceWorker.addEventListener('message', event => {
                        console.log('收到 Service Worker 消息:', event.data);
                    });
                })
                .catch(error => {
                    console.error('❌ Service Worker 注册失败:', error);
                });
        });
    }
    
    // 页面加载时初始化
    window.addEventListener('load', () => {
        updateNotificationButton();
        
        // 如果之前已启用，自动启动保活
        const isEnabled = localStorage.getItem('enable_background_system') === 'true';
        if (isEnabled && Notification.permission === 'granted') {
            const switchEl = document.getElementById('notification-permission-switch');
            if (switchEl) {
                switchEl.checked = true;
            }
            startKeepAlive();
        }
        
        console.log('通知系统已初始化');
    });
    
    // 当打开设置页面时，更新通知状态
    const originalOpenSettingsPage = window.openSettingsPage;
    if (typeof originalOpenSettingsPage === 'function') {
        window.openSettingsPage = function() {
            originalOpenSettingsPage.call(this);
            setTimeout(() => {
                updateNotificationButton();
            }, 100);
        };
    }

    </script>
</body>
</html>